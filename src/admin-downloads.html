<!DOCTYPE html>
<html lang="ja" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ダウンロード管理 | LIFE X 管理画面</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>

    <link href="./styles/main.css" rel="stylesheet">
    <script src="/js/common.js"></script>

    <!-- Supabase Auth Guard -->
    <script type="module" src="/js/auth-guard.js"></script>

    <!-- Supabase Integration -->
    <script type="module" src="/js/supabase-integration.js"></script>
    <script type="module">
        // Supabaseクライアントをsupabase-client.jsからインポート
        import { supabase } from '/js/supabase-client.js';
        window.supabase = supabase;
    </script>

    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        .sortable-ghost {
            opacity: 0.4;
        }
        .sortable-drag {
            opacity: 0.8;
        }
    </style>
</head>
<body class="h-full bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="/" class="text-xl font-bold text-gray-900 hover:text-gray-700">LIFE X</a>
                    <span class="ml-2 px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">管理者専用</span>
                </div>
                <nav class="hidden md:flex space-x-8 items-center">
                    <a href="/admin.html" class="nav-link">管理ホーム</a>
                    <a href="/admin-plans.html" class="nav-link">プラン管理</a>
                    <a href="/admin-rules.html" class="nav-link">ルール・ガイドライン管理</a>
                    <a href="/admin-downloads.html" class="nav-link active">ダウンロード管理</a>
                    <a href="/admin-faq.html" class="nav-link">よくある質問管理</a>
                    <a href="/admin-system.html" class="nav-link">システム管理</a>
                    <a href="/admin-report.html" class="nav-link">レポート</a>
                    <a href="/" class="nav-link">サイトに戻る</a>
                    <button onclick="logout()" type="button" class="nav-link text-red-600 hover:text-red-800">ログアウト</button>
                </nav>
                <div id="userInfo" class="text-sm"></div>
            </div>
        </div>
    </header>

    <div x-data="adminDownloads()" x-init="init()">
        <!-- Page Header -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">ダウンロード管理</h1>
                    <p class="text-gray-600 mt-2">カテゴリごとにファイルを管理</p>
                </div>
                <button type="button" @click="openCategoryModal()" class="btn-secondary">
                    <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                    </svg>
                    カテゴリ管理
                </button>
            </div>

            <!-- Categories -->
            <div class="space-y-6">
                <template x-for="category in categories" :key="category.id">
                    <div class="card">
                        <!-- Category Header -->
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-t-lg">
                            <div class="flex items-center space-x-3">
                                <div class="handle cursor-move">
                                    <svg class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                                    </svg>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-900" x-text="category.name"></h3>
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full" x-text="`${category.files.length}件`"></span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button type="button" @click="toggleCategory(category.id)" class="text-gray-500 hover:text-gray-700">
                                    <svg x-show="!category.expanded" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                    <svg x-show="category.expanded" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                    </svg>
                                </button>
                                <button type="button" @click="addFileToCategory(category.id)" class="text-blue-600 hover:text-blue-800">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                    </svg>
                                </button>
                                <button type="button" @click="editCategory(category)" class="text-gray-600 hover:text-gray-800">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                                <button type="button" @click="deleteCategory(category.id)" class="text-red-600 hover:text-red-800">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Category Files -->
                        <div x-show="category.expanded" class="p-4">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">並び替え</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ファイル名</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">形式</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">サイズ</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DL数</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">更新日</th>
                                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200 sortable-files" :data-category-id="category.id">
                                        <template x-for="file in category.files" :key="file.id">
                                            <tr class="hover:bg-gray-50" :data-file-id="file.id">
                                                <td class="px-4 py-2">
                                                    <div class="handle cursor-move">
                                                        <svg class="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16" />
                                                        </svg>
                                                    </div>
                                                </td>
                                                <td class="px-4 py-2 text-sm font-medium text-gray-900" x-text="file.name"></td>
                                                <td class="px-4 py-2">
                                                    <span class="px-2 py-1 text-xs rounded-full"
                                                          :class="getFileTypeClass(file.type)"
                                                          x-text="file.type.toUpperCase()"></span>
                                                </td>
                                                <td class="px-4 py-2 text-sm text-gray-500" x-text="formatFileSize(file.size)"></td>
                                                <td class="px-4 py-2 text-sm text-gray-500" x-text="file.downloads"></td>
                                                <td class="px-4 py-2 text-sm text-gray-500" x-text="file.updated"></td>
                                                <td class="px-4 py-2 text-right text-sm font-medium">
                                                    <button type="button" @click="editFile(file)" class="text-blue-600 hover:text-blue-900 mr-2">編集</button>
                                                    <button type="button" @click="deleteFile(category.id, file.id)" class="text-red-600 hover:text-red-900">削除</button>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                                <div x-show="category.files.length === 0" class="text-center py-8 text-gray-500">
                                    このカテゴリにはファイルがありません
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Add/Edit File Modal -->
        <div x-show="showFileModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
            <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <h3 class="text-lg font-medium text-gray-900 mb-4" x-text="editingFile ? 'ファイル編集' : '新規ファイル追加'"></h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ファイル名</label>
                            <input type="text" x-model="fileFormData.name" class="form-input w-full" placeholder="契約書テンプレート.pdf">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ファイル</label>
                            <div 
                                @drop.prevent="handleDrop"
                                @dragover.prevent="dragOver = true"
                                @dragleave.prevent="dragOver = false"
                                :class="dragOver ? 'border-blue-500 bg-blue-50' : 'border-gray-300 bg-gray-50'"
                                class="border-2 border-dashed rounded-lg p-6 text-center transition-colors cursor-pointer"
                                @click="$refs.fileInput.click()"
                            >
                                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                </svg>
                                <p class="mt-2 text-sm text-gray-600">
                                    <span class="font-semibold">クリックしてファイルを選択</span> または ドラッグ&ドロップ
                                </p>
                                <p x-show="uploadedFileName" class="mt-2 text-sm text-green-600" x-text="'選択済み: ' + uploadedFileName"></p>
                                <input type="file" x-ref="fileInput" @change="handleFileUpload" class="hidden" multiple>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">説明</label>
                            <textarea x-model="fileFormData.description" rows="3" class="form-input w-full" placeholder="ファイルの説明を入力"></textarea>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" @click="closeFileModal()" class="btn-secondary">キャンセル</button>
                        <button type="button" @click="saveFile()" class="btn-primary">保存</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Category Management Modal -->
        <div x-show="showCategoryModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
            <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">カテゴリ管理</h3>
                    
                    <div class="mb-4">
                        <div class="flex space-x-2">
                            <input type="text" x-model="newCategoryName" placeholder="新しいカテゴリ名" class="form-input flex-1">
                            <button type="button" @click="addCategory()" class="btn-primary">追加</button>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <template x-for="category in categories" :key="category.id">
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                                <span x-text="category.name"></span>
                                <div class="flex space-x-2">
                                    <button type="button" @click="editCategoryName(category)" class="text-blue-600 hover:text-blue-800">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                    </button>
                                    <button type="button" @click="deleteCategory(category.id)" class="text-red-600 hover:text-red-800">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>

                    <div class="mt-6 flex justify-end">
                        <button type="button" @click="closeCategoryModal()" class="btn-primary">閉じる</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function adminDownloads() {
            return {
                categories: [],
                
                showFileModal: false,
                showCategoryModal: false,
                editingFile: null,
                editingCategory: null,
                newCategoryName: '',
                selectedCategoryId: null,
                dragOver: false,
                uploadedFileName: '',
                
                fileFormData: {
                    name: '',
                    type: '',
                    size: 0,
                    description: ''
                },

                init() {
                    // ローカルストレージからデータを読み込み
                    this.loadFromSupabase();
                    
                    // カテゴリが空の場合はデフォルトカテゴリを設定
                    if (this.categories.length === 0) {
                        this.categories = [];
                    }
                    
                    this.$nextTick(() => {
                        this.initSortable();
                    });
                },

                initSortable() {
                    // カテゴリの並び替え
                    const categoryContainer = document.querySelector('.space-y-6');
                    if (categoryContainer) {
                        new Sortable(categoryContainer, {
                            handle: '.handle',
                            animation: 150,
                            onEnd: (evt) => {
                                this.reorderCategories(evt.oldIndex, evt.newIndex);
                            }
                        });
                    }

                    // ファイルの並び替え
                    document.querySelectorAll('.sortable-files').forEach(tbody => {
                        new Sortable(tbody, {
                            handle: '.handle',
                            animation: 150,
                            onEnd: (evt) => {
                                const categoryId = parseInt(tbody.dataset.categoryId);
                                this.reorderFiles(categoryId, evt.oldIndex, evt.newIndex);
                            }
                        });
                    });
                },

                toggleCategory(categoryId) {
                    const category = this.categories.find(c => c.id === categoryId);
                    if (category) {
                        category.expanded = !category.expanded;
                    }
                },

                addCategory() {
                    if (this.newCategoryName.trim()) {
                        // カテゴリが空の場合は1から開始、そうでなければ最大ID+1
                        const newId = this.categories.length === 0 
                            ? 1 
                            : Math.max(...this.categories.map(c => c.id || 0)) + 1;
                        
                        this.categories.push({
                            id: newId,
                            name: this.newCategoryName.trim(),
                            expanded: true,
                            files: []
                        });
                        this.newCategoryName = '';
                        
                        // データを保存
                        this.saveToSupabase();
                        
                        this.$nextTick(() => {
                            this.initSortable();
                        });
                    }
                },

                editCategoryName(category) {
                    const newName = prompt('カテゴリ名を入力してください', category.name);
                    if (newName && newName.trim()) {
                        category.name = newName.trim();
                    }
                },

                deleteCategory(categoryId) {
                    if (confirm('このカテゴリを削除しますか？')) {
                        this.categories = this.categories.filter(c => c.id !== categoryId);
                        this.saveToSupabase();
                    }
                },

                addFileToCategory(categoryId) {
                    this.selectedCategoryId = categoryId;
                    this.editingFile = null;
                    this.fileFormData = {
                        name: '',
                        type: '',
                        size: 0,
                        description: ''
                    };
                    this.showFileModal = true;
                },

                editFile(file) {
                    this.editingFile = file;
                    this.fileFormData = { ...file };
                    this.showFileModal = true;
                },

                deleteFile(categoryId, fileId) {
                    if (confirm('このファイルを削除しますか？')) {
                        const category = this.categories.find(c => c.id === categoryId);
                        if (category) {
                            category.files = category.files.filter(f => f.id !== fileId);
                            this.saveToSupabase();
                        }
                    }
                },

                saveFile() {
                    if (this.editingFile) {
                        Object.assign(this.editingFile, this.fileFormData);
                    } else if (this.selectedCategoryId) {
                        const category = this.categories.find(c => c.id === this.selectedCategoryId);
                        if (category) {
                            const newId = Math.max(0, ...category.files.map(f => f.id)) + 1;
                            category.files.push({
                                id: newId,
                                ...this.fileFormData,
                                downloads: 0,
                                updated: new Date().toISOString().split('T')[0]
                            });
                        }
                    }
                    this.saveToSupabase();
                    this.closeFileModal();
                },

                closeFileModal() {
                    this.showFileModal = false;
                    this.editingFile = null;
                    this.selectedCategoryId = null;
                    this.uploadedFileName = '';
                    this.dragOver = false;
                },

                openCategoryModal() {
                    this.showCategoryModal = true;
                },

                closeCategoryModal() {
                    this.showCategoryModal = false;
                },

                handleFileUpload(event) {
                    const files = event.target.files;
                    if (files && files.length > 0) {
                        this.processFile(files[0]);
                    }
                },
                
                handleDrop(event) {
                    this.dragOver = false;
                    const files = event.dataTransfer.files;
                    if (files && files.length > 0) {
                        this.processFile(files[0]);
                    }
                },
                
                processFile(file) {
                    if (file) {
                        this.fileFormData.type = file.name.split('.').pop().toLowerCase();
                        this.fileFormData.size = file.size;
                        this.uploadedFileName = file.name;
                        if (!this.fileFormData.name) {
                            this.fileFormData.name = file.name;
                        }
                        // トースト通知
                        if (window.lifeXAPI && window.lifeXAPI.showToast) {
                            window.lifeXAPI.showToast(`ファイル「${file.name}」を選択しました`, 'success');
                        }
                    }
                },

                formatFileSize(bytes) {
                    if (bytes < 1024) return bytes + ' B';
                    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
                },

                getFileTypeClass(type) {
                    const classes = {
                        'pdf': 'bg-red-100 text-red-800',
                        'xlsx': 'bg-green-100 text-green-800',
                        'docx': 'bg-blue-100 text-blue-800',
                        'pptx': 'bg-orange-100 text-orange-800',
                        'zip': 'bg-purple-100 text-purple-800',
                        'ai': 'bg-pink-100 text-pink-800',
                        'png': 'bg-indigo-100 text-indigo-800',
                        'jpg': 'bg-indigo-100 text-indigo-800',
                        'jpeg': 'bg-indigo-100 text-indigo-800'
                    };
                    return classes[type] || 'bg-gray-100 text-gray-800';
                },

                reorderCategories(oldIndex, newIndex) {
                    const item = this.categories.splice(oldIndex, 1)[0];
                    this.categories.splice(newIndex, 0, item);
                    this.saveToSupabase();
                },
                
                async saveToSupabase() {
                    try {
                        if (window.supabaseAPI) {
                            // Supabaseに保存
                            for (const category of this.categories) {
                                // カテゴリ内のファイル（ダウンロード資料）を保存
                                if (category.files && category.files.length > 0) {
                                    for (const file of category.files) {
                                        if (file.id && typeof file.id === 'string' && file.id.includes('-')) {
                                            // 既存ファイル更新
                                            await window.supabaseAPI.downloads.update(file.id, {
                                                title: file.title || file.name,
                                                description: file.description || '',
                                                file_url: file.url || file.file_url,
                                                file_size: file.size || file.file_size || 0,
                                                file_type: file.type || file.file_type || '',
                                                category_id: file.category_id,
                                                display_order: file.display_order || 0,
                                                status: file.status || 'active'
                                            });
                                        } else {
                                            // 新規ファイル作成
                                            const result = await window.supabaseAPI.downloads.create({
                                                title: file.title || file.name,
                                                description: file.description || '',
                                                file_url: file.url || file.file_url,
                                                file_size: file.size || file.file_size || 0,
                                                file_type: file.type || file.file_type || '',
                                                category_id: file.category_id,
                                                display_order: file.display_order || 0,
                                                status: file.status || 'active'
                                            });

                                            if (result.success && result.data) {
                                                file.id = result.data.id;
                                            }
                                        }
                                    }
                                }
                            }
                            console.log('✅ Downloads saved to Supabase');
                        } else {
                            // LocalStorageに保存（フォールバック）
                            const data = {
                                categories: this.categories.map(cat => ({
                                    id: cat.id,
                                    name: cat.name,
                                    files: cat.files || []
                                }))
                            };
                            localStorage.setItem('downloads_data', JSON.stringify(data));
                            console.log('⚠️ Saved to localStorage (fallback)');
                        }

                        // 統計更新イベントを発火
                        window.dispatchEvent(new CustomEvent('stats-updated'));
                    } catch (error) {
                        console.error('❌ Error saving downloads:', error);
                        // エラー時はLocalStorageにフォールバック
                        const data = {
                            categories: this.categories.map(cat => ({
                                id: cat.id,
                                name: cat.name,
                                files: cat.files || []
                            }))
                        };
                        localStorage.setItem('downloads_data', JSON.stringify(data));
                        console.log('⚠️ Saved to localStorage due to error');
                    }
                },
                
                async loadFromSupabase() {
                    try {
                        // Supabase APIが利用可能になるまで待機
                        let retries = 0;
                        while (!window.supabaseAPI && retries < 10) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                            retries++;
                        }

                        // Supabase or LocalStorage
                        if (window.supabaseAPI && window.supabase) {
                            console.log('Loading downloads from Supabase...');

                            // カテゴリとダウンロード資料を取得
                            const downloadCategories = await window.supabaseAPI.downloads.getCategories();
                            const downloads = await window.supabaseAPI.downloads.getItems();

                            if (downloadCategories && downloadCategories.length > 0) {
                                // カテゴリにダウンロード資料を紐付け
                                this.categories = downloadCategories.map(cat => ({
                                    id: cat.id,
                                    name: cat.name,
                                    expanded: true,
                                    files: downloads.filter(d => d.category_id === cat.id)
                                }));
                            } else {
                                // Supabaseが空の場合、LocalStorageを確認
                                const data = localStorage.getItem('downloads_data');
                                if (data) {
                                    const parsed = JSON.parse(data);
                                    if (parsed.categories && Array.isArray(parsed.categories)) {
                                        this.categories = parsed.categories.map(cat => ({
                                            ...cat,
                                            expanded: true,
                                            files: cat.files || []
                                        }));
                                    }
                                }
                            }
                            console.log('✅ Loaded downloads from Supabase:', this.categories.length);
                        } else {
                            // LocalStorageから読み込み（フォールバック）
                            const data = localStorage.getItem('downloads_data');
                            if (data) {
                                const parsed = JSON.parse(data);
                                console.log('Loading downloads data:', parsed);

                                // 新形式（配列）のチェック
                                if (parsed.categories && Array.isArray(parsed.categories)) {
                                    this.categories = parsed.categories.map(cat => ({
                                        ...cat,
                                        expanded: true,
                                        files: cat.files || []
                                    }));
                                }
                                // 古い形式（オブジェクト）のチェック（互換性のため）
                                else if (parsed.categories && typeof parsed.categories === 'object') {
                                    this.categories = Object.entries(parsed.categories).map(([key, value], index) => ({
                                        id: index + 1,
                                        name: value.name || key,
                                        expanded: true,
                                        files: value.files || value.items || []
                                    }));
                                }
                            }
                            console.log('⚠️ Loaded from localStorage (fallback)');
                        }
                    } catch (error) {
                        console.error('❌ Error loading downloads:', error);
                        // エラー時はLocalStorageフォールバック
                        const data = localStorage.getItem('downloads_data');
                        if (data) {
                            const parsed = JSON.parse(data);
                            if (parsed.categories && Array.isArray(parsed.categories)) {
                                this.categories = parsed.categories.map(cat => ({
                                    ...cat,
                                    expanded: true,
                                    files: cat.files || []
                                }));
                            }
                        }
                    }
                },

                reorderFiles(categoryId, oldIndex, newIndex) {
                    const category = this.categories.find(c => c.id === categoryId);
                    if (category) {
                        const item = category.files.splice(oldIndex, 1)[0];
                        category.files.splice(newIndex, 0, item);
                    }
                }
            }
        }
    </script>
</body>
</html>