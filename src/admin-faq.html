<!DOCTYPE html>
<html lang="ja" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAQç®¡ç† | LIFE X ç®¡ç†ç”»é¢</title>
    <!-- Version: 2025-01-24-v7 (FAQ API sync initialization) -->
    <!-- Tailwind CSS (Production Build) -->
    <link rel="stylesheet" href="/assets/tailwind.css">

    <link href="./styles/main.css" rel="stylesheet">

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>console.log('ğŸ”¥ admin-faq.html loaded - Version: 2025-01-24-v7 (FAQ API sync initialization)');</script>
    <script src="/js/common.js?v=20251024b"></script>

    <!-- Supabase Auth Guard -->
    <script type="module" src="/js/auth-guard.js?v=20251024"></script>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <!-- Supabase Integration - åŒæœŸåˆæœŸåŒ–ã«å¤‰æ›´ -->
    <script>
        console.log('ğŸš€ FAQ API initialization v6 - SYNC FIX: Initialize before Alpine.js');
        console.log('ğŸš€ Starting FAQ API initialization...');

        // Supabaseæ¥ç¶šæƒ…å ±ï¼ˆsupabase-client.jsã¨åŒã˜ï¼‰
        const SUPABASE_URL = 'https://hegpxvyziovlfxdfsrsv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhlZ3B4dnl6aW92bGZ4ZGZzcnN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2Nzk5MjYsImV4cCI6MjA3NjI1NTkyNn0.uLCJvgKDOWpTxRjt39DVyqUotQcSam3v4lItofWeDws';

        console.log('ğŸ”§ Supabase URL:', SUPABASE_URL);

        // Supabase CDNã®èª­ã¿è¾¼ã¿ã‚’å¾…ã¤é–¢æ•°ã‚’å®šç¾©
        window.initFAQAPI = function() {
            // Supabase CDNãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            if (!window.supabase?.createClient) {
                console.warn('âš ï¸ Supabase CDN not loaded yet, retrying...');
                setTimeout(window.initFAQAPI, 50);
                return;
            }

            console.log('âœ… Supabase CDN loaded');

            // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’æ­£ã—ãåˆæœŸåŒ–ã—ã¦ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜
            const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log('âœ… Supabase client initialized');
            console.log('   Has auth:', !!supabaseClient.auth);
            console.log('   Has from:', typeof supabaseClient.from === 'function');

            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜ã—ã¦ãƒ‡ãƒãƒƒã‚°å¯èƒ½ã«
            window.supabase = supabaseClient;

        // FAQç”¨ã®APIã‚’ç›´æ¥å®šç¾©
        window.supabaseAPI = window.supabaseAPI || {};
        window.supabaseAPI.faq = {
            async getCategories() {
                try {
                    console.log('ğŸ“‹ getCategories() called');
                    const { data, error } = await supabaseClient
                        .from('faq_categories')
                        .select('*')
                        .order('display_order');
                    if (error) {
                        console.error('âŒ getCategories error:', error);
                        throw error;
                    }
                    console.log('âœ… getCategories success:', data?.length || 0, 'categories');
                    return data || [];
                } catch (error) {
                    console.error('Error fetching FAQ categories:', error);
                    return [];
                }
            },

            async getItems(categoryId = null) {
                try {
                    console.log('ğŸ“‹ getItems() called, categoryId:', categoryId);
                    let query = supabaseClient
                        .from('faqs')
                        .select('*, faq_categories(name)')
                        .order('display_order');

                    if (categoryId) {
                        query = query.eq('category_id', categoryId);
                    }

                    const { data, error } = await query;
                    if (error) {
                        console.error('âŒ getItems error:', error);
                        throw error;
                    }
                    console.log('âœ… getItems success:', data?.length || 0, 'items');
                    return data || [];
                } catch (error) {
                    console.error('Error fetching FAQs:', error);
                    return [];
                }
            },

            async create(faqData) {
                try {
                    console.log('â• create() called:', faqData);
                    const { data, error } = await supabaseClient
                        .from('faqs')
                        .insert([{
                            question: faqData.question,
                            answer: faqData.answer,
                            category_id: faqData.category_id,
                            tags: faqData.tags || [],
                            status: faqData.status || 'published',
                            display_order: faqData.display_order || 0
                        }])
                        .select()
                        .single();

                    if (error) throw error;
                    return { success: true, data };
                } catch (error) {
                    console.error('Error creating FAQ:', error);
                    return { success: false, error: error.message };
                }
            },

            async update(faqId, updates) {
                try {
                    console.log('âœï¸ update() called, id:', faqId, 'updates:', updates);
                    const { data, error } = await supabaseClient
                        .from('faqs')
                        .update(updates)
                        .eq('id', faqId)
                        .select()
                        .single();

                    if (error) {
                        console.error('âŒ update error:', error);
                        throw error;
                    }
                    console.log('âœ… update success');
                    return { success: true, data };
                } catch (error) {
                    console.error('Error updating FAQ:', error);
                    return { success: false, error: error.message };
                }
            },

            async delete(faqId) {
                try {
                    console.log('ğŸ—‘ï¸ delete() called, id:', faqId);
                    const { error } = await supabaseClient
                        .from('faqs')
                        .delete()
                        .eq('id', faqId);

                    if (error) {
                        console.error('âŒ delete error:', error);
                        throw error;
                    }
                    console.log('âœ… delete success');
                    return { success: true };
                } catch (error) {
                    console.error('Error deleting FAQ:', error);
                    return { success: false, error: error.message };
                }
            }
        };

            console.log('âœ… FAQ API initialized');
            console.log('window.supabaseAPI:', window.supabaseAPI);

            // Alpine.jsã®åˆæœŸåŒ–æº–å‚™å®Œäº†ã‚’é€šçŸ¥
            window.supabaseAPIReady = true;
            window.dispatchEvent(new Event('supabaseAPIReady'));
        };

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸåŒ–ã‚’é–‹å§‹
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', window.initFAQAPI);
        } else {
            // ã™ã§ã«DOMãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯å³åº§ã«å®Ÿè¡Œ
            window.initFAQAPI();
        }
    </script>

    <!-- Alpine.js - é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼ˆè‡ªå‹•èµ·å‹•ï¼‰ -->
    <script>
        document.addEventListener('alpine:init', () => {
            console.log('ğŸ¿ Alpine.js initialized');
        });
    </script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="h-full bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="/" class="text-xl font-bold text-gray-900 hover:text-gray-700">LIFE X</a>
                    <span class="ml-2 px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">ç®¡ç†è€…å°‚ç”¨</span>
                </div>
                <nav class="hidden md:flex space-x-8 items-center">
                    <a href="/admin.html" class="nav-link">ç®¡ç†ãƒ›ãƒ¼ãƒ </a>
                    <a href="/admin-plans.html" class="nav-link">ãƒ—ãƒ©ãƒ³ç®¡ç†</a>
                    <a href="/admin-rules.html" class="nav-link">ãƒ«ãƒ¼ãƒ«ç®¡ç†</a>
                    <a href="/admin-downloads.html" class="nav-link">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç®¡ç†</a>
                    <a href="/admin-faq.html" class="nav-link active">FAQç®¡ç†</a>
                    <a href="/admin-notifications.html" class="nav-link">ãŠçŸ¥ã‚‰ã›ç®¡ç†</a>
                    <a href="/admin-users.html" class="nav-link">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</a>
                    <a href="/admin-profile.html" class="nav-link">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</a>
                    <a href="/admin-system.html" class="nav-link">ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†</a>
                    <a href="/admin-report.html" class="nav-link">ãƒ¬ãƒãƒ¼ãƒˆ</a>
                    <a href="/" class="nav-link">ã‚µã‚¤ãƒˆã«æˆ»ã‚‹</a>
                    <button onclick="logout()" type="button" class="nav-link text-red-600 hover:text-red-800">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </nav>

                <!-- Mobile Menu -->
                <div class="md:hidden" x-data="{ mobileMenuOpen: false }">
                    <button @click="mobileMenuOpen = !mobileMenuOpen" type="button" class="text-gray-500 hover:text-gray-600">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>

                    <div x-show="mobileMenuOpen" class="absolute top-16 right-4 bg-white shadow-lg rounded-lg border border-gray-200 p-4 z-50 min-w-48" style="display: none;">
                        <a href="/admin.html" class="block py-2 text-sm text-gray-600">ç®¡ç†ãƒ›ãƒ¼ãƒ </a>
                        <a href="/admin-plans.html" class="block py-2 text-sm text-gray-600">ãƒ—ãƒ©ãƒ³ç®¡ç†</a>
                        <a href="/admin-rules.html" class="block py-2 text-sm text-gray-600">ãƒ«ãƒ¼ãƒ«ç®¡ç†</a>
                        <a href="/admin-downloads.html" class="block py-2 text-sm text-gray-600">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç®¡ç†</a>
                        <a href="/admin-faq.html" class="block py-2 text-sm text-gray-900 font-medium">FAQç®¡ç†</a>
                        <a href="/admin-notifications.html" class="block py-2 text-sm text-gray-600">ãŠçŸ¥ã‚‰ã›ç®¡ç†</a>
                        <a href="/admin-users.html" class="block py-2 text-sm text-gray-600">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</a>
                        <a href="/admin-profile.html" class="block py-2 text-sm text-gray-600">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</a>
                        <a href="/admin-system.html" class="block py-2 text-sm text-gray-600">ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†</a>
                        <a href="/admin-report.html" class="block py-2 text-sm text-gray-600">ãƒ¬ãƒãƒ¼ãƒˆ</a>
                        <div class="border-t border-gray-200 mt-3 pt-3">
                            <a href="/" class="block py-2 text-sm text-gray-600">ã‚µã‚¤ãƒˆã«æˆ»ã‚‹</a>
                            <button onclick="logout()" type="button" class="block py-2 text-sm text-red-600 hover:text-red-800 text-left w-full">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                        </div>
                    </div>
                </div>

                <div id="userInfo" class="hidden md:block text-sm"></div>
            </div>
        </div>
    </header>

    <div x-data="adminFAQ" x-init="init">
        <!-- Page Header -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">FAQç®¡ç†</h1>
                    <p class="text-gray-600 mt-2">FAQã®è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ãƒ»ä¸¦ã³æ›¿ãˆã‚’ç®¡ç†</p>
                </div>
                <div class="flex space-x-3">
                    <button type="button" @click="openCategoryModal()" class="btn-secondary">
                        <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                        </svg>
                        ã‚«ãƒ†ã‚´ãƒªç®¡ç†
                    </button>
                    <button type="button" @click="openAddModal()" class="btn-primary">
                        <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        æ–°è¦FAQè¿½åŠ 
                    </button>
                </div>
            </div>

            <!-- ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚¿ãƒ– -->
            <div class="card mb-6">
                <div class="flex space-x-1 border-b border-gray-200">
                    <button
                        @click="activeCategory = 'all'"
                        :class="activeCategory === 'all' ? 'border-b-2 border-primary-500 text-primary-600' : 'text-gray-600 hover:text-gray-900'"
                        class="px-4 py-2 font-medium transition-colors">
                        ã™ã¹ã¦
                    </button>
                    <template x-for="(category, index) in categories" :key="index">
                        <button
                            @click="activeCategory = category"
                            :class="activeCategory === category ? 'border-b-2 border-primary-500 text-primary-600' : 'text-gray-600 hover:text-gray-900'"
                            class="px-4 py-2 font-medium transition-colors"
                            x-text="category">
                        </button>
                    </template>
                </div>
            </div>

            <!-- FAQ ãƒªã‚¹ãƒˆ -->
            <div class="space-y-4" id="faqList">
                <template x-for="faq in filteredFAQs" :key="faq.id">
                    <div class="card hover:shadow-lg transition-shadow" :data-id="faq.id">
                        <div class="flex items-start">
                            <!-- ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ« -->
                            <div class="handle cursor-move mr-4 mt-1">
                                <svg class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                                </svg>
                            </div>
                            
                            <!-- FAQå†…å®¹ -->
                            <div class="flex-1">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-3 mb-2">
                                            <span x-text="faq.category" class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded"></span>
                                            <span x-text="`è¡¨ç¤ºé †: ${faq.order}`" class="text-xs text-gray-500"></span>
                                            <span x-show="faq.status === 'active'" class="text-xs px-2 py-1 bg-green-100 text-green-800 rounded">å…¬é–‹ä¸­</span>
                                            <span x-show="faq.status === 'draft'" class="text-xs px-2 py-1 bg-gray-100 text-gray-800 rounded">ä¸‹æ›¸ã</span>
                                        </div>
                                        <h3 class="text-lg font-medium text-gray-900 mb-2" x-text="faq.question"></h3>
                                        <div class="text-sm text-gray-600" x-html="faq.answer.substring(0, 150) + (faq.answer.length > 150 ? '...' : '')"></div>
                                    </div>
                                    
                                    <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
                                    <div class="flex items-center space-x-2 ml-4">
                                        <button type="button" @click="editFAQ(faq)" class="text-blue-600 hover:text-blue-900">
                                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                            </svg>
                                        </button>
                                        <button type="button" @click="deleteFAQ(faq)" class="text-red-600 hover:text-red-900">
                                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Add/Edit Modal -->
        <div x-show="showModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
            <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-3xl shadow-lg rounded-md bg-white mb-10">
                <div class="mt-3">
                    <h3 class="text-lg font-medium text-gray-900 mb-4" x-text="editingFAQ ? 'FAQç·¨é›†' : 'æ–°è¦FAQè¿½åŠ '"></h3>

                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ã‚«ãƒ†ã‚´ãƒª <span class="text-red-500">*</span></label>
                                <select x-model="formData.category" class="form-input w-full" required>
                                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                    <template x-for="(category, index) in categories" :key="index">
                                        <option :value="category" x-text="category"></option>
                                    </template>
                                    <option value="new">æ–°è¦ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ...</option>
                                </select>
                                <input
                                    x-show="formData.category === 'new'"
                                    x-model="newCategory"
                                    type="text"
                                    placeholder="æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªå"
                                    class="form-input w-full mt-2"
                                    required>
                                <p class="text-xs text-gray-500 mt-1">ã‚«ãƒ†ã‚´ãƒªã‚’å¿…ãšé¸æŠã—ã¦ãã ã•ã„</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                                <select x-model="formData.status" class="form-input w-full">
                                    <option value="published">å…¬é–‹ä¸­</option>
                                    <option value="draft">ä¸‹æ›¸ã</option>
                                    <option value="archived">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">è³ªå•</label>
                            <input type="text" x-model="formData.question" class="form-input w-full" placeholder="ã‚ˆãã‚ã‚‹è³ªå•ã‚’å…¥åŠ›">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å›ç­”</label>
                            <div class="mb-2">
                                <button type="button" @click="insertHTML('bold')" class="text-sm px-2 py-1 bg-gray-100 rounded mr-1">å¤ªå­—</button>
                                <button type="button" @click="insertHTML('list')" class="text-sm px-2 py-1 bg-gray-100 rounded mr-1">ãƒªã‚¹ãƒˆ</button>
                                <button type="button" @click="insertHTML('br')" class="text-sm px-2 py-1 bg-gray-100 rounded">æ”¹è¡Œ</button>
                            </div>
                            <textarea
                                x-model="formData.answer"
                                rows="8"
                                class="form-input w-full"
                                placeholder="å›ç­”ã‚’å…¥åŠ›ï¼ˆHTMLå¯ï¼‰">
                            </textarea>
                            <p class="text-xs text-gray-500 mt-1">â€» HTMLã‚¿ã‚°ãŒä½¿ç”¨å¯èƒ½ã§ã™ï¼ˆ&lt;br&gt;, &lt;ul&gt;, &lt;li&gt;, &lt;strong&gt; ãªã©ï¼‰</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</label>
                            <div class="p-4 bg-gray-50 rounded border border-gray-200 min-h-[100px]" x-html="formData.answer || 'ï¼ˆå›ç­”ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰'"></div>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" @click="closeModal()" class="btn-secondary" :disabled="saving">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button type="button" @click="saveFAQ()"
                                :disabled="saving || !canSave"
                                :class="saving || !canSave ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'btn-primary'"
                                class="px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                            <span x-show="!saving">ä¿å­˜</span>
                            <span x-show="saving" class="flex items-center">
                                <svg class="animate-spin -ml-1 mr-3 h-4 w-4 text-current" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                ä¿å­˜ä¸­...
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Category Management Modal -->
        <div x-show="showCategoryModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
            <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white mb-10">
                <div class="mt-3">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">FAQã‚«ãƒ†ã‚´ãƒªç®¡ç†</h3>

                    <!-- ã‚«ãƒ†ã‚´ãƒªãƒªã‚¹ãƒˆ -->
                    <div class="space-y-2 mb-4">
                        <template x-for="(category, index) in categoryObjects" :key="category.id">
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded border border-gray-200">
                                <div class="flex-1">
                                    <div x-show="editingCategory && editingCategory.id === category.id">
                                        <input
                                            type="text"
                                            x-model="categoryFormData.name"
                                            class="form-input w-full"
                                            placeholder="ã‚«ãƒ†ã‚´ãƒªå">
                                    </div>
                                    <div x-show="!editingCategory || editingCategory.id !== category.id">
                                        <span class="font-medium" x-text="category.name"></span>
                                        <span class="text-xs text-gray-500 ml-2" x-text="`è¡¨ç¤ºé †: ${category.display_order || index + 1}`"></span>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2 ml-4">
                                    <template x-if="editingCategory && editingCategory.id === category.id">
                                        <div class="flex space-x-2">
                                            <button type="button" @click="saveCategoryEdit()" class="text-green-600 hover:text-green-900 text-sm">
                                                ä¿å­˜
                                            </button>
                                            <button type="button" @click="cancelCategoryEdit()" class="text-gray-600 hover:text-gray-900 text-sm">
                                                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                                            </button>
                                        </div>
                                    </template>
                                    <template x-if="!editingCategory || editingCategory.id !== category.id">
                                        <div class="flex space-x-2">
                                            <button type="button" @click="editCategoryItem(category)" class="text-blue-600 hover:text-blue-900">
                                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                </svg>
                                            </button>
                                            <button type="button" @click="deleteCategoryItem(category)" class="text-red-600 hover:text-red-900">
                                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                </svg>
                                            </button>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- æ–°è¦ã‚«ãƒ†ã‚´ãƒªè¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
                    <div class="p-4 bg-blue-50 rounded border border-blue-200">
                        <h4 class="text-sm font-medium text-gray-900 mb-2">æ–°è¦ã‚«ãƒ†ã‚´ãƒªè¿½åŠ </h4>
                        <div class="flex space-x-2">
                            <input
                                type="text"
                                x-model="newCategoryName"
                                @keyup.enter="addNewCategory()"
                                class="form-input flex-1"
                                placeholder="ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›">
                            <button type="button" @click="addNewCategory()" class="btn-primary">
                                è¿½åŠ 
                            </button>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end">
                        <button type="button" @click="closeCategoryModal()" class="btn-secondary">é–‰ã˜ã‚‹</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç°¡æ˜“çš„ãªlifeXAPIå®Ÿè£…ï¼ˆcommon.jsãŒèª­ã¿è¾¼ã‚ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
        if (!window.lifeXAPI) {
            window.lifeXAPI = {
                showToast(message, type) {
                    console.log(`[${type}] ${message}`);
                    // ç°¡æ˜“çš„ãªãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
                    const toast = document.createElement('div');
                    toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 ${
                        type === 'error' ? 'bg-red-500' :
                        type === 'success' ? 'bg-green-500' :
                        'bg-blue-500'
                    }`;
                    toast.textContent = message;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                }
            };
        }

        // ç°¡æ˜“çš„ãªèªè¨¼ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
        window.authManager = {
            isAuthenticated() {
                // ç°¡æ˜“ãƒã‚§ãƒƒã‚¯ - æœ¬ç•ªç’°å¢ƒã§ã¯é©åˆ‡ãªèªè¨¼ã‚’å®Ÿè£…
                return true;
            },
            requireAuth() {
                if (!this.isAuthenticated()) {
                    window.location.href = '/admin-login.html';
                    return false;
                }
                return true;
            }
        };

        document.addEventListener('alpine:init', () => {
            Alpine.data('adminFAQ', () => ({
                faqs: [],
                filteredFAQs: [],
                categories: [],
                categoryMap: {},
                categoryObjects: [],
                activeCategory: 'all',
                showModal: false,
                showCategoryModal: false,
                editingFAQ: null,
                editingCategory: null,
                newCategory: '',
                newCategoryName: '',
                saving: false,
                formData: {
                    question: '',
                    answer: '',
                    category: '',
                    status: 'published',
                    order: 1
                },
                categoryFormData: {
                    name: '',
                    display_order: 0
                },

                get canSave() {
                    const hasQuestion = this.formData.question.trim().length > 0;
                    const hasAnswer = this.formData.answer.trim().length > 0;
                    const hasValidCategory = this.getValidCategory().length > 0;
                    return hasQuestion && hasAnswer && hasValidCategory;
                },
                sortable: null,

                async init() {
                    console.log('ğŸ¿ Alpine init() called');

                    // FAQ APIã®åˆæœŸåŒ–ã‚’å¾…ã¤ï¼ˆå¿µã®ãŸã‚ï¼‰
                    if (!window.supabaseAPIReady) {
                        console.log('â³ Waiting for FAQ API to be ready...');
                        await new Promise(resolve => {
                            window.addEventListener('supabaseAPIReady', resolve, { once: true });
                        });
                    }
                    console.log('âœ… FAQ API ready, proceeding with initialization');

                    // ã‚«ãƒ†ã‚´ãƒªãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
                    await this.loadCategories();
                    // FAQãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
                    await this.loadFAQs();
                    this.filterFAQs();

                    // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã®åˆæœŸåŒ–
                    this.$nextTick(() => {
                        this.initSortable();
                    });
                },

                async loadCategories() {
                    try {
                        // FAQ APIãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆinit()ã§æ—¢ã«å¾…æ©Ÿæ¸ˆã¿ï¼‰
                        if (!window.supabaseAPI?.faq) {
                            console.error('âŒ CRITICAL: supabaseAPI.faq not available');
                            throw new Error('FAQ API not initialized');
                        }

                        const categories = await window.supabaseAPI.faq.getCategories();
                        if (categories && categories.length > 0) {
                            this.categoryObjects = categories;
                            this.categories = categories.map(c => c.name);

                            // Build category map: name -> id
                            this.categoryMap = {};
                            categories.forEach(cat => {
                                this.categoryMap[cat.name] = cat.id;
                            });

                            console.log('âœ… FAQ categories loaded:', this.categories);
                            console.log('   Category map:', this.categoryMap);
                        } else {
                            console.warn('âš ï¸ No FAQ categories found in database');
                        }
                    } catch (error) {
                        console.error('âŒ Error loading FAQ categories:', error);
                    }
                },

                async loadFAQs() {
                    try {
                        // init()ã§æ—¢ã«supabaseAPIã®å¾…æ©Ÿã¯å®Œäº†ã—ã¦ã„ã‚‹ã®ã§ã€ã“ã“ã§ã¯ä¸è¦
                        if (window.supabaseAPI && window.supabase) {
                            console.log('Loading FAQs from Supabase...');
                            this.faqs = await window.supabaseAPI.faq.getItems();
                            const categories = await window.supabaseAPI.faq.getCategories();

                            // ã‚«ãƒ†ã‚´ãƒªåã®ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                            if (categories && categories.length > 0) {
                                this.categories = categories.map(cat => cat.name);
                            }

                            // faq_categoriesã¨ã®é–¢é€£ä»˜ã‘ã‚’å‡¦ç†
                            if (this.faqs && this.faqs.length > 0) {
                                this.faqs = this.faqs.map(faq => {
                                    // ã‚«ãƒ†ã‚´ãƒªIDã‹ã‚‰åå‰ã‚’å–å¾—
                                    const category = categories.find(cat => cat.id === faq.category_id);
                                    return {
                                        ...faq,
                                        category: category ? category.name : faq.category || 'ãã®ä»–',
                                        order: faq.display_order || faq.order || 0
                                    };
                                });
                            }

                            // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«é™¤å¤–ï¼ˆ2åº¦ã¨è¡¨ç¤ºã•ã›ãªã„ï¼‰
                            this.faqs = this.faqs.filter(faq => {
                                const question = (faq.question || '').toLowerCase();
                                const answer = (faq.answer || '').toLowerCase();
                                const isTestData =
                                    question.includes('ã¦ã™ã¨') ||
                                    question.includes('ãƒ†ã‚¹ãƒˆ') ||
                                    question.includes('test') ||
                                    answer.includes('ã¦ã™ã¨') ||
                                    answer.includes('ãƒ†ã‚¹ãƒˆ') ||
                                    answer.includes('test');

                                if (isTestData) {
                                    console.warn('âš ï¸ Test data filtered out:', faq.question);
                                }
                                return !isTestData;
                            });

                            console.log('Loaded FAQs from Supabase:', this.faqs.length);

                            // Supabaseã‹ã‚‰æ­£å¸¸ã«ãƒ­ãƒ¼ãƒ‰ã§ããŸå ´åˆã€localStorageã‚’ã‚¯ãƒªã‚¢ï¼ˆå¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ï¼‰
                            localStorage.removeItem('faq_data');
                        } else {
                            // LocalStorageã‹ã‚‰å–å¾—ã‚’è©¦ã¿ã‚‹
                            const localData = localStorage.getItem('faq_data');
                            if (localData) {
                                this.faqs = JSON.parse(localData).faqs || [];

                                // LocalStorageã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã—ãŸå ´åˆã‚‚ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’é™¤å¤–
                                this.faqs = this.faqs.filter(faq => {
                                    const question = (faq.question || '').toLowerCase();
                                    const answer = (faq.answer || '').toLowerCase();
                                    return !question.includes('ã¦ã™ã¨') &&
                                           !question.includes('ãƒ†ã‚¹ãƒˆ') &&
                                           !question.includes('test') &&
                                           !answer.includes('ã¦ã™ã¨') &&
                                           !answer.includes('ãƒ†ã‚¹ãƒˆ') &&
                                           !answer.includes('test');
                                });
                            } else {
                                this.faqs = [];
                            }
                        }
                    } catch (error) {
                        console.error('Error loading FAQs:', error);
                        lifeXAPI.showToast('FAQãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                        this.faqs = [];
                    }
                },

                initSortable() {
                    const list = document.getElementById('faqList');
                    if (list) {
                        this.sortable = new Sortable(list, {
                            handle: '.handle',
                            animation: 150,
                            onEnd: (evt) => {
                                this.reorderFAQs(evt.oldIndex, evt.newIndex);
                            }
                        });
                    }
                },

                filterFAQs() {
                    if (this.activeCategory === 'all') {
                        this.filteredFAQs = [...this.faqs];
                    } else {
                        this.filteredFAQs = this.faqs.filter(faq => faq.category === this.activeCategory);
                    }

                    // è¡¨ç¤ºé †ã§ã‚½ãƒ¼ãƒˆï¼ˆdisplay_orderã‚‚è€ƒæ…®ï¼‰
                    this.filteredFAQs.sort((a, b) => {
                        const orderA = a.display_order || a.order || 0;
                        const orderB = b.display_order || b.order || 0;
                        return orderA - orderB;
                    });
                },

                reorderFAQs(oldIndex, newIndex) {
                    if (oldIndex === newIndex) return;
                    
                    const moved = this.filteredFAQs.splice(oldIndex, 1)[0];
                    this.filteredFAQs.splice(newIndex, 0, moved);
                    
                    // é †ç•ªã‚’æ›´æ–°
                    this.filteredFAQs.forEach((faq, index) => {
                        faq.order = index + 1;
                        const originalIndex = this.faqs.findIndex(f => f.id === faq.id);
                        if (originalIndex > -1) {
                            this.faqs[originalIndex].order = faq.order;
                        }
                    });
                    
                    this.saveFAQOrder();
                },

                openAddModal() {
                    this.editingFAQ = null;
                    this.formData = {
                        question: '',
                        answer: '',
                        category: '',
                        status: 'published',
                        order: this.faqs.length + 1
                    };
                    this.showModal = true;
                },

                editFAQ(faq) {
                    this.editingFAQ = faq;
                    this.formData = { ...faq };
                    this.showModal = true;
                },

                async saveFAQ() {
                    // ä¿å­˜ä¸­ã®å ´åˆã¯é‡è¤‡å®Ÿè¡Œã‚’é˜²ã
                    if (this.saving) {
                        return;
                    }

                    // ã‚«ãƒ†ã‚´ãƒªãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
                    if (!this.categoryMap || Object.keys(this.categoryMap).length === 0) {
                        lifeXAPI.showToast('ã‚«ãƒ†ã‚´ãƒªãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
                        // ã‚«ãƒ†ã‚´ãƒªã‚’å†èª­ã¿è¾¼ã¿
                        await this.loadCategories();
                        if (!this.categoryMap || Object.keys(this.categoryMap).length === 0) {
                            return;
                        }
                    }

                    // ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                    const validationResult = this.validateForm();
                    if (!validationResult.isValid) {
                        lifeXAPI.showToast(validationResult.message, 'error');
                        return;
                    }

                    // æ–°è¦ã‚«ãƒ†ã‚´ãƒªã®å‡¦ç†
                    const category = await this.processCategory();
                    if (!category) {
                        lifeXAPI.showToast('æœ‰åŠ¹ãªã‚«ãƒ†ã‚´ãƒªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                        return;
                    }

                    // ã‚«ãƒ†ã‚´ãƒªã®å­˜åœ¨ç¢ºèª
                    if (!this.categoryMap[category]) {
                        lifeXAPI.showToast(`ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚`, 'error');
                        return;
                    }
                    
                    // FAQãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†
                    const faqData = {
                        ...this.formData,
                        category: category,
                        question: this.formData.question.trim(),
                        answer: this.formData.answer.trim(),
                        updated: new Date().toISOString()
                    };

                    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ã‚’å…ˆã«ä¿å­˜ï¼ˆcloseModal()ã§editingFAQãŒã‚¯ãƒªã‚¢ã•ã‚Œã‚‹ãŸã‚ï¼‰
                    const isEditing = !!this.editingFAQ;
                    const editingId = this.editingFAQ?.id;

                    // ã™ãã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                    this.closeModal();

                    // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ä¿å­˜å‡¦ç†ã‚’å®Ÿè¡Œ
                    this.saving = true;

                    try {
                        if (isEditing) {
                            // ç·¨é›†ã®å ´åˆ
                            const index = this.faqs.findIndex(f => f.id === editingId);
                            if (index > -1) {
                                // IDã‚’ä¿æŒ
                                this.faqs[index] = {
                                    ...faqData,
                                    id: editingId
                                };
                                lifeXAPI.showToast('FAQã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
                            } else {
                                throw new Error('ç·¨é›†å¯¾è±¡ã®FAQãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                            }
                        } else {
                            // æ–°è¦è¿½åŠ ã®å ´åˆ
                            const newFAQ = {
                                ...faqData,
                                id: this.generateUniqueId(),
                                order: this.getNextOrder()
                            };
                            this.faqs.push(newFAQ);
                            lifeXAPI.showToast('FAQã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
                        }
                        
                        // APIã«ä¿å­˜
                        await this.saveToAPI();
                        
                        // UIæ›´æ–°
                        this.filterFAQs();
                        
                    } catch (error) {
                        console.error('FAQã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                        lifeXAPI.showToast(`FAQã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
                    } finally {
                        this.saving = false;
                    }
                },
                
                validateForm() {
                    // è³ªå•ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                    if (!this.formData.question || this.formData.question.trim().length === 0) {
                        return { isValid: false, message: 'è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„' };
                    }
                    if (this.formData.question.trim().length > 200) {
                        return { isValid: false, message: 'è³ªå•ã¯200æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„' };
                    }
                    
                    // å›ç­”ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                    if (!this.formData.answer || this.formData.answer.trim().length === 0) {
                        return { isValid: false, message: 'å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„' };
                    }
                    if (this.formData.answer.trim().length > 2000) {
                        return { isValid: false, message: 'å›ç­”ã¯2000æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„' };
                    }
                    
                    // ã‚«ãƒ†ã‚´ãƒªã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                    const category = this.getValidCategory();
                    if (!category) {
                        return { isValid: false, message: 'ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã¾ãŸã¯å…¥åŠ›ã—ã¦ãã ã•ã„' };
                    }
                    
                    return { isValid: true, message: '' };
                },
                
                getValidCategory() {
                    if (this.formData.category === 'new') {
                        return this.newCategory ? this.newCategory.trim() : '';
                    }
                    return this.formData.category;
                },
                
                async processCategory() {
                    if (this.formData.category === 'new' && this.newCategory) {
                        const trimmedCategory = this.newCategory.trim();
                        if (trimmedCategory.length === 0) {
                            return null;
                        }

                        // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                        if (this.categories.includes(trimmedCategory)) {
                            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                            this.newCategory = '';
                            return trimmedCategory;
                        }

                        try {
                            // Supabaseã«æ–°è¦ã‚«ãƒ†ã‚´ãƒªã‚’ä½œæˆ
                            if (window.supabase) {
                                // æ–°ã—ã„è¡¨ç¤ºé †ã‚’è¨ˆç®—
                                const maxOrder = this.categoryObjects.reduce((max, cat) =>
                                    Math.max(max, cat.display_order || 0), 0);

                                // ã‚«ãƒ†ã‚´ãƒªã‚’ä½œæˆ
                                const { data, error } = await window.supabase
                                    .from('faq_categories')
                                    .insert([{
                                        name: trimmedCategory,
                                        display_order: maxOrder + 1,
                                        created_at: new Date().toISOString(),
                                        updated_at: new Date().toISOString()
                                    }])
                                    .select();

                                if (error) {
                                    console.error('ã‚«ãƒ†ã‚´ãƒªä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                                    lifeXAPI.showToast('ã‚«ãƒ†ã‚´ãƒªã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                                    return null;
                                }

                                if (data && data.length > 0) {
                                    // ãƒ­ãƒ¼ã‚«ãƒ«ã®ã‚«ãƒ†ã‚´ãƒªãƒªã‚¹ãƒˆã«è¿½åŠ 
                                    const newCategory = data[0];
                                    this.categoryObjects.push(newCategory);
                                    this.categories.push(newCategory.name);

                                    // ã‚«ãƒ†ã‚´ãƒªãƒãƒƒãƒ—ã‚’æ›´æ–°
                                    this.categoryMap[newCategory.name] = newCategory.id;

                                    console.log('âœ… New category created:', newCategory);
                                }
                            }
                        } catch (error) {
                            console.error('ã‚«ãƒ†ã‚´ãƒªä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                            lifeXAPI.showToast('ã‚«ãƒ†ã‚´ãƒªã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                            return null;
                        }

                        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                        this.newCategory = '';
                        return trimmedCategory;
                    }

                    return this.formData.category;
                },
                
                generateUniqueId() {
                    // æ•°å­—ã¨ç¾åœ¨æ™‚åˆ»ã‚’çµ„ã¿åˆã‚ã›ãŸãƒ¦ãƒ‹ãƒ¼ã‚¯IDã‚’ç”Ÿæˆ
                    const timestamp = Date.now();
                    const random = Math.floor(Math.random() * 1000);
                    return `faq_${timestamp}_${random}`;
                },
                
                getNextOrder() {
                    // ç¾åœ¨ã®æœ€å¤§é †åº + 1ã‚’è¿”ã™
                    const maxOrder = this.faqs.reduce((max, faq) => Math.max(max, faq.order || 0), 0);
                    return maxOrder + 1;
                },

                getCategoryIdByName(categoryName) {
                    // ã‚«ãƒ†ã‚´ãƒªåã‹ã‚‰category_idã‚’å–å¾—
                    if (!categoryName) {
                        console.error('âŒ Category name is empty!');
                        throw new Error('ã‚«ãƒ†ã‚´ãƒªåãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    }

                    const categoryId = this.categoryMap[categoryName];
                    if (!categoryId) {
                        console.error(`âŒ Category "${categoryName}" not found in categoryMap:`, this.categoryMap);
                        throw new Error(`ã‚«ãƒ†ã‚´ãƒªã€Œ${categoryName}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                    }

                    return categoryId;
                },

                async deleteFAQ(faq) {
                    if (confirm(`ã€Œ${faq.question}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                        try {
                            // Supabaseã‹ã‚‰å‰Šé™¤
                            if (window.supabaseAPI && faq.id && typeof faq.id === 'string' && faq.id.includes('-')) {
                                const result = await window.supabaseAPI.faq.delete(faq.id);
                                if (!result.success) {
                                    throw new Error(result.error || 'Delete failed');
                                }
                            }

                            // ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
                            this.faqs = this.faqs.filter(f => f.id !== faq.id);
                            this.filterFAQs();
                            lifeXAPI.showToast('FAQã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');

                            // LocalStorageã‚‚æ›´æ–°
                            if (!window.supabaseAPI) {
                                this.saveToAPI();
                            }
                        } catch (error) {
                            console.error('FAQå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                            lifeXAPI.showToast('FAQã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                        }
                    }
                },

                closeModal() {
                    // ä¿å­˜ä¸­ã®å ´åˆã¯ã‚¯ãƒ­ãƒ¼ã‚ºã‚’é˜²ã
                    if (this.saving) {
                        return;
                    }
                    
                    this.showModal = false;
                    this.editingFAQ = null;
                    this.newCategory = '';
                    this.saving = false;
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                    this.formData = {
                        question: '',
                        answer: '',
                        category: '',
                        status: 'published',
                        order: 1
                    };
                },

                insertHTML(type) {
                    const textarea = document.querySelector('textarea[x-model="formData.answer"]');
                    const start = textarea.selectionStart;
                    const end = textarea.selectionEnd;
                    const text = this.formData.answer;
                    
                    let insertion = '';
                    switch(type) {
                        case 'bold':
                            insertion = '<strong>é¸æŠã—ãŸãƒ†ã‚­ã‚¹ãƒˆ</strong>';
                            break;
                        case 'list':
                            insertion = '<ul class="mt-2 ml-4 list-disc">\n  <li>é …ç›®1</li>\n  <li>é …ç›®2</li>\n</ul>';
                            break;
                        case 'br':
                            insertion = '<br>';
                            break;
                    }
                    
                    this.formData.answer = text.substring(0, start) + insertion + text.substring(end);
                    
                    // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’èª¿æ•´
                    this.$nextTick(() => {
                        textarea.focus();
                        textarea.setSelectionRange(start + insertion.length, start + insertion.length);
                    });
                },

                async saveToAPI() {
                    try {
                        // Supabase APIãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚‹ã¾ã§å¾…æ©Ÿ
                        let retries = 0;
                        while (!window.supabaseAPI && retries < 50) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                            retries++;
                        }

                        // Supabase or LocalStorage
                        if (window.supabaseAPI) {
                            // Supabaseã«ä¿å­˜
                            for (const faq of this.faqs) {
                                if (faq.id && typeof faq.id === 'string' && faq.id.includes('-')) {
                                    // UUIDã‚’æŒã¤æ—¢å­˜ã®FAQï¼ˆSupabaseã‹ã‚‰å–å¾—ã—ãŸã‚‚ã®ï¼‰â†’ æ›´æ–°
                                    const categoryId = this.getCategoryIdByName(faq.category);

                                    const result = await window.supabaseAPI.faq.update(faq.id, {
                                        question: faq.question,
                                        answer: faq.answer,
                                        category_id: categoryId,
                                        tags: faq.tags || [],
                                        status: faq.status || 'published',
                                        display_order: faq.order || 0
                                    });

                                    if (!result.success) {
                                        console.error('FAQæ›´æ–°å¤±æ•—:', result.error);
                                        throw new Error(result.error);
                                    }
                                } else {
                                    // æ–°è¦FAQ - Supabaseã«ä½œæˆ
                                    const categoryId = this.getCategoryIdByName(faq.category);

                                    const result = await window.supabaseAPI.faq.create({
                                        question: faq.question,
                                        answer: faq.answer,
                                        category_id: categoryId,
                                        tags: faq.tags || [],
                                        status: faq.status || 'published',
                                        display_order: faq.order || 0
                                    });

                                    if (result && result.success) {
                                        // ãƒ­ãƒ¼ã‚«ãƒ«ã®FAQã®IDã‚’Supabaseã®IDã«æ›´æ–°
                                        faq.id = result.data.id;
                                    } else {
                                        console.error('FAQä½œæˆå¤±æ•—:', result.error);
                                        throw new Error(result.error);
                                    }
                                }
                            }
                            console.log('âœ… FAQs saved to Supabase');
                        } else {
                            // LocalStorageã«ä¿å­˜ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                            localStorage.setItem('faq_data', JSON.stringify({ faqs: this.faqs }));
                            console.log('âš ï¸ Saved FAQs to localStorage (fallback)', this.faqs);
                        }

                        // çµ±è¨ˆæ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
                        window.dispatchEvent(new CustomEvent('stats-updated'));
                    } catch (error) {
                        console.error('âŒ FAQä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                        // Supabaseä¿å­˜å¤±æ•—æ™‚ã¯LocalStorageã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                        localStorage.setItem('faq_data', JSON.stringify({ faqs: this.faqs }));
                        console.log('âš ï¸ Saved to localStorage due to error');
                        throw error;
                    }
                },

                async saveFAQOrder() {
                    try {
                        if (window.supabaseAPI) {
                            // Supabaseã§é †åºã‚’æ›´æ–°
                            for (const faq of this.faqs) {
                                if (faq.id && typeof faq.id === 'string' && faq.id.includes('-')) {
                                    const result = await window.supabaseAPI.faq.update(faq.id, {
                                        display_order: faq.order || 0
                                    });

                                    if (!result.success) {
                                        console.error('FAQé †åºæ›´æ–°å¤±æ•—:', result.error);
                                    }
                                }
                            }
                            console.log('âœ… FAQ order updated in Supabase');
                        } else {
                            // LocalStorageã«ä¿å­˜ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                            localStorage.setItem('faq_data', JSON.stringify({ faqs: this.faqs }));
                            console.log('âš ï¸ Saved FAQ order to localStorage');
                        }

                        // çµ±è¨ˆæ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
                        window.dispatchEvent(new CustomEvent('stats-updated'));
                        lifeXAPI.showToast('è¡¨ç¤ºé †ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
                    } catch (error) {
                        console.error('FAQé †åºä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                        lifeXAPI.showToast('è¡¨ç¤ºé †ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    }
                },

                // ã‚«ãƒ†ã‚´ãƒªç®¡ç†é–¢æ•°
                openCategoryModal() {
                    this.showCategoryModal = true;
                    this.editingCategory = null;
                    this.newCategoryName = '';
                },

                closeCategoryModal() {
                    this.showCategoryModal = false;
                    this.editingCategory = null;
                    this.newCategoryName = '';
                    this.categoryFormData = {
                        name: '',
                        display_order: 0
                    };
                },

                editCategoryItem(category) {
                    this.editingCategory = category;
                    this.categoryFormData = {
                        name: category.name,
                        display_order: category.display_order || 0
                    };
                },

                async saveCategoryEdit() {
                    if (!this.editingCategory) return;

                    const trimmedName = this.categoryFormData.name.trim();
                    if (!trimmedName) {
                        lifeXAPI.showToast('ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                        return;
                    }

                    try {
                        // window.supabaseãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚‹ã¾ã§å¾…æ©Ÿ
                        let retries = 0;
                        while (!window.supabase && retries < 50) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                            retries++;
                        }

                        if (window.supabase) {
                            // ç›´æ¥Supabaseã‚’ä½¿ç”¨ã—ã¦ã‚«ãƒ†ã‚´ãƒªã‚’æ›´æ–°
                            const { data, error } = await window.supabase
                                .from('faq_categories')
                                .update({
                                    name: trimmedName,
                                    display_order: this.categoryFormData.display_order,
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', this.editingCategory.id)
                                .select();

                            if (error) {
                                console.error('ã‚«ãƒ†ã‚´ãƒªæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                                lifeXAPI.showToast('ã‚«ãƒ†ã‚´ãƒªã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                                return;
                            }

                            // ãƒ­ãƒ¼ã‚«ãƒ«ã®ã‚«ãƒ†ã‚´ãƒªãƒªã‚¹ãƒˆã‚’æ›´æ–°
                            const index = this.categoryObjects.findIndex(c => c.id === this.editingCategory.id);
                            if (index > -1) {
                                this.categoryObjects[index].name = trimmedName;
                                this.categoryObjects[index].display_order = this.categoryFormData.display_order;
                            }

                            // ã‚«ãƒ†ã‚´ãƒªåãƒªã‚¹ãƒˆã‚’æ›´æ–°
                            this.categories = this.categoryObjects.map(c => c.name);

                            // ã‚«ãƒ†ã‚´ãƒªãƒãƒƒãƒ—ã‚’å†æ§‹ç¯‰
                            this.categoryMap = {};
                            this.categoryObjects.forEach(cat => {
                                this.categoryMap[cat.name] = cat.id;
                            });

                            lifeXAPI.showToast('ã‚«ãƒ†ã‚´ãƒªã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
                            this.editingCategory = null;
                        } else {
                            throw new Error('Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                        }
                    } catch (error) {
                        console.error('ã‚«ãƒ†ã‚´ãƒªæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                        lifeXAPI.showToast('ã‚«ãƒ†ã‚´ãƒªã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    }
                },

                cancelCategoryEdit() {
                    this.editingCategory = null;
                    this.categoryFormData = {
                        name: '',
                        display_order: 0
                    };
                },

                async deleteCategoryItem(category) {
                    // ã“ã®ã‚«ãƒ†ã‚´ãƒªã«å±ã™ã‚‹FAQãŒã‚ã‚‹ã‹ç¢ºèª
                    const faqsInCategory = this.faqs.filter(faq => faq.category === category.name);
                    if (faqsInCategory.length > 0) {
                        lifeXAPI.showToast('ã“ã®ã‚«ãƒ†ã‚´ãƒªã«ã¯FAQãŒå­˜åœ¨ã™ã‚‹ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“', 'error');
                        return;
                    }

                    if (!confirm(`ã‚«ãƒ†ã‚´ãƒªã€Œ${category.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                        return;
                    }

                    try {
                        // window.supabaseãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚‹ã¾ã§å¾…æ©Ÿ
                        let retries = 0;
                        while (!window.supabase && retries < 50) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                            retries++;
                        }

                        if (window.supabase) {
                            // ç›´æ¥Supabaseã‚’ä½¿ç”¨ã—ã¦ã‚«ãƒ†ã‚´ãƒªã‚’å‰Šé™¤
                            const { error } = await window.supabase
                                .from('faq_categories')
                                .delete()
                                .eq('id', category.id);

                            if (error) {
                                console.error('ã‚«ãƒ†ã‚´ãƒªå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                                lifeXAPI.showToast('ã‚«ãƒ†ã‚´ãƒªã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                                return;
                            }

                            // ãƒ­ãƒ¼ã‚«ãƒ«ã®ã‚«ãƒ†ã‚´ãƒªãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
                            this.categoryObjects = this.categoryObjects.filter(c => c.id !== category.id);
                            this.categories = this.categoryObjects.map(c => c.name);

                            // ã‚«ãƒ†ã‚´ãƒªãƒãƒƒãƒ—ã‚’å†æ§‹ç¯‰
                            this.categoryMap = {};
                            this.categoryObjects.forEach(cat => {
                                this.categoryMap[cat.name] = cat.id;
                            });

                            lifeXAPI.showToast('ã‚«ãƒ†ã‚´ãƒªã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
                        } else {
                            throw new Error('Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                        }
                    } catch (error) {
                        console.error('ã‚«ãƒ†ã‚´ãƒªå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                        lifeXAPI.showToast('ã‚«ãƒ†ã‚´ãƒªã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    }
                },

                async addNewCategory() {
                    const trimmedName = this.newCategoryName.trim();
                    if (!trimmedName) {
                        lifeXAPI.showToast('ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                        return;
                    }

                    // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                    if (this.categories.includes(trimmedName)) {
                        lifeXAPI.showToast('ã“ã®ã‚«ãƒ†ã‚´ãƒªåã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™', 'error');
                        return;
                    }

                    try {
                        // window.supabaseãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚‹ã¾ã§å¾…æ©Ÿ
                        let retries = 0;
                        while (!window.supabase && retries < 50) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                            retries++;
                        }

                        if (window.supabase) {
                            // æ–°ã—ã„è¡¨ç¤ºé †ã‚’è¨ˆç®—
                            const maxOrder = this.categoryObjects.reduce((max, cat) =>
                                Math.max(max, cat.display_order || 0), 0);

                            // ç›´æ¥Supabaseã‚’ä½¿ç”¨ã—ã¦ã‚«ãƒ†ã‚´ãƒªã‚’ä½œæˆ
                            const { data, error } = await window.supabase
                                .from('faq_categories')
                                .insert([{
                                    name: trimmedName,
                                    display_order: maxOrder + 1,
                                    created_at: new Date().toISOString(),
                                    updated_at: new Date().toISOString()
                                }])
                                .select();

                            if (error) {
                                console.error('ã‚«ãƒ†ã‚´ãƒªä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                                lifeXAPI.showToast('ã‚«ãƒ†ã‚´ãƒªã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                                return;
                            }

                            if (data && data.length > 0) {
                                // ãƒ­ãƒ¼ã‚«ãƒ«ã®ã‚«ãƒ†ã‚´ãƒªãƒªã‚¹ãƒˆã«è¿½åŠ 
                                const newCategory = data[0];
                                this.categoryObjects.push(newCategory);
                                this.categories.push(newCategory.name);

                                // ã‚«ãƒ†ã‚´ãƒªãƒãƒƒãƒ—ã‚’æ›´æ–°
                                this.categoryMap[newCategory.name] = newCategory.id;

                                // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
                                this.newCategoryName = '';

                                lifeXAPI.showToast('ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
                            }
                        } else {
                            throw new Error('Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                        }
                    } catch (error) {
                        console.error('ã‚«ãƒ†ã‚´ãƒªä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                        lifeXAPI.showToast('ã‚«ãƒ†ã‚´ãƒªã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    }
                }
            }));
        });
    </script>
</body>
</html>