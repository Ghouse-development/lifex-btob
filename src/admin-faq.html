<!DOCTYPE html>
<html lang="ja" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAQ管理 | LIFE X 管理画面</title>
    <!-- Tailwind CSS (Production Build) -->
    <link rel="stylesheet" href="/assets/tailwind.css">

    <link href="./styles/main.css" rel="stylesheet">

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script src="/js/common.js?v=20251024"></script>

    <!-- Supabase Auth Guard -->
    <script type="module" src="/js/auth-guard.js?v=20251024"></script>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <!-- Supabase Integration - CDN待機後にロード -->
    <script type="module">
        // CDNの読み込みを待ってからインポート
        await new Promise(resolve => {
            if (window.supabase?.createClient) {
                resolve();
            } else {
                const checkInterval = setInterval(() => {
                    if (window.supabase?.createClient) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 50);
            }
        });

        // Supabaseクライアントをsupabase-client.jsからインポート
        import { supabase } from '/js/supabase-client.js?v=20251024b';
        window.supabase = supabase;

        // Supabase Integrationも待機後にロード
        await import('/js/supabase-integration.js?v=20251024b');
    </script>

    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="h-full bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="/" class="text-xl font-bold text-gray-900 hover:text-gray-700">LIFE X</a>
                    <span class="ml-2 px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">管理者専用</span>
                </div>
                <nav class="hidden md:flex space-x-8 items-center">
                    <a href="/admin.html" class="nav-link">管理ホーム</a>
                    <a href="/admin-plans.html" class="nav-link">プラン管理</a>
                    <a href="/admin-rules.html" class="nav-link">ルール管理</a>
                    <a href="/admin-downloads.html" class="nav-link">ダウンロード管理</a>
                    <a href="/admin-faq.html" class="nav-link active">FAQ管理</a>
                    <a href="/admin-notifications.html" class="nav-link">お知らせ管理</a>
                    <a href="/admin-users.html" class="nav-link">ユーザー管理</a>
                    <a href="/admin-profile.html" class="nav-link">プロフィール</a>
                    <a href="/admin-system.html" class="nav-link">システム管理</a>
                    <a href="/admin-report.html" class="nav-link">レポート</a>
                    <a href="/" class="nav-link">サイトに戻る</a>
                    <button onclick="logout()" type="button" class="nav-link text-red-600 hover:text-red-800">ログアウト</button>
                </nav>

                <!-- Mobile Menu -->
                <div class="md:hidden" x-data="{ mobileMenuOpen: false }">
                    <button @click="mobileMenuOpen = !mobileMenuOpen" type="button" class="text-gray-500 hover:text-gray-600">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>

                    <div x-show="mobileMenuOpen" class="absolute top-16 right-4 bg-white shadow-lg rounded-lg border border-gray-200 p-4 z-50 min-w-48" style="display: none;">
                        <a href="/admin.html" class="block py-2 text-sm text-gray-600">管理ホーム</a>
                        <a href="/admin-plans.html" class="block py-2 text-sm text-gray-600">プラン管理</a>
                        <a href="/admin-rules.html" class="block py-2 text-sm text-gray-600">ルール管理</a>
                        <a href="/admin-downloads.html" class="block py-2 text-sm text-gray-600">ダウンロード管理</a>
                        <a href="/admin-faq.html" class="block py-2 text-sm text-gray-900 font-medium">FAQ管理</a>
                        <a href="/admin-notifications.html" class="block py-2 text-sm text-gray-600">お知らせ管理</a>
                        <a href="/admin-users.html" class="block py-2 text-sm text-gray-600">ユーザー管理</a>
                        <a href="/admin-profile.html" class="block py-2 text-sm text-gray-600">プロフィール</a>
                        <a href="/admin-system.html" class="block py-2 text-sm text-gray-600">システム管理</a>
                        <a href="/admin-report.html" class="block py-2 text-sm text-gray-600">レポート</a>
                        <div class="border-t border-gray-200 mt-3 pt-3">
                            <a href="/" class="block py-2 text-sm text-gray-600">サイトに戻る</a>
                            <button onclick="logout()" type="button" class="block py-2 text-sm text-red-600 hover:text-red-800 text-left w-full">ログアウト</button>
                        </div>
                    </div>
                </div>

                <div id="userInfo" class="hidden md:block text-sm"></div>
            </div>
        </div>
    </header>

    <div x-data="adminFAQ()" x-init="init()">
        <!-- Page Header -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">FAQ管理</h1>
                    <p class="text-gray-600 mt-2">FAQの追加・編集・削除・並び替えを管理</p>
                </div>
                <div class="flex space-x-3">
                    <button type="button" @click="openCategoryModal()" class="btn-secondary">
                        <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                        </svg>
                        カテゴリ管理
                    </button>
                    <button type="button" @click="openAddModal()" class="btn-primary">
                        <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        新規FAQ追加
                    </button>
                </div>
            </div>

            <!-- カテゴリ別タブ -->
            <div class="card mb-6">
                <div class="flex space-x-1 border-b border-gray-200">
                    <button
                        @click="activeCategory = 'all'"
                        :class="activeCategory === 'all' ? 'border-b-2 border-primary-500 text-primary-600' : 'text-gray-600 hover:text-gray-900'"
                        class="px-4 py-2 font-medium transition-colors">
                        すべて
                    </button>
                    <template x-for="(category, index) in categories" :key="index">
                        <button
                            @click="activeCategory = category"
                            :class="activeCategory === category ? 'border-b-2 border-primary-500 text-primary-600' : 'text-gray-600 hover:text-gray-900'"
                            class="px-4 py-2 font-medium transition-colors"
                            x-text="category">
                        </button>
                    </template>
                </div>
            </div>

            <!-- FAQ リスト -->
            <div class="space-y-4" id="faqList">
                <template x-for="faq in filteredFAQs" :key="faq.id">
                    <div class="card hover:shadow-lg transition-shadow" :data-id="faq.id">
                        <div class="flex items-start">
                            <!-- ドラッグハンドル -->
                            <div class="handle cursor-move mr-4 mt-1">
                                <svg class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                                </svg>
                            </div>
                            
                            <!-- FAQ内容 -->
                            <div class="flex-1">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-3 mb-2">
                                            <span x-text="faq.category" class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded"></span>
                                            <span x-text="`表示順: ${faq.order}`" class="text-xs text-gray-500"></span>
                                            <span x-show="faq.status === 'active'" class="text-xs px-2 py-1 bg-green-100 text-green-800 rounded">公開中</span>
                                            <span x-show="faq.status === 'draft'" class="text-xs px-2 py-1 bg-gray-100 text-gray-800 rounded">下書き</span>
                                        </div>
                                        <h3 class="text-lg font-medium text-gray-900 mb-2" x-text="faq.question"></h3>
                                        <div class="text-sm text-gray-600" x-html="faq.answer.substring(0, 150) + (faq.answer.length > 150 ? '...' : '')"></div>
                                    </div>
                                    
                                    <!-- 操作ボタン -->
                                    <div class="flex items-center space-x-2 ml-4">
                                        <button type="button" @click="editFAQ(faq)" class="text-blue-600 hover:text-blue-900">
                                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                            </svg>
                                        </button>
                                        <button type="button" @click="deleteFAQ(faq)" class="text-red-600 hover:text-red-900">
                                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Add/Edit Modal -->
        <div x-show="showModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
            <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-3xl shadow-lg rounded-md bg-white mb-10">
                <div class="mt-3">
                    <h3 class="text-lg font-medium text-gray-900 mb-4" x-text="editingFAQ ? 'FAQ編集' : '新規FAQ追加'"></h3>

                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">カテゴリ <span class="text-red-500">*</span></label>
                                <select x-model="formData.category" class="form-input w-full" required>
                                    <option value="">選択してください</option>
                                    <template x-for="(category, index) in categories" :key="index">
                                        <option :value="category" x-text="category"></option>
                                    </template>
                                    <option value="new">新規カテゴリを追加...</option>
                                </select>
                                <input
                                    x-show="formData.category === 'new'"
                                    x-model="newCategory"
                                    type="text"
                                    placeholder="新しいカテゴリ名"
                                    class="form-input w-full mt-2"
                                    required>
                                <p class="text-xs text-gray-500 mt-1">カテゴリを必ず選択してください</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ステータス</label>
                                <select x-model="formData.status" class="form-input w-full">
                                    <option value="published">公開中</option>
                                    <option value="draft">下書き</option>
                                    <option value="archived">アーカイブ</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">質問</label>
                            <input type="text" x-model="formData.question" class="form-input w-full" placeholder="よくある質問を入力">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">回答</label>
                            <div class="mb-2">
                                <button type="button" @click="insertHTML('bold')" class="text-sm px-2 py-1 bg-gray-100 rounded mr-1">太字</button>
                                <button type="button" @click="insertHTML('list')" class="text-sm px-2 py-1 bg-gray-100 rounded mr-1">リスト</button>
                                <button type="button" @click="insertHTML('br')" class="text-sm px-2 py-1 bg-gray-100 rounded">改行</button>
                            </div>
                            <textarea
                                x-model="formData.answer"
                                rows="8"
                                class="form-input w-full"
                                placeholder="回答を入力（HTML可）">
                            </textarea>
                            <p class="text-xs text-gray-500 mt-1">※ HTMLタグが使用可能です（&lt;br&gt;, &lt;ul&gt;, &lt;li&gt;, &lt;strong&gt; など）</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">プレビュー</label>
                            <div class="p-4 bg-gray-50 rounded border border-gray-200 min-h-[100px]" x-html="formData.answer || '（回答のプレビューがここに表示されます）'"></div>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" @click="closeModal()" class="btn-secondary" :disabled="saving">キャンセル</button>
                        <button type="button" @click="saveFAQ()"
                                :disabled="saving || !canSave"
                                :class="saving || !canSave ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'btn-primary'"
                                class="px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                            <span x-show="!saving">保存</span>
                            <span x-show="saving" class="flex items-center">
                                <svg class="animate-spin -ml-1 mr-3 h-4 w-4 text-current" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                保存中...
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Category Management Modal -->
        <div x-show="showCategoryModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
            <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white mb-10">
                <div class="mt-3">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">FAQカテゴリ管理</h3>

                    <!-- カテゴリリスト -->
                    <div class="space-y-2 mb-4">
                        <template x-for="(category, index) in categoryObjects" :key="category.id">
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded border border-gray-200">
                                <div class="flex-1">
                                    <div x-show="editingCategory && editingCategory.id === category.id">
                                        <input
                                            type="text"
                                            x-model="categoryFormData.name"
                                            class="form-input w-full"
                                            placeholder="カテゴリ名">
                                    </div>
                                    <div x-show="!editingCategory || editingCategory.id !== category.id">
                                        <span class="font-medium" x-text="category.name"></span>
                                        <span class="text-xs text-gray-500 ml-2" x-text="`表示順: ${category.display_order || index + 1}`"></span>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2 ml-4">
                                    <template x-if="editingCategory && editingCategory.id === category.id">
                                        <div class="flex space-x-2">
                                            <button type="button" @click="saveCategoryEdit()" class="text-green-600 hover:text-green-900 text-sm">
                                                保存
                                            </button>
                                            <button type="button" @click="cancelCategoryEdit()" class="text-gray-600 hover:text-gray-900 text-sm">
                                                キャンセル
                                            </button>
                                        </div>
                                    </template>
                                    <template x-if="!editingCategory || editingCategory.id !== category.id">
                                        <div class="flex space-x-2">
                                            <button type="button" @click="editCategoryItem(category)" class="text-blue-600 hover:text-blue-900">
                                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                </svg>
                                            </button>
                                            <button type="button" @click="deleteCategoryItem(category)" class="text-red-600 hover:text-red-900">
                                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                </svg>
                                            </button>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- 新規カテゴリ追加フォーム -->
                    <div class="p-4 bg-blue-50 rounded border border-blue-200">
                        <h4 class="text-sm font-medium text-gray-900 mb-2">新規カテゴリ追加</h4>
                        <div class="flex space-x-2">
                            <input
                                type="text"
                                x-model="newCategoryName"
                                @keyup.enter="addNewCategory()"
                                class="form-input flex-1"
                                placeholder="カテゴリ名を入力">
                            <button type="button" @click="addNewCategory()" class="btn-primary">
                                追加
                            </button>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end">
                        <button type="button" @click="closeCategoryModal()" class="btn-secondary">閉じる</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 簡易的なlifeXAPI実装（common.jsが読み込めない場合のフォールバック）
        if (!window.lifeXAPI) {
            window.lifeXAPI = {
                showToast(message, type) {
                    console.log(`[${type}] ${message}`);
                    // 簡易的なトースト表示
                    const toast = document.createElement('div');
                    toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 ${
                        type === 'error' ? 'bg-red-500' :
                        type === 'success' ? 'bg-green-500' :
                        'bg-blue-500'
                    }`;
                    toast.textContent = message;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                }
            };
        }

        // 簡易的な認証マネージャー
        window.authManager = {
            isAuthenticated() {
                // 簡易チェック - 本番環境では適切な認証を実装
                return true;
            },
            requireAuth() {
                if (!this.isAuthenticated()) {
                    window.location.href = '/admin-login.html';
                    return false;
                }
                return true;
            }
        };

        function adminFAQ() {
            return {
                faqs: [],
                filteredFAQs: [],
                categories: [],
                categoryMap: {},
                categoryObjects: [],
                activeCategory: 'all',
                showModal: false,
                showCategoryModal: false,
                editingFAQ: null,
                editingCategory: null,
                newCategory: '',
                newCategoryName: '',
                saving: false,
                formData: {
                    question: '',
                    answer: '',
                    category: '',
                    status: 'published',
                    order: 1
                },
                categoryFormData: {
                    name: '',
                    display_order: 0
                },

                get canSave() {
                    const hasQuestion = this.formData.question.trim().length > 0;
                    const hasAnswer = this.formData.answer.trim().length > 0;
                    const hasValidCategory = this.getValidCategory().length > 0;
                    return hasQuestion && hasAnswer && hasValidCategory;
                },
                sortable: null,

                async init() {
                    // カテゴリデータの読み込み
                    await this.loadCategories();
                    // FAQデータの読み込み
                    await this.loadFAQs();
                    this.filterFAQs();

                    // ドラッグ&ドロップの初期化
                    this.$nextTick(() => {
                        this.initSortable();
                    });
                },

                async loadCategories() {
                    try {
                        // Supabase APIが利用可能になるまで待機
                        let retries = 0;
                        while (!window.supabaseAPI && retries < 50) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                            retries++;
                        }

                        if (window.supabaseAPI) {
                            const categories = await window.supabaseAPI.faq.getCategories();
                            if (categories && categories.length > 0) {
                                this.categoryObjects = categories;
                                this.categories = categories.map(c => c.name);

                                // Build category map: name -> id
                                this.categoryMap = {};
                                categories.forEach(cat => {
                                    this.categoryMap[cat.name] = cat.id;
                                });

                                console.log('✅ FAQ categories loaded:', this.categories);
                                console.log('   Category map:', this.categoryMap);
                            } else {
                                console.warn('⚠️ No FAQ categories found in database');
                            }
                        } else {
                            console.error('❌ window.supabaseAPI is not available after waiting');
                        }
                    } catch (error) {
                        console.error('❌ Error loading FAQ categories:', error);
                    }
                },

                async loadFAQs() {
                    try {
                        // Supabase APIが利用可能になるまで待機
                        let retries = 0;
                        while (!window.supabaseAPI && retries < 10) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                            retries++;
                        }

                        // Supabase or LocalStorage
                        if (window.supabaseAPI && window.supabase) {
                            console.log('Loading FAQs from Supabase...');
                            this.faqs = await window.supabaseAPI.faq.getItems();
                            const categories = await window.supabaseAPI.faq.getCategories();

                            // カテゴリ名のリストを更新
                            if (categories && categories.length > 0) {
                                this.categories = categories.map(cat => cat.name);
                            }

                            // faq_categoriesとの関連付けを処理
                            if (this.faqs && this.faqs.length > 0) {
                                this.faqs = this.faqs.map(faq => {
                                    // カテゴリIDから名前を取得
                                    const category = categories.find(cat => cat.id === faq.category_id);
                                    return {
                                        ...faq,
                                        category: category ? category.name : faq.category || 'その他',
                                        order: faq.display_order || faq.order || 0
                                    };
                                });
                            }

                            // テストデータを完全に除外（2度と表示させない）
                            this.faqs = this.faqs.filter(faq => {
                                const question = (faq.question || '').toLowerCase();
                                const answer = (faq.answer || '').toLowerCase();
                                const isTestData =
                                    question.includes('てすと') ||
                                    question.includes('テスト') ||
                                    question.includes('test') ||
                                    answer.includes('てすと') ||
                                    answer.includes('テスト') ||
                                    answer.includes('test');

                                if (isTestData) {
                                    console.warn('⚠️ Test data filtered out:', faq.question);
                                }
                                return !isTestData;
                            });

                            console.log('Loaded FAQs from Supabase:', this.faqs.length);

                            // Supabaseから正常にロードできた場合、localStorageをクリア（古いキャッシュを削除）
                            localStorage.removeItem('faq_data');
                        } else {
                            // LocalStorageから取得を試みる
                            const localData = localStorage.getItem('faq_data');
                            if (localData) {
                                this.faqs = JSON.parse(localData).faqs || [];

                                // LocalStorageからロードした場合もテストデータを除外
                                this.faqs = this.faqs.filter(faq => {
                                    const question = (faq.question || '').toLowerCase();
                                    const answer = (faq.answer || '').toLowerCase();
                                    return !question.includes('てすと') &&
                                           !question.includes('テスト') &&
                                           !question.includes('test') &&
                                           !answer.includes('てすと') &&
                                           !answer.includes('テスト') &&
                                           !answer.includes('test');
                                });
                            } else {
                                this.faqs = [];
                            }
                        }
                    } catch (error) {
                        console.error('Error loading FAQs:', error);
                        lifeXAPI.showToast('FAQデータの読み込みに失敗しました', 'error');
                        this.faqs = [];
                    }
                },

                initSortable() {
                    const list = document.getElementById('faqList');
                    if (list) {
                        this.sortable = new Sortable(list, {
                            handle: '.handle',
                            animation: 150,
                            onEnd: (evt) => {
                                this.reorderFAQs(evt.oldIndex, evt.newIndex);
                            }
                        });
                    }
                },

                filterFAQs() {
                    if (this.activeCategory === 'all') {
                        this.filteredFAQs = [...this.faqs];
                    } else {
                        this.filteredFAQs = this.faqs.filter(faq => faq.category === this.activeCategory);
                    }

                    // 表示順でソート（display_orderも考慮）
                    this.filteredFAQs.sort((a, b) => {
                        const orderA = a.display_order || a.order || 0;
                        const orderB = b.display_order || b.order || 0;
                        return orderA - orderB;
                    });
                },

                reorderFAQs(oldIndex, newIndex) {
                    if (oldIndex === newIndex) return;
                    
                    const moved = this.filteredFAQs.splice(oldIndex, 1)[0];
                    this.filteredFAQs.splice(newIndex, 0, moved);
                    
                    // 順番を更新
                    this.filteredFAQs.forEach((faq, index) => {
                        faq.order = index + 1;
                        const originalIndex = this.faqs.findIndex(f => f.id === faq.id);
                        if (originalIndex > -1) {
                            this.faqs[originalIndex].order = faq.order;
                        }
                    });
                    
                    this.saveFAQOrder();
                },

                openAddModal() {
                    this.editingFAQ = null;
                    this.formData = {
                        question: '',
                        answer: '',
                        category: '',
                        status: 'published',
                        order: this.faqs.length + 1
                    };
                    this.showModal = true;
                },

                editFAQ(faq) {
                    this.editingFAQ = faq;
                    this.formData = { ...faq };
                    this.showModal = true;
                },

                async saveFAQ() {
                    // 保存中の場合は重複実行を防ぐ
                    if (this.saving) {
                        return;
                    }

                    // カテゴリデータの確認
                    if (!this.categoryMap || Object.keys(this.categoryMap).length === 0) {
                        lifeXAPI.showToast('カテゴリデータが読み込まれていません。ページを再読み込みしてください。', 'error');
                        // カテゴリを再読み込み
                        await this.loadCategories();
                        if (!this.categoryMap || Object.keys(this.categoryMap).length === 0) {
                            return;
                        }
                    }

                    // フォームバリデーション
                    const validationResult = this.validateForm();
                    if (!validationResult.isValid) {
                        lifeXAPI.showToast(validationResult.message, 'error');
                        return;
                    }

                    // 新規カテゴリの処理
                    const category = await this.processCategory();
                    if (!category) {
                        lifeXAPI.showToast('有効なカテゴリを入力してください', 'error');
                        return;
                    }

                    // カテゴリの存在確認
                    if (!this.categoryMap[category]) {
                        lifeXAPI.showToast(`カテゴリ「${category}」が見つかりません。カテゴリを追加してから再度お試しください。`, 'error');
                        return;
                    }
                    
                    // FAQデータの処理
                    const faqData = {
                        ...this.formData,
                        category: category,
                        question: this.formData.question.trim(),
                        answer: this.formData.answer.trim(),
                        updated: new Date().toISOString()
                    };

                    // 編集モードかどうかを先に保存（closeModal()でeditingFAQがクリアされるため）
                    const isEditing = !!this.editingFAQ;
                    const editingId = this.editingFAQ?.id;

                    // すぐにモーダルを閉じる
                    this.closeModal();

                    // バックグラウンドで保存処理を実行
                    this.saving = true;

                    try {
                        if (isEditing) {
                            // 編集の場合
                            const index = this.faqs.findIndex(f => f.id === editingId);
                            if (index > -1) {
                                // IDを保持
                                this.faqs[index] = {
                                    ...faqData,
                                    id: editingId
                                };
                                lifeXAPI.showToast('FAQを更新しました', 'success');
                            } else {
                                throw new Error('編集対象のFAQが見つかりません');
                            }
                        } else {
                            // 新規追加の場合
                            const newFAQ = {
                                ...faqData,
                                id: this.generateUniqueId(),
                                order: this.getNextOrder()
                            };
                            this.faqs.push(newFAQ);
                            lifeXAPI.showToast('FAQを追加しました', 'success');
                        }
                        
                        // APIに保存
                        await this.saveToAPI();
                        
                        // UI更新
                        this.filterFAQs();
                        
                    } catch (error) {
                        console.error('FAQの保存に失敗しました:', error);
                        lifeXAPI.showToast(`FAQの保存に失敗しました: ${error.message}`, 'error');
                    } finally {
                        this.saving = false;
                    }
                },
                
                validateForm() {
                    // 質問のバリデーション
                    if (!this.formData.question || this.formData.question.trim().length === 0) {
                        return { isValid: false, message: '質問を入力してください' };
                    }
                    if (this.formData.question.trim().length > 200) {
                        return { isValid: false, message: '質問は200文字以内で入力してください' };
                    }
                    
                    // 回答のバリデーション
                    if (!this.formData.answer || this.formData.answer.trim().length === 0) {
                        return { isValid: false, message: '回答を入力してください' };
                    }
                    if (this.formData.answer.trim().length > 2000) {
                        return { isValid: false, message: '回答は2000文字以内で入力してください' };
                    }
                    
                    // カテゴリのバリデーション
                    const category = this.getValidCategory();
                    if (!category) {
                        return { isValid: false, message: 'カテゴリを選択または入力してください' };
                    }
                    
                    return { isValid: true, message: '' };
                },
                
                getValidCategory() {
                    if (this.formData.category === 'new') {
                        return this.newCategory ? this.newCategory.trim() : '';
                    }
                    return this.formData.category;
                },
                
                async processCategory() {
                    if (this.formData.category === 'new' && this.newCategory) {
                        const trimmedCategory = this.newCategory.trim();
                        if (trimmedCategory.length === 0) {
                            return null;
                        }

                        // 重複チェック
                        if (this.categories.includes(trimmedCategory)) {
                            // フォームをリセット
                            this.newCategory = '';
                            return trimmedCategory;
                        }

                        try {
                            // Supabaseに新規カテゴリを作成
                            if (window.supabase && window.supabase.from) {
                                // 新しい表示順を計算
                                const maxOrder = this.categoryObjects.reduce((max, cat) =>
                                    Math.max(max, cat.display_order || 0), 0);

                                // カテゴリを作成
                                const { data, error } = await window.supabase
                                    .from('faq_categories')
                                    .insert([{
                                        name: trimmedCategory,
                                        display_order: maxOrder + 1,
                                        created_at: new Date().toISOString(),
                                        updated_at: new Date().toISOString()
                                    }])
                                    .select();

                                if (error) {
                                    console.error('カテゴリ作成エラー:', error);
                                    lifeXAPI.showToast('カテゴリの作成に失敗しました', 'error');
                                    return null;
                                }

                                if (data && data.length > 0) {
                                    // ローカルのカテゴリリストに追加
                                    const newCategory = data[0];
                                    this.categoryObjects.push(newCategory);
                                    this.categories.push(newCategory.name);

                                    // カテゴリマップを更新
                                    this.categoryMap[newCategory.name] = newCategory.id;

                                    console.log('✅ New category created:', newCategory);
                                }
                            }
                        } catch (error) {
                            console.error('カテゴリ作成エラー:', error);
                            lifeXAPI.showToast('カテゴリの作成に失敗しました', 'error');
                            return null;
                        }

                        // フォームをリセット
                        this.newCategory = '';
                        return trimmedCategory;
                    }

                    return this.formData.category;
                },
                
                generateUniqueId() {
                    // 数字と現在時刻を組み合わせたユニークIDを生成
                    const timestamp = Date.now();
                    const random = Math.floor(Math.random() * 1000);
                    return `faq_${timestamp}_${random}`;
                },
                
                getNextOrder() {
                    // 現在の最大順序 + 1を返す
                    const maxOrder = this.faqs.reduce((max, faq) => Math.max(max, faq.order || 0), 0);
                    return maxOrder + 1;
                },

                getCategoryIdByName(categoryName) {
                    // カテゴリ名からcategory_idを取得
                    if (!categoryName) {
                        console.error('❌ Category name is empty!');
                        throw new Error('カテゴリ名が指定されていません');
                    }

                    const categoryId = this.categoryMap[categoryName];
                    if (!categoryId) {
                        console.error(`❌ Category "${categoryName}" not found in categoryMap:`, this.categoryMap);
                        throw new Error(`カテゴリ「${categoryName}」が見つかりません`);
                    }

                    return categoryId;
                },

                async deleteFAQ(faq) {
                    if (confirm(`「${faq.question}」を削除しますか？`)) {
                        try {
                            // Supabaseから削除
                            if (window.supabaseAPI && faq.id && typeof faq.id === 'string' && faq.id.includes('-')) {
                                const result = await window.supabaseAPI.faq.delete(faq.id);
                                if (!result.success) {
                                    throw new Error(result.error || 'Delete failed');
                                }
                            }

                            // ローカルのリストから削除
                            this.faqs = this.faqs.filter(f => f.id !== faq.id);
                            this.filterFAQs();
                            lifeXAPI.showToast('FAQを削除しました', 'success');

                            // LocalStorageも更新
                            if (!window.supabaseAPI) {
                                this.saveToAPI();
                            }
                        } catch (error) {
                            console.error('FAQ削除エラー:', error);
                            lifeXAPI.showToast('FAQの削除に失敗しました', 'error');
                        }
                    }
                },

                closeModal() {
                    // 保存中の場合はクローズを防ぐ
                    if (this.saving) {
                        return;
                    }
                    
                    this.showModal = false;
                    this.editingFAQ = null;
                    this.newCategory = '';
                    this.saving = false;
                    
                    // フォームをリセット
                    this.formData = {
                        question: '',
                        answer: '',
                        category: '',
                        status: 'published',
                        order: 1
                    };
                },

                insertHTML(type) {
                    const textarea = document.querySelector('textarea[x-model="formData.answer"]');
                    const start = textarea.selectionStart;
                    const end = textarea.selectionEnd;
                    const text = this.formData.answer;
                    
                    let insertion = '';
                    switch(type) {
                        case 'bold':
                            insertion = '<strong>選択したテキスト</strong>';
                            break;
                        case 'list':
                            insertion = '<ul class="mt-2 ml-4 list-disc">\n  <li>項目1</li>\n  <li>項目2</li>\n</ul>';
                            break;
                        case 'br':
                            insertion = '<br>';
                            break;
                    }
                    
                    this.formData.answer = text.substring(0, start) + insertion + text.substring(end);
                    
                    // カーソル位置を調整
                    this.$nextTick(() => {
                        textarea.focus();
                        textarea.setSelectionRange(start + insertion.length, start + insertion.length);
                    });
                },

                async saveToAPI() {
                    try {
                        // Supabase APIが利用可能になるまで待機
                        let retries = 0;
                        while (!window.supabaseAPI && retries < 50) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                            retries++;
                        }

                        // Supabase or LocalStorage
                        if (window.supabaseAPI) {
                            // Supabaseに保存
                            for (const faq of this.faqs) {
                                if (faq.id && typeof faq.id === 'string' && faq.id.includes('-')) {
                                    // UUIDを持つ既存のFAQ（Supabaseから取得したもの）→ 更新
                                    const categoryId = this.getCategoryIdByName(faq.category);

                                    const result = await window.supabaseAPI.faq.update(faq.id, {
                                        question: faq.question,
                                        answer: faq.answer,
                                        category_id: categoryId,
                                        tags: faq.tags || [],
                                        status: faq.status || 'published',
                                        display_order: faq.order || 0
                                    });

                                    if (!result.success) {
                                        console.error('FAQ更新失敗:', result.error);
                                        throw new Error(result.error);
                                    }
                                } else {
                                    // 新規FAQ - Supabaseに作成
                                    const categoryId = this.getCategoryIdByName(faq.category);

                                    const result = await window.supabaseAPI.faq.create({
                                        question: faq.question,
                                        answer: faq.answer,
                                        category_id: categoryId,
                                        tags: faq.tags || [],
                                        status: faq.status || 'published',
                                        display_order: faq.order || 0
                                    });

                                    if (result && result.success) {
                                        // ローカルのFAQのIDをSupabaseのIDに更新
                                        faq.id = result.data.id;
                                    } else {
                                        console.error('FAQ作成失敗:', result.error);
                                        throw new Error(result.error);
                                    }
                                }
                            }
                            console.log('✅ FAQs saved to Supabase');
                        } else {
                            // LocalStorageに保存（フォールバック）
                            localStorage.setItem('faq_data', JSON.stringify({ faqs: this.faqs }));
                            console.log('⚠️ Saved FAQs to localStorage (fallback)', this.faqs);
                        }

                        // 統計更新イベントを発火
                        window.dispatchEvent(new CustomEvent('stats-updated'));
                    } catch (error) {
                        console.error('❌ FAQ保存エラー:', error);
                        // Supabase保存失敗時はLocalStorageにフォールバック
                        localStorage.setItem('faq_data', JSON.stringify({ faqs: this.faqs }));
                        console.log('⚠️ Saved to localStorage due to error');
                        throw error;
                    }
                },

                async saveFAQOrder() {
                    try {
                        if (window.supabaseAPI) {
                            // Supabaseで順序を更新
                            for (const faq of this.faqs) {
                                if (faq.id && typeof faq.id === 'string' && faq.id.includes('-')) {
                                    const result = await window.supabaseAPI.faq.update(faq.id, {
                                        display_order: faq.order || 0
                                    });

                                    if (!result.success) {
                                        console.error('FAQ順序更新失敗:', result.error);
                                    }
                                }
                            }
                            console.log('✅ FAQ order updated in Supabase');
                        } else {
                            // LocalStorageに保存（フォールバック）
                            localStorage.setItem('faq_data', JSON.stringify({ faqs: this.faqs }));
                            console.log('⚠️ Saved FAQ order to localStorage');
                        }

                        // 統計更新イベントを発火
                        window.dispatchEvent(new CustomEvent('stats-updated'));
                        lifeXAPI.showToast('表示順を更新しました', 'success');
                    } catch (error) {
                        console.error('FAQ順序保存エラー:', error);
                        lifeXAPI.showToast('表示順の更新に失敗しました', 'error');
                    }
                },

                // カテゴリ管理関数
                openCategoryModal() {
                    this.showCategoryModal = true;
                    this.editingCategory = null;
                    this.newCategoryName = '';
                },

                closeCategoryModal() {
                    this.showCategoryModal = false;
                    this.editingCategory = null;
                    this.newCategoryName = '';
                    this.categoryFormData = {
                        name: '',
                        display_order: 0
                    };
                },

                editCategoryItem(category) {
                    this.editingCategory = category;
                    this.categoryFormData = {
                        name: category.name,
                        display_order: category.display_order || 0
                    };
                },

                async saveCategoryEdit() {
                    if (!this.editingCategory) return;

                    const trimmedName = this.categoryFormData.name.trim();
                    if (!trimmedName) {
                        lifeXAPI.showToast('カテゴリ名を入力してください', 'error');
                        return;
                    }

                    try {
                        // window.supabaseが利用可能になるまで待機
                        let retries = 0;
                        while ((!window.supabase || !window.supabase.from) && retries < 50) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                            retries++;
                        }

                        if (window.supabase && window.supabase.from) {
                            // 直接Supabaseを使用してカテゴリを更新
                            const { data, error } = await window.supabase
                                .from('faq_categories')
                                .update({
                                    name: trimmedName,
                                    display_order: this.categoryFormData.display_order,
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', this.editingCategory.id)
                                .select();

                            if (error) {
                                console.error('カテゴリ更新エラー:', error);
                                lifeXAPI.showToast('カテゴリの更新に失敗しました', 'error');
                                return;
                            }

                            // ローカルのカテゴリリストを更新
                            const index = this.categoryObjects.findIndex(c => c.id === this.editingCategory.id);
                            if (index > -1) {
                                this.categoryObjects[index].name = trimmedName;
                                this.categoryObjects[index].display_order = this.categoryFormData.display_order;
                            }

                            // カテゴリ名リストを更新
                            this.categories = this.categoryObjects.map(c => c.name);

                            // カテゴリマップを再構築
                            this.categoryMap = {};
                            this.categoryObjects.forEach(cat => {
                                this.categoryMap[cat.name] = cat.id;
                            });

                            lifeXAPI.showToast('カテゴリを更新しました', 'success');
                            this.editingCategory = null;
                        } else {
                            throw new Error('Supabaseクライアントが初期化されていません');
                        }
                    } catch (error) {
                        console.error('カテゴリ更新エラー:', error);
                        lifeXAPI.showToast('カテゴリの更新に失敗しました', 'error');
                    }
                },

                cancelCategoryEdit() {
                    this.editingCategory = null;
                    this.categoryFormData = {
                        name: '',
                        display_order: 0
                    };
                },

                async deleteCategoryItem(category) {
                    // このカテゴリに属するFAQがあるか確認
                    const faqsInCategory = this.faqs.filter(faq => faq.category === category.name);
                    if (faqsInCategory.length > 0) {
                        lifeXAPI.showToast('このカテゴリにはFAQが存在するため削除できません', 'error');
                        return;
                    }

                    if (!confirm(`カテゴリ「${category.name}」を削除しますか？`)) {
                        return;
                    }

                    try {
                        // window.supabaseが利用可能になるまで待機
                        let retries = 0;
                        while ((!window.supabase || !window.supabase.from) && retries < 50) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                            retries++;
                        }

                        if (window.supabase && window.supabase.from) {
                            // 直接Supabaseを使用してカテゴリを削除
                            const { error } = await window.supabase
                                .from('faq_categories')
                                .delete()
                                .eq('id', category.id);

                            if (error) {
                                console.error('カテゴリ削除エラー:', error);
                                lifeXAPI.showToast('カテゴリの削除に失敗しました', 'error');
                                return;
                            }

                            // ローカルのカテゴリリストから削除
                            this.categoryObjects = this.categoryObjects.filter(c => c.id !== category.id);
                            this.categories = this.categoryObjects.map(c => c.name);

                            // カテゴリマップを再構築
                            this.categoryMap = {};
                            this.categoryObjects.forEach(cat => {
                                this.categoryMap[cat.name] = cat.id;
                            });

                            lifeXAPI.showToast('カテゴリを削除しました', 'success');
                        } else {
                            throw new Error('Supabaseクライアントが初期化されていません');
                        }
                    } catch (error) {
                        console.error('カテゴリ削除エラー:', error);
                        lifeXAPI.showToast('カテゴリの削除に失敗しました', 'error');
                    }
                },

                async addNewCategory() {
                    const trimmedName = this.newCategoryName.trim();
                    if (!trimmedName) {
                        lifeXAPI.showToast('カテゴリ名を入力してください', 'error');
                        return;
                    }

                    // 重複チェック
                    if (this.categories.includes(trimmedName)) {
                        lifeXAPI.showToast('このカテゴリ名は既に存在します', 'error');
                        return;
                    }

                    try {
                        // window.supabaseが利用可能になるまで待機
                        let retries = 0;
                        while ((!window.supabase || !window.supabase.from) && retries < 50) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                            retries++;
                        }

                        if (window.supabase && window.supabase.from) {
                            // 新しい表示順を計算
                            const maxOrder = this.categoryObjects.reduce((max, cat) =>
                                Math.max(max, cat.display_order || 0), 0);

                            // 直接Supabaseを使用してカテゴリを作成
                            const { data, error } = await window.supabase
                                .from('faq_categories')
                                .insert([{
                                    name: trimmedName,
                                    display_order: maxOrder + 1,
                                    created_at: new Date().toISOString(),
                                    updated_at: new Date().toISOString()
                                }])
                                .select();

                            if (error) {
                                console.error('カテゴリ作成エラー:', error);
                                lifeXAPI.showToast('カテゴリの作成に失敗しました', 'error');
                                return;
                            }

                            if (data && data.length > 0) {
                                // ローカルのカテゴリリストに追加
                                const newCategory = data[0];
                                this.categoryObjects.push(newCategory);
                                this.categories.push(newCategory.name);

                                // カテゴリマップを更新
                                this.categoryMap[newCategory.name] = newCategory.id;

                                // 入力欄をクリア
                                this.newCategoryName = '';

                                lifeXAPI.showToast('カテゴリを追加しました', 'success');
                            }
                        } else {
                            throw new Error('Supabaseクライアントが初期化されていません');
                        }
                    } catch (error) {
                        console.error('カテゴリ作成エラー:', error);
                        lifeXAPI.showToast('カテゴリの作成に失敗しました', 'error');
                    }
                }
            };
        }
    </script>
</body>
</html>