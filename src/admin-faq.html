<!DOCTYPE html>
<html lang="ja" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>よくある質問管理 | LIFE X 管理画面</title>
    <link href="./styles/main.css" rel="stylesheet">
    <script src="/js/common.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="h-full bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="/" class="text-xl font-bold text-gray-900 hover:text-gray-700">LIFE X</a>
                    <span class="ml-2 px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">管理者専用</span>
                </div>
                <nav class="hidden md:flex space-x-8 items-center">
                    <a href="/admin.html" class="nav-link">管理ホーム</a>
                    <a href="/admin-plans.html" class="nav-link">プラン管理</a>
                    <a href="/admin-rules.html" class="nav-link">ルール・ガイドライン管理</a>
                    <a href="/admin-downloads.html" class="nav-link">ダウンロード管理</a>
                    <a href="/admin-faq.html" class="nav-link active">よくある質問管理</a>
                    <a href="/admin-system.html" class="nav-link">システム管理</a>
                    <a href="/admin-report.html" class="nav-link">レポート</a>
                    <a href="/" class="nav-link">サイトに戻る</a>
                    <button @click="logout()" class="nav-link text-red-600 hover:text-red-800">ログアウト</button>
                </nav>
                <div id="userInfo" class="text-sm"></div>
            </div>
        </div>
    </header>

    <div x-data="adminFAQ()" x-init="init()">
        <!-- Page Header -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">よくある質問管理</h1>
                    <p class="text-gray-600 mt-2">FAQの追加・編集・削除・並び替えを管理</p>
                </div>
                <button @click="openAddModal()" class="btn-primary">
                    <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    新規FAQ追加
                </button>
            </div>

            <!-- カテゴリ別タブ -->
            <div class="card mb-6">
                <div class="flex space-x-1 border-b border-gray-200">
                    <button 
                        @click="activeCategory = 'all'"
                        :class="activeCategory === 'all' ? 'border-b-2 border-primary-500 text-primary-600' : 'text-gray-600 hover:text-gray-900'"
                        class="px-4 py-2 font-medium transition-colors">
                        すべて
                    </button>
                    <template x-for="category in categories" :key="category">
                        <button 
                            @click="activeCategory = category"
                            :class="activeCategory === category ? 'border-b-2 border-primary-500 text-primary-600' : 'text-gray-600 hover:text-gray-900'"
                            class="px-4 py-2 font-medium transition-colors"
                            x-text="category">
                        </button>
                    </template>
                </div>
            </div>

            <!-- FAQ リスト -->
            <div class="space-y-4" id="faqList">
                <template x-for="faq in filteredFAQs" :key="faq.id">
                    <div class="card hover:shadow-lg transition-shadow" :data-id="faq.id">
                        <div class="flex items-start">
                            <!-- ドラッグハンドル -->
                            <div class="handle cursor-move mr-4 mt-1">
                                <svg class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                                </svg>
                            </div>
                            
                            <!-- FAQ内容 -->
                            <div class="flex-1">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-3 mb-2">
                                            <span x-text="faq.category" class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded"></span>
                                            <span x-text="`表示順: ${faq.order}`" class="text-xs text-gray-500"></span>
                                            <span x-show="faq.status === 'active'" class="text-xs px-2 py-1 bg-green-100 text-green-800 rounded">公開中</span>
                                            <span x-show="faq.status === 'draft'" class="text-xs px-2 py-1 bg-gray-100 text-gray-800 rounded">下書き</span>
                                        </div>
                                        <h3 class="text-lg font-medium text-gray-900 mb-2" x-text="faq.question"></h3>
                                        <div class="text-sm text-gray-600" x-html="faq.answer.substring(0, 150) + (faq.answer.length > 150 ? '...' : '')"></div>
                                    </div>
                                    
                                    <!-- 操作ボタン -->
                                    <div class="flex items-center space-x-2 ml-4">
                                        <button @click="editFAQ(faq)" class="text-blue-600 hover:text-blue-900">
                                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                            </svg>
                                        </button>
                                        <button @click="deleteFAQ(faq)" class="text-red-600 hover:text-red-900">
                                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Add/Edit Modal -->
        <div x-show="showModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
            <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-3xl shadow-lg rounded-md bg-white mb-10">
                <div class="mt-3">
                    <h3 class="text-lg font-medium text-gray-900 mb-4" x-text="editingFAQ ? 'FAQ編集' : '新規FAQ追加'"></h3>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">カテゴリ</label>
                                <select x-model="formData.category" class="form-input w-full">
                                    <option value="">選択してください</option>
                                    <template x-for="category in categories" :key="category">
                                        <option :value="category" x-text="category"></option>
                                    </template>
                                    <option value="new">新規カテゴリを追加...</option>
                                </select>
                                <input 
                                    x-show="formData.category === 'new'"
                                    x-model="newCategory"
                                    type="text"
                                    placeholder="新しいカテゴリ名"
                                    class="form-input w-full mt-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ステータス</label>
                                <select x-model="formData.status" class="form-input w-full">
                                    <option value="active">公開中</option>
                                    <option value="draft">下書き</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">質問</label>
                            <input type="text" x-model="formData.question" class="form-input w-full" placeholder="よくある質問を入力">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">回答</label>
                            <div class="mb-2">
                                <button type="button" @click="insertHTML('bold')" class="text-sm px-2 py-1 bg-gray-100 rounded mr-1">太字</button>
                                <button type="button" @click="insertHTML('list')" class="text-sm px-2 py-1 bg-gray-100 rounded mr-1">リスト</button>
                                <button type="button" @click="insertHTML('br')" class="text-sm px-2 py-1 bg-gray-100 rounded">改行</button>
                            </div>
                            <textarea 
                                x-model="formData.answer" 
                                rows="8" 
                                class="form-input w-full" 
                                placeholder="回答を入力（HTML可）">
                            </textarea>
                            <p class="text-xs text-gray-500 mt-1">※ HTMLタグが使用可能です（&lt;br&gt;, &lt;ul&gt;, &lt;li&gt;, &lt;strong&gt; など）</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">プレビュー</label>
                            <div class="p-4 bg-gray-50 rounded border border-gray-200 min-h-[100px]" x-html="formData.answer || '（回答のプレビューがここに表示されます）'"></div>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-end space-x-3">
                        <button @click="closeModal()" class="btn-secondary">キャンセル</button>
                        <button @click="saveFAQ()" class="btn-primary">保存</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function adminFAQ() {
            return {
                faqs: [],
                filteredFAQs: [],
                categories: ['プラン変更', '費用', '営業', 'アフターサービス', '工事', '契約', '仕様'],
                activeCategory: 'all',
                showModal: false,
                editingFAQ: null,
                newCategory: '',
                formData: {
                    question: '',
                    answer: '',
                    category: '',
                    status: 'active',
                    order: 1
                },
                sortable: null,

                async init() {
                    // 認証チェック
                    if (!authManager.isAuthenticated()) {
                        window.location.href = '/admin-login.html';
                        return;
                    }
                    
                    // FAQデータの読み込み
                    await this.loadFAQs();
                    this.filterFAQs();
                    
                    // ドラッグ&ドロップの初期化
                    this.$nextTick(() => {
                        this.initSortable();
                    });
                },

                async loadFAQs() {
                    // LocalStorageから取得を試みる
                    const localData = localStorage.getItem('faq_data');
                    if (localData) {
                        this.faqs = JSON.parse(localData).faqs || [];
                    } else {
                        // 実際にはAPIから取得
                        this.faqs = [];
                    }
                },

                initSortable() {
                    const list = document.getElementById('faqList');
                    if (list) {
                        this.sortable = new Sortable(list, {
                            handle: '.handle',
                            animation: 150,
                            onEnd: (evt) => {
                                this.reorderFAQs(evt.oldIndex, evt.newIndex);
                            }
                        });
                    }
                },

                filterFAQs() {
                    if (this.activeCategory === 'all') {
                        this.filteredFAQs = [...this.faqs];
                    } else {
                        this.filteredFAQs = this.faqs.filter(faq => faq.category === this.activeCategory);
                    }
                    
                    // 表示順でソート
                    this.filteredFAQs.sort((a, b) => a.order - b.order);
                },

                reorderFAQs(oldIndex, newIndex) {
                    if (oldIndex === newIndex) return;
                    
                    const moved = this.filteredFAQs.splice(oldIndex, 1)[0];
                    this.filteredFAQs.splice(newIndex, 0, moved);
                    
                    // 順番を更新
                    this.filteredFAQs.forEach((faq, index) => {
                        faq.order = index + 1;
                        const originalIndex = this.faqs.findIndex(f => f.id === faq.id);
                        if (originalIndex > -1) {
                            this.faqs[originalIndex].order = faq.order;
                        }
                    });
                    
                    this.saveFAQOrder();
                },

                openAddModal() {
                    this.editingFAQ = null;
                    this.formData = {
                        question: '',
                        answer: '',
                        category: '',
                        status: 'active',
                        order: this.faqs.length + 1
                    };
                    this.showModal = true;
                },

                editFAQ(faq) {
                    this.editingFAQ = faq;
                    this.formData = { ...faq };
                    this.showModal = true;
                },

                async saveFAQ() {
                    if (!this.formData.question || !this.formData.answer) {
                        lifeXAPI.showToast('質問と回答を入力してください', 'error');
                        return;
                    }

                    // 新規カテゴリの処理
                    if (this.formData.category === 'new' && this.newCategory) {
                        this.formData.category = this.newCategory;
                        if (!this.categories.includes(this.newCategory)) {
                            this.categories.push(this.newCategory);
                        }
                        this.newCategory = '';
                    }

                    if (!this.formData.category) {
                        lifeXAPI.showToast('カテゴリを選択してください', 'error');
                        return;
                    }

                    try {
                        if (this.editingFAQ) {
                            // 編集
                            const index = this.faqs.findIndex(f => f.id === this.editingFAQ.id);
                            if (index > -1) {
                                this.faqs[index] = {
                                    ...this.formData,
                                    updated: new Date().toISOString()
                                };
                            }
                            lifeXAPI.showToast('FAQを更新しました', 'success');
                        } else {
                            // 新規追加
                            const newFAQ = {
                                ...this.formData,
                                id: Date.now(),
                                updated: new Date().toISOString()
                            };
                            this.faqs.push(newFAQ);
                            lifeXAPI.showToast('FAQを追加しました', 'success');
                        }
                        
                        this.filterFAQs();
                        this.closeModal();
                        
                        // 実際にはAPIで保存
                        await this.saveToAPI();
                    } catch (error) {
                        console.error('FAQの保存に失敗しました:', error);
                        lifeXAPI.showToast('FAQの保存に失敗しました', 'error');
                    }
                },

                deleteFAQ(faq) {
                    if (confirm(`「${faq.question}」を削除しますか？`)) {
                        this.faqs = this.faqs.filter(f => f.id !== faq.id);
                        this.filterFAQs();
                        lifeXAPI.showToast('FAQを削除しました', 'success');
                        
                        // 実際にはAPIで削除
                        this.saveToAPI();
                    }
                },

                closeModal() {
                    this.showModal = false;
                    this.editingFAQ = null;
                    this.newCategory = '';
                },

                insertHTML(type) {
                    const textarea = document.querySelector('textarea[x-model="formData.answer"]');
                    const start = textarea.selectionStart;
                    const end = textarea.selectionEnd;
                    const text = this.formData.answer;
                    
                    let insertion = '';
                    switch(type) {
                        case 'bold':
                            insertion = '<strong>選択したテキスト</strong>';
                            break;
                        case 'list':
                            insertion = '<ul class="mt-2 ml-4 list-disc">\n  <li>項目1</li>\n  <li>項目2</li>\n</ul>';
                            break;
                        case 'br':
                            insertion = '<br>';
                            break;
                    }
                    
                    this.formData.answer = text.substring(0, start) + insertion + text.substring(end);
                    
                    // カーソル位置を調整
                    this.$nextTick(() => {
                        textarea.focus();
                        textarea.setSelectionRange(start + insertion.length, start + insertion.length);
                    });
                },

                async saveToAPI() {
                    // LocalStorageに保存
                    localStorage.setItem('faq_data', JSON.stringify({ faqs: this.faqs }));
                    console.log('Saved FAQs to localStorage', this.faqs);
                    // 統計更新イベントを発火
                    window.dispatchEvent(new CustomEvent('stats-updated'));
                },

                async saveFAQOrder() {
                    // LocalStorageに保存
                    localStorage.setItem('faq_data', JSON.stringify({ faqs: this.faqs }));
                    console.log('Saved FAQ order to localStorage');
                    // 統計更新イベントを発火
                    window.dispatchEvent(new CustomEvent('stats-updated'));
                    lifeXAPI.showToast('表示順を更新しました', 'success');
                }
            };
        }

        // 認証チェック
        if (!window.authManager.requireAuth()) {
            // requireAuth内でリダイレクトされる
        }
    </script>
</body>
</html>