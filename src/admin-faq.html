<!DOCTYPE html>
<html lang="ja" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAQÁÆ°ÁêÜ | LIFE X ÁÆ°ÁêÜÁîªÈù¢</title>
    <!-- Version: 2025-01-24-v5 (CRITICAL: Proper Supabase createClient) -->
    <!-- Tailwind CSS (Production Build) -->
    <link rel="stylesheet" href="/assets/tailwind.css">

    <link href="./styles/main.css" rel="stylesheet">

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>console.log('üî• admin-faq.html loaded - Version: 2025-01-24-v5 (CRITICAL FIX)');</script>
    <script src="/js/common.js?v=20251024"></script>

    <!-- Supabase Auth Guard -->
    <script type="module" src="/js/auth-guard.js?v=20251024"></script>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <!-- Supabase Integration - Áõ¥Êé•ÂàùÊúüÂåñ -->
    <script type="module">
        (async () => {
            try {
                console.log('üöÄ FAQ API initialization v5 - CRITICAL FIX: Proper Supabase createClient');
                console.log('üöÄ Starting FAQ API initialization...');

                // SupabaseÊé•Á∂öÊÉÖÂ†±Ôºàsupabase-client.js„Å®Âêå„ÅòÔºâ
                const SUPABASE_URL = 'https://hegpxvyziovlfxdfsrsv.supabase.co';
                const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhlZ3B4dnl6aW92bGZ4ZGZzcnN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2Nzk5MjYsImV4cCI6MjA3NjI1NTkyNn0.uLCJvgKDOWpTxRjt39DVyqUotQcSam3v4lItofWeDws';

                console.log('üîß Supabase URL:', SUPABASE_URL);

                // CDN„ÅÆË™≠„ÅøËæº„Åø„ÇíÂæÖ„Å§
                await new Promise(resolve => {
                    if (window.supabase?.createClient) {
                        resolve();
                    } else {
                        const checkInterval = setInterval(() => {
                            if (window.supabase?.createClient) {
                                clearInterval(checkInterval);
                                resolve();
                            }
                        }, 50);
                    }
                });

                console.log('‚úÖ Supabase CDN loaded');

                // Supabase„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÇíÊ≠£„Åó„ÅèÂàùÊúüÂåñ„Åó„Å¶„Ç∞„É≠„Éº„Éê„É´„Å´‰øùÂ≠ò
                const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('‚úÖ Supabase client initialized');
                console.log('   Has auth:', !!supabaseClient.auth);
                console.log('   Has from:', typeof supabaseClient.from === 'function');

                // „Ç∞„É≠„Éº„Éê„É´„Å´‰øùÂ≠ò„Åó„Å¶„Éá„Éê„ÉÉ„Ç∞ÂèØËÉΩ„Å´
                window.supabaseClient = supabaseClient;

        // FAQÁî®„ÅÆAPI„ÇíÁõ¥Êé•ÂÆöÁæ©
        window.supabaseAPI = window.supabaseAPI || {};
        window.supabaseAPI.faq = {
            async getCategories() {
                try {
                    console.log('üìã getCategories() called');
                    const { data, error } = await supabaseClient
                        .from('faq_categories')
                        .select('*')
                        .order('display_order');
                    if (error) {
                        console.error('‚ùå getCategories error:', error);
                        throw error;
                    }
                    console.log('‚úÖ getCategories success:', data?.length || 0, 'categories');
                    return data || [];
                } catch (error) {
                    console.error('Error fetching FAQ categories:', error);
                    return [];
                }
            },

            async getItems(categoryId = null) {
                try {
                    console.log('üìã getItems() called, categoryId:', categoryId);
                    let query = supabaseClient
                        .from('faqs')
                        .select('*, faq_categories(name)')
                        .order('display_order');

                    if (categoryId) {
                        query = query.eq('category_id', categoryId);
                    }

                    const { data, error } = await query;
                    if (error) {
                        console.error('‚ùå getItems error:', error);
                        throw error;
                    }
                    console.log('‚úÖ getItems success:', data?.length || 0, 'items');
                    return data || [];
                } catch (error) {
                    console.error('Error fetching FAQs:', error);
                    return [];
                }
            },

            async create(faqData) {
                try {
                    console.log('‚ûï create() called:', faqData);
                    const { data, error } = await supabaseClient
                        .from('faqs')
                        .insert([{
                            question: faqData.question,
                            answer: faqData.answer,
                            category_id: faqData.category_id,
                            tags: faqData.tags || [],
                            status: faqData.status || 'published',
                            display_order: faqData.display_order || 0
                        }])
                        .select()
                        .single();

                    if (error) throw error;
                    return { success: true, data };
                } catch (error) {
                    console.error('Error creating FAQ:', error);
                    return { success: false, error: error.message };
                }
            },

            async update(faqId, updates) {
                try {
                    console.log('‚úèÔ∏è update() called, id:', faqId, 'updates:', updates);
                    const { data, error } = await supabaseClient
                        .from('faqs')
                        .update(updates)
                        .eq('id', faqId)
                        .select()
                        .single();

                    if (error) {
                        console.error('‚ùå update error:', error);
                        throw error;
                    }
                    console.log('‚úÖ update success');
                    return { success: true, data };
                } catch (error) {
                    console.error('Error updating FAQ:', error);
                    return { success: false, error: error.message };
                }
            },

            async delete(faqId) {
                try {
                    console.log('üóëÔ∏è delete() called, id:', faqId);
                    const { error } = await supabaseClient
                        .from('faqs')
                        .delete()
                        .eq('id', faqId);

                    if (error) {
                        console.error('‚ùå delete error:', error);
                        throw error;
                    }
                    console.log('‚úÖ delete success');
                    return { success: true };
                } catch (error) {
                    console.error('Error deleting FAQ:', error);
                    return { success: false, error: error.message };
                }
            }
        };

                console.log('‚úÖ FAQ API initialized');
                console.log('window.supabaseAPI:', window.supabaseAPI);

                // Alpine.js„ÅÆÂàùÊúüÂåñÊ∫ñÂÇôÂÆå‰∫Ü„ÇíÈÄöÁü•
                window.supabaseAPIReady = true;
                window.dispatchEvent(new Event('supabaseAPIReady'));

                // Alpine.js „ÇíËµ∑Âãï
                if (window.startAlpine) {
                    console.log('üöÄ Starting Alpine.js now...');
                    window.startAlpine();
                } else {
                    console.warn('‚ö†Ô∏è window.startAlpine not found, waiting...');
                    // Alpine.js CDN„ÅÆ„É≠„Éº„Éâ„ÇíÂæÖ„Å§
                    const checkAlpine = setInterval(() => {
                        if (window.startAlpine) {
                            clearInterval(checkAlpine);
                            console.log('üöÄ Starting Alpine.js (delayed)...');
                            window.startAlpine();
                        }
                    }, 50);
                }
            } catch (error) {
                console.error('‚ùå Failed to initialize FAQ API:', error);
                console.error('Error stack:', error.stack);
            }
        })();
    </script>

    <!-- Alpine.js - ÊâãÂãïÂàùÊúüÂåñ„É¢„Éº„Éâ -->
    <script>
        // Alpine.js „ÅÆËá™ÂãïËµ∑Âãï„ÇíÈò≤„Åê
        window.deferLoadingAlpine = callback => {
            console.log('üéø Deferring Alpine.js startup...');
            window.startAlpine = callback;
        };

        document.addEventListener('alpine:init', () => {
            console.log('üéø Alpine.js initialized');
        });
    </script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="h-full bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="/" class="text-xl font-bold text-gray-900 hover:text-gray-700">LIFE X</a>
                    <span class="ml-2 px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">ÁÆ°ÁêÜËÄÖÂ∞ÇÁî®</span>
                </div>
                <nav class="hidden md:flex space-x-8 items-center">
                    <a href="/admin.html" class="nav-link">ÁÆ°ÁêÜ„Éõ„Éº„É†</a>
                    <a href="/admin-plans.html" class="nav-link">„Éó„É©„É≥ÁÆ°ÁêÜ</a>
                    <a href="/admin-rules.html" class="nav-link">„É´„Éº„É´ÁÆ°ÁêÜ</a>
                    <a href="/admin-downloads.html" class="nav-link">„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÁÆ°ÁêÜ</a>
                    <a href="/admin-faq.html" class="nav-link active">FAQÁÆ°ÁêÜ</a>
                    <a href="/admin-notifications.html" class="nav-link">„ÅäÁü•„Çâ„ÅõÁÆ°ÁêÜ</a>
                    <a href="/admin-users.html" class="nav-link">„É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ</a>
                    <a href="/admin-profile.html" class="nav-link">„Éó„É≠„Éï„Ç£„Éº„É´</a>
                    <a href="/admin-system.html" class="nav-link">„Ç∑„Çπ„ÉÜ„É†ÁÆ°ÁêÜ</a>
                    <a href="/admin-report.html" class="nav-link">„É¨„Éù„Éº„Éà</a>
                    <a href="/" class="nav-link">„Çµ„Ç§„Éà„Å´Êàª„Çã</a>
                    <button onclick="logout()" type="button" class="nav-link text-red-600 hover:text-red-800">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                </nav>

                <!-- Mobile Menu -->
                <div class="md:hidden" x-data="{ mobileMenuOpen: false }">
                    <button @click="mobileMenuOpen = !mobileMenuOpen" type="button" class="text-gray-500 hover:text-gray-600">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>

                    <div x-show="mobileMenuOpen" class="absolute top-16 right-4 bg-white shadow-lg rounded-lg border border-gray-200 p-4 z-50 min-w-48" style="display: none;">
                        <a href="/admin.html" class="block py-2 text-sm text-gray-600">ÁÆ°ÁêÜ„Éõ„Éº„É†</a>
                        <a href="/admin-plans.html" class="block py-2 text-sm text-gray-600">„Éó„É©„É≥ÁÆ°ÁêÜ</a>
                        <a href="/admin-rules.html" class="block py-2 text-sm text-gray-600">„É´„Éº„É´ÁÆ°ÁêÜ</a>
                        <a href="/admin-downloads.html" class="block py-2 text-sm text-gray-600">„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÁÆ°ÁêÜ</a>
                        <a href="/admin-faq.html" class="block py-2 text-sm text-gray-900 font-medium">FAQÁÆ°ÁêÜ</a>
                        <a href="/admin-notifications.html" class="block py-2 text-sm text-gray-600">„ÅäÁü•„Çâ„ÅõÁÆ°ÁêÜ</a>
                        <a href="/admin-users.html" class="block py-2 text-sm text-gray-600">„É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ</a>
                        <a href="/admin-profile.html" class="block py-2 text-sm text-gray-600">„Éó„É≠„Éï„Ç£„Éº„É´</a>
                        <a href="/admin-system.html" class="block py-2 text-sm text-gray-600">„Ç∑„Çπ„ÉÜ„É†ÁÆ°ÁêÜ</a>
                        <a href="/admin-report.html" class="block py-2 text-sm text-gray-600">„É¨„Éù„Éº„Éà</a>
                        <div class="border-t border-gray-200 mt-3 pt-3">
                            <a href="/" class="block py-2 text-sm text-gray-600">„Çµ„Ç§„Éà„Å´Êàª„Çã</a>
                            <button onclick="logout()" type="button" class="block py-2 text-sm text-red-600 hover:text-red-800 text-left w-full">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                        </div>
                    </div>
                </div>

                <div id="userInfo" class="hidden md:block text-sm"></div>
            </div>
        </div>
    </header>

    <div x-data="adminFAQ()" x-init="init()">
        <!-- Page Header -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">FAQÁÆ°ÁêÜ</h1>
                    <p class="text-gray-600 mt-2">FAQ„ÅÆËøΩÂä†„ÉªÁ∑®ÈõÜ„ÉªÂâäÈô§„Éª‰∏¶„Å≥Êõø„Åà„ÇíÁÆ°ÁêÜ</p>
                </div>
                <div class="flex space-x-3">
                    <button type="button" @click="openCategoryModal()" class="btn-secondary">
                        <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                        </svg>
                        „Ç´„ÉÜ„Ç¥„É™ÁÆ°ÁêÜ
                    </button>
                    <button type="button" @click="openAddModal()" class="btn-primary">
                        <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Êñ∞Ë¶èFAQËøΩÂä†
                    </button>
                </div>
            </div>

            <!-- „Ç´„ÉÜ„Ç¥„É™Âà•„Çø„Éñ -->
            <div class="card mb-6">
                <div class="flex space-x-1 border-b border-gray-200">
                    <button
                        @click="activeCategory = 'all'"
                        :class="activeCategory === 'all' ? 'border-b-2 border-primary-500 text-primary-600' : 'text-gray-600 hover:text-gray-900'"
                        class="px-4 py-2 font-medium transition-colors">
                        „Åô„Åπ„Å¶
                    </button>
                    <template x-for="(category, index) in categories" :key="index">
                        <button
                            @click="activeCategory = category"
                            :class="activeCategory === category ? 'border-b-2 border-primary-500 text-primary-600' : 'text-gray-600 hover:text-gray-900'"
                            class="px-4 py-2 font-medium transition-colors"
                            x-text="category">
                        </button>
                    </template>
                </div>
            </div>

            <!-- FAQ „É™„Çπ„Éà -->
            <div class="space-y-4" id="faqList">
                <template x-for="faq in filteredFAQs" :key="faq.id">
                    <div class="card hover:shadow-lg transition-shadow" :data-id="faq.id">
                        <div class="flex items-start">
                            <!-- „Éâ„É©„ÉÉ„Ç∞„Éè„É≥„Éâ„É´ -->
                            <div class="handle cursor-move mr-4 mt-1">
                                <svg class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                                </svg>
                            </div>
                            
                            <!-- FAQÂÜÖÂÆπ -->
                            <div class="flex-1">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-3 mb-2">
                                            <span x-text="faq.category" class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded"></span>
                                            <span x-text="`Ë°®Á§∫È†Ü: ${faq.order}`" class="text-xs text-gray-500"></span>
                                            <span x-show="faq.status === 'active'" class="text-xs px-2 py-1 bg-green-100 text-green-800 rounded">ÂÖ¨Èñã‰∏≠</span>
                                            <span x-show="faq.status === 'draft'" class="text-xs px-2 py-1 bg-gray-100 text-gray-800 rounded">‰∏ãÊõ∏„Åç</span>
                                        </div>
                                        <h3 class="text-lg font-medium text-gray-900 mb-2" x-text="faq.question"></h3>
                                        <div class="text-sm text-gray-600" x-html="faq.answer.substring(0, 150) + (faq.answer.length > 150 ? '...' : '')"></div>
                                    </div>
                                    
                                    <!-- Êìç‰Ωú„Éú„Çø„É≥ -->
                                    <div class="flex items-center space-x-2 ml-4">
                                        <button type="button" @click="editFAQ(faq)" class="text-blue-600 hover:text-blue-900">
                                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                            </svg>
                                        </button>
                                        <button type="button" @click="deleteFAQ(faq)" class="text-red-600 hover:text-red-900">
                                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Add/Edit Modal -->
        <div x-show="showModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
            <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-3xl shadow-lg rounded-md bg-white mb-10">
                <div class="mt-3">
                    <h3 class="text-lg font-medium text-gray-900 mb-4" x-text="editingFAQ ? 'FAQÁ∑®ÈõÜ' : 'Êñ∞Ë¶èFAQËøΩÂä†'"></h3>

                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">„Ç´„ÉÜ„Ç¥„É™ <span class="text-red-500">*</span></label>
                                <select x-model="formData.category" class="form-input w-full" required>
                                    <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                    <template x-for="(category, index) in categories" :key="index">
                                        <option :value="category" x-text="category"></option>
                                    </template>
                                    <option value="new">Êñ∞Ë¶è„Ç´„ÉÜ„Ç¥„É™„ÇíËøΩÂä†...</option>
                                </select>
                                <input
                                    x-show="formData.category === 'new'"
                                    x-model="newCategory"
                                    type="text"
                                    placeholder="Êñ∞„Åó„ÅÑ„Ç´„ÉÜ„Ç¥„É™Âêç"
                                    class="form-input w-full mt-2"
                                    required>
                                <p class="text-xs text-gray-500 mt-1">„Ç´„ÉÜ„Ç¥„É™„ÇíÂøÖ„ÅöÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                                <select x-model="formData.status" class="form-input w-full">
                                    <option value="published">ÂÖ¨Èñã‰∏≠</option>
                                    <option value="draft">‰∏ãÊõ∏„Åç</option>
                                    <option value="archived">„Ç¢„Éº„Ç´„Ç§„Éñ</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ë≥™Âïè</label>
                            <input type="text" x-model="formData.question" class="form-input w-full" placeholder="„Çà„Åè„ÅÇ„ÇãË≥™Âïè„ÇíÂÖ•Âäõ">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ÂõûÁ≠î</label>
                            <div class="mb-2">
                                <button type="button" @click="insertHTML('bold')" class="text-sm px-2 py-1 bg-gray-100 rounded mr-1">Â§™Â≠ó</button>
                                <button type="button" @click="insertHTML('list')" class="text-sm px-2 py-1 bg-gray-100 rounded mr-1">„É™„Çπ„Éà</button>
                                <button type="button" @click="insertHTML('br')" class="text-sm px-2 py-1 bg-gray-100 rounded">ÊîπË°å</button>
                            </div>
                            <textarea
                                x-model="formData.answer"
                                rows="8"
                                class="form-input w-full"
                                placeholder="ÂõûÁ≠î„ÇíÂÖ•ÂäõÔºàHTMLÂèØÔºâ">
                            </textarea>
                            <p class="text-xs text-gray-500 mt-1">‚Äª HTML„Çø„Ç∞„Åå‰ΩøÁî®ÂèØËÉΩ„Åß„ÅôÔºà&lt;br&gt;, &lt;ul&gt;, &lt;li&gt;, &lt;strong&gt; „Å™„Å©Ôºâ</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">„Éó„É¨„Éì„É•„Éº</label>
                            <div class="p-4 bg-gray-50 rounded border border-gray-200 min-h-[100px]" x-html="formData.answer || 'ÔºàÂõûÁ≠î„ÅÆ„Éó„É¨„Éì„É•„Éº„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„ÅôÔºâ'"></div>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" @click="closeModal()" class="btn-secondary" :disabled="saving">„Ç≠„É£„É≥„Çª„É´</button>
                        <button type="button" @click="saveFAQ()"
                                :disabled="saving || !canSave"
                                :class="saving || !canSave ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'btn-primary'"
                                class="px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                            <span x-show="!saving">‰øùÂ≠ò</span>
                            <span x-show="saving" class="flex items-center">
                                <svg class="animate-spin -ml-1 mr-3 h-4 w-4 text-current" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                ‰øùÂ≠ò‰∏≠...
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Category Management Modal -->
        <div x-show="showCategoryModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
            <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white mb-10">
                <div class="mt-3">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">FAQ„Ç´„ÉÜ„Ç¥„É™ÁÆ°ÁêÜ</h3>

                    <!-- „Ç´„ÉÜ„Ç¥„É™„É™„Çπ„Éà -->
                    <div class="space-y-2 mb-4">
                        <template x-for="(category, index) in categoryObjects" :key="category.id">
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded border border-gray-200">
                                <div class="flex-1">
                                    <div x-show="editingCategory && editingCategory.id === category.id">
                                        <input
                                            type="text"
                                            x-model="categoryFormData.name"
                                            class="form-input w-full"
                                            placeholder="„Ç´„ÉÜ„Ç¥„É™Âêç">
                                    </div>
                                    <div x-show="!editingCategory || editingCategory.id !== category.id">
                                        <span class="font-medium" x-text="category.name"></span>
                                        <span class="text-xs text-gray-500 ml-2" x-text="`Ë°®Á§∫È†Ü: ${category.display_order || index + 1}`"></span>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2 ml-4">
                                    <template x-if="editingCategory && editingCategory.id === category.id">
                                        <div class="flex space-x-2">
                                            <button type="button" @click="saveCategoryEdit()" class="text-green-600 hover:text-green-900 text-sm">
                                                ‰øùÂ≠ò
                                            </button>
                                            <button type="button" @click="cancelCategoryEdit()" class="text-gray-600 hover:text-gray-900 text-sm">
                                                „Ç≠„É£„É≥„Çª„É´
                                            </button>
                                        </div>
                                    </template>
                                    <template x-if="!editingCategory || editingCategory.id !== category.id">
                                        <div class="flex space-x-2">
                                            <button type="button" @click="editCategoryItem(category)" class="text-blue-600 hover:text-blue-900">
                                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                </svg>
                                            </button>
                                            <button type="button" @click="deleteCategoryItem(category)" class="text-red-600 hover:text-red-900">
                                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                </svg>
                                            </button>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Êñ∞Ë¶è„Ç´„ÉÜ„Ç¥„É™ËøΩÂä†„Éï„Ç©„Éº„É† -->
                    <div class="p-4 bg-blue-50 rounded border border-blue-200">
                        <h4 class="text-sm font-medium text-gray-900 mb-2">Êñ∞Ë¶è„Ç´„ÉÜ„Ç¥„É™ËøΩÂä†</h4>
                        <div class="flex space-x-2">
                            <input
                                type="text"
                                x-model="newCategoryName"
                                @keyup.enter="addNewCategory()"
                                class="form-input flex-1"
                                placeholder="„Ç´„ÉÜ„Ç¥„É™Âêç„ÇíÂÖ•Âäõ">
                            <button type="button" @click="addNewCategory()" class="btn-primary">
                                ËøΩÂä†
                            </button>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end">
                        <button type="button" @click="closeCategoryModal()" class="btn-secondary">Èñâ„Åò„Çã</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Á∞°ÊòìÁöÑ„Å™lifeXAPIÂÆüË£ÖÔºàcommon.js„ÅåË™≠„ÅøËæº„ÇÅ„Å™„ÅÑÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
        if (!window.lifeXAPI) {
            window.lifeXAPI = {
                showToast(message, type) {
                    console.log(`[${type}] ${message}`);
                    // Á∞°ÊòìÁöÑ„Å™„Éà„Éº„Çπ„ÉàË°®Á§∫
                    const toast = document.createElement('div');
                    toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 ${
                        type === 'error' ? 'bg-red-500' :
                        type === 'success' ? 'bg-green-500' :
                        'bg-blue-500'
                    }`;
                    toast.textContent = message;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                }
            };
        }

        // Á∞°ÊòìÁöÑ„Å™Ë™çË®º„Éû„Éç„Éº„Ç∏„É£„Éº
        window.authManager = {
            isAuthenticated() {
                // Á∞°Êòì„ÉÅ„Çß„ÉÉ„ÇØ - Êú¨Áï™Áí∞Â¢É„Åß„ÅØÈÅ©Âàá„Å™Ë™çË®º„ÇíÂÆüË£Ö
                return true;
            },
            requireAuth() {
                if (!this.isAuthenticated()) {
                    window.location.href = '/admin-login.html';
                    return false;
                }
                return true;
            }
        };

        function adminFAQ() {
            return {
                faqs: [],
                filteredFAQs: [],
                categories: [],
                categoryMap: {},
                categoryObjects: [],
                activeCategory: 'all',
                showModal: false,
                showCategoryModal: false,
                editingFAQ: null,
                editingCategory: null,
                newCategory: '',
                newCategoryName: '',
                saving: false,
                formData: {
                    question: '',
                    answer: '',
                    category: '',
                    status: 'published',
                    order: 1
                },
                categoryFormData: {
                    name: '',
                    display_order: 0
                },

                get canSave() {
                    const hasQuestion = this.formData.question.trim().length > 0;
                    const hasAnswer = this.formData.answer.trim().length > 0;
                    const hasValidCategory = this.getValidCategory().length > 0;
                    return hasQuestion && hasAnswer && hasValidCategory;
                },
                sortable: null,

                async init() {
                    console.log('üéø Alpine init() called');
                    console.log('‚úÖ FAQ API already initialized (Alpine started after API ready)');

                    // „Ç´„ÉÜ„Ç¥„É™„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø
                    await this.loadCategories();
                    // FAQ„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø
                    await this.loadFAQs();
                    this.filterFAQs();

                    // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„ÅÆÂàùÊúüÂåñ
                    this.$nextTick(() => {
                        this.initSortable();
                    });
                },

                async loadCategories() {
                    try {
                        // Alpine.js„ÅØFAQ APIÂàùÊúüÂåñÂæå„Å´„Åó„ÅãËµ∑Âãï„Åó„Å™„ÅÑ„Åü„ÇÅ„ÄÅsupabaseAPI„ÅØÂøÖ„ÅöÂà©Áî®ÂèØËÉΩ
                        if (!window.supabaseAPI) {
                            console.error('‚ùå CRITICAL: supabaseAPI not available despite controlled startup');
                            return;
                        }

                        const categories = await window.supabaseAPI.faq.getCategories();
                        if (categories && categories.length > 0) {
                            this.categoryObjects = categories;
                            this.categories = categories.map(c => c.name);

                            // Build category map: name -> id
                            this.categoryMap = {};
                            categories.forEach(cat => {
                                this.categoryMap[cat.name] = cat.id;
                            });

                            console.log('‚úÖ FAQ categories loaded:', this.categories);
                            console.log('   Category map:', this.categoryMap);
                        } else {
                            console.warn('‚ö†Ô∏è No FAQ categories found in database');
                        }
                    } catch (error) {
                        console.error('‚ùå Error loading FAQ categories:', error);
                    }
                },

                async loadFAQs() {
                    try {
                        // init()„ÅßÊó¢„Å´supabaseAPI„ÅÆÂæÖÊ©ü„ÅØÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Çã„ÅÆ„Åß„ÄÅ„Åì„Åì„Åß„ÅØ‰∏çË¶Å
                        if (window.supabaseAPI && window.supabase) {
                            console.log('Loading FAQs from Supabase...');
                            this.faqs = await window.supabaseAPI.faq.getItems();
                            const categories = await window.supabaseAPI.faq.getCategories();

                            // „Ç´„ÉÜ„Ç¥„É™Âêç„ÅÆ„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
                            if (categories && categories.length > 0) {
                                this.categories = categories.map(cat => cat.name);
                            }

                            // faq_categories„Å®„ÅÆÈñ¢ÈÄ£‰ªò„Åë„ÇíÂá¶ÁêÜ
                            if (this.faqs && this.faqs.length > 0) {
                                this.faqs = this.faqs.map(faq => {
                                    // „Ç´„ÉÜ„Ç¥„É™ID„Åã„ÇâÂêçÂâç„ÇíÂèñÂæó
                                    const category = categories.find(cat => cat.id === faq.category_id);
                                    return {
                                        ...faq,
                                        category: category ? category.name : faq.category || '„Åù„ÅÆ‰ªñ',
                                        order: faq.display_order || faq.order || 0
                                    };
                                });
                            }

                            // „ÉÜ„Çπ„Éà„Éá„Éº„Çø„ÇíÂÆåÂÖ®„Å´Èô§Â§ñÔºà2Â∫¶„Å®Ë°®Á§∫„Åï„Åõ„Å™„ÅÑÔºâ
                            this.faqs = this.faqs.filter(faq => {
                                const question = (faq.question || '').toLowerCase();
                                const answer = (faq.answer || '').toLowerCase();
                                const isTestData =
                                    question.includes('„Å¶„Åô„Å®') ||
                                    question.includes('„ÉÜ„Çπ„Éà') ||
                                    question.includes('test') ||
                                    answer.includes('„Å¶„Åô„Å®') ||
                                    answer.includes('„ÉÜ„Çπ„Éà') ||
                                    answer.includes('test');

                                if (isTestData) {
                                    console.warn('‚ö†Ô∏è Test data filtered out:', faq.question);
                                }
                                return !isTestData;
                            });

                            console.log('Loaded FAQs from Supabase:', this.faqs.length);

                            // Supabase„Åã„ÇâÊ≠£Â∏∏„Å´„É≠„Éº„Éâ„Åß„Åç„ÅüÂ†¥Âêà„ÄÅlocalStorage„Çí„ÇØ„É™„Ç¢ÔºàÂè§„ÅÑ„Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÂâäÈô§Ôºâ
                            localStorage.removeItem('faq_data');
                        } else {
                            // LocalStorage„Åã„ÇâÂèñÂæó„ÇíË©¶„Åø„Çã
                            const localData = localStorage.getItem('faq_data');
                            if (localData) {
                                this.faqs = JSON.parse(localData).faqs || [];

                                // LocalStorage„Åã„Çâ„É≠„Éº„Éâ„Åó„ÅüÂ†¥Âêà„ÇÇ„ÉÜ„Çπ„Éà„Éá„Éº„Çø„ÇíÈô§Â§ñ
                                this.faqs = this.faqs.filter(faq => {
                                    const question = (faq.question || '').toLowerCase();
                                    const answer = (faq.answer || '').toLowerCase();
                                    return !question.includes('„Å¶„Åô„Å®') &&
                                           !question.includes('„ÉÜ„Çπ„Éà') &&
                                           !question.includes('test') &&
                                           !answer.includes('„Å¶„Åô„Å®') &&
                                           !answer.includes('„ÉÜ„Çπ„Éà') &&
                                           !answer.includes('test');
                                });
                            } else {
                                this.faqs = [];
                            }
                        }
                    } catch (error) {
                        console.error('Error loading FAQs:', error);
                        lifeXAPI.showToast('FAQ„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                        this.faqs = [];
                    }
                },

                initSortable() {
                    const list = document.getElementById('faqList');
                    if (list) {
                        this.sortable = new Sortable(list, {
                            handle: '.handle',
                            animation: 150,
                            onEnd: (evt) => {
                                this.reorderFAQs(evt.oldIndex, evt.newIndex);
                            }
                        });
                    }
                },

                filterFAQs() {
                    if (this.activeCategory === 'all') {
                        this.filteredFAQs = [...this.faqs];
                    } else {
                        this.filteredFAQs = this.faqs.filter(faq => faq.category === this.activeCategory);
                    }

                    // Ë°®Á§∫È†Ü„Åß„ÇΩ„Éº„ÉàÔºàdisplay_order„ÇÇËÄÉÊÖÆÔºâ
                    this.filteredFAQs.sort((a, b) => {
                        const orderA = a.display_order || a.order || 0;
                        const orderB = b.display_order || b.order || 0;
                        return orderA - orderB;
                    });
                },

                reorderFAQs(oldIndex, newIndex) {
                    if (oldIndex === newIndex) return;
                    
                    const moved = this.filteredFAQs.splice(oldIndex, 1)[0];
                    this.filteredFAQs.splice(newIndex, 0, moved);
                    
                    // È†ÜÁï™„ÇíÊõ¥Êñ∞
                    this.filteredFAQs.forEach((faq, index) => {
                        faq.order = index + 1;
                        const originalIndex = this.faqs.findIndex(f => f.id === faq.id);
                        if (originalIndex > -1) {
                            this.faqs[originalIndex].order = faq.order;
                        }
                    });
                    
                    this.saveFAQOrder();
                },

                openAddModal() {
                    this.editingFAQ = null;
                    this.formData = {
                        question: '',
                        answer: '',
                        category: '',
                        status: 'published',
                        order: this.faqs.length + 1
                    };
                    this.showModal = true;
                },

                editFAQ(faq) {
                    this.editingFAQ = faq;
                    this.formData = { ...faq };
                    this.showModal = true;
                },

                async saveFAQ() {
                    // ‰øùÂ≠ò‰∏≠„ÅÆÂ†¥Âêà„ÅØÈáçË§áÂÆüË°å„ÇíÈò≤„Åê
                    if (this.saving) {
                        return;
                    }

                    // „Ç´„ÉÜ„Ç¥„É™„Éá„Éº„Çø„ÅÆÁ¢∫Ë™ç
                    if (!this.categoryMap || Object.keys(this.categoryMap).length === 0) {
                        lifeXAPI.showToast('„Ç´„ÉÜ„Ç¥„É™„Éá„Éº„Çø„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
                        // „Ç´„ÉÜ„Ç¥„É™„ÇíÂÜçË™≠„ÅøËæº„Åø
                        await this.loadCategories();
                        if (!this.categoryMap || Object.keys(this.categoryMap).length === 0) {
                            return;
                        }
                    }

                    // „Éï„Ç©„Éº„É†„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
                    const validationResult = this.validateForm();
                    if (!validationResult.isValid) {
                        lifeXAPI.showToast(validationResult.message, 'error');
                        return;
                    }

                    // Êñ∞Ë¶è„Ç´„ÉÜ„Ç¥„É™„ÅÆÂá¶ÁêÜ
                    const category = await this.processCategory();
                    if (!category) {
                        lifeXAPI.showToast('ÊúâÂäπ„Å™„Ç´„ÉÜ„Ç¥„É™„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                        return;
                    }

                    // „Ç´„ÉÜ„Ç¥„É™„ÅÆÂ≠òÂú®Á¢∫Ë™ç
                    if (!this.categoryMap[category]) {
                        lifeXAPI.showToast(`„Ç´„ÉÜ„Ç¥„É™„Äå${category}„Äç„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ„Ç´„ÉÜ„Ç¥„É™„ÇíËøΩÂä†„Åó„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ`, 'error');
                        return;
                    }
                    
                    // FAQ„Éá„Éº„Çø„ÅÆÂá¶ÁêÜ
                    const faqData = {
                        ...this.formData,
                        category: category,
                        question: this.formData.question.trim(),
                        answer: this.formData.answer.trim(),
                        updated: new Date().toISOString()
                    };

                    // Á∑®ÈõÜ„É¢„Éº„Éâ„Åã„Å©„ÅÜ„Åã„ÇíÂÖà„Å´‰øùÂ≠òÔºàcloseModal()„ÅßeditingFAQ„Åå„ÇØ„É™„Ç¢„Åï„Çå„Çã„Åü„ÇÅÔºâ
                    const isEditing = !!this.editingFAQ;
                    const editingId = this.editingFAQ?.id;

                    // „Åô„Åê„Å´„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
                    this.closeModal();

                    // „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„Åß‰øùÂ≠òÂá¶ÁêÜ„ÇíÂÆüË°å
                    this.saving = true;

                    try {
                        if (isEditing) {
                            // Á∑®ÈõÜ„ÅÆÂ†¥Âêà
                            const index = this.faqs.findIndex(f => f.id === editingId);
                            if (index > -1) {
                                // ID„Çí‰øùÊåÅ
                                this.faqs[index] = {
                                    ...faqData,
                                    id: editingId
                                };
                                lifeXAPI.showToast('FAQ„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
                            } else {
                                throw new Error('Á∑®ÈõÜÂØæË±°„ÅÆFAQ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                            }
                        } else {
                            // Êñ∞Ë¶èËøΩÂä†„ÅÆÂ†¥Âêà
                            const newFAQ = {
                                ...faqData,
                                id: this.generateUniqueId(),
                                order: this.getNextOrder()
                            };
                            this.faqs.push(newFAQ);
                            lifeXAPI.showToast('FAQ„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü', 'success');
                        }
                        
                        // API„Å´‰øùÂ≠ò
                        await this.saveToAPI();
                        
                        // UIÊõ¥Êñ∞
                        this.filterFAQs();
                        
                    } catch (error) {
                        console.error('FAQ„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
                        lifeXAPI.showToast(`FAQ„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`, 'error');
                    } finally {
                        this.saving = false;
                    }
                },
                
                validateForm() {
                    // Ë≥™Âïè„ÅÆ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
                    if (!this.formData.question || this.formData.question.trim().length === 0) {
                        return { isValid: false, message: 'Ë≥™Âïè„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ' };
                    }
                    if (this.formData.question.trim().length > 200) {
                        return { isValid: false, message: 'Ë≥™Âïè„ÅØ200ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ' };
                    }
                    
                    // ÂõûÁ≠î„ÅÆ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
                    if (!this.formData.answer || this.formData.answer.trim().length === 0) {
                        return { isValid: false, message: 'ÂõûÁ≠î„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ' };
                    }
                    if (this.formData.answer.trim().length > 2000) {
                        return { isValid: false, message: 'ÂõûÁ≠î„ÅØ2000ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ' };
                    }
                    
                    // „Ç´„ÉÜ„Ç¥„É™„ÅÆ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
                    const category = this.getValidCategory();
                    if (!category) {
                        return { isValid: false, message: '„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû„Åæ„Åü„ÅØÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ' };
                    }
                    
                    return { isValid: true, message: '' };
                },
                
                getValidCategory() {
                    if (this.formData.category === 'new') {
                        return this.newCategory ? this.newCategory.trim() : '';
                    }
                    return this.formData.category;
                },
                
                async processCategory() {
                    if (this.formData.category === 'new' && this.newCategory) {
                        const trimmedCategory = this.newCategory.trim();
                        if (trimmedCategory.length === 0) {
                            return null;
                        }

                        // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
                        if (this.categories.includes(trimmedCategory)) {
                            // „Éï„Ç©„Éº„É†„Çí„É™„Çª„ÉÉ„Éà
                            this.newCategory = '';
                            return trimmedCategory;
                        }

                        try {
                            // Supabase„Å´Êñ∞Ë¶è„Ç´„ÉÜ„Ç¥„É™„Çí‰ΩúÊàê
                            if (window.supabase && window.supabase.from) {
                                // Êñ∞„Åó„ÅÑË°®Á§∫È†Ü„ÇíË®àÁÆó
                                const maxOrder = this.categoryObjects.reduce((max, cat) =>
                                    Math.max(max, cat.display_order || 0), 0);

                                // „Ç´„ÉÜ„Ç¥„É™„Çí‰ΩúÊàê
                                const { data, error } = await window.supabase
                                    .from('faq_categories')
                                    .insert([{
                                        name: trimmedCategory,
                                        display_order: maxOrder + 1,
                                        created_at: new Date().toISOString(),
                                        updated_at: new Date().toISOString()
                                    }])
                                    .select();

                                if (error) {
                                    console.error('„Ç´„ÉÜ„Ç¥„É™‰ΩúÊàê„Ç®„É©„Éº:', error);
                                    lifeXAPI.showToast('„Ç´„ÉÜ„Ç¥„É™„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                                    return null;
                                }

                                if (data && data.length > 0) {
                                    // „É≠„Éº„Ç´„É´„ÅÆ„Ç´„ÉÜ„Ç¥„É™„É™„Çπ„Éà„Å´ËøΩÂä†
                                    const newCategory = data[0];
                                    this.categoryObjects.push(newCategory);
                                    this.categories.push(newCategory.name);

                                    // „Ç´„ÉÜ„Ç¥„É™„Éû„ÉÉ„Éó„ÇíÊõ¥Êñ∞
                                    this.categoryMap[newCategory.name] = newCategory.id;

                                    console.log('‚úÖ New category created:', newCategory);
                                }
                            }
                        } catch (error) {
                            console.error('„Ç´„ÉÜ„Ç¥„É™‰ΩúÊàê„Ç®„É©„Éº:', error);
                            lifeXAPI.showToast('„Ç´„ÉÜ„Ç¥„É™„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                            return null;
                        }

                        // „Éï„Ç©„Éº„É†„Çí„É™„Çª„ÉÉ„Éà
                        this.newCategory = '';
                        return trimmedCategory;
                    }

                    return this.formData.category;
                },
                
                generateUniqueId() {
                    // Êï∞Â≠ó„Å®ÁèæÂú®ÊôÇÂàª„ÇíÁµÑ„ÅøÂêà„Çè„Åõ„Åü„É¶„Éã„Éº„ÇØID„ÇíÁîüÊàê
                    const timestamp = Date.now();
                    const random = Math.floor(Math.random() * 1000);
                    return `faq_${timestamp}_${random}`;
                },
                
                getNextOrder() {
                    // ÁèæÂú®„ÅÆÊúÄÂ§ßÈ†ÜÂ∫è + 1„ÇíËøî„Åô
                    const maxOrder = this.faqs.reduce((max, faq) => Math.max(max, faq.order || 0), 0);
                    return maxOrder + 1;
                },

                getCategoryIdByName(categoryName) {
                    // „Ç´„ÉÜ„Ç¥„É™Âêç„Åã„Çâcategory_id„ÇíÂèñÂæó
                    if (!categoryName) {
                        console.error('‚ùå Category name is empty!');
                        throw new Error('„Ç´„ÉÜ„Ç¥„É™Âêç„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    }

                    const categoryId = this.categoryMap[categoryName];
                    if (!categoryId) {
                        console.error(`‚ùå Category "${categoryName}" not found in categoryMap:`, this.categoryMap);
                        throw new Error(`„Ç´„ÉÜ„Ç¥„É™„Äå${categoryName}„Äç„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì`);
                    }

                    return categoryId;
                },

                async deleteFAQ(faq) {
                    if (confirm(`„Äå${faq.question}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                        try {
                            // Supabase„Åã„ÇâÂâäÈô§
                            if (window.supabaseAPI && faq.id && typeof faq.id === 'string' && faq.id.includes('-')) {
                                const result = await window.supabaseAPI.faq.delete(faq.id);
                                if (!result.success) {
                                    throw new Error(result.error || 'Delete failed');
                                }
                            }

                            // „É≠„Éº„Ç´„É´„ÅÆ„É™„Çπ„Éà„Åã„ÇâÂâäÈô§
                            this.faqs = this.faqs.filter(f => f.id !== faq.id);
                            this.filterFAQs();
                            lifeXAPI.showToast('FAQ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');

                            // LocalStorage„ÇÇÊõ¥Êñ∞
                            if (!window.supabaseAPI) {
                                this.saveToAPI();
                            }
                        } catch (error) {
                            console.error('FAQÂâäÈô§„Ç®„É©„Éº:', error);
                            lifeXAPI.showToast('FAQ„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                        }
                    }
                },

                closeModal() {
                    // ‰øùÂ≠ò‰∏≠„ÅÆÂ†¥Âêà„ÅØ„ÇØ„É≠„Éº„Ç∫„ÇíÈò≤„Åê
                    if (this.saving) {
                        return;
                    }
                    
                    this.showModal = false;
                    this.editingFAQ = null;
                    this.newCategory = '';
                    this.saving = false;
                    
                    // „Éï„Ç©„Éº„É†„Çí„É™„Çª„ÉÉ„Éà
                    this.formData = {
                        question: '',
                        answer: '',
                        category: '',
                        status: 'published',
                        order: 1
                    };
                },

                insertHTML(type) {
                    const textarea = document.querySelector('textarea[x-model="formData.answer"]');
                    const start = textarea.selectionStart;
                    const end = textarea.selectionEnd;
                    const text = this.formData.answer;
                    
                    let insertion = '';
                    switch(type) {
                        case 'bold':
                            insertion = '<strong>ÈÅ∏Êäû„Åó„Åü„ÉÜ„Ç≠„Çπ„Éà</strong>';
                            break;
                        case 'list':
                            insertion = '<ul class="mt-2 ml-4 list-disc">\n  <li>È†ÖÁõÆ1</li>\n  <li>È†ÖÁõÆ2</li>\n</ul>';
                            break;
                        case 'br':
                            insertion = '<br>';
                            break;
                    }
                    
                    this.formData.answer = text.substring(0, start) + insertion + text.substring(end);
                    
                    // „Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆ„ÇíË™øÊï¥
                    this.$nextTick(() => {
                        textarea.focus();
                        textarea.setSelectionRange(start + insertion.length, start + insertion.length);
                    });
                },

                async saveToAPI() {
                    try {
                        // Supabase API„ÅåÂà©Áî®ÂèØËÉΩ„Å´„Å™„Çã„Åæ„ÅßÂæÖÊ©ü
                        let retries = 0;
                        while (!window.supabaseAPI && retries < 50) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                            retries++;
                        }

                        // Supabase or LocalStorage
                        if (window.supabaseAPI) {
                            // Supabase„Å´‰øùÂ≠ò
                            for (const faq of this.faqs) {
                                if (faq.id && typeof faq.id === 'string' && faq.id.includes('-')) {
                                    // UUID„ÇíÊåÅ„Å§Êó¢Â≠ò„ÅÆFAQÔºàSupabase„Åã„ÇâÂèñÂæó„Åó„Åü„ÇÇ„ÅÆÔºâ‚Üí Êõ¥Êñ∞
                                    const categoryId = this.getCategoryIdByName(faq.category);

                                    const result = await window.supabaseAPI.faq.update(faq.id, {
                                        question: faq.question,
                                        answer: faq.answer,
                                        category_id: categoryId,
                                        tags: faq.tags || [],
                                        status: faq.status || 'published',
                                        display_order: faq.order || 0
                                    });

                                    if (!result.success) {
                                        console.error('FAQÊõ¥Êñ∞Â§±Êïó:', result.error);
                                        throw new Error(result.error);
                                    }
                                } else {
                                    // Êñ∞Ë¶èFAQ - Supabase„Å´‰ΩúÊàê
                                    const categoryId = this.getCategoryIdByName(faq.category);

                                    const result = await window.supabaseAPI.faq.create({
                                        question: faq.question,
                                        answer: faq.answer,
                                        category_id: categoryId,
                                        tags: faq.tags || [],
                                        status: faq.status || 'published',
                                        display_order: faq.order || 0
                                    });

                                    if (result && result.success) {
                                        // „É≠„Éº„Ç´„É´„ÅÆFAQ„ÅÆID„ÇíSupabase„ÅÆID„Å´Êõ¥Êñ∞
                                        faq.id = result.data.id;
                                    } else {
                                        console.error('FAQ‰ΩúÊàêÂ§±Êïó:', result.error);
                                        throw new Error(result.error);
                                    }
                                }
                            }
                            console.log('‚úÖ FAQs saved to Supabase');
                        } else {
                            // LocalStorage„Å´‰øùÂ≠òÔºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
                            localStorage.setItem('faq_data', JSON.stringify({ faqs: this.faqs }));
                            console.log('‚ö†Ô∏è Saved FAQs to localStorage (fallback)', this.faqs);
                        }

                        // Áµ±Ë®àÊõ¥Êñ∞„Ç§„Éô„É≥„Éà„ÇíÁô∫ÁÅ´
                        window.dispatchEvent(new CustomEvent('stats-updated'));
                    } catch (error) {
                        console.error('‚ùå FAQ‰øùÂ≠ò„Ç®„É©„Éº:', error);
                        // Supabase‰øùÂ≠òÂ§±ÊïóÊôÇ„ÅØLocalStorage„Å´„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                        localStorage.setItem('faq_data', JSON.stringify({ faqs: this.faqs }));
                        console.log('‚ö†Ô∏è Saved to localStorage due to error');
                        throw error;
                    }
                },

                async saveFAQOrder() {
                    try {
                        if (window.supabaseAPI) {
                            // Supabase„ÅßÈ†ÜÂ∫è„ÇíÊõ¥Êñ∞
                            for (const faq of this.faqs) {
                                if (faq.id && typeof faq.id === 'string' && faq.id.includes('-')) {
                                    const result = await window.supabaseAPI.faq.update(faq.id, {
                                        display_order: faq.order || 0
                                    });

                                    if (!result.success) {
                                        console.error('FAQÈ†ÜÂ∫èÊõ¥Êñ∞Â§±Êïó:', result.error);
                                    }
                                }
                            }
                            console.log('‚úÖ FAQ order updated in Supabase');
                        } else {
                            // LocalStorage„Å´‰øùÂ≠òÔºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
                            localStorage.setItem('faq_data', JSON.stringify({ faqs: this.faqs }));
                            console.log('‚ö†Ô∏è Saved FAQ order to localStorage');
                        }

                        // Áµ±Ë®àÊõ¥Êñ∞„Ç§„Éô„É≥„Éà„ÇíÁô∫ÁÅ´
                        window.dispatchEvent(new CustomEvent('stats-updated'));
                        lifeXAPI.showToast('Ë°®Á§∫È†Ü„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
                    } catch (error) {
                        console.error('FAQÈ†ÜÂ∫è‰øùÂ≠ò„Ç®„É©„Éº:', error);
                        lifeXAPI.showToast('Ë°®Á§∫È†Ü„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                    }
                },

                // „Ç´„ÉÜ„Ç¥„É™ÁÆ°ÁêÜÈñ¢Êï∞
                openCategoryModal() {
                    this.showCategoryModal = true;
                    this.editingCategory = null;
                    this.newCategoryName = '';
                },

                closeCategoryModal() {
                    this.showCategoryModal = false;
                    this.editingCategory = null;
                    this.newCategoryName = '';
                    this.categoryFormData = {
                        name: '',
                        display_order: 0
                    };
                },

                editCategoryItem(category) {
                    this.editingCategory = category;
                    this.categoryFormData = {
                        name: category.name,
                        display_order: category.display_order || 0
                    };
                },

                async saveCategoryEdit() {
                    if (!this.editingCategory) return;

                    const trimmedName = this.categoryFormData.name.trim();
                    if (!trimmedName) {
                        lifeXAPI.showToast('„Ç´„ÉÜ„Ç¥„É™Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                        return;
                    }

                    try {
                        // window.supabase„ÅåÂà©Áî®ÂèØËÉΩ„Å´„Å™„Çã„Åæ„ÅßÂæÖÊ©ü
                        let retries = 0;
                        while ((!window.supabase || !window.supabase.from) && retries < 50) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                            retries++;
                        }

                        if (window.supabase && window.supabase.from) {
                            // Áõ¥Êé•Supabase„Çí‰ΩøÁî®„Åó„Å¶„Ç´„ÉÜ„Ç¥„É™„ÇíÊõ¥Êñ∞
                            const { data, error } = await window.supabase
                                .from('faq_categories')
                                .update({
                                    name: trimmedName,
                                    display_order: this.categoryFormData.display_order,
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', this.editingCategory.id)
                                .select();

                            if (error) {
                                console.error('„Ç´„ÉÜ„Ç¥„É™Êõ¥Êñ∞„Ç®„É©„Éº:', error);
                                lifeXAPI.showToast('„Ç´„ÉÜ„Ç¥„É™„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                                return;
                            }

                            // „É≠„Éº„Ç´„É´„ÅÆ„Ç´„ÉÜ„Ç¥„É™„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
                            const index = this.categoryObjects.findIndex(c => c.id === this.editingCategory.id);
                            if (index > -1) {
                                this.categoryObjects[index].name = trimmedName;
                                this.categoryObjects[index].display_order = this.categoryFormData.display_order;
                            }

                            // „Ç´„ÉÜ„Ç¥„É™Âêç„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
                            this.categories = this.categoryObjects.map(c => c.name);

                            // „Ç´„ÉÜ„Ç¥„É™„Éû„ÉÉ„Éó„ÇíÂÜçÊßãÁØâ
                            this.categoryMap = {};
                            this.categoryObjects.forEach(cat => {
                                this.categoryMap[cat.name] = cat.id;
                            });

                            lifeXAPI.showToast('„Ç´„ÉÜ„Ç¥„É™„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
                            this.editingCategory = null;
                        } else {
                            throw new Error('Supabase„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                        }
                    } catch (error) {
                        console.error('„Ç´„ÉÜ„Ç¥„É™Êõ¥Êñ∞„Ç®„É©„Éº:', error);
                        lifeXAPI.showToast('„Ç´„ÉÜ„Ç¥„É™„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                    }
                },

                cancelCategoryEdit() {
                    this.editingCategory = null;
                    this.categoryFormData = {
                        name: '',
                        display_order: 0
                    };
                },

                async deleteCategoryItem(category) {
                    // „Åì„ÅÆ„Ç´„ÉÜ„Ç¥„É™„Å´Â±û„Åô„ÇãFAQ„Åå„ÅÇ„Çã„ÅãÁ¢∫Ë™ç
                    const faqsInCategory = this.faqs.filter(faq => faq.category === category.name);
                    if (faqsInCategory.length > 0) {
                        lifeXAPI.showToast('„Åì„ÅÆ„Ç´„ÉÜ„Ç¥„É™„Å´„ÅØFAQ„ÅåÂ≠òÂú®„Åô„Çã„Åü„ÇÅÂâäÈô§„Åß„Åç„Åæ„Åõ„Çì', 'error');
                        return;
                    }

                    if (!confirm(`„Ç´„ÉÜ„Ç¥„É™„Äå${category.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                        return;
                    }

                    try {
                        // window.supabase„ÅåÂà©Áî®ÂèØËÉΩ„Å´„Å™„Çã„Åæ„ÅßÂæÖÊ©ü
                        let retries = 0;
                        while ((!window.supabase || !window.supabase.from) && retries < 50) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                            retries++;
                        }

                        if (window.supabase && window.supabase.from) {
                            // Áõ¥Êé•Supabase„Çí‰ΩøÁî®„Åó„Å¶„Ç´„ÉÜ„Ç¥„É™„ÇíÂâäÈô§
                            const { error } = await window.supabase
                                .from('faq_categories')
                                .delete()
                                .eq('id', category.id);

                            if (error) {
                                console.error('„Ç´„ÉÜ„Ç¥„É™ÂâäÈô§„Ç®„É©„Éº:', error);
                                lifeXAPI.showToast('„Ç´„ÉÜ„Ç¥„É™„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                                return;
                            }

                            // „É≠„Éº„Ç´„É´„ÅÆ„Ç´„ÉÜ„Ç¥„É™„É™„Çπ„Éà„Åã„ÇâÂâäÈô§
                            this.categoryObjects = this.categoryObjects.filter(c => c.id !== category.id);
                            this.categories = this.categoryObjects.map(c => c.name);

                            // „Ç´„ÉÜ„Ç¥„É™„Éû„ÉÉ„Éó„ÇíÂÜçÊßãÁØâ
                            this.categoryMap = {};
                            this.categoryObjects.forEach(cat => {
                                this.categoryMap[cat.name] = cat.id;
                            });

                            lifeXAPI.showToast('„Ç´„ÉÜ„Ç¥„É™„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
                        } else {
                            throw new Error('Supabase„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                        }
                    } catch (error) {
                        console.error('„Ç´„ÉÜ„Ç¥„É™ÂâäÈô§„Ç®„É©„Éº:', error);
                        lifeXAPI.showToast('„Ç´„ÉÜ„Ç¥„É™„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                    }
                },

                async addNewCategory() {
                    const trimmedName = this.newCategoryName.trim();
                    if (!trimmedName) {
                        lifeXAPI.showToast('„Ç´„ÉÜ„Ç¥„É™Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                        return;
                    }

                    // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
                    if (this.categories.includes(trimmedName)) {
                        lifeXAPI.showToast('„Åì„ÅÆ„Ç´„ÉÜ„Ç¥„É™Âêç„ÅØÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô', 'error');
                        return;
                    }

                    try {
                        // window.supabase„ÅåÂà©Áî®ÂèØËÉΩ„Å´„Å™„Çã„Åæ„ÅßÂæÖÊ©ü
                        let retries = 0;
                        while ((!window.supabase || !window.supabase.from) && retries < 50) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                            retries++;
                        }

                        if (window.supabase && window.supabase.from) {
                            // Êñ∞„Åó„ÅÑË°®Á§∫È†Ü„ÇíË®àÁÆó
                            const maxOrder = this.categoryObjects.reduce((max, cat) =>
                                Math.max(max, cat.display_order || 0), 0);

                            // Áõ¥Êé•Supabase„Çí‰ΩøÁî®„Åó„Å¶„Ç´„ÉÜ„Ç¥„É™„Çí‰ΩúÊàê
                            const { data, error } = await window.supabase
                                .from('faq_categories')
                                .insert([{
                                    name: trimmedName,
                                    display_order: maxOrder + 1,
                                    created_at: new Date().toISOString(),
                                    updated_at: new Date().toISOString()
                                }])
                                .select();

                            if (error) {
                                console.error('„Ç´„ÉÜ„Ç¥„É™‰ΩúÊàê„Ç®„É©„Éº:', error);
                                lifeXAPI.showToast('„Ç´„ÉÜ„Ç¥„É™„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                                return;
                            }

                            if (data && data.length > 0) {
                                // „É≠„Éº„Ç´„É´„ÅÆ„Ç´„ÉÜ„Ç¥„É™„É™„Çπ„Éà„Å´ËøΩÂä†
                                const newCategory = data[0];
                                this.categoryObjects.push(newCategory);
                                this.categories.push(newCategory.name);

                                // „Ç´„ÉÜ„Ç¥„É™„Éû„ÉÉ„Éó„ÇíÊõ¥Êñ∞
                                this.categoryMap[newCategory.name] = newCategory.id;

                                // ÂÖ•ÂäõÊ¨Ñ„Çí„ÇØ„É™„Ç¢
                                this.newCategoryName = '';

                                lifeXAPI.showToast('„Ç´„ÉÜ„Ç¥„É™„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü', 'success');
                            }
                        } else {
                            throw new Error('Supabase„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                        }
                    } catch (error) {
                        console.error('„Ç´„ÉÜ„Ç¥„É™‰ΩúÊàê„Ç®„É©„Éº:', error);
                        lifeXAPI.showToast('„Ç´„ÉÜ„Ç¥„É™„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                    }
                }
            };
        }
    </script>
</body>
</html>