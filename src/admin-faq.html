<!DOCTYPE html>
<html lang="ja" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>よくある質問管理 | LIFE X 管理画面</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>

    <link href="./styles/main.css" rel="stylesheet">
    <script src="/js/common.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <!-- Supabase Integration -->
    <script type="module" src="/js/supabase-integration.js"></script>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const supabaseUrl = 'https://tkemcbxqbrfqgmyswkjg.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRrZW1jYnhxYnJmcWdteXN3a2pnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3OTIwMjUsImV4cCI6MjA3NDM2ODAyNX0.UKHU7iTO35N3MuIzJYp9VVxB7ga2YDQ5Vrzd6Gf3k-I';
        window.supabase = createClient(supabaseUrl, supabaseKey);
    </script>

    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="h-full bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="/" class="text-xl font-bold text-gray-900 hover:text-gray-700">LIFE X</a>
                    <span class="ml-2 px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">管理者専用</span>
                </div>
                <nav class="hidden md:flex space-x-8 items-center">
                    <a href="/admin.html" class="nav-link">管理ホーム</a>
                    <a href="/admin-plans.html" class="nav-link">プラン管理</a>
                    <a href="/admin-rules.html" class="nav-link">ルール・ガイドライン管理</a>
                    <a href="/admin-downloads.html" class="nav-link">ダウンロード管理</a>
                    <a href="/admin-faq.html" class="nav-link active">よくある質問管理</a>
                    <a href="/admin-system.html" class="nav-link">システム管理</a>
                    <a href="/admin-report.html" class="nav-link">レポート</a>
                    <a href="/" class="nav-link">サイトに戻る</a>
                    <button @click="logout()" class="nav-link text-red-600 hover:text-red-800">ログアウト</button>
                </nav>
                <div id="userInfo" class="text-sm"></div>
            </div>
        </div>
    </header>

    <div x-data="adminFAQ()" x-init="init()">
        <!-- Page Header -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">よくある質問管理</h1>
                    <p class="text-gray-600 mt-2">FAQの追加・編集・削除・並び替えを管理</p>
                </div>
                <button @click="openAddModal()" class="btn-primary">
                    <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    新規FAQ追加
                </button>
            </div>

            <!-- カテゴリ別タブ -->
            <div class="card mb-6">
                <div class="flex space-x-1 border-b border-gray-200">
                    <button 
                        @click="activeCategory = 'all'"
                        :class="activeCategory === 'all' ? 'border-b-2 border-primary-500 text-primary-600' : 'text-gray-600 hover:text-gray-900'"
                        class="px-4 py-2 font-medium transition-colors">
                        すべて
                    </button>
                    <template x-for="category in categories" :key="category">
                        <button 
                            @click="activeCategory = category"
                            :class="activeCategory === category ? 'border-b-2 border-primary-500 text-primary-600' : 'text-gray-600 hover:text-gray-900'"
                            class="px-4 py-2 font-medium transition-colors"
                            x-text="category">
                        </button>
                    </template>
                </div>
            </div>

            <!-- FAQ リスト -->
            <div class="space-y-4" id="faqList">
                <template x-for="faq in filteredFAQs" :key="faq.id">
                    <div class="card hover:shadow-lg transition-shadow" :data-id="faq.id">
                        <div class="flex items-start">
                            <!-- ドラッグハンドル -->
                            <div class="handle cursor-move mr-4 mt-1">
                                <svg class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                                </svg>
                            </div>
                            
                            <!-- FAQ内容 -->
                            <div class="flex-1">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-3 mb-2">
                                            <span x-text="faq.category" class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded"></span>
                                            <span x-text="`表示順: ${faq.order}`" class="text-xs text-gray-500"></span>
                                            <span x-show="faq.status === 'active'" class="text-xs px-2 py-1 bg-green-100 text-green-800 rounded">公開中</span>
                                            <span x-show="faq.status === 'draft'" class="text-xs px-2 py-1 bg-gray-100 text-gray-800 rounded">下書き</span>
                                        </div>
                                        <h3 class="text-lg font-medium text-gray-900 mb-2" x-text="faq.question"></h3>
                                        <div class="text-sm text-gray-600" x-html="faq.answer.substring(0, 150) + (faq.answer.length > 150 ? '...' : '')"></div>
                                    </div>
                                    
                                    <!-- 操作ボタン -->
                                    <div class="flex items-center space-x-2 ml-4">
                                        <button @click="editFAQ(faq)" class="text-blue-600 hover:text-blue-900">
                                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                            </svg>
                                        </button>
                                        <button @click="deleteFAQ(faq)" class="text-red-600 hover:text-red-900">
                                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Add/Edit Modal -->
        <div x-show="showModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
            <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-3xl shadow-lg rounded-md bg-white mb-10">
                <div class="mt-3">
                    <h3 class="text-lg font-medium text-gray-900 mb-4" x-text="editingFAQ ? 'FAQ編集' : '新規FAQ追加'"></h3>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">カテゴリ</label>
                                <select x-model="formData.category" class="form-input w-full">
                                    <option value="">選択してください</option>
                                    <template x-for="category in categories" :key="category">
                                        <option :value="category" x-text="category"></option>
                                    </template>
                                    <option value="new">新規カテゴリを追加...</option>
                                </select>
                                <input 
                                    x-show="formData.category === 'new'"
                                    x-model="newCategory"
                                    type="text"
                                    placeholder="新しいカテゴリ名"
                                    class="form-input w-full mt-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ステータス</label>
                                <select x-model="formData.status" class="form-input w-full">
                                    <option value="active">公開中</option>
                                    <option value="draft">下書き</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">質問</label>
                            <input type="text" x-model="formData.question" class="form-input w-full" placeholder="よくある質問を入力">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">回答</label>
                            <div class="mb-2">
                                <button type="button" @click="insertHTML('bold')" class="text-sm px-2 py-1 bg-gray-100 rounded mr-1">太字</button>
                                <button type="button" @click="insertHTML('list')" class="text-sm px-2 py-1 bg-gray-100 rounded mr-1">リスト</button>
                                <button type="button" @click="insertHTML('br')" class="text-sm px-2 py-1 bg-gray-100 rounded">改行</button>
                            </div>
                            <textarea 
                                x-model="formData.answer" 
                                rows="8" 
                                class="form-input w-full" 
                                placeholder="回答を入力（HTML可）">
                            </textarea>
                            <p class="text-xs text-gray-500 mt-1">※ HTMLタグが使用可能です（&lt;br&gt;, &lt;ul&gt;, &lt;li&gt;, &lt;strong&gt; など）</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">プレビュー</label>
                            <div class="p-4 bg-gray-50 rounded border border-gray-200 min-h-[100px]" x-html="formData.answer || '（回答のプレビューがここに表示されます）'"></div>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-end space-x-3">
                        <button @click="closeModal()" class="btn-secondary" :disabled="saving">キャンセル</button>
                        <button @click="saveFAQ()" 
                                :disabled="saving || !canSave"
                                :class="saving || !canSave ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'btn-primary'"
                                class="px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                            <span x-show="!saving">保存</span>
                            <span x-show="saving" class="flex items-center">
                                <svg class="animate-spin -ml-1 mr-3 h-4 w-4 text-current" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                保存中...
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 簡易的なlifeXAPI実装（common.jsが読み込めない場合のフォールバック）
        if (!window.lifeXAPI) {
            window.lifeXAPI = {
                showToast(message, type) {
                    console.log(`[${type}] ${message}`);
                    // 簡易的なトースト表示
                    const toast = document.createElement('div');
                    toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 ${
                        type === 'error' ? 'bg-red-500' :
                        type === 'success' ? 'bg-green-500' :
                        'bg-blue-500'
                    }`;
                    toast.textContent = message;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                }
            };
        }

        // 簡易的な認証マネージャー
        window.authManager = {
            isAuthenticated() {
                // 簡易チェック - 本番環境では適切な認証を実装
                return true;
            },
            requireAuth() {
                if (!this.isAuthenticated()) {
                    window.location.href = '/admin-login.html';
                    return false;
                }
                return true;
            }
        };

        function adminFAQ() {
            return {
                faqs: [],
                filteredFAQs: [],
                categories: ['登録・ログイン', 'プラン・価格', '技術・仕様', 'サポート', 'その他'],
                // カテゴリIDマッピング（テストデータと同期）
                categoryMap: {
                    '登録・ログイン': '11111111-1111-1111-1111-111111111111',
                    'プラン・価格': '22222222-2222-2222-2222-222222222222',
                    '技術・仕様': '33333333-3333-3333-3333-333333333333',
                    'サポート': '44444444-4444-4444-4444-444444444444',
                    'その他': '55555555-5555-5555-5555-555555555555'
                },
                activeCategory: 'all',
                showModal: false,
                editingFAQ: null,
                newCategory: '',
                saving: false,
                formData: {
                    question: '',
                    answer: '',
                    category: '',
                    status: 'active',
                    order: 1
                },
                
                get canSave() {
                    const hasQuestion = this.formData.question.trim().length > 0;
                    const hasAnswer = this.formData.answer.trim().length > 0;
                    const hasValidCategory = this.getValidCategory().length > 0;
                    return hasQuestion && hasAnswer && hasValidCategory;
                },
                sortable: null,

                async init() {
                    // 認証チェック（オプション）
                    // if (!window.authManager.isAuthenticated()) {
                    //     window.location.href = '/admin-login.html';
                    //     return;
                    // }
                    
                    // FAQデータの読み込み
                    await this.loadFAQs();
                    this.filterFAQs();
                    
                    // ドラッグ&ドロップの初期化
                    this.$nextTick(() => {
                        this.initSortable();
                    });
                },

                async loadFAQs() {
                    try {
                        // Supabase APIが利用可能になるまで待機
                        let retries = 0;
                        while (!window.supabaseAPI && retries < 10) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                            retries++;
                        }

                        // Supabase or LocalStorage
                        if (window.supabaseAPI && window.supabase) {
                            console.log('Loading FAQs from Supabase...');
                            this.faqs = await window.supabaseAPI.faq.getItems();
                            const categories = await window.supabaseAPI.faq.getCategories();

                            // カテゴリ名のリストを更新
                            if (categories && categories.length > 0) {
                                this.categories = categories.map(cat => cat.name);
                            }

                            // faq_categoriesとの関連付けを処理
                            if (this.faqs && this.faqs.length > 0) {
                                this.faqs = this.faqs.map(faq => {
                                    // カテゴリIDから名前を取得
                                    const category = categories.find(cat => cat.id === faq.category_id);
                                    return {
                                        ...faq,
                                        category: category ? category.name : faq.category || 'その他',
                                        order: faq.display_order || faq.order || 0
                                    };
                                });
                            }
                            console.log('Loaded FAQs from Supabase:', this.faqs.length);
                        } else {
                            // LocalStorageから取得を試みる
                            const localData = localStorage.getItem('faq_data');
                            if (localData) {
                                this.faqs = JSON.parse(localData).faqs || [];
                            } else {
                                this.faqs = [];
                            }
                        }
                    } catch (error) {
                        console.error('Error loading FAQs:', error);
                        lifeXAPI.showToast('FAQデータの読み込みに失敗しました', 'error');
                        this.faqs = [];
                    }
                },

                initSortable() {
                    const list = document.getElementById('faqList');
                    if (list) {
                        this.sortable = new Sortable(list, {
                            handle: '.handle',
                            animation: 150,
                            onEnd: (evt) => {
                                this.reorderFAQs(evt.oldIndex, evt.newIndex);
                            }
                        });
                    }
                },

                filterFAQs() {
                    if (this.activeCategory === 'all') {
                        this.filteredFAQs = [...this.faqs];
                    } else {
                        this.filteredFAQs = this.faqs.filter(faq => faq.category === this.activeCategory);
                    }

                    // 表示順でソート（display_orderも考慮）
                    this.filteredFAQs.sort((a, b) => {
                        const orderA = a.display_order || a.order || 0;
                        const orderB = b.display_order || b.order || 0;
                        return orderA - orderB;
                    });
                },

                reorderFAQs(oldIndex, newIndex) {
                    if (oldIndex === newIndex) return;
                    
                    const moved = this.filteredFAQs.splice(oldIndex, 1)[0];
                    this.filteredFAQs.splice(newIndex, 0, moved);
                    
                    // 順番を更新
                    this.filteredFAQs.forEach((faq, index) => {
                        faq.order = index + 1;
                        const originalIndex = this.faqs.findIndex(f => f.id === faq.id);
                        if (originalIndex > -1) {
                            this.faqs[originalIndex].order = faq.order;
                        }
                    });
                    
                    this.saveFAQOrder();
                },

                openAddModal() {
                    this.editingFAQ = null;
                    this.formData = {
                        question: '',
                        answer: '',
                        category: '',
                        status: 'active',
                        order: this.faqs.length + 1
                    };
                    this.showModal = true;
                },

                editFAQ(faq) {
                    this.editingFAQ = faq;
                    this.formData = { ...faq };
                    this.showModal = true;
                },

                async saveFAQ() {
                    // 保存中の場合は重複実行を防ぐ
                    if (this.saving) {
                        return;
                    }
                    
                    // フォームバリデーション
                    const validationResult = this.validateForm();
                    if (!validationResult.isValid) {
                        lifeXAPI.showToast(validationResult.message, 'error');
                        return;
                    }

                    // 新規カテゴリの処理
                    const category = this.processCategory();
                    if (!category) {
                        lifeXAPI.showToast('有効なカテゴリを入力してください', 'error');
                        return;
                    }
                    
                    // FAQデータの処理
                    const faqData = {
                        ...this.formData,
                        category: category,
                        question: this.formData.question.trim(),
                        answer: this.formData.answer.trim(),
                        updated: new Date().toISOString()
                    };

                    // すぐにモーダルを閉じる
                    this.closeModal();
                    
                    // バックグラウンドで保存処理を実行
                    this.saving = true;
                    
                    try {
                        if (this.editingFAQ) {
                            // 編集の場合
                            const index = this.faqs.findIndex(f => f.id === this.editingFAQ.id);
                            if (index > -1) {
                                // IDを保持
                                this.faqs[index] = {
                                    ...faqData,
                                    id: this.editingFAQ.id
                                };
                                lifeXAPI.showToast('FAQを更新しました', 'success');
                            } else {
                                throw new Error('編集対象のFAQが見つかりません');
                            }
                        } else {
                            // 新規追加の場合
                            const newFAQ = {
                                ...faqData,
                                id: this.generateUniqueId(),
                                order: this.getNextOrder()
                            };
                            this.faqs.push(newFAQ);
                            lifeXAPI.showToast('FAQを追加しました', 'success');
                        }
                        
                        // APIに保存
                        await this.saveToAPI();
                        
                        // UI更新
                        this.filterFAQs();
                        
                    } catch (error) {
                        console.error('FAQの保存に失敗しました:', error);
                        lifeXAPI.showToast(`FAQの保存に失敗しました: ${error.message}`, 'error');
                    } finally {
                        this.saving = false;
                    }
                },
                
                validateForm() {
                    // 質問のバリデーション
                    if (!this.formData.question || this.formData.question.trim().length === 0) {
                        return { isValid: false, message: '質問を入力してください' };
                    }
                    if (this.formData.question.trim().length > 200) {
                        return { isValid: false, message: '質問は200文字以内で入力してください' };
                    }
                    
                    // 回答のバリデーション
                    if (!this.formData.answer || this.formData.answer.trim().length === 0) {
                        return { isValid: false, message: '回答を入力してください' };
                    }
                    if (this.formData.answer.trim().length > 2000) {
                        return { isValid: false, message: '回答は2000文字以内で入力してください' };
                    }
                    
                    // カテゴリのバリデーション
                    const category = this.getValidCategory();
                    if (!category) {
                        return { isValid: false, message: 'カテゴリを選択または入力してください' };
                    }
                    
                    return { isValid: true, message: '' };
                },
                
                getValidCategory() {
                    if (this.formData.category === 'new') {
                        return this.newCategory ? this.newCategory.trim() : '';
                    }
                    return this.formData.category;
                },
                
                processCategory() {
                    if (this.formData.category === 'new' && this.newCategory) {
                        const trimmedCategory = this.newCategory.trim();
                        if (trimmedCategory.length === 0) {
                            return null;
                        }
                        
                        // 新しいカテゴリを追加
                        if (!this.categories.includes(trimmedCategory)) {
                            this.categories.push(trimmedCategory);
                            this.categories.sort(); // アルファベット順にソート
                        }
                        
                        // フォームをリセット
                        this.newCategory = '';
                        return trimmedCategory;
                    }
                    
                    return this.formData.category;
                },
                
                generateUniqueId() {
                    // 数字と現在時刻を組み合わせたユニークIDを生成
                    const timestamp = Date.now();
                    const random = Math.floor(Math.random() * 1000);
                    return `faq_${timestamp}_${random}`;
                },
                
                getNextOrder() {
                    // 現在の最大順序 + 1を返す
                    const maxOrder = this.faqs.reduce((max, faq) => Math.max(max, faq.order || 0), 0);
                    return maxOrder + 1;
                },

                async deleteFAQ(faq) {
                    if (confirm(`「${faq.question}」を削除しますか？`)) {
                        try {
                            // Supabaseから削除
                            if (window.supabaseAPI && faq.id && typeof faq.id === 'string' && faq.id.includes('-')) {
                                const result = await window.supabaseAPI.faq.delete(faq.id);
                                if (!result.success) {
                                    throw new Error(result.error || 'Delete failed');
                                }
                            }

                            // ローカルのリストから削除
                            this.faqs = this.faqs.filter(f => f.id !== faq.id);
                            this.filterFAQs();
                            lifeXAPI.showToast('FAQを削除しました', 'success');

                            // LocalStorageも更新
                            if (!window.supabaseAPI) {
                                this.saveToAPI();
                            }
                        } catch (error) {
                            console.error('FAQ削除エラー:', error);
                            lifeXAPI.showToast('FAQの削除に失敗しました', 'error');
                        }
                    }
                },

                closeModal() {
                    // 保存中の場合はクローズを防ぐ
                    if (this.saving) {
                        return;
                    }
                    
                    this.showModal = false;
                    this.editingFAQ = null;
                    this.newCategory = '';
                    this.saving = false;
                    
                    // フォームをリセット
                    this.formData = {
                        question: '',
                        answer: '',
                        category: '',
                        status: 'active',
                        order: 1
                    };
                },

                insertHTML(type) {
                    const textarea = document.querySelector('textarea[x-model="formData.answer"]');
                    const start = textarea.selectionStart;
                    const end = textarea.selectionEnd;
                    const text = this.formData.answer;
                    
                    let insertion = '';
                    switch(type) {
                        case 'bold':
                            insertion = '<strong>選択したテキスト</strong>';
                            break;
                        case 'list':
                            insertion = '<ul class="mt-2 ml-4 list-disc">\n  <li>項目1</li>\n  <li>項目2</li>\n</ul>';
                            break;
                        case 'br':
                            insertion = '<br>';
                            break;
                    }
                    
                    this.formData.answer = text.substring(0, start) + insertion + text.substring(end);
                    
                    // カーソル位置を調整
                    this.$nextTick(() => {
                        textarea.focus();
                        textarea.setSelectionRange(start + insertion.length, start + insertion.length);
                    });
                },

                async saveToAPI() {
                    try {
                        // Supabase or LocalStorage
                        if (window.supabaseAPI) {
                            // Supabaseに保存
                            for (const faq of this.faqs) {
                                if (faq.id && typeof faq.id === 'string' && faq.id.includes('-')) {
                                    // UUIDを持つ既存のFAQ（Supabaseから取得したもの）
                                    // まだAPI未実装なのでスキップ
                                    console.log('Would update FAQ in Supabase:', faq);
                                } else {
                                    // 新規FAQ - Supabaseに作成
                                    // カテゴリ名からcategory_idを取得
                                    let categoryId = null;
                                    if (faq.category) {
                                        categoryId = this.categoryMap[faq.category] || this.categoryMap['その他'];
                                    }

                                    const result = await window.supabaseAPI.faq.create({
                                        question: faq.question,
                                        answer: faq.answer,
                                        category_id: categoryId,
                                        tags: faq.tags || [],
                                        status: faq.status || 'published',
                                        display_order: faq.order || 0
                                    });
                                    if (result && result.success) {
                                        faq.id = result.data.id;
                                    }
                                }
                            }
                            console.log('FAQs saved to Supabase');
                        } else {
                            // LocalStorageに保存
                            localStorage.setItem('faq_data', JSON.stringify({ faqs: this.faqs }));
                            console.log('Saved FAQs to localStorage', this.faqs);
                        }

                        // 統計更新イベントを発火
                        window.dispatchEvent(new CustomEvent('stats-updated'));
                    } catch (error) {
                        console.error('FAQ保存エラー:', error);
                        throw error;
                    }
                },

                async saveFAQOrder() {
                    try {
                        if (window.supabaseAPI) {
                            // Supabaseで順序を更新
                            for (const faq of this.faqs) {
                                if (faq.id && typeof faq.id === 'string' && faq.id.includes('-')) {
                                    // 実際のAPI実装時に更新処理を追加
                                    console.log('Would update FAQ order in Supabase:', faq.id, faq.order);
                                }
                            }
                        } else {
                            // LocalStorageに保存
                            localStorage.setItem('faq_data', JSON.stringify({ faqs: this.faqs }));
                            console.log('Saved FAQ order to localStorage');
                        }

                        // 統計更新イベントを発火
                        window.dispatchEvent(new CustomEvent('stats-updated'));
                        lifeXAPI.showToast('表示順を更新しました', 'success');
                    } catch (error) {
                        console.error('FAQ順序保存エラー:', error);
                        lifeXAPI.showToast('表示順の更新に失敗しました', 'error');
                    }
                }
            };
        }

        // 認証チェック（オプション）
        // if (window.authManager && !window.authManager.requireAuth()) {
        //     // requireAuth内でリダイレクトされる
        // }
    </script>
</body>
</html>