<!DOCTYPE html>
<html lang="ja" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>お知らせ管理 | LIFE X</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>

    <link href="./styles/main.css" rel="stylesheet">
    <script src="/js/common.js"></script>

    <!-- Supabase Auth Guard (Admin Only) -->
    <script type="module">
        import { protectPage } from '/js/auth-guard.js';
        (async () => {
            await protectPage({ requireAdmin: true });
        })();
    </script>

    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="h-full bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="/" class="text-xl font-bold text-gray-900 hover:text-gray-700">LIFE X</a>
                    <span class="ml-2 px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">管理者専用</span>
                </div>
                <nav class="hidden md:flex space-x-8 items-center">
                    <a href="/admin.html" class="nav-link">管理ホーム</a>
                    <a href="/admin-plans.html" class="nav-link">プラン管理</a>
                    <a href="/admin-rules.html" class="nav-link">ルール管理</a>
                    <a href="/admin-downloads.html" class="nav-link">ダウンロード管理</a>
                    <a href="/admin-faq.html" class="nav-link">FAQ管理</a>
                    <a href="/admin-notifications.html" class="nav-link active">お知らせ管理</a>
                    <a href="/admin-users.html" class="nav-link">ユーザー管理</a>
                    <a href="/admin-profile.html" class="nav-link">プロフィール</a>
                    <a href="/admin-system.html" class="nav-link">システム管理</a>
                    <a href="/admin-report.html" class="nav-link">レポート</a>
                    <a href="/" class="nav-link">サイトに戻る</a>
                    <button onclick="logout()" type="button" class="nav-link text-red-600 hover:text-red-800">ログアウト</button>
                </nav>

                <!-- Mobile Menu -->
                <div class="md:hidden" x-data="{ mobileMenuOpen: false }">
                    <button @click="mobileMenuOpen = !mobileMenuOpen" type="button" class="text-gray-500 hover:text-gray-600">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>

                    <div x-show="mobileMenuOpen" class="absolute top-16 right-4 bg-white shadow-lg rounded-lg border border-gray-200 p-4 z-50 min-w-48" style="display: none;">
                        <a href="/admin.html" class="block py-2 text-sm text-gray-600">管理ホーム</a>
                        <a href="/admin-plans.html" class="block py-2 text-sm text-gray-600">プラン管理</a>
                        <a href="/admin-rules.html" class="block py-2 text-sm text-gray-600">ルール管理</a>
                        <a href="/admin-downloads.html" class="block py-2 text-sm text-gray-600">ダウンロード管理</a>
                        <a href="/admin-faq.html" class="block py-2 text-sm text-gray-600">FAQ管理</a>
                        <a href="/admin-notifications.html" class="block py-2 text-sm text-gray-900 font-medium">お知らせ管理</a>
                        <a href="/admin-users.html" class="block py-2 text-sm text-gray-600">ユーザー管理</a>
                        <a href="/admin-profile.html" class="block py-2 text-sm text-gray-600">プロフィール</a>
                        <a href="/admin-system.html" class="block py-2 text-sm text-gray-600">システム管理</a>
                        <a href="/admin-report.html" class="block py-2 text-sm text-gray-600">レポート</a>
                        <div class="border-t border-gray-200 mt-3 pt-3">
                            <a href="/" class="block py-2 text-sm text-gray-600">サイトに戻る</a>
                            <button onclick="logout()" type="button" class="block py-2 text-sm text-red-600 hover:text-red-800 text-left w-full">ログアウト</button>
                        </div>
                    </div>
                </div>

                <div id="userInfo" class="hidden md:block text-sm"></div>
            </div>
        </div>
    </header>

    <div x-data="notificationsManager()" x-init="init()">
        <!-- Page Header -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900">お知らせ管理</h1>
                <p class="text-gray-600 mt-2">加盟店向けお知らせの作成・編集・削除</p>
            </div>

            <!-- アクションボタン -->
            <div class="mb-6">
                <button type="button" @click="openCreateModal()" class="btn-primary">
                    <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    新規お知らせ作成
                </button>
            </div>

            <!-- お知らせ一覧 -->
            <div class="card">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">タイトル</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">カテゴリ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">対象</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">優先度</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ステータス</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">公開日</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">操作</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="notification in notifications" :key="notification.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 text-sm font-medium text-gray-900" x-text="notification.title"></td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 py-1 text-xs rounded-full"
                                              :class="{
                                                  'bg-blue-100 text-blue-800': notification.category === 'plan',
                                                  'bg-green-100 text-green-800': notification.category === 'rule',
                                                  'bg-purple-100 text-purple-800': notification.category === 'download',
                                                  'bg-orange-100 text-orange-800': notification.category === 'faq',
                                                  'bg-red-100 text-red-800': notification.category === 'system',
                                                  'bg-gray-100 text-gray-800': notification.category === 'general'
                                              }"
                                              x-text="getCategoryLabel(notification.category)"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="getTargetLabel(notification.target_role)"></td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 py-1 text-xs rounded-full"
                                              :class="{
                                                  'bg-red-100 text-red-800': notification.priority === 'high',
                                                  'bg-yellow-100 text-yellow-800': notification.priority === 'normal',
                                                  'bg-gray-100 text-gray-800': notification.priority === 'low'
                                              }"
                                              x-text="getPriorityLabel(notification.priority)"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 py-1 text-xs rounded-full"
                                              :class="{
                                                  'bg-green-100 text-green-800': notification.status === 'published',
                                                  'bg-yellow-100 text-yellow-800': notification.status === 'draft',
                                                  'bg-gray-100 text-gray-800': notification.status === 'archived'
                                              }"
                                              x-text="getStatusLabel(notification.status)"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatDate(notification.published_at)"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                        <button type="button" @click="editNotification(notification)" class="text-blue-600 hover:text-blue-900">編集</button>
                                        <button type="button" @click="deleteNotification(notification.id)" class="text-red-600 hover:text-red-900">削除</button>
                                    </td>
                                </tr>
                            </template>
                            <tr x-show="notifications.length === 0">
                                <td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">
                                    お知らせがありません
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 作成・編集モーダル -->
        <div x-show="showModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
            <div class="relative top-20 mx-auto p-6 border w-full max-w-2xl shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <h3 class="text-lg font-medium text-gray-900 mb-6" x-text="editingId ? 'お知らせ編集' : '新規お知らせ作成'"></h3>
                    <form @submit.prevent="saveNotification()" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">タイトル <span class="text-red-500">*</span></label>
                            <input type="text" x-model="formData.title" class="form-input w-full" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">内容 <span class="text-red-500">*</span></label>
                            <textarea x-model="formData.content" rows="6" class="form-input w-full" required></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">カテゴリ</label>
                                <select x-model="formData.category" class="form-input w-full">
                                    <option value="general">一般</option>
                                    <option value="plan">プラン</option>
                                    <option value="rule">ルール</option>
                                    <option value="download">ダウンロード</option>
                                    <option value="faq">FAQ</option>
                                    <option value="system">システム</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">優先度</label>
                                <select x-model="formData.priority" class="form-input w-full">
                                    <option value="low">低</option>
                                    <option value="normal">通常</option>
                                    <option value="high">高</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">対象</label>
                                <select x-model="formData.target_role" class="form-input w-full">
                                    <option value="all">全員</option>
                                    <option value="admin">管理者のみ</option>
                                    <option value="member">メンバーのみ</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ステータス</label>
                                <select x-model="formData.status" class="form-input w-full">
                                    <option value="draft">下書き</option>
                                    <option value="published">公開</option>
                                    <option value="archived">アーカイブ</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" @click="closeModal()" class="btn-secondary">キャンセル</button>
                            <button type="submit" class="btn-primary">保存</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { getCurrentUser } from '/js/supabase-auth.js';

        function notificationsManager() {
            return {
                notifications: [],
                showModal: false,
                editingId: null,
                currentUserId: null,
                formData: {
                    title: '',
                    content: '',
                    category: 'general',
                    priority: 'normal',
                    status: 'draft',
                    target_role: 'all'
                },

                async init() {
                    const { user, profile } = await getCurrentUser();
                    this.currentUserId = profile.id;
                    await this.loadNotifications();
                },

                async loadNotifications() {
                    try {
                        const { data, error } = await window.supabase
                            .from('notifications')
                            .select('*')
                            .order('created_at', { ascending: false });

                        if (error) throw error;
                        this.notifications = data || [];
                    } catch (error) {
                        console.error('Error loading notifications:', error);
                        lifeXAPI.showToast('お知らせの読み込みに失敗しました', 'error');
                    }
                },

                openCreateModal() {
                    this.editingId = null;
                    this.formData = {
                        title: '',
                        content: '',
                        category: 'general',
                        priority: 'normal',
                        status: 'draft',
                        target_role: 'all'
                    };
                    this.showModal = true;
                },

                editNotification(notification) {
                    this.editingId = notification.id;
                    this.formData = {
                        title: notification.title,
                        content: notification.content,
                        category: notification.category,
                        priority: notification.priority,
                        status: notification.status,
                        target_role: notification.target_role
                    };
                    this.showModal = true;
                },

                async saveNotification() {
                    try {
                        const data = {
                            ...this.formData,
                            published_at: this.formData.status === 'published' ? new Date().toISOString() : null,
                            created_by: this.currentUserId
                        };

                        if (this.editingId) {
                            // 更新
                            const { error } = await window.supabase
                                .from('notifications')
                                .update(data)
                                .eq('id', this.editingId);

                            if (error) throw error;
                            lifeXAPI.showToast('お知らせを更新しました', 'success');
                        } else {
                            // 新規作成
                            const { error } = await window.supabase
                                .from('notifications')
                                .insert([data]);

                            if (error) throw error;
                            lifeXAPI.showToast('お知らせを作成しました', 'success');
                        }

                        await this.loadNotifications();
                        this.closeModal();
                    } catch (error) {
                        console.error('Error saving notification:', error);
                        lifeXAPI.showToast('お知らせの保存に失敗しました', 'error');
                    }
                },

                async deleteNotification(id) {
                    if (!confirm('このお知らせを削除しますか？')) return;

                    try {
                        const { error } = await window.supabase
                            .from('notifications')
                            .delete()
                            .eq('id', id);

                        if (error) throw error;

                        await this.loadNotifications();
                        lifeXAPI.showToast('お知らせを削除しました', 'success');
                    } catch (error) {
                        console.error('Error deleting notification:', error);
                        lifeXAPI.showToast('お知らせの削除に失敗しました', 'error');
                    }
                },

                closeModal() {
                    this.showModal = false;
                    this.editingId = null;
                },

                getCategoryLabel(category) {
                    const labels = {
                        general: '一般',
                        plan: 'プラン',
                        rule: 'ルール',
                        download: 'ダウンロード',
                        faq: 'FAQ',
                        system: 'システム'
                    };
                    return labels[category] || category;
                },

                getTargetLabel(target) {
                    const labels = {
                        all: '全員',
                        admin: '管理者のみ',
                        member: 'メンバーのみ'
                    };
                    return labels[target] || target;
                },

                getPriorityLabel(priority) {
                    const labels = {
                        high: '高',
                        normal: '通常',
                        low: '低'
                    };
                    return labels[priority] || priority;
                },

                getStatusLabel(status) {
                    const labels = {
                        draft: '下書き',
                        published: '公開',
                        archived: 'アーカイブ'
                    };
                    return labels[status] || status;
                },

                formatDate(dateStr) {
                    if (!dateStr) return '-';
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('ja-JP', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                }
            };
        }

        window.notificationsManager = notificationsManager;
    </script>
</body>
</html>
