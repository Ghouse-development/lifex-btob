<!DOCTYPE html>
<html lang="ja" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プラン管理 | LIFE X 管理画面</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>

    <link href="./styles/main.css" rel="stylesheet">
    <script src="/js/common.js"></script>
    <script defer src="https://unpkg.com/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
</head>
<body class="h-full bg-gray-50">
    <style>
        /* モーダルのz-index管理 */
        .modal-overlay {
            z-index: 40;
            pointer-events: auto;
        }
        .modal-content {
            z-index: 50;
            pointer-events: auto;
            transition: none; /* ドラッグ時のちらつき防止 */
        }

        /* クリック阻害を防ぐ */
        .modal-content, .modal-content * {
            pointer-events: auto !important;
        }

        /* グローバル固定ボタンを非表示 */
        .global-fixed-cta {
            display: none !important;
        }

        /* モーダルフッターを常に表示 */
        .modal-footer {
            background: white !important;
            border-top: 1px solid #e5e7eb;
        }

        /* モーダルヘッダーのドラッグスタイル */
        .modal-header {
            cursor: grab;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .modal-header.dragging {
            cursor: grabbing;
        }

        /* モーダル本文の単一スクロール */
        .modal-body {
            overflow-y: auto;
            overflow-x: hidden;
            max-height: calc(90vh - 120px - 80px); /* header + footer + margin */
        }

        /* 内部セクションのスクロール無効化 */
        .modal-body section,
        .modal-body .dropzone,
        .modal-body .file-upload-area,
        .modal-body .file-upload-item {
            overflow: visible !important;
            max-height: none !important;
        }

        /* 入力欄の統一スタイル */
        .form-field > span {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.25rem;
        }

        .input {
            width: 100%;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            background-color: white;
            padding: 0.5rem 0.75rem;
            color: #111827;
            transition: all 0.15s;
        }

        .input:hover {
            border-color: #9ca3af;
        }

        .input:focus {
            outline: none;
            border-color: #3b82f6;
            ring: 2px;
            ring-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .input::placeholder {
            color: #9ca3af;
        }

        .input:disabled, .input[readonly] {
            background-color: #f9fafb;
            cursor: not-allowed;
        }

        /* ドロップゾーンスタイル */
        .dropzone {
            border-radius: 0.75rem;
            border: 2px dashed #d1d5db;
            background-color: #f9fafb;
            height: 8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .dropzone:hover {
            border-color: #60a5fa;
            background-color: #eff6ff;
        }

        .file-upload-area:hover {
            background-color: rgba(59, 130, 246, 0.05);
        }
        .file-upload-item input:checked + label div {
            background-color: rgba(34, 197, 94, 0.1);
            border-color: rgb(34, 197, 94);
        }
        .file-upload-item.drag-over > div {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
        }
        .form-input {
            @apply mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm;
        }
        .btn-primary {
            @apply inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500;
        }
        .btn-secondary {
            @apply inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500;
        }
    </style>
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="/" class="text-xl font-bold text-gray-900 hover:text-gray-700">LIFE X</a>
                    <span class="ml-2 px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">管理者専用</span>
                </div>
                <nav class="hidden md:flex space-x-8 items-center">
                    <a href="/admin.html" class="nav-link">管理ホーム</a>
                    <a href="/admin-plans.html" class="nav-link active">プラン管理</a>
                    <a href="/admin-rules.html" class="nav-link">ルール・ガイドライン管理</a>
                    <a href="/admin-downloads.html" class="nav-link">ダウンロード管理</a>
                    <a href="/admin-faq.html" class="nav-link">よくある質問管理</a>
                    <a href="/admin-system.html" class="nav-link">システム管理</a>
                    <a href="/admin-report.html" class="nav-link">レポート</a>
                    <a href="/" class="nav-link">サイトに戻る</a>
                    <button @click="logout()" class="nav-link text-red-600 hover:text-red-800">ログアウト</button>
                </nav>
                <div id="userInfo" class="text-sm"></div>
            </div>
        </div>
    </header>

    <div x-data="adminPlans()" x-init="init()">
        <!-- Page Header -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">プラン管理</h1>
                    <p class="text-gray-600 mt-2">住宅プランの追加・編集・削除を管理</p>
                </div>
                <button @click="openAddModal()" class="btn-primary">
                    <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    新規プラン追加
                </button>
            </div>

            <!-- Filter & Search -->
            <div class="card mb-6">
                <div class="flex flex-col md:flex-row gap-4">
                    <input type="text" 
                           x-model="searchQuery"
                           @input="filterPlans()"
                           placeholder="プランコードで検索..." 
                           class="form-input flex-1">
                    <select x-model="filterCategory" @change="filterPlans()" class="form-input">
                        <option value="">全てのカテゴリ</option>
                        <option value="30坪">30坪</option>
                        <option value="33坪">33坪</option>
                        <option value="35坪">35坪</option>
                        <option value="平屋">平屋</option>
                        <option value="2階建て">2階建て</option>
                    </select>
                    <select x-model="sortBy" @change="sortPlans()" class="form-input">
                        <option value="updated">更新日順</option>
                        <option value="id">プランコード順</option>
                        <option value="tsubo">坪数順</option>
                        <option value="sellPrice">販売価格順</option>
                    </select>
                </div>
            </div>

            <!-- Plans Table -->
            <div class="card">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">プランコード</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">階数</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">坪数</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">間口×奥行</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">間取り</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">販売価格<span class="text-red-500 ml-1">(税込)</span></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">原価<span class="text-blue-500 ml-1">(税別)</span></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">粗利益<span class="text-blue-500 ml-1">(税別)</span></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ステータス</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">更新日</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="plan in filteredPlans" :key="plan.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap text-left text-sm font-medium">
                                        <button @click="editPlan(plan)" class="text-blue-600 hover:text-blue-900 mr-3">編集</button>
                                        <button @click="deletePlan(plan)" class="text-red-600 hover:text-red-900">削除</button>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="plan.id"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <span x-text="plan.floors == 1 ? '平屋' : plan.floors == 2 ? '2階建て' : '3階建て'"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="`${plan.tsubo || plan.size}坪`"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="(plan.width && plan.depth) ? `${plan.width}×${plan.depth}mm` : '-'"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="plan.layout"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="`¥${((plan.prices?.sell || plan.sellPrice || plan.price || 0) / 10000).toLocaleString()}万円`"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="(plan.prices?.cost || plan.cost) ? `¥${((plan.prices?.cost || plan.cost) / 10000).toLocaleString()}万円` : '-'"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="(plan.prices?.gross || plan.grossProfit) ? `¥${((plan.prices?.gross || plan.grossProfit) / 10000).toLocaleString()}万円` : '-'"></td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span x-show="plan.status === 'published' || plan.status === 'active'" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                            公開中
                                        </span>
                                        <span x-show="plan.status === 'draft'" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                                            下書き
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="plan.updated || plan.updatedAt || '-'"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Add/Edit Modal -->
        <div x-show="showModal"
             x-data="modalDraggable()"
             @click.self="closeModal()"
             class="fixed inset-0 z-50 bg-black/40"
             style="display: none;">

            <!-- モーダルコンテナ -->
            <div class="modal-content fixed bg-white shadow-xl rounded-xl"
                 style="left: 5vw; top: 5vh; width: 90vw; max-width: 1200px; height: 90vh; display: flex; flex-direction: column;"
                 :style="`transform: translate(${dragPosition.x}px, ${dragPosition.y}px);`">
                <!-- ヘッダー（ドラッグ可能） -->
                <div class="modal-header px-6 py-4 border-b flex-shrink-0"
                     @mousedown="startDrag($event)"
                     @touchstart="startDrag($event)"
                     :class="{'dragging': isDragging}">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-bold text-gray-900" x-text="editingPlan ? 'プラン編集' : '新規プラン追加'"></h2>
                            <p class="text-sm text-gray-500 mt-1">プラン情報を入力してください</p>
                        </div>
                        <button type="button" @click.stop="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- フォーム全体 -->
                <form @submit.prevent="handleFormSubmit()" style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
                    <!-- スクロール可能な本文エリア（ここだけスクロール） -->
                    <div class="modal-body px-6 py-6 space-y-6" style="flex: 1; overflow-y: auto;">

                        <!-- 基本情報セクション -->
                        <section class="border border-gray-200 rounded-xl p-3 sm:p-5">
                            <h3 class="text-base font-semibold text-gray-900 mb-4">基本情報</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
                                    <label class="form-field">
                                        <span>プランコード <span class="text-red-500">*</span></span>
                                        <input type="text"
                                               x-model="formData.id"
                                               name="planCode"
                                               @input="validateField('id')"
                                               :class="formErrors.id ? 'border-red-300' : ''"
                                               class="input"
                                               placeholder="例：28-40-N-12-001"
                                               required>
                                        <div x-show="formErrors.id" class="text-red-500 text-xs mt-1" x-text="formErrors.id"></div>
                                    </label>
                                    <label class="form-field">
                                        <span>階数 <span class="text-red-500">*</span></span>
                                        <select x-model="formData.floors"
                                                name="floors"
                                                @change="updateFloorPlans(); validateField('floors')"
                                                :class="formErrors.floors ? 'border-red-300' : ''"
                                                class="input"
                                                required>
                                            <option value="" disabled>選択してください</option>
                                            <option value="1">平屋</option>
                                            <option value="2">2階建て</option>
                                            <option value="3">3階建て</option>
                                        </select>
                                        <div x-show="formErrors.floors" class="text-red-500 text-xs mt-1" x-text="formErrors.floors"></div>
                                    </label>
                                    <label class="form-field">
                                        <span>LDK階数</span>
                                        <select x-model="formData.ldkFloor" name="ldkFloor" class="input">
                                            <option value="1階">1階</option>
                                            <option value="2階">2階</option>
                                            <option value="3階">3階</option>
                                        </select>
                                    </label>
                                    <label class="form-field">
                                        <span>水廻り階数</span>
                                        <select x-model="formData.bathroomFloor" name="bathroomFloor" class="input">
                                            <option value="1階">1階</option>
                                            <option value="2階">2階</option>
                                            <option value="3階">3階</option>
                                        </select>
                                    </label>
                                    <label class="form-field">
                                        <span>坪数 <span class="text-red-500">*</span></span>
                                        <input type="number"
                                               x-model="formData.tsubo"
                                               name="tsubo"
                                               @input="validateField('tsubo')"
                                               :class="formErrors.tsubo ? 'border-red-300' : ''"
                                               class="input"
                                               placeholder="例：30"
                                               min="10"
                                               max="100"
                                               required>
                                        <div x-show="formErrors.tsubo" class="text-red-500 text-xs mt-1" x-text="formErrors.tsubo"></div>
                                    </label>
                                    <label class="form-field">
                                        <span>間口（mm） <span class="text-red-500">*</span></span>
                                        <input type="number"
                                               x-model="formData.width"
                                               name="width"
                                               @input="calculateTsubo(); validateField('width')"
                                               :class="formErrors.width ? 'border-red-300' : ''"
                                               class="input"
                                               placeholder="例：5460"
                                               min="3000"
                                               max="15000"
                                               required>
                                        <div x-show="formErrors.width" class="text-red-500 text-xs mt-1" x-text="formErrors.width"></div>
                                    </label>
                                    <label class="form-field">
                                        <span>奥行（mm） <span class="text-red-500">*</span></span>
                                        <input type="number"
                                               x-model="formData.depth"
                                               name="depth"
                                               @input="calculateTsubo(); validateField('depth')"
                                               :class="formErrors.depth ? 'border-red-300' : ''"
                                               class="input"
                                               placeholder="例：9100"
                                               min="3000"
                                               max="20000"
                                               required>
                                        <div x-show="formErrors.depth" class="text-red-500 text-xs mt-1" x-text="formErrors.depth"></div>
                                    </label>
                                    <label class="form-field">
                                        <span>間取り <span class="text-red-500">*</span></span>
                                        <select x-model="formData.layout"
                                                name="layout"
                                                @change="validateField('layout')"
                                                :class="formErrors.layout ? 'border-red-300' : ''"
                                                class="input"
                                                required>
                                            <option value="">選択してください</option>
                                            <option value="1LDK">1LDK</option>
                                            <option value="2LDK">2LDK</option>
                                            <option value="3LDK">3LDK</option>
                                            <option value="4LDK">4LDK</option>
                                            <option value="5LDK">5LDK</option>
                                            <option value="その他">その他</option>
                                        </select>
                                        <div x-show="formErrors.layout" class="text-red-500 text-xs mt-1" x-text="formErrors.layout"></div>
                                    </label>
                                    <label class="form-field md:col-span-2 lg:col-span-3">
                                        <span>説明</span>
                                        <textarea x-model="formData.description" name="description" rows="3" class="input h-24" placeholder="プランの特徴やポイントを入力してください"></textarea>
                                    </label>
                            </div>
                        </section>

                        <!-- 価格情報セクション -->
                        <section class="border border-gray-200 rounded-xl p-3 sm:p-5">
                            <h3 class="text-base font-semibold text-gray-900 mb-4">価格情報</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
                                    <label class="form-field">
                                        <span>想定販売価格（万円）<span class="text-red-500">*</span> <span class="ml-1 text-gray-400">税込</span></span>
                                        <select x-model="formData.sellPrice"
                                                name="sellPrice"
                                                @change="calculateProfits(); validateField('sellPrice')"
                                                :class="formErrors.sellPrice ? 'border-red-300' : ''"
                                                class="input"
                                                required>
                                            <option value="">選択してください</option>
                                            <option value="2200">2200万円</option>
                                            <option value="2400">2400万円</option>
                                            <option value="2500">2500万円</option>
                                            <option value="2610">2610万円</option>
                                            <option value="2720">2720万円</option>
                                            <option value="2830">2830万円</option>
                                            <option value="3000">3000万円</option>
                                            <option value="その他">その他（直接入力）</option>
                                        </select>
                                        <div x-show="formData.sellPrice === 'その他'" class="mt-2">
                                            <input type="number"
                                                   x-model="formData.customSellPrice"
                                                   name="customSellPrice"
                                                   @input="calculateProfits()"
                                                   class="input"
                                                   placeholder="事：3980"
                                                   min="1000"
                                                   max="10000">
                                        </div>
                                        <div x-show="formErrors.sellPrice" class="text-red-500 text-xs mt-1" x-text="formErrors.sellPrice"></div>
                                    </label>
                                    <label class="form-field">
                                        <span>想定原価（万円） <a class="text-blue-600 underline text-xs">税別</a></span>
                                        <input type="number"
                                               x-model="formData.cost"
                                               name="cost"
                                               @input="calculateProfits(); validateField('cost')"
                                               :class="formErrors.cost ? 'border-red-300' : ''"
                                               class="input"
                                               placeholder="例：1500"
                                               min="500"
                                               max="5000"
                                               required>
                                        <div x-show="formErrors.cost" class="text-red-500 text-xs mt-1" x-text="formErrors.cost"></div>
                                    </label>
                                    <div class="form-field">
                                        <span>想定粗利益（万円） <a class="text-blue-600 underline text-xs">税別</a></span>
                                        <input type="text" x-model="calculatedGrossProfit"
                                               class="input bg-green-50"
                                               name="priceGross"
                                               readonly>
                                        <p class="text-xs text-gray-400 mt-1">自動計算</p>
                                    </div>
                                    <label class="form-field">
                                        <span>UA値（W/㎡K）</span>
                                        <input type="number" x-model="formData.uaValue"
                                               name="ua"
                                               class="input"
                                               placeholder="0.87"
                                               step="0.01"
                                               min="0"
                                               max="2">
                                        <p class="text-[11px] text-gray-400 mt-1">外皮平均熱貫流率</p>
                                    </label>
                                    <label class="form-field">
                                        <span>一次エネルギー削減率（再エネなし）%</span>
                                        <input type="number" x-model="formData.energyReduction"
                                               name="bei"
                                               class="input"
                                               placeholder="20"
                                               min="0"
                                               max="100">
                                        <p class="text-[11px] text-gray-400 mt-1">BEI値から算出</p>
                                    </label>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:col-span-3 mt-4">
                                        <label class="form-field">
                                            <span>ステータス</span>
                                            <select x-model="formData.status" name="status" class="input">
                                                <option value="draft">下書き（非公開）</option>
                                                <option value="published">公開中</option>
                                            </select>
                                            <p class="text-xs text-gray-400 mt-1">下書きで保存後、内容を確認してから公開してください</p>
                                        </label>
                                        <label class="form-field">
                                            <span>設計担当者</span>
                                            <input type="text" x-model="formData.designer" name="designer" class="input" placeholder="設計者名">
                                        </label>
                                    </div>
                            </div>
                        </section>

                        <!-- 特徴タグセクション -->
                        <section class="border border-gray-200 rounded-xl p-5">
                            <h3 class="text-base font-semibold text-gray-900 mb-4">特徴タグ</h3>
                            <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">住空間特徴</label>
                                        <div class="flex flex-wrap gap-2">
                                            <template x-for="tag in ['吹抜', 'フリースペース', '書斎', '畳スペース', 'ヌック', 'ロフト']" :key="tag">
                                                <button type="button"
                                                        @click="toggleFeatureTag(tag)"
                                                        :class="formData.featureTags && formData.featureTags.includes(tag) ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-700 border-gray-300 hover:bg-blue-50 active:bg-blue-100'"
                                                        class="px-4 py-3 border rounded-lg text-sm sm:text-base transition-colors duration-200 flex items-center justify-center space-x-2 min-h-[44px]">
                                                    <span x-show="formData.featureTags && formData.featureTags.includes(tag)" class="text-white">✓</span>
                                                    <span x-text="tag"></span>
                                                </button>
                                            </template>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">収納設備</label>
                                        <div class="flex flex-wrap gap-2">
                                            <template x-for="tag in ['パントリー', 'ウォークインクローゼット', 'シューズクローク', 'ファミリークローク', 'リビング収納', '小屋裏収納']" :key="tag">
                                                <button type="button"
                                                        @click="toggleFeatureTag(tag)"
                                                        :class="formData.featureTags && formData.featureTags.includes(tag) ? 'bg-green-600 text-white border-green-600' : 'bg-white text-gray-700 border-gray-300 hover:bg-green-50 active:bg-green-100'"
                                                        class="px-4 py-3 border rounded-lg text-sm sm:text-base transition-colors duration-200 flex items-center justify-center space-x-2 min-h-[44px]">
                                                    <span x-show="formData.featureTags && formData.featureTags.includes(tag)" class="text-white">✓</span>
                                                    <span x-text="tag"></span>
                                                </button>
                                            </template>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">外部設備</label>
                                        <div class="flex flex-wrap gap-2">
                                            <template x-for="tag in ['バルコニー', 'ウッドデッキ', 'ガレージ', 'カーポート', '庫裏']" :key="tag">
                                                <button type="button"
                                                        @click="toggleFeatureTag(tag)"
                                                        :class="formData.featureTags && formData.featureTags.includes(tag) ? 'bg-purple-600 text-white border-purple-600' : 'bg-white text-gray-700 border-gray-300 hover:bg-purple-50 active:bg-purple-100'"
                                                        class="px-4 py-3 border rounded-lg text-sm sm:text-base transition-colors duration-200 flex items-center justify-center space-x-2 min-h-[44px]">
                                                    <span x-show="formData.featureTags && formData.featureTags.includes(tag)" class="text-white">✓</span>
                                                    <span x-text="tag"></span>
                                                </button>
                                            </template>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">カスタムタグ</label>
                                        <input type="text" x-model="formData.customTags" 
                                               class="form-input w-full" 
                                               placeholder="独自の特徴をカンマ区切りで入力（例: 太陽光発電, 床暖房, IHクッキングヒーター）">
                                        <div class="text-xs text-gray-500 mt-1">カスタムタグは自由に追加できます</div>
                                    </div>
                                    
                                    <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                                        <h5 class="font-medium text-blue-900 mb-2">選択されたタグ</h5>
                                        <div class="flex flex-wrap gap-1">
                                            <template x-for="tag in getAllSelectedTags()" :key="tag">
                                                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs" x-text="tag"></span>
                                            </template>
                                            <span x-show="getAllSelectedTags().length === 0" class="text-blue-600 text-sm">タグが選択されていません</span>
                                        </div>
                                    </div>
                            </div>
                        </section>

                        <!-- 画像・ファイルセクション -->
                        <section class="border border-gray-200 rounded-xl p-5">
                            <h3 class="text-base font-semibold text-gray-900 mb-4">画像・ファイル</h3>
                            <div class="grid grid-cols-2 gap-4">
                                    <!-- 外観パース -->
                                    <div>
                                        <label class="text-sm font-medium text-gray-700 mb-2 block">外観パース <span class="text-red-500">*</span></label>
                                        <div class="file-upload-item">
                                            <input type="file" @change="handleFileSelect($event, 'image', 'exterior')" accept="image/*" class="hidden" id="file-exterior">

                                            <!-- プレビューまたはアップロード領域 -->
                                            <template x-if="formData.files?.images?.exterior?.preview">
                                                <div class="relative border-2 border-green-300 rounded-lg overflow-hidden bg-green-50">
                                                    <img :src="formData.files.images.exterior.preview"
                                                         alt="外観パース"
                                                         class="w-full h-48 object-cover">
                                                    <div class="absolute top-2 right-2 flex gap-2">
                                                        <button type="button"
                                                                @click.stop="removeFile('image', 'exterior')"
                                                                class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-full shadow-lg transition-colors">
                                                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                            </svg>
                                                        </button>
                                                    </div>
                                                    <div class="p-2 bg-white bg-opacity-90">
                                                        <p class="text-sm text-green-600 font-medium truncate" x-text="formData.files.images.exterior.name"></p>
                                                        <p class="text-xs text-gray-500" x-text="(formData.files.images.exterior.size / 1024).toFixed(1) + ' KB'"></p>
                                                    </div>
                                                </div>
                                            </template>

                                            <template x-if="!formData.files?.images?.exterior?.preview">
                                                <div @drop="handleDrop($event, 'image', 'exterior')"
                                                     @dragover.prevent
                                                     @dragenter.prevent
                                                     @dragenter="$event.target.closest('.file-upload-item').classList.add('drag-over')"
                                                     @dragleave="$event.target.closest('.file-upload-item').classList.remove('drag-over')"
                                                     @click="document.getElementById('file-exterior').click()"
                                                     class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition-colors cursor-pointer min-h-[120px] sm:min-h-[100px] flex flex-col items-center justify-center active:bg-gray-100">
                                                    <div class="flex items-center justify-center mb-2">
                                                        <svg class="h-8 w-8 text-gray-400 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                        </svg>
                                                        <span class="font-medium text-gray-700">外観パース</span>
                                                    </div>
                                                    <span class="text-gray-500 text-sm">ドラッグ&ドロップまたはクリック</span>
                                                    <span class="text-gray-400 text-xs mt-1">JPG, PNG, WebP (5MB以下)</span>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                    
                                    <!-- 内観パース -->
                                    <div>
                                        <label class="text-sm font-medium text-gray-700 mb-2 block">内観パース <span class="text-red-500">*</span></label>
                                        <div class="file-upload-item">
                                            <input type="file" @change="handleFileSelect($event, 'image', 'interior')" accept="image/*" class="hidden" id="file-interior">

                                            <!-- プレビューまたはアップロード領域 -->
                                            <template x-if="formData.files?.images?.interior?.preview">
                                                <div class="relative border-2 border-green-300 rounded-lg overflow-hidden bg-green-50">
                                                    <img :src="formData.files.images.interior.preview"
                                                         alt="内観パース"
                                                         class="w-full h-48 object-cover">
                                                    <div class="absolute top-2 right-2 flex gap-2">
                                                        <button type="button"
                                                                @click.stop="removeFile('image', 'interior')"
                                                                class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-full shadow-lg transition-colors">
                                                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                            </svg>
                                                        </button>
                                                    </div>
                                                    <div class="p-2 bg-white bg-opacity-90">
                                                        <p class="text-sm text-green-600 font-medium truncate" x-text="formData.files.images.interior.name"></p>
                                                        <p class="text-xs text-gray-500" x-text="(formData.files.images.interior.size / 1024).toFixed(1) + ' KB'"></p>
                                                    </div>
                                                </div>
                                            </template>

                                            <template x-if="!formData.files?.images?.interior?.preview">
                                                <div @drop="handleDrop($event, 'image', 'interior')"
                                                     @dragover.prevent
                                                     @dragenter.prevent
                                                     @dragenter="$event.target.closest('.file-upload-item').classList.add('drag-over')"
                                                     @dragleave="$event.target.closest('.file-upload-item').classList.remove('drag-over')"
                                                     @click="document.getElementById('file-interior').click()"
                                                     class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition-colors cursor-pointer min-h-[120px] sm:min-h-[100px] flex flex-col items-center justify-center active:bg-gray-100">
                                                    <div class="flex items-center justify-center mb-2">
                                                        <svg class="h-8 w-8 text-gray-400 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                        </svg>
                                                        <span class="font-medium text-gray-700">内観パース</span>
                                                    </div>
                                                    <span class="text-gray-500 text-sm">ドラッグ&ドロップまたはクリック</span>
                                                    <span class="text-gray-400 text-xs mt-1">JPG, PNG, WebP (5MB以下)</span>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-lg mt-4">
                                <h4 class="text-base font-semibold text-gray-900 mb-4">間取り図アップロード</h4>
                                <div>
                                    <label class="text-sm font-medium text-gray-700 mb-2 block">間取り図（階数分登録） <span class="text-red-500">*</span></label>
                                    <template x-for="floor in Array.from({length: parseInt(formData.floors) || 1}, (_, i) => i + 1)" :key="floor">
                                        <div class="mb-3">
                                            <div class="file-upload-item">
                                                <input type="file" @change="handleFileSelect($event, 'floorPlan', floor)" accept="image/*" class="hidden" :id="'file-floor-' + floor">

                                                <!-- プレビューまたはアップロード領域 -->
                                                <template x-if="formData.files?.floorPlans?.[floor]?.preview">
                                                    <div class="relative border-2 border-green-300 rounded-lg overflow-hidden bg-green-50">
                                                        <img :src="formData.files.floorPlans[floor].preview"
                                                             :alt="`${floor}階間取り図`"
                                                             class="w-full h-40 object-contain bg-white">
                                                        <div class="absolute top-2 right-2">
                                                            <button type="button"
                                                                    @click.stop="removeFile('floorPlan', floor)"
                                                                    class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-full shadow-lg transition-colors">
                                                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                                </svg>
                                                            </button>
                                                        </div>
                                                        <div class="p-2 bg-white bg-opacity-90">
                                                            <p class="text-sm text-green-600 font-medium truncate" x-text="`${floor}階: ${formData.files.floorPlans[floor].name}`"></p>
                                                            <p class="text-xs text-gray-500" x-text="(formData.files.floorPlans[floor].size / 1024).toFixed(1) + ' KB'"></p>
                                                        </div>
                                                    </div>
                                                </template>

                                                <template x-if="!formData.files?.floorPlans?.[floor]?.preview">
                                                    <div
                                                        @drop="handleDrop($event, 'floorPlan', floor)"
                                                        @dragover.prevent
                                                        @dragenter.prevent
                                                        @dragenter="$event.target.closest('.file-upload-item').classList.add('drag-over')"
                                                        @dragleave="$event.target.closest('.file-upload-item').classList.remove('drag-over')"
                                                        @click="document.getElementById('file-floor-' + floor).click()"
                                                        class="border-2 border-dashed border-gray-300 rounded p-4 text-sm hover:bg-gray-50 transition-colors cursor-pointer min-h-[90px] sm:min-h-[70px] flex flex-col items-center justify-center active:bg-gray-100">
                                                        <div class="flex items-center justify-center mb-1">
                                                            <svg class="h-4 w-4 text-gray-400 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                            </svg>
                                                            <span class="font-medium" x-text="`${floor}階間取り図`"></span>
                                                        </div>
                                                        <span class="text-gray-500">ドラッグ&ドロップまたはクリック</span>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ファイルアップロード領域 -->
                        <div class="col-span-2 border-t pt-4 mt-4">
                            <h4 class="text-sm font-semibold text-gray-900 mb-3">プラン関連ファイル</h4>
                            
                            <!-- プレゼン資料 -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">プレゼン資料</label>
                                <div class="file-upload-item">
                                    <input type="file" @change="handleFileSelect($event, 'presentation')" accept=".pptx,.ppt,.pdf" class="hidden" id="file-presentation">

                                    <!-- プレビューまたはアップロード領域 -->
                                    <template x-if="formData.files?.presentation?.name">
                                        <div class="relative border-2 border-green-300 rounded-lg overflow-hidden bg-green-50">
                                            <div class="w-full h-32 bg-orange-50 flex items-center justify-center">
                                                <svg class="w-16 h-16 text-orange-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                                </svg>
                                            </div>
                                            <div class="absolute top-2 right-2">
                                                <button type="button" @click.stop="removeFile('presentation')" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-full shadow-lg transition-colors">
                                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                    </svg>
                                                </button>
                                            </div>
                                            <div class="p-2 bg-white bg-opacity-90">
                                                <p class="text-sm text-green-600 font-medium truncate" x-text="formData.files.presentation.name"></p>
                                                <p class="text-xs text-gray-500" x-text="(formData.files.presentation.size / 1024).toFixed(1) + ' KB'"></p>
                                            </div>
                                        </div>
                                    </template>

                                    <!-- 初回アップロード領域 -->
                                    <template x-if="!formData.files?.presentation?.name">
                                        <div @drop="handleDrop($event, 'presentation')" @dragover.prevent @dragenter.prevent @click="document.getElementById('file-presentation').click()" class="border-2 border-dashed border-gray-300 rounded p-4 text-center hover:bg-gray-50 transition-colors cursor-pointer min-h-[100px] flex flex-col items-center justify-center active:bg-gray-100">
                                            <svg class="h-10 w-10 text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                            </svg>
                                            <span class="text-gray-600 text-sm">プレゼン資料（PowerPoint, PDF）</span>
                                            <span class="text-gray-500 text-xs mt-1">ドラッグ&ドロップまたはクリック</span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            
                            <!-- 図面（アコーディオン化） -->
                            <div class="mb-4" x-data="{
                                equipmentOpen: false,
                                structureOpen: false,
                                presentationOpen: false,
                                optionOpen: false
                            }">
                                <label class="block text-sm font-medium text-gray-700 mb-2">図面（グループ別）</label>

                                <!-- 設備図面グループ -->
                                <div class="mb-2 border border-gray-200 rounded-lg overflow-hidden">
                                    <button type="button" @click="equipmentOpen = !equipmentOpen" class="w-full px-4 py-3 bg-gray-50 hover:bg-gray-100 flex justify-between items-center transition-colors">
                                        <span class="font-medium text-gray-700">🏠 設備図面（6種類）</span>
                                        <svg class="w-5 h-5 transition-transform" :class="equipmentOpen ? 'rotate-180' : ''" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </button>
                                    <div x-show="equipmentOpen" x-collapse class="p-3 bg-white">
                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                            <template x-for="drawing in ['キッチン', '洗面化粧台', 'システムバス', 'トイレ', '照明', '換気システム']" :key="drawing">
                                                <div class="mb-3">
                                                    <label class="block text-xs font-medium text-gray-600 mb-1" x-text="drawing"></label>
                                                    <div class="file-upload-item">
                                                        <input type="file" multiple @change="handleFileSelect($event, 'drawing', drawing)" accept=".pdf,.jpg,.jpeg,.png" class="hidden" :id="'file-' + drawing.replace(/[^a-zA-Z0-9]/g, '')">

                                                        <!-- プレビューまたはアップロード領域 -->
                                                        <template x-if="formData.files?.drawings?.[drawing]?.length > 0">
                                                            <div class="space-y-2">
                                                                <template x-for="(file, index) in formData.files.drawings[drawing]" :key="index">
                                                                    <div class="relative border-2 border-green-300 rounded-lg overflow-hidden bg-green-50">
                                                                        <!-- 画像プレビュー -->
                                                                        <template x-if="file.preview">
                                                                            <img :src="file.preview" :alt="file.name" class="w-full h-32 object-contain bg-white">
                                                                        </template>
                                                                        <!-- PDFプレビュー -->
                                                                        <template x-if="!file.preview">
                                                                            <div class="w-full h-32 bg-red-50 flex items-center justify-center">
                                                                                <svg class="w-12 h-12 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                                                                </svg>
                                                                            </div>
                                                                        </template>
                                                                        <!-- 削除ボタン -->
                                                                        <div class="absolute top-2 right-2">
                                                                            <button type="button" @click.stop="removeDrawingFile(drawing, index)" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-full shadow-lg transition-colors">
                                                                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                                                </svg>
                                                                            </button>
                                                                        </div>
                                                                        <!-- ファイル情報 -->
                                                                        <div class="p-2 bg-white bg-opacity-90">
                                                                            <p class="text-sm text-green-600 font-medium truncate" x-text="file.name"></p>
                                                                            <p class="text-xs text-gray-500" x-text="(file.size / 1024).toFixed(1) + ' KB'"></p>
                                                                        </div>
                                                                    </div>
                                                                </template>
                                                                <!-- 追加アップロード -->
                                                                <button type="button" @click="document.getElementById('file-' + drawing.replace(/[^a-zA-Z0-9]/g, '')).click()" class="w-full border-2 border-dashed border-gray-300 rounded p-2 text-xs hover:bg-gray-50 transition-colors active:bg-gray-100">
                                                                    + さらに追加
                                                                </button>
                                                            </div>
                                                        </template>

                                                        <!-- 初回アップロード領域 -->
                                                        <template x-if="!formData.files?.drawings?.[drawing] || formData.files.drawings[drawing].length === 0">
                                                            <div @drop="handleDrop($event, 'drawing', drawing)" @dragover.prevent @dragenter.prevent @click="document.getElementById('file-' + drawing.replace(/[^a-zA-Z0-9]/g, '')).click()" class="border-2 border-dashed border-gray-300 rounded p-3 text-xs hover:bg-gray-50 transition-colors cursor-pointer min-h-[90px] sm:min-h-[70px] flex flex-col items-center justify-center active:bg-gray-100">
                                                                <svg class="h-6 w-6 text-gray-400 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                                                </svg>
                                                                <span class="text-gray-500 text-center">ドラッグ&ドロップ<br>またはクリック</span>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>

                                <!-- 構造図面グループ -->
                                <div class="mb-2 border border-gray-200 rounded-lg overflow-hidden">
                                    <button type="button" @click="structureOpen = !structureOpen" class="w-full px-4 py-3 bg-gray-50 hover:bg-gray-100 flex justify-between items-center transition-colors">
                                        <span class="font-medium text-gray-700">🏗️ 構造図面（2種類）</span>
                                        <svg class="w-5 h-5 transition-transform" :class="structureOpen ? 'rotate-180' : ''" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </button>
                                    <div x-show="structureOpen" x-collapse class="p-3 bg-white">
                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                            <template x-for="drawing in ['実施図', '申請図・構造図・プレカット図']" :key="drawing">
                                                <div class="mb-3">
                                                    <label class="block text-xs font-medium text-gray-600 mb-1" x-text="drawing"></label>
                                                    <div class="file-upload-item">
                                                        <input type="file" multiple @change="handleFileSelect($event, 'drawing', drawing)" accept=".pdf,.jpg,.jpeg,.png" class="hidden" :id="'file-' + drawing.replace(/[^a-zA-Z0-9]/g, '')">
                                                        <template x-if="formData.files?.drawings?.[drawing]?.length > 0">
                                                            <div class="space-y-2">
                                                                <template x-for="(file, index) in formData.files.drawings[drawing]" :key="index">
                                                                    <div class="relative border-2 border-green-300 rounded-lg overflow-hidden bg-green-50">
                                                                        <template x-if="file.preview">
                                                                            <img :src="file.preview" :alt="file.name" class="w-full h-32 object-contain bg-white">
                                                                        </template>
                                                                        <template x-if="!file.preview">
                                                                            <div class="w-full h-32 bg-red-50 flex items-center justify-center">
                                                                                <svg class="w-12 h-12 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                                                                </svg>
                                                                            </div>
                                                                        </template>
                                                                        <div class="absolute top-2 right-2">
                                                                            <button type="button" @click.stop="removeDrawingFile(drawing, index)" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-full shadow-lg transition-colors">
                                                                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                                                </svg>
                                                                            </button>
                                                                        </div>
                                                                        <div class="p-2 bg-white bg-opacity-90">
                                                                            <p class="text-sm text-green-600 font-medium truncate" x-text="file.name"></p>
                                                                            <p class="text-xs text-gray-500" x-text="(file.size / 1024).toFixed(1) + ' KB'"></p>
                                                                        </div>
                                                                    </div>
                                                                </template>
                                                                <button type="button" @click="document.getElementById('file-' + drawing.replace(/[^a-zA-Z0-9]/g, '')).click()" class="w-full border-2 border-dashed border-gray-300 rounded p-2 text-xs hover:bg-gray-50 transition-colors active:bg-gray-100">+ さらに追加</button>
                                                            </div>
                                                        </template>
                                                        <template x-if="!formData.files?.drawings?.[drawing] || formData.files.drawings[drawing].length === 0">
                                                            <div @drop="handleDrop($event, 'drawing', drawing)" @dragover.prevent @dragenter.prevent @click="document.getElementById('file-' + drawing.replace(/[^a-zA-Z0-9]/g, '')).click()" class="border-2 border-dashed border-gray-300 rounded p-3 text-xs hover:bg-gray-50 transition-colors cursor-pointer min-h-[90px] sm:min-h-[70px] flex flex-col items-center justify-center active:bg-gray-100">
                                                                <svg class="h-6 w-6 text-gray-400 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                                                </svg>
                                                                <span class="text-gray-500 text-center">ドラッグ&ドロップ<br>またはクリック</span>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>

                                <!-- プレゼン図面グループ -->
                                <div class="mb-2 border border-gray-200 rounded-lg overflow-hidden">
                                    <button type="button" @click="presentationOpen = !presentationOpen" class="w-full px-4 py-3 bg-gray-50 hover:bg-gray-100 flex justify-between items-center transition-colors">
                                        <span class="font-medium text-gray-700">📊 プレゼン図面（4種類）</span>
                                        <svg class="w-5 h-5 transition-transform" :class="presentationOpen ? 'rotate-180' : ''" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </button>
                                    <div x-show="presentationOpen" x-collapse class="p-3 bg-white">
                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                            <template x-for="drawing in ['内装プレゼン（EXCEL）', '仕様書・外装プレゼン（EXCEL）', '建具プレゼン', 'サッシプレゼン']" :key="drawing">
                                                <div class="mb-3">
                                                    <label class="block text-xs font-medium text-gray-600 mb-1" x-text="drawing"></label>
                                                    <div class="file-upload-item">
                                                        <input type="file" multiple @change="handleFileSelect($event, 'drawing', drawing)" accept=".pdf,.jpg,.jpeg,.png,.xlsx,.xls" class="hidden" :id="'file-' + drawing.replace(/[^a-zA-Z0-9]/g, '')">
                                                        <template x-if="formData.files?.drawings?.[drawing]?.length > 0">
                                                            <div class="space-y-2">
                                                                <template x-for="(file, index) in formData.files.drawings[drawing]" :key="index">
                                                                    <div class="relative border-2 border-green-300 rounded-lg overflow-hidden bg-green-50">
                                                                        <template x-if="file.preview">
                                                                            <img :src="file.preview" :alt="file.name" class="w-full h-32 object-contain bg-white">
                                                                        </template>
                                                                        <template x-if="!file.preview">
                                                                            <div class="w-full h-32 bg-green-50 flex items-center justify-center">
                                                                                <svg class="w-12 h-12 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                                                </svg>
                                                                            </div>
                                                                        </template>
                                                                        <div class="absolute top-2 right-2">
                                                                            <button type="button" @click.stop="removeDrawingFile(drawing, index)" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-full shadow-lg transition-colors">
                                                                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                                                </svg>
                                                                            </button>
                                                                        </div>
                                                                        <div class="p-2 bg-white bg-opacity-90">
                                                                            <p class="text-sm text-green-600 font-medium truncate" x-text="file.name"></p>
                                                                            <p class="text-xs text-gray-500" x-text="(file.size / 1024).toFixed(1) + ' KB'"></p>
                                                                        </div>
                                                                    </div>
                                                                </template>
                                                                <button type="button" @click="document.getElementById('file-' + drawing.replace(/[^a-zA-Z0-9]/g, '')).click()" class="w-full border-2 border-dashed border-gray-300 rounded p-2 text-xs hover:bg-gray-50 transition-colors active:bg-gray-100">+ さらに追加</button>
                                                            </div>
                                                        </template>
                                                        <template x-if="!formData.files?.drawings?.[drawing] || formData.files.drawings[drawing].length === 0">
                                                            <div @drop="handleDrop($event, 'drawing', drawing)" @dragover.prevent @dragenter.prevent @click="document.getElementById('file-' + drawing.replace(/[^a-zA-Z0-9]/g, '')).click()" class="border-2 border-dashed border-gray-300 rounded p-3 text-xs hover:bg-gray-50 transition-colors cursor-pointer min-h-[90px] sm:min-h-[70px] flex flex-col items-center justify-center active:bg-gray-100">
                                                                <svg class="h-6 w-6 text-gray-400 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                                                </svg>
                                                                <span class="text-gray-500 text-center">ドラッグ&ドロップ<br>またはクリック</span>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>

                                <!-- オプション図面グループ -->
                                <div class="mb-2 border border-gray-200 rounded-lg overflow-hidden">
                                    <button type="button" @click="optionOpen = !optionOpen" class="w-full px-4 py-3 bg-gray-50 hover:bg-gray-100 flex justify-between items-center transition-colors">
                                        <span class="font-medium text-gray-700">⚡ オプション（2種類）</span>
                                        <svg class="w-5 h-5 transition-transform" :class="optionOpen ? 'rotate-180' : ''" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </button>
                                    <div x-show="optionOpen" x-collapse class="p-3 bg-white">
                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                            <template x-for="drawing in ['evoltz', '太陽光（オプション）']" :key="drawing">
                                                <div class="mb-3">
                                                    <label class="block text-xs font-medium text-gray-600 mb-1" x-text="drawing"></label>
                                                    <div class="file-upload-item">
                                                        <input type="file" multiple @change="handleFileSelect($event, 'drawing', drawing)" accept=".pdf,.jpg,.jpeg,.png" class="hidden" :id="'file-' + drawing.replace(/[^a-zA-Z0-9]/g, '')">
                                                        <template x-if="formData.files?.drawings?.[drawing]?.length > 0">
                                                            <div class="space-y-2">
                                                                <template x-for="(file, index) in formData.files.drawings[drawing]" :key="index">
                                                                    <div class="relative border-2 border-green-300 rounded-lg overflow-hidden bg-green-50">
                                                                        <template x-if="file.preview">
                                                                            <img :src="file.preview" :alt="file.name" class="w-full h-32 object-contain bg-white">
                                                                        </template>
                                                                        <template x-if="!file.preview">
                                                                            <div class="w-full h-32 bg-red-50 flex items-center justify-center">
                                                                                <svg class="w-12 h-12 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                                                                </svg>
                                                                            </div>
                                                                        </template>
                                                                        <div class="absolute top-2 right-2">
                                                                            <button type="button" @click.stop="removeDrawingFile(drawing, index)" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-full shadow-lg transition-colors">
                                                                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                                                </svg>
                                                                            </button>
                                                                        </div>
                                                                        <div class="p-2 bg-white bg-opacity-90">
                                                                            <p class="text-sm text-green-600 font-medium truncate" x-text="file.name"></p>
                                                                            <p class="text-xs text-gray-500" x-text="(file.size / 1024).toFixed(1) + ' KB'"></p>
                                                                        </div>
                                                                    </div>
                                                                </template>
                                                                <button type="button" @click="document.getElementById('file-' + drawing.replace(/[^a-zA-Z0-9]/g, '')).click()" class="w-full border-2 border-dashed border-gray-300 rounded p-2 text-xs hover:bg-gray-50 transition-colors active:bg-gray-100">+ さらに追加</button>
                                                            </div>
                                                        </template>
                                                        <template x-if="!formData.files?.drawings?.[drawing] || formData.files.drawings[drawing].length === 0">
                                                            <div @drop="handleDrop($event, 'drawing', drawing)" @dragover.prevent @dragenter.prevent @click="document.getElementById('file-' + drawing.replace(/[^a-zA-Z0-9]/g, '')).click()" class="border-2 border-dashed border-gray-300 rounded p-3 text-xs hover:bg-gray-50 transition-colors cursor-pointer min-h-[90px] sm:min-h-[70px] flex flex-col items-center justify-center active:bg-gray-100">
                                                                <svg class="h-6 w-6 text-gray-400 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                                                </svg>
                                                                <span class="text-gray-500 text-center">ドラッグ&ドロップ<br>またはクリック</span>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- その他のファイル -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">その他の資料</label>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    <template x-for="doc in ['資金計画書', '実行予算', 'Walk in Homeデータ']" :key="doc">
                                        <div class="mb-3">
                                            <label class="block text-xs font-medium text-gray-600 mb-1" x-text="doc"></label>
                                            <div class="file-upload-item">
                                                <input type="file" multiple @change="handleFileSelect($event, 'document', doc)" accept=".pdf,.xlsx,.xls,.doc,.docx" class="hidden" :id="'file-' + doc.replace(/[^a-zA-Z0-9]/g, '')">

                                                <!-- プレビューまたはアップロード領域 -->
                                                <template x-if="formData.files?.documents?.[doc]?.length > 0">
                                                    <div class="space-y-2">
                                                        <template x-for="(file, index) in formData.files.documents[doc]" :key="index">
                                                            <div class="relative border-2 border-green-300 rounded-lg overflow-hidden bg-green-50">
                                                                <div class="w-full h-24 bg-blue-50 flex items-center justify-center">
                                                                    <svg class="w-10 h-10 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                                    </svg>
                                                                </div>
                                                                <div class="absolute top-2 right-2">
                                                                    <button type="button" @click.stop="removeDocumentFile(doc, index)" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-full shadow-lg transition-colors">
                                                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                                        </svg>
                                                                    </button>
                                                                </div>
                                                                <div class="p-2 bg-white bg-opacity-90">
                                                                    <p class="text-sm text-green-600 font-medium truncate" x-text="file.name"></p>
                                                                    <p class="text-xs text-gray-500" x-text="(file.size / 1024).toFixed(1) + ' KB'"></p>
                                                                </div>
                                                            </div>
                                                        </template>
                                                        <button type="button" @click="document.getElementById('file-' + doc.replace(/[^a-zA-Z0-9]/g, '')).click()" class="w-full border-2 border-dashed border-gray-300 rounded p-2 text-xs hover:bg-gray-50 transition-colors active:bg-gray-100">+ さらに追加</button>
                                                    </div>
                                                </template>

                                                <!-- 初回アップロード領域 -->
                                                <template x-if="!formData.files?.documents?.[doc] || formData.files.documents[doc].length === 0">
                                                    <div @drop="handleDrop($event, 'document', doc)" @dragover.prevent @dragenter.prevent @click="document.getElementById('file-' + doc.replace(/[^a-zA-Z0-9]/g, '')).click()" class="border-2 border-dashed border-gray-300 rounded p-3 text-xs hover:bg-gray-50 transition-colors cursor-pointer min-h-[90px] sm:min-h-[70px] flex flex-col items-center justify-center active:bg-gray-100">
                                                        <svg class="h-6 w-6 text-gray-400 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                                        </svg>
                                                        <span class="text-gray-500 text-center">ドラッグ&ドロップ<br>またはクリック</span>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>

                        </section>

                    </div>

                    <!-- フッター（常に画面下に表示・スマホ最適化） -->
                    <div class="modal-footer px-4 sm:px-6 py-4 border-t bg-white" style="flex-shrink: 0;">
                        <div class="flex items-center justify-center gap-3 sm:gap-4 w-full">
                            <!-- キャンセルボタン -->
                            <button type="button"
                                    @click="closeModal()"
                                    class="flex-1 sm:flex-none sm:w-32 px-6 py-3 min-h-[48px] rounded-lg border-2 border-gray-300 text-gray-700 hover:bg-gray-50 active:bg-gray-100 transition-colors font-medium text-base">
                                キャンセル
                            </button>

                            <!-- 保存ボタン -->
                            <button type="submit"
                                    :disabled="!isFormValid() || saving"
                                    :class="isFormValid() && !saving ? 'bg-blue-600 hover:bg-blue-700 active:bg-blue-800' : 'bg-gray-400 cursor-not-allowed'"
                                    class="flex-1 sm:flex-none sm:w-32 px-6 py-3 min-h-[48px] rounded-lg text-white font-medium text-base transition-colors disabled:opacity-50">
                                <span x-text="saving ? '保存中...' : '保存'"></span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        function adminPlans() {
            return {
                plans: [],
                loading: true,
                filteredPlans: [],
                searchQuery: '',
                filterCategory: '',
                sortBy: 'updated',
                showModal: false,
                editingPlan: null,
                formData: {
                    id: '',
                    floors: '2',
                    tsubo: '',
                    width: '',
                    depth: '',
                    layout: '',
                    sellPrice: '',
                    customSellPrice: '',
                    cost: '',
                    grossProfit: '',
                    status: 'draft',
                    description: '',
                    designer: '',
                    tags: [],
                    featureTags: [],
                    customTags: '',
                    images: {
                        exterior: '',
                        interior: ''
                    },
                    floorPlans: [],
                    files: {
                        presentation: null,
                        drawings: {},
                        documents: {},
                        images: {},
                        floorPlans: {}
                    }
                },
                
                // Enhanced modal functionality
                formErrors: {},
                saving: false,
                modalTabs: [
                    { id: 'basic', name: '基本情報', icon: '<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>' },
                    { id: 'features', name: '特徴タグ', icon: '<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" /></svg>' },
                    { id: 'files', name: '画像・ファイル', icon: '<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>' },
                    { id: 'confirm', name: '確認', icon: '<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>' }
                ],

                get calculatedGrossProfit() {
                    const sellPrice = this.getActualSellPrice();
                    const cost = parseFloat(this.formData.cost) || 0;
                    if (sellPrice && cost) {
                        const grossProfit = (sellPrice / 1.1) - cost;
                        return Math.round(grossProfit * 10) / 10; // 小数点1位まで
                    }
                    return '';
                },
                
                get profitMargin() {
                    const sellPrice = this.getActualSellPrice();
                    const cost = parseFloat(this.formData.cost) || 0;
                    if (sellPrice && cost) {
                        const margin = ((sellPrice / 1.1 - cost) / (sellPrice / 1.1)) * 100;
                        return Math.round(margin * 10) / 10;
                    }
                    return 0;
                },

                realtimeChannel: null,

                async init() {
                    // プランデータの読み込み
                    await this.loadPlans();
                    this.filterPlans();
                    this.loading = false;

                    // Realtime購読開始（同時編集対応）
                    if (typeof this.setupRealtimeSubscription === 'function') {
                        this.setupRealtimeSubscription();
                    }

                    // Escキーでモーダルを閉じる
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape' && this.showModal) {
                            this.closeModal();
                        }
                    });

                    // デバッグ: 保存ボタンのクリック阻害要素を検出
                    this.$nextTick(() => {
                        const checkClickability = () => {
                            const btn = document.querySelector('button[type="submit"]');
                            if (btn) {
                                const r = btn.getBoundingClientRect();
                                const elOnTop = document.elementFromPoint(r.left + r.width / 2, r.top + r.height / 2);
                                if (elOnTop && elOnTop !== btn && !btn.contains(elOnTop)) {
                                    console.warn('[Debug] Element blocking save button:', elOnTop);
                                } else {
                                    console.log('[Debug] Save button is clickable');
                                }
                            }
                        };
                        // モーダル表示時にチェック
                        this.$watch('showModal', (value) => {
                            if (value) {
                                setTimeout(checkClickability, 100);
                            }
                        });
                    });
                },
                
                async loadPlans() {
                    try {
                        const data = await lifeXAPI.getPlansIndex();
                        this.plans = data.plans || [];
                        this.filterPlans();
                    } catch (error) {
                        console.error('プランの読み込みに失敗しました:', error);
                        lifeXAPI.showToast('プランの読み込みに失敗しました', 'error');
                    }
                },

                filterPlans() {
                    let filtered = [...this.plans];
                    
                    if (this.searchQuery) {
                        filtered = filtered.filter(plan => 
                            plan.id.toLowerCase().includes(this.searchQuery.toLowerCase())
                        );
                    }
                    
                    if (this.filterCategory) {
                        if (this.filterCategory.includes('坪')) {
                            const size = parseInt(this.filterCategory);
                            filtered = filtered.filter(plan => plan.size === size);
                        } else {
                            filtered = filtered.filter(plan => 
                                plan.name.includes(this.filterCategory)
                            );
                        }
                    }
                    
                    this.filteredPlans = filtered;
                    this.sortPlans();
                },

                sortPlans() {
                    this.filteredPlans.sort((a, b) => {
                        switch(this.sortBy) {
                            case 'name':
                                return a.name.localeCompare(b.name);
                            case 'date':
                                return new Date(b.updated) - new Date(a.updated);
                            case 'size':
                                return a.size - b.size;
                            default:
                                return 0;
                        }
                    });
                },

                openAddModal() {
                    this.editingPlan = null;
                    this.currentTab = 'basic';
                    this.formErrors = {};
                    this.saving = false;
                    this.formData = {
                        id: '',
                        floors: '2',
                        ldkFloor: '1階',
                        bathroomFloor: '1階',
                        tsubo: '',
                        width: '',
                        depth: '',
                        layout: '',
                        sellPrice: '',
                        customSellPrice: '',
                        cost: '',
                        grossProfit: '',
                        uaValue: '',
                        energyReduction: '',
                        status: 'draft',
                        description: '',
                        designer: '',
                        featureTags: [],
                        customTags: '',
                        images: {
                            exterior: '',
                            interior: ''
                        },
                        floorPlans: [],
                        files: {
                            presentation: null,
                            drawings: {},
                            documents: {},
                            images: {},
                            floorPlans: {}
                        }
                    };
                    this.showModal = true;
                },
                
                // Enhanced tab navigation
                switchTab(tabId) {
                    this.currentTab = tabId;
                },
                
                nextTab() {
                    const currentIndex = this.modalTabs.findIndex(tab => tab.id === this.currentTab);
                    if (currentIndex < this.modalTabs.length - 1) {
                        this.currentTab = this.modalTabs[currentIndex + 1].id;
                    }
                },
                
                prevTab() {
                    const currentIndex = this.modalTabs.findIndex(tab => tab.id === this.currentTab);
                    if (currentIndex > 0) {
                        this.currentTab = this.modalTabs[currentIndex - 1].id;
                    }
                },
                
                isTabCompleted(tabId) {
                    switch(tabId) {
                        case 'basic':
                            return this.formData.id && this.formData.tsubo && this.formData.layout && this.getActualSellPrice() && this.formData.cost;
                        case 'features':
                            return true; // 特徴タグは任意
                        case 'files':
                            return true; // 画像も一時的に任意にする
                        case 'confirm':
                            return this.isFormValid();
                        default:
                            return false;
                    }
                },
                
                // Form validation
                validateField(fieldName) {
                    this.formErrors = {...this.formErrors};
                    delete this.formErrors[fieldName];

                    switch(fieldName) {
                        case 'id':
                            if (!this.formData.id) {
                                this.formErrors.id = 'プランコードは必須です';
                            } else {
                                // 重複チェック（編集時は自分自身を除外）
                                const duplicate = this.plans.find(p =>
                                    p.id === this.formData.id &&
                                    (!this.editingPlan || p.id !== this.editingPlan.id)
                                );
                                if (duplicate) {
                                    this.formErrors.id = 'このプランコードは既に使用されています';
                                } else {
                                    delete this.formErrors.id;
                                }
                            }
                            break;
                        case 'tsubo':
                            if (!this.formData.tsubo) {
                                this.formErrors.tsubo = '坪数は必須です';
                            } else if (this.formData.tsubo < 10 || this.formData.tsubo > 100) {
                                this.formErrors.tsubo = '坪数は10-100の範囲で入力してください';
                            }
                            break;
                        case 'layout':
                            if (!this.formData.layout) {
                                this.formErrors.layout = '間取りは必須です';
                            }
                            break;
                        case 'sellPrice':
                            if (!this.getActualSellPrice()) {
                                this.formErrors.sellPrice = '販売価格は必須です';
                            }
                            break;
                        case 'cost':
                            if (!this.formData.cost) {
                                this.formErrors.cost = '原価は必須です';
                            } else if (this.formData.cost < 500 || this.formData.cost > 5000) {
                                this.formErrors.cost = '原価は500-5000万円の範囲で入力してください';
                            }
                            break;
                        case 'width':
                            if (!this.formData.width) {
                                this.formErrors.width = '間口は必須です';
                            } else if (this.formData.width < 3000 || this.formData.width > 15000) {
                                this.formErrors.width = '間口は3000-15000mmの範囲で入力してください';
                            }
                            break;
                        case 'depth':
                            if (!this.formData.depth) {
                                this.formErrors.depth = '奥行は必須です';
                            } else if (this.formData.depth < 3000 || this.formData.depth > 20000) {
                                this.formErrors.depth = '奥行は3000-20000mmの範囲で入力してください';
                            }
                            break;
                    }
                },
                
                getFieldValidationClass(fieldName) {
                    if (this.formErrors[fieldName]) {
                        return 'border-red-300 focus:border-red-500 focus:ring-red-500';
                    } else if (this.isFieldValid(fieldName)) {
                        return 'border-green-300 focus:border-green-500 focus:ring-green-500';
                    }
                    return '';
                },
                
                isFieldValid(fieldName) {
                    switch(fieldName) {
                        case 'id': return !!this.formData.id;
                        case 'tsubo': return this.formData.tsubo >= 10 && this.formData.tsubo <= 100;
                        case 'layout': return !!this.formData.layout;
                        case 'sellPrice': return !!this.getActualSellPrice();
                        case 'cost': return this.formData.cost >= 500 && this.formData.cost <= 5000;
                        case 'width': return this.formData.width >= 3000 && this.formData.width <= 15000;
                        case 'depth': return this.formData.depth >= 3000 && this.formData.depth <= 20000;
                        default: return false;
                    }
                },
                
                isFormValid() {
                    // 基本情報のバリデーションのみチェック（画像は一時的に必須から外す）
                    const basicValid = this.isFieldValid('id') && 
                           this.isFieldValid('tsubo') && 
                           this.isFieldValid('layout') && 
                           this.isFieldValid('sellPrice') && 
                           this.isFieldValid('cost');
                    
                    console.log('Validation check:', {
                        id: this.isFieldValid('id'),
                        tsubo: this.isFieldValid('tsubo'),
                        layout: this.isFieldValid('layout'),
                        sellPrice: this.isFieldValid('sellPrice'),
                        cost: this.isFieldValid('cost'),
                        basicValid: basicValid
                    });
                    
                    return basicValid;
                },
                
                // Smart calculation functions
                getActualSellPrice() {
                    if (this.formData.sellPrice === 'その他') {
                        return parseFloat(this.formData.customSellPrice) || 0;
                    }
                    return parseFloat(this.formData.sellPrice) || 0;
                },
                
                calculateProfits() {
                    // 自動計算は getter で実装済み
                },
                
                calculateTsubo() {
                    if (this.formData.width && this.formData.depth) {
                        const area = (this.formData.width * this.formData.depth) / 1000000; // mm2 to m2
                        const tsubo = area / 3.3058; // m2 to tsubo
                        this.formData.tsubo = Math.round(tsubo * 10) / 10;
                    }
                },
                
                getProfitMarginStatus() {
                    if (this.profitMargin < 20) return '低い';
                    if (this.profitMargin < 30) return '标準';
                    return '良好';
                },
                
                // Auto-generation functions
                generatePlanCode() {
                    const timestamp = Date.now().toString().slice(-3);
                    const randomLetter = String.fromCharCode(65 + Math.floor(Math.random() * 26));
                    this.formData.id = `LX-${timestamp}${randomLetter}`;
                    this.validateField('id');
                },
                
                getAllSelectedTags() {
                    const tags = [...(this.formData.featureTags || [])];
                    if (this.formData.customTags) {
                        tags.push(...this.formData.customTags.split(',').map(t => t.trim()).filter(t => t));
                    }
                    return tags;
                },

                editPlan(plan) {
                    this.editingPlan = plan;
                    this.currentTab = 'basic';
                    this.formData = {
                        ...plan,
                        ldkFloor: plan.ldkFloor || '1階',
                        bathroomFloor: plan.bathroomFloor || '1階',
                        uaValue: plan.uaValue || '',
                        energyReduction: plan.energyReduction || '',
                        tsubo: plan.tsubo || plan.size || '',
                        sellPrice: plan.prices?.sell ? plan.prices.sell / 10000 : (plan.sellPrice || plan.price || ''),  // 円→万円に変換
                        cost: plan.prices?.cost ? plan.prices.cost / 10000 : (plan.cost || ''),      // 円→万円に変換
                        grossProfit: plan.prices?.gross ? plan.prices.gross / 10000 : (plan.grossProfit || ''), // 円→万円に変換
                        tags: plan.tags || [],
                        featureTags: plan.featureTags || plan.tags || [],
                        images: plan.images || { exterior: '', interior: '' },
                        floorPlans: plan.floorPlans || [],
                        files: plan.files || { presentation: null, drawings: {}, documents: {}, images: {}, floorPlans: {} }
                    };
                    this.showModal = true;
                },

                async deletePlan(plan) {
                    if (confirm(`プラン「${plan.name}」を削除しますか？`)) {
                        try {
                            // LocalStorageから削除
                            const localData = localStorage.getItem('plans_data');
                            if (localData) {
                                let plansData = JSON.parse(localData);
                                plansData.plans = plansData.plans.filter(p => p.id !== plan.id);
                                localStorage.setItem('plans_data', JSON.stringify(plansData));
                            }
                            
                            // UIから削除
                            this.plans = this.plans.filter(p => p.id !== plan.id);
                            this.filterPlans();
                            this.updateStats();
                            lifeXAPI.showToast('プランを削除しました', 'success');
                        } catch (error) {
                            console.error('プランの削除に失敗しました:', error);
                            lifeXAPI.showToast('プランの削除に失敗しました', 'error');
                        }
                    }
                },

                handleFormSubmit() {
                    console.log('[ui] save-click');
                    // 二重送信防止
                    if (this.saving) {
                        console.log('[submit] already submitting, skip');
                        return;
                    }
                    this.savePlan();
                },

                async savePlan() {
                    console.log('[submit] start');
                    console.log('[SavePlan] FormData:', this.formData);
                    console.log('[SavePlan] Is form valid?', this.isFormValid());

                    // バリデーションチェック
                    if (!this.isFormValid()) {
                        console.error('[submit] validation error');
                        console.error('[SavePlan] Form errors:', this.formErrors);

                        // 具体的なエラー内容を表示
                        const errorMessages = [];
                        let firstErrorField = null;

                        if (!this.formData.id) {
                            errorMessages.push('プランコード');
                            if (!firstErrorField) firstErrorField = 'id';
                        }
                        if (!this.formData.tsubo) {
                            errorMessages.push('坪数');
                            if (!firstErrorField) firstErrorField = 'tsubo';
                        }
                        if (!this.formData.layout) {
                            errorMessages.push('間取り');
                            if (!firstErrorField) firstErrorField = 'layout';
                        }
                        if (!this.getActualSellPrice()) {
                            errorMessages.push('販売価格');
                            if (!firstErrorField) firstErrorField = 'sellPrice';
                        }
                        if (!this.formData.cost) {
                            errorMessages.push('原価');
                            if (!firstErrorField) firstErrorField = 'cost';
                        }

                        const message = errorMessages.length > 0
                            ? `以下の必須項目を入力してください: ${errorMessages.join('、')}`
                            : '必須項目を入力してください';

                        lifeXAPI.showToast(message, 'error');

                        // 最初のエラーフィールドにスクロール
                        if (firstErrorField) {
                            this.scrollToError(firstErrorField);
                        }
                        return;
                    }

                    // 二重送信防止
                    this.saving = true;
                    console.log('[SavePlan] バリデーション成功、保存処理を開始');
                    
                    try {
                        // カスタムタグを処理
                        if (this.formData.customTags) {
                            const customTags = this.formData.customTags.split(',').map(t => t.trim()).filter(t => t);
                            this.formData.tags = [...(this.formData.featureTags || []), ...customTags];
                        } else {
                            this.formData.tags = this.formData.featureTags || [];
                        }
                        
                        // 販売価格の処理
                        const actualSellPrice = this.getActualSellPrice();
                        const actualCost = parseFloat(this.formData.cost) || 0;
                        const actualGrossProfit = this.calculatedGrossProfit;
                        
                        // プラン名を生成（階数と坪数とレイアウトから）
                        const floorName = this.formData.floors == 1 ? '平屋' : `${this.formData.floors}階建て`;
                        const planName = `${floorName} ${this.formData.tsubo}坪 ${this.formData.layout}`;
                        
                        const planData = {
                            ...this.formData,
                            name: planName,  // プラン名を追加
                            size: parseFloat(this.formData.tsubo) || 0,  // sizeフィールドも追加（互換性のため）
                            updatedAt: new Date().toISOString(),
                            updated: new Date().toISOString(),  // updatedフィールドも追加（互換性のため）
                            tsubo: parseFloat(this.formData.tsubo) || 0,
                            width: parseInt(this.formData.width) || 0,
                            depth: parseInt(this.formData.depth) || 0,
                            prices: {
                                sell: actualSellPrice * 10000,  // 万円→円に変換
                                cost: actualCost * 10000,      // 万円→円に変換
                                gross: actualGrossProfit * 10000 // 万円→円に変換
                            },
                            price: actualSellPrice * 10000,  // priceフィールドも追加（互換性のため）
                            sellPrice: actualSellPrice * 10000,  // sellPriceフィールドも維持
                            cost: actualCost * 10000,  // costフィールドも維持
                            grossProfit: actualGrossProfit * 10000  // grossProfitフィールドも維持
                        };
                        
                        // 不要なフィールドを削除（互換性フィールドは残す）
                        delete planData.customSellPrice;
                        delete planData.featureTags;
                        delete planData.customTags;
                        
                        console.log('[SavePlan] 送信データ:', planData);

                        try {
                            if (this.editingPlan) {
                                console.log('[SavePlan] 既存プランを更新:', this.editingPlan.id);
                                await lifeXAPI.updatePlan(this.editingPlan.id, planData);
                                console.log('[SavePlan] プラン更新成功');
                                lifeXAPI.showToast('プランを更新しました', 'success');
                            } else {
                                console.log('[SavePlan] 新規プランを作成');
                                const result = await lifeXAPI.createPlan(planData);
                                console.log('[SavePlan] プラン作成成功:', result);
                                lifeXAPI.showToast('プランを追加しました', 'success');
                            }

                            console.log('[SavePlan] プラン一覧を再読み込み');
                            await this.loadPlans();
                            this.filterPlans();
                            this.updateStats();
                            this.closeModal();
                            console.log('[submit] success');
                        } catch (apiError) {
                            console.error('[SavePlan] API呼び出しエラー:', apiError);
                            console.error('[SavePlan] エラー詳細:', {
                                message: apiError.message,
                                stack: apiError.stack,
                                response: apiError.response
                            });
                            throw apiError;
                        }
                    } catch (error) {
                        console.error('[submit] error', error);
                        const errorMessage = error.response?.data?.message
                            || error.message
                            || 'プランの保存に失敗しました';
                        lifeXAPI.showToast(errorMessage, 'error');
                    } finally {
                        this.saving = false;
                        console.log('[SavePlan] 保存処理終了');
                    }
                },

                scrollToError(fieldName) {
                    // エラーフィールドへスクロール
                    const element = document.querySelector(`[x-model="formData.${fieldName}"]`);
                    if (element) {
                        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        element.focus();
                        // エラーフィールドをハイライト
                        element.classList.add('ring-2', 'ring-red-500');
                        setTimeout(() => {
                            element.classList.remove('ring-2', 'ring-red-500');
                        }, 3000);
                    }
                },

                closeModal() {
                    // フォームに何か入力されている場合は確認
                    const hasInput = this.formData.id || this.formData.tsubo || this.formData.layout;

                    if (hasInput && !confirm('入力内容が保存されていません。閉じてもよろしいですか？')) {
                        return;
                    }

                    this.showModal = false;
                    this.editingPlan = null;
                    this.currentTab = 'basic';
                    // モーダル位置をリセット
                    if (this.$refs.modalDraggable) {
                        this.$refs.modalDraggable.resetPosition();
                    }
                },
                
                updateStats() {
                    // 統計情報を更新するためのイベントを発行
                    window.dispatchEvent(new CustomEvent('plans-updated'));
                },
                
                handleDrop(event, type, subtype = null) {
                    event.preventDefault();
                    
                    // ドラッグオーバー効果を削除
                    event.target.closest('.file-upload-item')?.classList.remove('drag-over');
                    
                    const files = event.dataTransfer.files;
                    if (files.length > 0) {
                        if (subtype) {
                            // 図面など複数ファイル可能な場合
                            this.processFile(Array.from(files), type, subtype);
                        } else {
                            // 単一ファイルの場合
                            this.processFile(files[0], type);
                        }
                        lifeXAPI.showToast(`${files.length}ファイルがアップロードされました`, 'success');
                    }
                },
                
                handleFileSelect(event, type, subtype = null) {
                    const files = event.target.files;
                    if (files.length > 0) {
                        // 複数ファイル対応
                        if (files.length > 1) {
                            this.processFile(Array.from(files), type, subtype);
                        } else {
                            this.processFile(files[0], type, subtype);
                        }
                    }
                },
                
                processFile(file, type, subtype = null) {
                    // 複数ファイル対応
                    if (Array.isArray(file)) {
                        file.forEach(f => this.processSingleFile(f, type, subtype));
                    } else {
                        this.processSingleFile(file, type, subtype);
                    }
                },
                
                processSingleFile(file, type, subtype = null) {
                    // ファイルサイズチェック（5MB制限）
                    const maxSize = 5 * 1024 * 1024; // 5MB
                    if (file.size > maxSize) {
                        lifeXAPI.showToast(`ファイルサイズが大きすぎます（最大5MB）: ${file.name}`, 'error');
                        return;
                    }

                    // 画像形式チェック
                    if (type === 'image' || type === 'floorPlan') {
                        const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
                        if (!allowedTypes.includes(file.type)) {
                            lifeXAPI.showToast('対応していない画像形式です（JPG, PNG, WebPのみ）', 'error');
                            return;
                        }
                    }

                    // ファイル情報を保存
                    const fileInfo = {
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        lastModified: file.lastModified,
                        file: file  // 実際のファイルオブジェクトを保持
                    };

                    // 画像ファイルの場合はプレビューURLを生成
                    if (file.type.startsWith('image/')) {
                        fileInfo.preview = URL.createObjectURL(file);
                    }

                    if (type === 'presentation') {
                        this.formData.files.presentation = fileInfo;
                    } else if (type === 'drawing' && subtype) {
                        if (!this.formData.files.drawings) {
                            this.formData.files.drawings = {};
                        }
                        // 複数ファイル対応
                        if (!this.formData.files.drawings[subtype]) {
                            this.formData.files.drawings[subtype] = [];
                        }
                        if (!Array.isArray(this.formData.files.drawings[subtype])) {
                            this.formData.files.drawings[subtype] = [this.formData.files.drawings[subtype]];
                        }
                        this.formData.files.drawings[subtype].push(fileInfo);
                    } else if (type === 'document' && subtype) {
                        if (!this.formData.files.documents) {
                            this.formData.files.documents = {};
                        }
                        // 複数ファイル対応
                        if (!this.formData.files.documents[subtype]) {
                            this.formData.files.documents[subtype] = [];
                        }
                        if (!Array.isArray(this.formData.files.documents[subtype])) {
                            this.formData.files.documents[subtype] = [this.formData.files.documents[subtype]];
                        }
                        this.formData.files.documents[subtype].push(fileInfo);
                    } else if (type === 'image' && subtype) {
                        if (!this.formData.files.images) {
                            this.formData.files.images = {};
                        }
                        this.formData.files.images[subtype] = fileInfo;
                    } else if (type === 'floorPlan' && subtype) {
                        if (!this.formData.files.floorPlans) {
                            this.formData.files.floorPlans = {};
                        }
                        this.formData.files.floorPlans[subtype] = fileInfo;
                    }

                    // 実際のアップロード処理はここに実装
                    console.log('File uploaded:', type, subtype, fileInfo);
                },

                removeFile(type, subtype = null) {
                    if (!confirm('このファイルを削除してもよろしいですか？')) {
                        return;
                    }

                    if (type === 'image' && subtype) {
                        if (this.formData.files?.images?.[subtype]) {
                            // プレビューURLを解放
                            if (this.formData.files.images[subtype].preview) {
                                URL.revokeObjectURL(this.formData.files.images[subtype].preview);
                            }
                            delete this.formData.files.images[subtype];
                        }
                    } else if (type === 'floorPlan' && subtype) {
                        if (this.formData.files?.floorPlans?.[subtype]) {
                            if (this.formData.files.floorPlans[subtype].preview) {
                                URL.revokeObjectURL(this.formData.files.floorPlans[subtype].preview);
                            }
                            delete this.formData.files.floorPlans[subtype];
                        }
                    } else if (type === 'presentation') {
                        if (this.formData.files?.presentation) {
                            delete this.formData.files.presentation;
                        }
                    }

                    lifeXAPI.showToast('ファイルを削除しました', 'success');
                },

                removeDrawingFile(drawingType, index) {
                    if (!confirm('このファイルを削除してもよろしいですか？')) {
                        return;
                    }

                    if (this.formData.files?.drawings?.[drawingType]?.[index]) {
                        // プレビューURLを解放
                        if (this.formData.files.drawings[drawingType][index].preview) {
                            URL.revokeObjectURL(this.formData.files.drawings[drawingType][index].preview);
                        }
                        // 配列から削除
                        this.formData.files.drawings[drawingType].splice(index, 1);

                        // 配列が空になったら削除
                        if (this.formData.files.drawings[drawingType].length === 0) {
                            delete this.formData.files.drawings[drawingType];
                        }
                    }

                    lifeXAPI.showToast('ファイルを削除しました', 'success');
                },

                removeDocumentFile(docType, index) {
                    if (!confirm('このファイルを削除してもよろしいですか？')) {
                        return;
                    }

                    if (this.formData.files?.documents?.[docType]?.[index]) {
                        // プレビューURLを解放（画像の場合）
                        if (this.formData.files.documents[docType][index].preview) {
                            URL.revokeObjectURL(this.formData.files.documents[docType][index].preview);
                        }
                        // 配列から削除
                        this.formData.files.documents[docType].splice(index, 1);

                        // 配列が空になったら削除
                        if (this.formData.files.documents[docType].length === 0) {
                            delete this.formData.files.documents[docType];
                        }
                    }

                    lifeXAPI.showToast('ファイルを削除しました', 'success');
                },

                toggleFeatureTag(tag) {
                    if (!this.formData.featureTags) {
                        this.formData.featureTags = [];
                    }
                    const index = this.formData.featureTags.indexOf(tag);
                    if (index > -1) {
                        this.formData.featureTags.splice(index, 1);
                    } else {
                        this.formData.featureTags.push(tag);
                    }
                },
                
                updateFloorPlans() {
                    const floors = parseInt(this.formData.floors) || 1;
                    this.formData.floorPlans = Array(floors).fill('');
                },

                // LocalStorageに保存
                async savePlansToLocalStorage() {
                    try {
                        const plansData = {
                            plans: this.plans,
                            lastUpdated: new Date().toISOString()
                        };
                        localStorage.setItem('plansData', JSON.stringify(plansData));
                        lifeXAPI.showToast('プランデータを保存しました', 'success');
                        console.log('Plans saved to localStorage:', plansData);
                    } catch (error) {
                        console.error('Failed to save plans:', error);
                        lifeXAPI.showToast('保存に失敗しました', 'error');
                    }
                },

                // Realtime同時編集機能
                setupRealtimeSubscription() {
                    // Supabase Realtimeのインポート確認
                    if (!window.supabase) {
                        console.warn('Supabase not loaded, realtime disabled');
                        return;
                    }

                    this.realtimeChannel = window.supabase
                        .channel('plans-realtime')
                        .on(
                            'postgres_changes',
                            {
                                event: '*',
                                schema: 'public',
                                table: 'plans'
                            },
                            (payload) => {
                                console.log('Realtime update:', payload);
                                this.handleRealtimeUpdate(payload);
                            }
                        )
                        .subscribe((status) => {
                            if (status === 'SUBSCRIBED') {
                                console.log('✅ Realtime同時編集機能が有効になりました');
                                lifeXAPI.showToast('同時編集機能が有効です', 'info');
                            }
                        });
                },

                handleRealtimeUpdate(payload) {
                    const { eventType, new: newRecord, old: oldRecord } = payload;

                    if (eventType === 'INSERT') {
                        // 新規追加: リストに追加
                        const exists = this.plans.find(p => p.id === newRecord.id);
                        if (!exists) {
                            this.plans.unshift(newRecord);
                            this.filterPlans();
                            lifeXAPI.showToast('他のユーザーが新しいプランを追加しました', 'info');
                        }
                    } else if (eventType === 'UPDATE') {
                        // 更新: リスト内のデータを更新
                        const index = this.plans.findIndex(p => p.id === newRecord.id);
                        if (index !== -1) {
                            // 現在編集中のプランと同じか確認
                            if (this.editingPlan && this.editingPlan.id === newRecord.id) {
                                if (confirm('他のユーザーがこのプランを更新しました。最新データを読み込みますか？\n（キャンセルすると編集内容が上書きされる可能性があります）')) {
                                    this.plans[index] = newRecord;
                                    this.editingPlan = { ...newRecord };
                                    this.loadFormData(newRecord);
                                    lifeXAPI.showToast('最新データを読み込みました', 'success');
                                }
                            } else {
                                this.plans[index] = newRecord;
                                this.filterPlans();
                                lifeXAPI.showToast('プランが更新されました', 'info');
                            }
                        }
                    } else if (eventType === 'DELETE') {
                        // 削除: リストから削除
                        this.plans = this.plans.filter(p => p.id !== oldRecord.id);
                        this.filterPlans();

                        // 編集中のプランが削除された場合
                        if (this.editingPlan && this.editingPlan.id === oldRecord.id) {
                            alert('他のユーザーがこのプランを削除しました。モーダルを閉じます。');
                            this.closeModal();
                        } else {
                            lifeXAPI.showToast('プランが削除されました', 'info');
                        }
                    }
                }
            }
        }

        // モーダルドラッグ機能
        function modalDraggable() {
            return {
                isDragging: false,
                dragPosition: { x: 0, y: 0 },
                dragStart: { x: 0, y: 0 },
                initialPos: { x: 0, y: 0 },

                startDrag(event) {
                    // モバイルではドラッグ無効
                    if (window.innerWidth < 768) return;

                    // ボタンや入力要素ではドラッグ開始しない
                    const target = event.target;
                    if (target.closest('button, input, select, textarea, [contenteditable="true"]')) {
                        return;
                    }

                    this.isDragging = true;
                    const clientX = event.type === 'touchstart' ? event.touches[0].clientX : event.clientX;
                    const clientY = event.type === 'touchstart' ? event.touches[0].clientY : event.clientY;

                    this.dragStart = {
                        x: clientX - this.dragPosition.x,
                        y: clientY - this.dragPosition.y
                    };

                    // イベントリスナーを追加
                    document.addEventListener('mousemove', this.handleDrag.bind(this));
                    document.addEventListener('mouseup', this.endDrag.bind(this));
                    document.addEventListener('touchmove', this.handleDrag.bind(this));
                    document.addEventListener('touchend', this.endDrag.bind(this));

                    event.preventDefault();
                },

                handleDrag(event) {
                    if (!this.isDragging) return;

                    const clientX = event.type === 'touchmove' ? event.touches[0].clientX : event.clientX;
                    const clientY = event.type === 'touchmove' ? event.touches[0].clientY : event.clientY;

                    let newX = clientX - this.dragStart.x;
                    let newY = clientY - this.dragStart.y;

                    // 画面境界制限（20px余白）
                    const margin = 20;
                    const modalWidth = 1536; // max-w-6xl
                    const modalHeight = window.innerHeight * 0.9; // max-h-[90vh]

                    const maxX = (window.innerWidth - modalWidth) / 2 - margin;
                    const minX = -(window.innerWidth - modalWidth) / 2 + margin;
                    const maxY = (window.innerHeight - modalHeight) / 2 - margin;
                    const minY = -(window.innerHeight - modalHeight) / 2 + margin;

                    newX = Math.max(minX, Math.min(newX, maxX));
                    newY = Math.max(minY, Math.min(newY, maxY));

                    this.dragPosition = { x: newX, y: newY };
                },

                endDrag() {
                    this.isDragging = false;

                    // イベントリスナーを削除
                    document.removeEventListener('mousemove', this.handleDrag.bind(this));
                    document.removeEventListener('mouseup', this.endDrag.bind(this));
                    document.removeEventListener('touchmove', this.handleDrag.bind(this));
                    document.removeEventListener('touchend', this.endDrag.bind(this));
                },

                resetPosition() {
                    this.dragPosition = { x: 0, y: 0 };
                }
            }
        }

        // ページ離脱時のクリーンアップ
        window.addEventListener('beforeunload', () => {
            const component = Alpine.$data(document.querySelector('[x-data="adminPlans()"]'));
            if (component && component.cleanup) {
                component.cleanup();
            }
        });
    </script>
</body>
</html>