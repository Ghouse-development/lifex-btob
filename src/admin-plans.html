<!DOCTYPE html>
<html lang="ja" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プラン管理 | LIFE X 管理画面</title>

    <!-- キャッシュ無効化 - 常に最新データを表示 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Tailwind CSS (Production Build) -->
    <link rel="stylesheet" href="/assets/tailwind.css">

    <link href="./styles/main.css" rel="stylesheet">
    <script src="/js/common.js"></script>

    <!-- Supabase Auth Guard -->
    <script type="module" src="/js/auth-guard.js"></script>

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Supabase Client Initialization (Inline) -->
    <script>
        // Supabase接続情報
        const supabaseUrl = 'https://hegpxvyziovlfxdfsrsv.supabase.co';
        // 管理画面ではService role keyを使用（RLS制限を回避）
        const supabaseServiceKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhlZ3B4dnl6aW92bGZ4ZGZzcnN2Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MDY3OTkyNiwiZXhwIjoyMDc2MjU1OTI2fQ.OYB1WmG_xWsAVJQZFQ4fToCR6AXcFYHYNH-1QDOS8uM';

        // CDN版のSupabaseからクライアントを作成
        if (window.supabase && window.supabase.createClient) {
            window.supabase = window.supabase.createClient(supabaseUrl, supabaseServiceKey, {
                auth: {
                    autoRefreshToken: true,
                    persistSession: true,
                    detectSessionInUrl: true
                },
                db: {
                    schema: 'public'
                },
                global: {
                    headers: { 'x-application-name': 'LIFE-X' }
                }
            });
            console.log('✅ [Supabase] Client initialized');
        } else {
            console.error('❌ [Supabase] CDN not loaded');
        }

        // Supabase APIをグローバルに公開
        window.supabaseAPI = {
            plans: {
                async getAll() {
                    // 削除済み（status='deleted'）を除外
                    const { data, error } = await window.supabase
                        .from('plans')
                        .select('*')
                        .neq('status', 'deleted')  // status != 'deleted'
                        .order('created_at', { ascending: false });
                    if (error) throw error;
                    return data || [];
                },
                async create(planData) {
                    console.log('[create] 送信するデータ:', planData);
                    console.log('[create] データのキー:', Object.keys(planData));
                    console.log('[create] plan_nameが含まれているか:', 'plan_name' in planData, planData.plan_name);

                    try {
                        // INSERT実行（返り値なし）
                        const { error: insertError } = await window.supabase
                            .from('plans')
                            .insert(planData);  // 配列ではなくオブジェクトで送信

                        if (insertError) {
                            console.error('[create] INSERT エラー:', insertError);
                            console.error('[create] エラーコード:', insertError.code);
                            console.error('[create] エラーメッセージ:', insertError.message);
                            console.error('[create] エラー詳細:', insertError.details);
                            throw insertError;
                        }

                        console.log('[create] INSERT成功、データを取得中...');

                        // 挿入後にデータを取得
                        const { data: inserted, error: selectError } = await window.supabase
                            .from('plans')
                            .select()
                            .eq('id', planData.id)
                            .single();

                        if (selectError) {
                            console.warn('[create] 取得エラー:', selectError);
                            // 挿入は成功したのでplanDataを返す
                            return { success: true, data: planData };
                        }

                        console.log('[create] 完全成功:', inserted);
                        return { success: true, data: inserted };

                    } catch (err) {
                        console.error('[create] 予期しないエラー:', err);
                        throw err;
                    }
                },
                async update(planId, updates) {
                    const { data, error } = await window.supabaseClient.from('plans').update(updates).eq('id', planId).select('*').single();
                    if (error) {
                        console.error('[update] Supabase error:', error);
                        throw error;
                    }
                    return { success: true, data };
                },
                async delete(planId) {
                    const { data, error } = await window.supabaseClient.from('plans').update({ status: 'deleted', updated_at: new Date().toISOString() }).eq('id', planId).select('*').single();
                    if (error) {
                        console.error('[delete] Supabase error:', error);
                        throw error;
                    }
                    return { success: true, data };
                }
            }
        };

        // Supabase Bridgeをグローバルに公開
        window.supabaseBridge = {
            useSupabase: true,
            init() {
                console.log('✅ [Supabase Bridge] Initialized');
            },
            async getPlans() {
                return await window.supabaseAPI.plans.getAll();
            },
            async savePlan(planData) {
                return await window.supabaseAPI.plans.create(planData);
            },
            async updatePlan(planId, updates) {
                return await window.supabaseAPI.plans.update(planId, updates);
            }
        };

        // 初期化
        window.supabaseBridge.init();
    </script>

    <script defer src="https://unpkg.com/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

</head>
<body class="h-full bg-gray-50">
    <style>
        /* Alpine.js x-cloak */
        [x-cloak] { display: none !important; }

        /* モーダルのz-index管理 */
        .modal-overlay {
            z-index: 40;
            pointer-events: auto;
        }
        .modal-content {
            z-index: 50;
            pointer-events: auto;
            transition: none; /* ドラッグ時のちらつき防止 */
        }

        /* クリック阻害を防ぐ */
        .modal-content, .modal-content * {
            pointer-events: auto !important;
        }

        /* グローバル固定ボタンを非表示 */
        .global-fixed-cta {
            display: none !important;
        }

        /* モーダルフッターを常に表示 */
        .modal-footer {
            background: white !important;
            border-top: 1px solid #e5e7eb;
        }

        /* モーダルヘッダーのドラッグスタイル */
        .modal-header {
            cursor: grab;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .modal-header.dragging {
            cursor: grabbing;
        }

        /* モーダル本文の単一スクロール */
        .modal-body {
            overflow-y: auto;
            overflow-x: hidden;
            max-height: calc(90vh - 120px - 80px); /* header + footer + margin */
        }

        /* 内部セクションのスクロール無効化 */
        .modal-body section,
        .modal-body .dropzone,
        .modal-body .file-upload-area,
        .modal-body .file-upload-item {
            overflow: visible !important;
            max-height: none !important;
        }

        /* 入力欄の統一スタイル */
        .form-field > span {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.25rem;
        }

        .input {
            width: 100%;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            background-color: white;
            padding: 0.5rem 0.75rem;
            color: #111827;
            transition: all 0.15s;
        }

        .input:hover {
            border-color: #9ca3af;
        }

        .input:focus {
            outline: none;
            border-color: #3b82f6;
            ring: 2px;
            ring-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .input::placeholder {
            color: #9ca3af;
        }

        .input:disabled, .input[readonly] {
            background-color: #f9fafb;
            cursor: not-allowed;
        }

        /* ドロップゾーンスタイル */
        .dropzone {
            border-radius: 0.75rem;
            border: 2px dashed #d1d5db;
            background-color: #f9fafb;
            height: 8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .dropzone:hover {
            border-color: #60a5fa;
            background-color: #eff6ff;
        }

        .file-upload-area:hover {
            background-color: rgba(59, 130, 246, 0.05);
        }
        .file-upload-item input:checked + label div {
            background-color: rgba(34, 197, 94, 0.1);
            border-color: rgb(34, 197, 94);
        }
        .file-upload-item.drag-over > div {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
        }
        .form-input {
            @apply mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm;
        }
        .btn-primary {
            @apply inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500;
        }
        .btn-secondary {
            @apply inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500;
        }
    </style>
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="/" class="text-xl font-bold text-gray-900 hover:text-gray-700">LIFE X</a>
                    <span class="ml-2 px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">管理者専用</span>
                </div>
                <nav class="hidden md:flex space-x-8 items-center">
                    <a href="/admin.html" class="nav-link">管理ホーム</a>
                    <a href="/admin-plans.html" class="nav-link active">プラン管理</a>
                    <a href="/admin-rules.html" class="nav-link">ルール管理</a>
                    <a href="/admin-downloads.html" class="nav-link">ダウンロード管理</a>
                    <a href="/admin-faq.html" class="nav-link">FAQ管理</a>
                    <a href="/admin-system.html" class="nav-link">システム管理</a>
                    <a href="/admin-report.html" class="nav-link">レポート</a>
                    <a href="/" class="nav-link">サイトに戻る</a>
                    <button onclick="logout()" type="button" class="nav-link text-red-600 hover:text-red-800">ログアウト</button>
                </nav>
                <div id="userInfo" class="text-sm"></div>
            </div>
        </div>
    </header>

    <div x-data="adminPlans()" x-init="init()">
        <!-- Page Header -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">プラン管理</h1>
                    <p class="text-gray-600 mt-2">住宅プランの追加・編集・削除を管理</p>
                </div>
                <button type="button" @click="openAddModal()" class="btn-primary">
                    <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    新規プラン追加
                </button>
            </div>

            <!-- Filter & Search -->
            <div class="card mb-6">
                <div class="flex flex-col md:flex-row gap-4">
                    <input type="text" 
                           x-model="searchQuery"
                           @input="filterPlans()"
                           placeholder="プランコードで検索..." 
                           class="form-input flex-1">
                    <select x-model="filterCategory" @change="filterPlans()" class="form-input">
                        <option value="">全てのカテゴリ</option>
                        <option value="30坪">30坪</option>
                        <option value="33坪">33坪</option>
                        <option value="35坪">35坪</option>
                        <option value="平屋">平屋</option>
                        <option value="2階建て">2階建て</option>
                    </select>
                    <select x-model="sortBy" @change="sortPlans()" class="form-input">
                        <option value="updated">更新日順</option>
                        <option value="id">プランコード順</option>
                        <option value="tsubo">坪数順</option>
                        <option value="sellPrice">販売価格順</option>
                    </select>
                </div>
            </div>

            <!-- Plans Table -->
            <div class="card">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">プランID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">階数</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">坪数</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">間口×奥行</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">間取り</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">販売価格<span class="text-red-500 ml-1">(税込)</span></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">原価<span class="text-blue-500 ml-1">(税別)</span></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">粗利益<span class="text-blue-500 ml-1">(税別)</span></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ステータス</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">更新日</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="plan in filteredPlans" :key="plan.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap text-left text-sm font-medium">
                                        <button type="button" @click="editPlan(plan)" class="text-blue-600 hover:text-blue-900 mr-3">編集</button>
                                        <button type="button" @click="deletePlan(plan)" class="text-red-600 hover:text-red-900">削除</button>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="plan.plan_code || plan.planCode || plan.id.substring(0, 8) + '...'"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <span x-text="plan.floors == 1 ? '平屋' : plan.floors == 2 ? '2階建て' : '3階建て'"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="`${plan.tsubo || plan.size}坪`"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="(plan.width && plan.depth) ? `${plan.width}×${plan.depth}mm` : '-'"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="plan.layout"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="`¥${((plan.prices?.sell || plan.sellPrice || plan.price || 0) / 10000).toLocaleString()}万円`"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="(plan.prices?.cost || plan.cost) ? `¥${((plan.prices?.cost || plan.cost) / 10000).toLocaleString()}万円` : '-'"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="(plan.prices?.gross || plan.grossProfit) ? `¥${((plan.prices?.gross || plan.grossProfit) / 10000).toLocaleString()}万円` : '-'"></td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span x-show="plan.status === 'published' || plan.status === 'active'" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                            公開中
                                        </span>
                                        <span x-show="plan.status === 'draft'" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                                            下書き
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="plan.updated || plan.updatedAt || '-'"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

        <!-- Add/Edit Modal -->
        <div x-show="showModal"
             @click.self="closeModal()"
             class="fixed inset-0 z-[9999] flex items-center justify-center"
             style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5);"
             x-cloak>

            <!-- モーダルコンテナ -->
            <div class="modal-content bg-white shadow-2xl rounded-xl relative"
                 x-data="modalDraggable()"
                 style="width: 95%; max-width: 1400px; height: 90vh; display: flex; flex-direction: column; position: relative; z-index: 10000;"
                 @click.stop>
                <!-- ヘッダー（ドラッグ可能） -->
                <div class="modal-header px-6 py-4 border-b flex-shrink-0"
                     @mousedown="startDrag($event)"
                     @touchstart="startDrag($event)"
                     :class="{'dragging': isDragging}">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-bold text-gray-900" x-text="editingPlan ? 'プラン編集' : '新規プラン追加'"></h2>
                            <p class="text-sm text-gray-500 mt-1">プラン情報を入力してください</p>
                        </div>
                        <button type="button" @click.stop="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- フォーム全体 -->
                <form @submit.prevent="handleFormSubmit()" style="flex: 1; display: flex; flex-direction: column; min-height: 0; overflow: hidden;">
                    <!-- スクロール可能な本文エリア（ここだけスクロール） -->
                    <div class="modal-body px-6 py-6 space-y-6" style="flex: 1; overflow-y: scroll !important; overflow-x: hidden; min-height: 0; background: #f9fafb;">

                        <!-- 基本情報セクション -->
                        <section class="border border-gray-200 rounded-xl p-3 sm:p-5">
                            <h3 class="text-base font-semibold text-gray-900 mb-4">基本情報</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
                                    <!-- プランID（内部用UUID、非表示） -->
                                    <input type="hidden" x-model="formData.id">

                                    <!-- プランコード（表示用、手入力、任意） -->
                                    <label class="form-field">
                                        <span>プランコード</span>
                                        <input type="text"
                                               x-model="formData.planCode"
                                               name="planCode"
                                               @input="validateField('planCode')"
                                               :class="formErrors.planCode ? 'border-red-300' : ''"
                                               class="input"
                                               placeholder="例: LX-001（任意）"
                                               pattern="[A-Za-z0-9\-]+"
                                               title="半角英数字とハイフンのみ使用できます">
                                        <div x-show="formErrors.planCode" class="text-red-500 text-xs mt-1" x-text="formErrors.planCode"></div>
                                        <div class="text-xs text-gray-500 mt-1">半角英数字とハイフンのみ</div>
                                    </label>
                                    <label class="form-field">
                                        <span>階数 <span class="text-red-500">*</span></span>
                                        <select x-model="formData.floors"
                                                name="floors"
                                                @change="updateFloorPlans(); validateField('floors')"
                                                :class="formErrors.floors ? 'border-red-300' : ''"
                                                class="input"
                                                required>
                                            <option value="" disabled>選択してください</option>
                                            <option value="1">平屋</option>
                                            <option value="2">2階建て</option>
                                            <option value="3">3階建て</option>
                                        </select>
                                        <div x-show="formErrors.floors" class="text-red-500 text-xs mt-1" x-text="formErrors.floors"></div>
                                    </label>
                                    <label class="form-field">
                                        <span>LDK階数</span>
                                        <select x-model="formData.ldkFloor" name="ldkFloor" class="input">
                                            <option value="1">1階</option>
                                            <option value="2">2階</option>
                                            <option value="3">3階</option>
                                        </select>
                                    </label>
                                    <label class="form-field">
                                        <span>水廻り階数</span>
                                        <select x-model="formData.bathroomFloor" name="bathroomFloor" class="input">
                                            <option value="1">1階</option>
                                            <option value="2">2階</option>
                                            <option value="3">3階</option>
                                        </select>
                                    </label>
                                    <label class="form-field">
                                        <span>延床面積（㎡） <span class="text-red-500">*</span></span>
                                        <input type="number"
                                               x-model="formData.totalFloorArea"
                                               name="totalFloorArea"
                                               @input="validateField('totalFloorArea')"
                                               :class="formErrors.totalFloorArea ? 'border-red-300' : ''"
                                               class="input"
                                               placeholder="例：100.00"
                                               min="33"
                                               max="330"
                                               step="0.01"
                                               required>
                                        <div x-show="calculatedTsubo" class="text-xs text-gray-500 mt-1">
                                            坪数: <span class="font-semibold text-gray-700" x-text="`${calculatedTsubo}坪`"></span>
                                        </div>
                                        <div x-show="formErrors.totalFloorArea" class="text-red-500 text-xs mt-1" x-text="formErrors.totalFloorArea"></div>
                                    </label>
                                    <label class="form-field">
                                        <span>施工床面積（㎡） <span class="text-red-500">*</span></span>
                                        <input type="number"
                                               x-model="formData.constructionFloorArea"
                                               name="constructionFloorArea"
                                               @input="validateField('constructionFloorArea')"
                                               :class="formErrors.constructionFloorArea ? 'border-red-300' : ''"
                                               class="input"
                                               placeholder="例：110.00"
                                               min="33"
                                               max="330"
                                               step="0.01"
                                               required>
                                        <div x-show="calculatedConstructionTsubo" class="text-xs text-gray-500 mt-1">
                                            坪数: <span class="font-semibold text-gray-700" x-text="`${calculatedConstructionTsubo}坪`"></span>
                                        </div>
                                        <div x-show="formErrors.constructionFloorArea" class="text-red-500 text-xs mt-1" x-text="formErrors.constructionFloorArea"></div>
                                    </label>
                                    <label class="form-field">
                                        <span>間口（mm） <span class="text-red-500">*</span></span>
                                        <input type="number"
                                               x-model="formData.width"
                                               name="width"
                                               @input="calculateTsubo(); validateField('width')"
                                               :class="formErrors.width ? 'border-red-300' : ''"
                                               class="input"
                                               placeholder="例：5460"
                                               min="3000"
                                               max="15000"
                                               required>
                                        <div x-show="formErrors.width" class="text-red-500 text-xs mt-1" x-text="formErrors.width"></div>
                                    </label>
                                    <label class="form-field">
                                        <span>奥行（mm） <span class="text-red-500">*</span></span>
                                        <input type="number"
                                               x-model="formData.depth"
                                               name="depth"
                                               @input="calculateTsubo(); validateField('depth')"
                                               :class="formErrors.depth ? 'border-red-300' : ''"
                                               class="input"
                                               placeholder="例：9100"
                                               min="3000"
                                               max="20000"
                                               required>
                                        <div x-show="formErrors.depth" class="text-red-500 text-xs mt-1" x-text="formErrors.depth"></div>
                                    </label>
                                    <label class="form-field">
                                        <span>間取り <span class="text-red-500">*</span></span>
                                        <select x-model="formData.layout"
                                                name="layout"
                                                @change="validateField('layout')"
                                                :class="formErrors.layout ? 'border-red-300' : ''"
                                                class="input"
                                                required>
                                            <option value="">選択してください</option>
                                            <option value="1LDK">1LDK</option>
                                            <option value="2LDK">2LDK</option>
                                            <option value="3LDK">3LDK</option>
                                            <option value="4LDK">4LDK</option>
                                            <option value="5LDK">5LDK</option>
                                            <option value="その他">その他</option>
                                        </select>
                                        <div x-show="formErrors.layout" class="text-red-500 text-xs mt-1" x-text="formErrors.layout"></div>
                                    </label>
                                    <label class="form-field md:col-span-2 lg:col-span-3">
                                        <span>説明</span>
                                        <textarea x-model="formData.description" name="description" rows="3" class="input h-24" placeholder="プランの特徴やポイントを入力してください"></textarea>
                                    </label>
                            </div>
                        </section>

                        <!-- 価格情報セクション -->
                        <section class="border border-gray-200 rounded-xl p-3 sm:p-5">
                            <h3 class="text-base font-semibold text-gray-900 mb-4">価格情報</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
                                    <label class="form-field">
                                        <span>想定販売価格（万円）<span class="text-red-500">*</span> <span class="ml-1 text-gray-400">税込</span></span>
                                        <select x-model="formData.sellPrice"
                                                name="sellPrice"
                                                @change="calculateProfits(); validateField('sellPrice')"
                                                :class="formErrors.sellPrice ? 'border-red-300' : ''"
                                                class="input"
                                                required>
                                            <option value="">選択してください</option>
                                            <option value="2400">2400万円</option>
                                            <option value="2500">2500万円</option>
                                            <option value="2610">2610万円</option>
                                            <option value="2720">2720万円</option>
                                            <option value="2830">2830万円</option>
                                            <option value="その他">その他（直接入力）</option>
                                        </select>
                                        <div x-show="formData.sellPrice === 'その他'" class="mt-2">
                                            <input type="number"
                                                   x-model="formData.customSellPrice"
                                                   name="customSellPrice"
                                                   @input="calculateProfits()"
                                                   class="input"
                                                   placeholder="事：3980"
                                                   min="1000"
                                                   max="10000">
                                        </div>
                                        <div x-show="formErrors.sellPrice" class="text-red-500 text-xs mt-1" x-text="formErrors.sellPrice"></div>
                                    </label>
                                    <label class="form-field">
                                        <span>想定原価（万円） <span class="text-red-500">*</span> <a class="text-blue-600 underline text-xs">税別</a></span>
                                        <input type="number"
                                               x-model="formData.cost"
                                               name="cost"
                                               @input="calculateProfits(); validateField('cost')"
                                               :class="formErrors.cost ? 'border-red-300' : ''"
                                               class="input"
                                               placeholder="例：1500"
                                               min="500"
                                               max="5000"
                                               required>
                                        <div x-show="formErrors.cost" class="text-red-500 text-xs mt-1" x-text="formErrors.cost"></div>
                                    </label>
                                    <div class="form-field">
                                        <span>想定粗利益（万円） <a class="text-blue-600 underline text-xs">税別</a></span>
                                        <input type="text" x-model="calculatedGrossProfit"
                                               class="input bg-green-50"
                                               name="priceGross"
                                               readonly>
                                        <p class="text-xs text-gray-400 mt-1">自動計算</p>
                                    </div>
                                    <label class="form-field">
                                        <span>UA値（W/㎡K）</span>
                                        <input type="number" x-model="formData.uaValue"
                                               name="ua"
                                               class="input"
                                               placeholder="0.87"
                                               step="0.01"
                                               min="0"
                                               max="2">
                                        <p class="text-[11px] text-gray-400 mt-1">外皮平均熱貫流率</p>
                                    </label>
                                    <label class="form-field">
                                        <span>一次エネルギー削減率（再エネなし）%</span>
                                        <input type="number" x-model="formData.energyReduction"
                                               name="bei"
                                               class="input"
                                               placeholder="20"
                                               min="0"
                                               max="100">
                                        <p class="text-[11px] text-gray-400 mt-1">BEI値から算出</p>
                                    </label>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:col-span-3 mt-4">
                                        <label class="form-field">
                                            <span>ステータス</span>
                                            <select x-model="formData.status" name="status" class="input">
                                                <option value="draft">下書き（非公開）</option>
                                                <option value="published">公開中</option>
                                            </select>
                                            <p class="text-xs text-gray-400 mt-1">下書きで保存後、内容を確認してから公開してください</p>
                                        </label>
                                        <label class="form-field">
                                            <span>設計担当者</span>
                                            <input type="text" x-model="formData.designer" name="designer" class="input" placeholder="設計者名">
                                        </label>
                                    </div>
                            </div>
                        </section>

                        <!-- 特徴タグセクション -->
                        <section class="border border-gray-200 rounded-xl p-5">
                            <h3 class="text-base font-semibold text-gray-900 mb-4">特徴タグ</h3>
                            <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">住空間特徴</label>
                                        <div class="flex flex-wrap gap-2">
                                            <template x-for="tag in ['吹抜', 'フリースペース', '書斎', '畳スペース', 'バルコニー']" :key="tag">
                                                <button type="button"
                                                        @click="toggleFeatureTag(tag)"
                                                        :class="formData.featureTags && formData.featureTags.includes(tag) ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-700 border-gray-300 hover:bg-blue-50 active:bg-blue-100'"
                                                        class="px-4 py-3 border rounded-lg text-sm sm:text-base transition-colors duration-200 flex items-center justify-center space-x-2 min-h-[44px]">
                                                    <span x-show="formData.featureTags && formData.featureTags.includes(tag)" class="text-white">✓</span>
                                                    <span x-text="tag"></span>
                                                </button>
                                            </template>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">収納設備</label>
                                        <div class="flex flex-wrap gap-2">
                                            <template x-for="tag in ['パントリー', 'ウォークインクローゼット', 'シューズクローク', 'ファミリークローク', 'リビング収納']" :key="tag">
                                                <button type="button"
                                                        @click="toggleFeatureTag(tag)"
                                                        :class="formData.featureTags && formData.featureTags.includes(tag) ? 'bg-green-600 text-white border-green-600' : 'bg-white text-gray-700 border-gray-300 hover:bg-green-50 active:bg-green-100'"
                                                        class="px-4 py-3 border rounded-lg text-sm sm:text-base transition-colors duration-200 flex items-center justify-center space-x-2 min-h-[44px]">
                                                    <span x-show="formData.featureTags && formData.featureTags.includes(tag)" class="text-white">✓</span>
                                                    <span x-text="tag"></span>
                                                </button>
                                            </template>
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">カスタムタグ</label>
                                        <input type="text" x-model="formData.customTags" 
                                               class="form-input w-full" 
                                               placeholder="独自の特徴をカンマ区切りで入力（例: 太陽光発電, 床暖房, IHクッキングヒーター）">
                                        <div class="text-xs text-gray-500 mt-1">カスタムタグは自由に追加できます</div>
                                    </div>
                                    
                                    <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                                        <h5 class="font-medium text-blue-900 mb-2">選択されたタグ</h5>
                                        <div class="flex flex-wrap gap-1">
                                            <template x-for="tag in getAllSelectedTags()" :key="tag">
                                                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs" x-text="tag"></span>
                                            </template>
                                            <span x-show="getAllSelectedTags().length === 0" class="text-blue-600 text-sm">タグが選択されていません</span>
                                        </div>
                                    </div>
                            </div>
                        </section>

                        <!-- 画像・ファイルセクション -->
                        <section class="border border-gray-200 rounded-xl p-5">
                            <h3 class="text-base font-semibold text-gray-900 mb-4">画像・ファイル</h3>
                            <div class="grid grid-cols-2 gap-4">
                                    <!-- 外観パース -->
                                    <div>
                                        <label class="text-sm font-medium text-gray-700 mb-2 block">外観パース <span class="text-red-500">*</span></label>
                                        <div class="file-upload-item">
                                            <input type="file" @change="handleFileSelect($event, 'image', 'exterior')" accept="image/*" class="hidden" id="file-exterior">

                                            <!-- プレビューまたはアップロード領域 -->
                                            <template x-if="formData.files?.images?.exterior?.preview">
                                                <div class="relative border-2 border-green-300 rounded-lg overflow-hidden bg-green-50">
                                                    <img :src="formData.files.images.exterior.preview"
                                                         alt="外観パース"
                                                         class="w-full h-48 object-cover">
                                                    <div class="absolute top-2 right-2 flex gap-2">
                                                        <button type="button"
                                                                @click.stop="removeFile('image', 'exterior')"
                                                                class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-full shadow-lg transition-colors">
                                                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                            </svg>
                                                        </button>
                                                    </div>
                                                    <div class="p-2 bg-white bg-opacity-90">
                                                        <p class="text-sm text-green-600 font-medium truncate" x-text="formData.files.images.exterior.name"></p>
                                                        <p class="text-xs text-gray-500" x-text="(formData.files.images.exterior.size / 1024).toFixed(1) + ' KB'"></p>
                                                    </div>
                                                </div>
                                            </template>

                                            <template x-if="!formData.files?.images?.exterior?.preview">
                                                <div @drop="handleDrop($event, 'image', 'exterior')"
                                                     @dragover.prevent
                                                     @dragenter.prevent
                                                     @dragenter="$event.target.closest('.file-upload-item').classList.add('drag-over')"
                                                     @dragleave="$event.target.closest('.file-upload-item').classList.remove('drag-over')"
                                                     @click="document.getElementById('file-exterior').click()"
                                                     class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition-colors cursor-pointer min-h-[120px] sm:min-h-[100px] flex flex-col items-center justify-center active:bg-gray-100">
                                                    <div class="flex items-center justify-center mb-2">
                                                        <svg class="h-8 w-8 text-gray-400 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                        </svg>
                                                        <span class="font-medium text-gray-700">外観パース</span>
                                                    </div>
                                                    <span class="text-gray-500 text-sm">ドラッグ&ドロップまたはクリック</span>
                                                    <span class="text-gray-400 text-xs mt-1">JPG, PNG, WebP (5MB以下)</span>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                    
                                    <!-- 内観パース -->
                                    <div>
                                        <label class="text-sm font-medium text-gray-700 mb-2 block">内観パース</label>
                                        <div class="file-upload-item">
                                            <input type="file" @change="handleFileSelect($event, 'image', 'interior')" accept="image/*" class="hidden" id="file-interior">

                                            <!-- プレビューまたはアップロード領域 -->
                                            <template x-if="formData.files?.images?.interior?.preview">
                                                <div class="relative border-2 border-green-300 rounded-lg overflow-hidden bg-green-50">
                                                    <img :src="formData.files.images.interior.preview"
                                                         alt="内観パース"
                                                         class="w-full h-48 object-cover">
                                                    <div class="absolute top-2 right-2 flex gap-2">
                                                        <button type="button"
                                                                @click.stop="removeFile('image', 'interior')"
                                                                class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-full shadow-lg transition-colors">
                                                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                            </svg>
                                                        </button>
                                                    </div>
                                                    <div class="p-2 bg-white bg-opacity-90">
                                                        <p class="text-sm text-green-600 font-medium truncate" x-text="formData.files.images.interior.name"></p>
                                                        <p class="text-xs text-gray-500" x-text="(formData.files.images.interior.size / 1024).toFixed(1) + ' KB'"></p>
                                                    </div>
                                                </div>
                                            </template>

                                            <template x-if="!formData.files?.images?.interior?.preview">
                                                <div @drop="handleDrop($event, 'image', 'interior')"
                                                     @dragover.prevent
                                                     @dragenter.prevent
                                                     @dragenter="$event.target.closest('.file-upload-item').classList.add('drag-over')"
                                                     @dragleave="$event.target.closest('.file-upload-item').classList.remove('drag-over')"
                                                     @click="document.getElementById('file-interior').click()"
                                                     class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition-colors cursor-pointer min-h-[120px] sm:min-h-[100px] flex flex-col items-center justify-center active:bg-gray-100">
                                                    <div class="flex items-center justify-center mb-2">
                                                        <svg class="h-8 w-8 text-gray-400 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                        </svg>
                                                        <span class="font-medium text-gray-700">内観パース</span>
                                                    </div>
                                                    <span class="text-gray-500 text-sm">ドラッグ&ドロップまたはクリック</span>
                                                    <span class="text-gray-400 text-xs mt-1">JPG, PNG, WebP (5MB以下)</span>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>

                            <div class="bg-gray-50 p-4 rounded-lg mt-4">
                                <h4 class="text-base font-semibold text-gray-900 mb-4">間取り図アップロード</h4>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    <template x-for="floor in Array.from({length: parseInt(formData.floors) || 1}, (_, i) => i + 1)" :key="floor">
                                        <div>
                                            <label class="text-xs font-medium text-gray-700 mb-1 block" x-text="`${floor}階`"></label>
                                            <div class="file-upload-item">
                                                <input type="file" @change="handleFileSelect($event, 'floorPlan', floor)" accept="image/*" class="hidden" :id="'file-floor-' + floor">

                                                <!-- プレビューまたはアップロード領域 -->
                                                <template x-if="formData.files?.floorPlans?.[floor]?.preview">
                                                    <div class="relative border-2 border-green-300 rounded-lg overflow-hidden bg-green-50">
                                                        <img :src="formData.files.floorPlans[floor].preview"
                                                             :alt="`${floor}階間取り図`"
                                                             class="w-full h-32 object-contain bg-white">
                                                        <div class="absolute top-2 right-2">
                                                            <button type="button"
                                                                    @click.stop="removeFile('floorPlan', floor)"
                                                                    class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-full shadow-lg transition-colors">
                                                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                                </svg>
                                                            </button>
                                                        </div>
                                                        <div class="p-2 bg-white bg-opacity-90">
                                                            <p class="text-sm text-green-600 font-medium truncate" x-text="`${floor}階: ${formData.files.floorPlans[floor].name}`"></p>
                                                            <p class="text-xs text-gray-500" x-text="(formData.files.floorPlans[floor].size / 1024).toFixed(1) + ' KB'"></p>
                                                        </div>
                                                    </div>
                                                </template>

                                                <template x-if="!formData.files?.floorPlans?.[floor]?.preview">
                                                    <div
                                                        @drop="handleDrop($event, 'floorPlan', floor)"
                                                        @dragover.prevent
                                                        @dragenter.prevent
                                                        @dragenter="$event.target.closest('.file-upload-item').classList.add('drag-over')"
                                                        @dragleave="$event.target.closest('.file-upload-item').classList.remove('drag-over')"
                                                        @click="document.getElementById('file-floor-' + floor).click()"
                                                        class="border-2 border-dashed border-gray-300 rounded p-3 text-xs hover:bg-gray-50 transition-colors cursor-pointer h-32 flex flex-col items-center justify-center active:bg-gray-100">
                                                        <svg class="h-6 w-6 text-gray-400 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                        </svg>
                                                        <span class="text-gray-500 text-center">クリック</span>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <!-- プラン関連ファイル -->
                            <div class="border-t pt-4 mt-4">
                                <h4 class="text-sm font-semibold text-gray-900 mb-3">プラン関連ファイル</h4>
                            
                            <!-- プレゼン資料 -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">プレゼン資料</label>
                                <div class="file-upload-item">
                                    <input type="file" @change="handleFileSelect($event, 'presentation')" accept=".pptx,.ppt,.pdf" class="hidden" id="file-presentation">

                                    <!-- プレビューまたはアップロード領域 -->
                                    <template x-if="formData.files?.presentation?.name">
                                        <div class="relative border-2 border-green-300 rounded-lg overflow-hidden bg-green-50">
                                            <div class="w-full h-32 bg-orange-50 flex items-center justify-center">
                                                <svg class="w-16 h-16 text-orange-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                                </svg>
                                            </div>
                                            <div class="absolute top-2 right-2">
                                                <button type="button" @click.stop="removeFile('presentation')" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-full shadow-lg transition-colors">
                                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                    </svg>
                                                </button>
                                            </div>
                                            <div class="p-2 bg-white bg-opacity-90">
                                                <p class="text-sm text-green-600 font-medium truncate" x-text="formData.files.presentation.name"></p>
                                                <p class="text-xs text-gray-500" x-text="(formData.files.presentation.size / 1024).toFixed(1) + ' KB'"></p>
                                            </div>
                                        </div>
                                    </template>

                                    <!-- 初回アップロード領域 -->
                                    <template x-if="!formData.files?.presentation?.name">
                                        <div @drop="handleDrop($event, 'presentation')" @dragover.prevent @dragenter.prevent @click="document.getElementById('file-presentation').click()" class="border-2 border-dashed border-gray-300 rounded p-4 text-center hover:bg-gray-50 transition-colors cursor-pointer min-h-[100px] flex flex-col items-center justify-center active:bg-gray-100">
                                            <svg class="h-10 w-10 text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                            </svg>
                                            <span class="text-gray-600 text-sm">プレゼン資料（PowerPoint, PDF）</span>
                                            <span class="text-gray-500 text-xs mt-1">ドラッグ&ドロップまたはクリック</span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            
                            <!-- 図面（アコーディオン化） -->
                            <div class="mb-4" x-data="{
                                equipmentOpen: true,
                                structureOpen: true,
                                presentationOpen: true
                            }">
                                <label class="block text-sm font-medium text-gray-700 mb-2">図面（グループ別）</label>

                                <!-- 設備図面グループ -->
                                <div class="mb-2 border border-gray-200 rounded-lg overflow-hidden">
                                    <button type="button" @click="equipmentOpen = !equipmentOpen" class="w-full px-4 py-3 bg-gray-50 hover:bg-gray-100 flex justify-between items-center transition-colors">
                                        <span class="font-medium text-gray-700">🏠 設備図面（8種類）</span>
                                        <svg class="w-5 h-5 transition-transform" :class="equipmentOpen ? 'rotate-180' : ''" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </button>
                                    <div x-show="equipmentOpen" x-collapse class="p-3 bg-white">
                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                            <template x-for="drawing in ['キッチン', '洗面化粧台', 'システムバス', 'トイレ', '照明', '換気システム', 'evoltz', '太陽光']" :key="drawing">
                                                <div class="mb-3">
                                                    <label class="block text-xs font-medium text-gray-600 mb-1" x-text="drawing"></label>
                                                    <div class="file-upload-item">
                                                        <input type="file" multiple @change="handleFileSelect($event, 'drawing', drawing)" accept=".pdf,.jpg,.jpeg,.png" class="hidden" :id="'file-' + drawing.replace(/[^a-zA-Z0-9]/g, '')">

                                                        <!-- プレビューまたはアップロード領域 -->
                                                        <template x-if="formData.files?.drawings?.[drawing]?.length > 0">
                                                            <div class="space-y-2">
                                                                <template x-for="(file, index) in formData.files.drawings[drawing]" :key="index">
                                                                    <div class="relative border-2 border-green-300 rounded-lg overflow-hidden bg-green-50">
                                                                        <!-- 画像プレビュー -->
                                                                        <template x-if="file.preview">
                                                                            <img :src="file.preview" :alt="file.name" class="w-full h-32 object-contain bg-white">
                                                                        </template>
                                                                        <!-- PDFプレビュー -->
                                                                        <template x-if="!file.preview">
                                                                            <div class="w-full h-32 bg-red-50 flex items-center justify-center">
                                                                                <svg class="w-12 h-12 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                                                                </svg>
                                                                            </div>
                                                                        </template>
                                                                        <!-- 削除ボタン -->
                                                                        <div class="absolute top-2 right-2">
                                                                            <button type="button" @click.stop="removeDrawingFile(drawing, index)" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-full shadow-lg transition-colors">
                                                                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                                                </svg>
                                                                            </button>
                                                                        </div>
                                                                        <!-- ファイル情報 -->
                                                                        <div class="p-2 bg-white bg-opacity-90">
                                                                            <p class="text-sm text-green-600 font-medium truncate" x-text="file.name"></p>
                                                                            <p class="text-xs text-gray-500" x-text="(file.size / 1024).toFixed(1) + ' KB'"></p>
                                                                        </div>
                                                                    </div>
                                                                </template>
                                                                <!-- 追加アップロード -->
                                                                <button type="button" @click="document.getElementById('file-' + drawing.replace(/[^a-zA-Z0-9]/g, '')).click()" class="w-full border-2 border-dashed border-gray-300 rounded p-2 text-xs hover:bg-gray-50 transition-colors active:bg-gray-100">
                                                                    + さらに追加
                                                                </button>
                                                            </div>
                                                        </template>

                                                        <!-- 初回アップロード領域 -->
                                                        <template x-if="!formData.files?.drawings?.[drawing] || formData.files.drawings[drawing].length === 0">
                                                            <div @drop="handleDrop($event, 'drawing', drawing)" @dragover.prevent @dragenter.prevent @click="document.getElementById('file-' + drawing.replace(/[^a-zA-Z0-9]/g, '')).click()" class="border-2 border-dashed border-gray-300 rounded p-3 text-xs hover:bg-gray-50 transition-colors cursor-pointer min-h-[90px] sm:min-h-[70px] flex flex-col items-center justify-center active:bg-gray-100">
                                                                <svg class="h-6 w-6 text-gray-400 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                                                </svg>
                                                                <span class="text-gray-500 text-center">ドラッグ&ドロップ<br>またはクリック</span>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>

                                <!-- 構造図面グループ -->
                                <div class="mb-2 border border-gray-200 rounded-lg overflow-hidden">
                                    <button type="button" @click="structureOpen = !structureOpen" class="w-full px-4 py-3 bg-gray-50 hover:bg-gray-100 flex justify-between items-center transition-colors">
                                        <span class="font-medium text-gray-700">🏗️ 構造図面（4種類）</span>
                                        <svg class="w-5 h-5 transition-transform" :class="structureOpen ? 'rotate-180' : ''" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </button>
                                    <div x-show="structureOpen" x-collapse class="p-3 bg-white">
                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                            <template x-for="drawing in ['実施図', '申請図', '構造図', 'プレカット図']" :key="drawing">
                                                <div class="mb-3">
                                                    <label class="block text-xs font-medium text-gray-600 mb-1" x-text="drawing"></label>
                                                    <div class="file-upload-item">
                                                        <input type="file" multiple @change="handleFileSelect($event, 'drawing', drawing)" accept=".pdf,.jpg,.jpeg,.png" class="hidden" :id="'file-' + drawing.replace(/[^a-zA-Z0-9]/g, '')">
                                                        <template x-if="formData.files?.drawings?.[drawing]?.length > 0">
                                                            <div class="space-y-2">
                                                                <template x-for="(file, index) in formData.files.drawings[drawing]" :key="index">
                                                                    <div class="relative border-2 border-green-300 rounded-lg overflow-hidden bg-green-50">
                                                                        <template x-if="file.preview">
                                                                            <img :src="file.preview" :alt="file.name" class="w-full h-32 object-contain bg-white">
                                                                        </template>
                                                                        <template x-if="!file.preview">
                                                                            <div class="w-full h-32 bg-red-50 flex items-center justify-center">
                                                                                <svg class="w-12 h-12 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                                                                </svg>
                                                                            </div>
                                                                        </template>
                                                                        <div class="absolute top-2 right-2">
                                                                            <button type="button" @click.stop="removeDrawingFile(drawing, index)" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-full shadow-lg transition-colors">
                                                                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                                                </svg>
                                                                            </button>
                                                                        </div>
                                                                        <div class="p-2 bg-white bg-opacity-90">
                                                                            <p class="text-sm text-green-600 font-medium truncate" x-text="file.name"></p>
                                                                            <p class="text-xs text-gray-500" x-text="(file.size / 1024).toFixed(1) + ' KB'"></p>
                                                                        </div>
                                                                    </div>
                                                                </template>
                                                                <button type="button" @click="document.getElementById('file-' + drawing.replace(/[^a-zA-Z0-9]/g, '')).click()" class="w-full border-2 border-dashed border-gray-300 rounded p-2 text-xs hover:bg-gray-50 transition-colors active:bg-gray-100">+ さらに追加</button>
                                                            </div>
                                                        </template>
                                                        <template x-if="!formData.files?.drawings?.[drawing] || formData.files.drawings[drawing].length === 0">
                                                            <div @drop="handleDrop($event, 'drawing', drawing)" @dragover.prevent @dragenter.prevent @click="document.getElementById('file-' + drawing.replace(/[^a-zA-Z0-9]/g, '')).click()" class="border-2 border-dashed border-gray-300 rounded p-3 text-xs hover:bg-gray-50 transition-colors cursor-pointer min-h-[90px] sm:min-h-[70px] flex flex-col items-center justify-center active:bg-gray-100">
                                                                <svg class="h-6 w-6 text-gray-400 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                                                </svg>
                                                                <span class="text-gray-500 text-center">ドラッグ&ドロップ<br>またはクリック</span>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>

                                <!-- プレゼン図面グループ -->
                                <div class="mb-2 border border-gray-200 rounded-lg overflow-hidden">
                                    <button type="button" @click="presentationOpen = !presentationOpen" class="w-full px-4 py-3 bg-gray-50 hover:bg-gray-100 flex justify-between items-center transition-colors">
                                        <span class="font-medium text-gray-700">📊 プレゼン図面（4種類）</span>
                                        <svg class="w-5 h-5 transition-transform" :class="presentationOpen ? 'rotate-180' : ''" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </button>
                                    <div x-show="presentationOpen" x-collapse class="p-3 bg-white">
                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                            <template x-for="drawing in ['仕様書・外装プレゼン', '内装プレゼン', '建具プレゼン', 'サッシプレゼン']" :key="drawing">
                                                <div class="mb-3">
                                                    <label class="block text-xs font-medium text-gray-600 mb-1" x-text="drawing"></label>
                                                    <div class="file-upload-item">
                                                        <input type="file" multiple @change="handleFileSelect($event, 'drawing', drawing)" accept=".pdf,.jpg,.jpeg,.png,.xlsx,.xls" class="hidden" :id="'file-' + drawing.replace(/[^a-zA-Z0-9]/g, '')">
                                                        <template x-if="formData.files?.drawings?.[drawing]?.length > 0">
                                                            <div class="space-y-2">
                                                                <template x-for="(file, index) in formData.files.drawings[drawing]" :key="index">
                                                                    <div class="relative border-2 border-green-300 rounded-lg overflow-hidden bg-green-50">
                                                                        <template x-if="file.preview">
                                                                            <img :src="file.preview" :alt="file.name" class="w-full h-32 object-contain bg-white">
                                                                        </template>
                                                                        <template x-if="!file.preview">
                                                                            <div class="w-full h-32 bg-green-50 flex items-center justify-center">
                                                                                <svg class="w-12 h-12 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                                                </svg>
                                                                            </div>
                                                                        </template>
                                                                        <div class="absolute top-2 right-2">
                                                                            <button type="button" @click.stop="removeDrawingFile(drawing, index)" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-full shadow-lg transition-colors">
                                                                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                                                </svg>
                                                                            </button>
                                                                        </div>
                                                                        <div class="p-2 bg-white bg-opacity-90">
                                                                            <p class="text-sm text-green-600 font-medium truncate" x-text="file.name"></p>
                                                                            <p class="text-xs text-gray-500" x-text="(file.size / 1024).toFixed(1) + ' KB'"></p>
                                                                        </div>
                                                                    </div>
                                                                </template>
                                                                <button type="button" @click="document.getElementById('file-' + drawing.replace(/[^a-zA-Z0-9]/g, '')).click()" class="w-full border-2 border-dashed border-gray-300 rounded p-2 text-xs hover:bg-gray-50 transition-colors active:bg-gray-100">+ さらに追加</button>
                                                            </div>
                                                        </template>
                                                        <template x-if="!formData.files?.drawings?.[drawing] || formData.files.drawings[drawing].length === 0">
                                                            <div @drop="handleDrop($event, 'drawing', drawing)" @dragover.prevent @dragenter.prevent @click="document.getElementById('file-' + drawing.replace(/[^a-zA-Z0-9]/g, '')).click()" class="border-2 border-dashed border-gray-300 rounded p-3 text-xs hover:bg-gray-50 transition-colors cursor-pointer min-h-[90px] sm:min-h-[70px] flex flex-col items-center justify-center active:bg-gray-100">
                                                                <svg class="h-6 w-6 text-gray-400 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                                                </svg>
                                                                <span class="text-gray-500 text-center">ドラッグ&ドロップ<br>またはクリック</span>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <!-- その他のファイル -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">その他の資料</label>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    <template x-for="doc in ['実行予算', 'Walk in Homeデータ']" :key="doc">
                                        <div class="mb-3">
                                            <label class="block text-xs font-medium text-gray-600 mb-1" x-text="doc"></label>
                                            <div class="file-upload-item">
                                                <input type="file" multiple @change="handleFileSelect($event, 'document', doc)" accept=".pdf,.xlsx,.xls,.doc,.docx" class="hidden" :id="'file-' + doc.replace(/[^a-zA-Z0-9]/g, '')">

                                                <!-- プレビューまたはアップロード領域 -->
                                                <template x-if="formData.files?.documents?.[doc]?.length > 0">
                                                    <div class="space-y-2">
                                                        <template x-for="(file, index) in formData.files.documents[doc]" :key="index">
                                                            <div class="relative border-2 border-green-300 rounded-lg overflow-hidden bg-green-50">
                                                                <div class="w-full h-24 bg-blue-50 flex items-center justify-center">
                                                                    <svg class="w-10 h-10 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                                    </svg>
                                                                </div>
                                                                <div class="absolute top-2 right-2">
                                                                    <button type="button" @click.stop="removeDocumentFile(doc, index)" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-full shadow-lg transition-colors">
                                                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                                        </svg>
                                                                    </button>
                                                                </div>
                                                                <div class="p-2 bg-white bg-opacity-90">
                                                                    <p class="text-sm text-green-600 font-medium truncate" x-text="file.name"></p>
                                                                    <p class="text-xs text-gray-500" x-text="(file.size / 1024).toFixed(1) + ' KB'"></p>
                                                                </div>
                                                            </div>
                                                        </template>
                                                        <button type="button" @click="document.getElementById('file-' + doc.replace(/[^a-zA-Z0-9]/g, '')).click()" class="w-full border-2 border-dashed border-gray-300 rounded p-2 text-xs hover:bg-gray-50 transition-colors active:bg-gray-100">+ さらに追加</button>
                                                    </div>
                                                </template>

                                                <!-- 初回アップロード領域 -->
                                                <template x-if="!formData.files?.documents?.[doc] || formData.files.documents[doc].length === 0">
                                                    <div @drop="handleDrop($event, 'document', doc)" @dragover.prevent @dragenter.prevent @click="document.getElementById('file-' + doc.replace(/[^a-zA-Z0-9]/g, '')).click()" class="border-2 border-dashed border-gray-300 rounded p-3 text-xs hover:bg-gray-50 transition-colors cursor-pointer min-h-[90px] sm:min-h-[70px] flex flex-col items-center justify-center active:bg-gray-100">
                                                        <svg class="h-6 w-6 text-gray-400 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                                        </svg>
                                                        <span class="text-gray-500 text-center">ドラッグ&ドロップ<br>またはクリック</span>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                        </section>

                    </div>
                    <!-- modal-body終了 -->

                    <!-- フッター（常に画面下に表示・スマホ最適化） -->
                    <div class="modal-footer px-4 sm:px-6 py-4 border-t bg-white" style="flex-shrink: 0;">
                        <div class="flex items-center justify-center gap-3 sm:gap-4 w-full">
                            <!-- キャンセルボタン -->
                            <button type="button"
                                    @click="closeModal()"
                                    class="flex-1 sm:flex-none sm:w-32 px-6 py-3 min-h-[48px] rounded-lg border-2 border-gray-300 text-gray-700 hover:bg-gray-50 active:bg-gray-100 transition-colors font-medium text-base">
                                キャンセル
                            </button>

                            <!-- 保存ボタン -->
                            <button type="submit"
                                    :disabled="!isFormValid() || saving"
                                    :class="isFormValid() && !saving ? 'bg-blue-600 hover:bg-blue-700 active:bg-blue-800' : 'bg-gray-400 cursor-not-allowed'"
                                    class="flex-1 sm:flex-none sm:w-32 px-6 py-3 min-h-[48px] rounded-lg text-white font-medium text-base transition-colors disabled:opacity-50">
                                <span x-text="saving ? '保存中...' : '保存'"></span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

    </div>
    <!-- adminPlans() scope end -->

    <script>
        // トースト表示のヘルパー関数（lifeXAPIが未定義の場合の対策）
        function showToast(message, type = 'info') {
            if (window.lifeXAPI && typeof window.lifeXAPI.showToast === 'function') {
                window.lifeXAPI.showToast(message, type);
            } else {
                // フォールバック: alertで表示
                const icon = type === 'success' ? '✓' : type === 'error' ? '✗' : 'ℹ';
                alert(`${icon} ${message}`);
            }
        }

        function adminPlans() {
            return {
                plans: [],
                loading: true,
                filteredPlans: [],
                searchQuery: '',
                filterCategory: '',
                sortBy: 'updated',
                showModal: false,
                editingPlan: null,
                formData: {
                    id: '',
                    floors: '2',
                    totalFloorArea: '',
                    constructionFloorArea: '',
                    width: '',
                    depth: '',
                    layout: '',
                    ldkFloor: '',
                    bathroomFloor: '',
                    sellPrice: '',
                    customSellPrice: '',
                    cost: '',
                    grossProfit: '',
                    uaValue: '',
                    energyReduction: '',
                    status: 'draft',
                    description: '',
                    designer: '',
                    tags: [],
                    featureTags: [],
                    customTags: '',
                    images: {
                        exterior: '',
                        interior: ''
                    },
                    floorPlans: [],
                    files: {
                        presentation: null,
                        drawings: {},
                        documents: {},
                        images: {},
                        floorPlans: {}
                    }
                },
                
                // Enhanced modal functionality
                formErrors: {},
                saving: false,

                get calculatedTsubo() {
                    const area = parseFloat(this.formData.totalFloorArea) || 0;
                    if (area > 0) {
                        const tsubo = area / 3.3058; // m2 to tsubo
                        return Math.round(tsubo * 100) / 100; // 小数点第二位まで
                    }
                    return '';
                },

                get calculatedConstructionTsubo() {
                    const area = parseFloat(this.formData.constructionFloorArea) || 0;
                    if (area > 0) {
                        const tsubo = area / 3.3058; // m2 to tsubo
                        return Math.round(tsubo * 100) / 100; // 小数点第二位まで
                    }
                    return '';
                },

                get calculatedGrossProfit() {
                    const sellPrice = this.getActualSellPrice();
                    const cost = parseFloat(this.formData.cost) || 0;
                    if (sellPrice && cost) {
                        const grossProfit = (sellPrice / 1.1) - cost;
                        return Math.round(grossProfit * 10) / 10; // 小数点1位まで
                    }
                    return '';
                },
                
                get profitMargin() {
                    const sellPrice = this.getActualSellPrice();
                    const cost = parseFloat(this.formData.cost) || 0;
                    if (sellPrice && cost) {
                        const margin = ((sellPrice / 1.1 - cost) / (sellPrice / 1.1)) * 100;
                        return Math.round(margin * 10) / 10;
                    }
                    return 0;
                },

                realtimeChannel: null,

                async init() {
                    // プランデータの読み込み
                    await this.loadPlans();
                    this.filterPlans();
                    this.loading = false;

                    // Realtime購読開始（同時編集対応）
                    if (typeof this.setupRealtimeSubscription === 'function') {
                        this.setupRealtimeSubscription();
                    }

                    // Escキーでモーダルを閉じる
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape' && this.showModal) {
                            this.closeModal();
                        }
                    });

                    // デバッグ: 保存ボタンのクリック阻害要素を検出
                    this.$nextTick(() => {
                        const checkClickability = () => {
                            const btn = document.querySelector('button[type="submit"]');
                            if (btn) {
                                const r = btn.getBoundingClientRect();
                                const elOnTop = document.elementFromPoint(r.left + r.width / 2, r.top + r.height / 2);
                                if (elOnTop && elOnTop !== btn && !btn.contains(elOnTop)) {
                                    console.warn('[Debug] Element blocking save button:', elOnTop);
                                } else {
                                    console.log('[Debug] Save button is clickable');
                                }
                            }
                        };
                        // モーダル表示時にチェック
                        this.$watch('showModal', (value) => {
                            if (value) {
                                setTimeout(checkClickability, 100);
                            }
                        });
                    });
                },
                
                async loadPlans() {
                    this.loading = true;
                    try {
                        console.log('[LoadPlans] Supabaseからプランを取得');
                        const plans = await window.supabaseBridge.getPlans();
                        this.plans = plans || [];
                        console.log('[LoadPlans] Supabaseから取得成功:', this.plans.length, '件');
                        this.filterPlans();
                    } catch (error) {
                        console.error('プランの読み込みに失敗しました:', error);
                        showToast('プランの読み込みに失敗しました', 'error');
                        this.plans = [];
                    } finally {
                        this.loading = false;
                    }
                },

                filterPlans() {
                    let filtered = [...this.plans];
                    
                    if (this.searchQuery) {
                        filtered = filtered.filter(plan => 
                            plan.id.toLowerCase().includes(this.searchQuery.toLowerCase())
                        );
                    }
                    
                    if (this.filterCategory) {
                        if (this.filterCategory.includes('坪')) {
                            const size = parseInt(this.filterCategory);
                            filtered = filtered.filter(plan => plan.size === size);
                        } else {
                            filtered = filtered.filter(plan =>
                                (plan.name || plan.plan_name || '').includes(this.filterCategory)
                            );
                        }
                    }
                    
                    this.filteredPlans = filtered;
                    this.sortPlans();
                },

                sortPlans() {
                    this.filteredPlans.sort((a, b) => {
                        switch(this.sortBy) {
                            case 'name':
                                return a.name.localeCompare(b.name);
                            case 'date':
                                return new Date(b.updated) - new Date(a.updated);
                            case 'size':
                                return a.size - b.size;
                            default:
                                return 0;
                        }
                    });
                },

                openAddModal() {
                    this.editingPlan = null;
                    this.currentTab = 'basic';
                    this.formErrors = {};
                    this.saving = false;
                    this.formData = {
                        id: crypto.randomUUID(),  // UUID自動生成（内部用・非表示）
                        planCode: '',  // 手入力用プランコード（任意）
                        floors: '2',
                        ldkFloor: '1',  // 数値文字列に修正
                        bathroomFloor: '1',  // 数値文字列に修正
                        totalFloorArea: '',
                        constructionFloorArea: '',
                        width: '',
                        depth: '',
                        layout: '',
                        sellPrice: '',
                        customSellPrice: '',
                        cost: '',
                        grossProfit: '',
                        uaValue: '',
                        energyReduction: '',
                        status: 'draft',
                        description: '',
                        designer: '',
                        featureTags: [],
                        customTags: '',
                        images: {
                            exterior: '',
                            interior: ''
                        },
                        floorPlans: [],
                        files: {
                            presentation: null,
                            drawings: {},
                            documents: {},
                            images: {},
                            floorPlans: {}
                        }
                    };
                    this.showModal = true;

                    // モーダルのスクロール位置を先頭にリセット
                    this.$nextTick(() => {
                        const modalBody = document.querySelector('.modal-body');
                        if (modalBody) {
                            modalBody.scrollTop = 0;
                        }
                    });
                },
                
                // Form validation
                validateField(fieldName) {
                    this.formErrors = {...this.formErrors};
                    delete this.formErrors[fieldName];

                    switch(fieldName) {
                        case 'id':
                            if (!this.formData.id) {
                                this.formErrors.id = 'プランIDは必須です';
                            } else {
                                // 重複チェック（編集時は自分自身を除外）
                                const duplicate = this.plans.find(p =>
                                    p.id === this.formData.id &&
                                    (!this.editingPlan || p.id !== this.editingPlan.id)
                                );
                                if (duplicate) {
                                    this.formErrors.id = 'このプランIDは既に使用されています';
                                } else {
                                    delete this.formErrors.id;
                                }
                            }
                            break;
                        case 'planCode':
                            if (!this.formData.planCode) {
                                this.formErrors.planCode = 'プランコードは必須です';
                            } else if (!/^[A-Za-z0-9\-]+$/.test(this.formData.planCode)) {
                                this.formErrors.planCode = '半角英数字とハイフンのみ使用できます';
                            } else {
                                // 重複チェック（編集時は自分自身を除外）
                                const duplicate = this.plans.find(p =>
                                    p.plan_code === this.formData.planCode &&
                                    (!this.editingPlan || p.plan_code !== this.editingPlan.plan_code)
                                );
                                if (duplicate) {
                                    this.formErrors.planCode = 'このプランコードは既に使用されています';
                                } else {
                                    delete this.formErrors.planCode;
                                }
                            }
                            break;
                        case 'totalFloorArea':
                            if (!this.formData.totalFloorArea) {
                                this.formErrors.totalFloorArea = '延床面積は必須です';
                            } else if (this.formData.totalFloorArea < 33 || this.formData.totalFloorArea > 330) {
                                this.formErrors.totalFloorArea = '延床面積は33-330㎡の範囲で入力してください';
                            } else {
                                delete this.formErrors.totalFloorArea;
                            }
                            break;
                        case 'constructionFloorArea':
                            if (!this.formData.constructionFloorArea) {
                                this.formErrors.constructionFloorArea = '施工床面積は必須です';
                            } else if (this.formData.constructionFloorArea < 33 || this.formData.constructionFloorArea > 330) {
                                this.formErrors.constructionFloorArea = '施工床面積は33-330㎡の範囲で入力してください';
                            } else {
                                delete this.formErrors.constructionFloorArea;
                            }
                            break;
                        case 'layout':
                            if (!this.formData.layout) {
                                this.formErrors.layout = '間取りは必須です';
                            }
                            break;
                        case 'sellPrice':
                            if (!this.getActualSellPrice()) {
                                this.formErrors.sellPrice = '販売価格は必須です';
                            }
                            break;
                        case 'cost':
                            if (!this.formData.cost) {
                                this.formErrors.cost = '原価は必須です';
                            } else if (this.formData.cost < 500 || this.formData.cost > 5000) {
                                this.formErrors.cost = '原価は500-5000万円の範囲で入力してください';
                            }
                            break;
                        case 'width':
                            if (!this.formData.width) {
                                this.formErrors.width = '間口は必須です';
                            } else if (this.formData.width < 3000 || this.formData.width > 15000) {
                                this.formErrors.width = '間口は3000-15000mmの範囲で入力してください';
                            }
                            break;
                        case 'depth':
                            if (!this.formData.depth) {
                                this.formErrors.depth = '奥行は必須です';
                            } else if (this.formData.depth < 3000 || this.formData.depth > 20000) {
                                this.formErrors.depth = '奥行は3000-20000mmの範囲で入力してください';
                            }
                            break;
                    }
                },
                
                getFieldValidationClass(fieldName) {
                    if (this.formErrors[fieldName]) {
                        return 'border-red-300 focus:border-red-500 focus:ring-red-500';
                    } else if (this.isFieldValid(fieldName)) {
                        return 'border-green-300 focus:border-green-500 focus:ring-green-500';
                    }
                    return '';
                },
                
                isFieldValid(fieldName) {
                    switch(fieldName) {
                        case 'id': return !!this.formData.id;
                        case 'planCode': return !!this.formData.planCode && /^[A-Za-z0-9\-]+$/.test(this.formData.planCode);
                        case 'totalFloorArea': return this.formData.totalFloorArea >= 33 && this.formData.totalFloorArea <= 330;
                        case 'constructionFloorArea': return this.formData.constructionFloorArea >= 33 && this.formData.constructionFloorArea <= 330;
                        case 'layout': return !!this.formData.layout;
                        case 'sellPrice': return !!this.getActualSellPrice();
                        case 'cost': return this.formData.cost >= 500 && this.formData.cost <= 5000;
                        case 'width': return this.formData.width >= 3000 && this.formData.width <= 15000;
                        case 'depth': return this.formData.depth >= 3000 && this.formData.depth <= 20000;
                        default: return false;
                    }
                },
                
                isFormValid() {
                    // 基本情報のバリデーションのみチェック（画像は一時的に必須から外す）
                    // planCodeは任意項目（入力されている場合のみバリデーション）
                    const basicValid = this.isFieldValid('id') &&
                           this.isFieldValid('totalFloorArea') &&
                           this.isFieldValid('constructionFloorArea') &&
                           this.isFieldValid('layout') &&
                           this.isFieldValid('sellPrice') &&
                           this.isFieldValid('cost');

                    const validationResult = {
                        id: this.isFieldValid('id'),
                        idValue: this.formData.id,
                        planCode: this.formData.planCode ? this.isFieldValid('planCode') : 'optional',
                        planCodeValue: this.formData.planCode,
                        totalFloorArea: this.isFieldValid('totalFloorArea'),
                        totalFloorAreaValue: this.formData.totalFloorArea,
                        constructionFloorArea: this.isFieldValid('constructionFloorArea'),
                        constructionFloorAreaValue: this.formData.constructionFloorArea,
                        layout: this.isFieldValid('layout'),
                        layoutValue: this.formData.layout,
                        sellPrice: this.isFieldValid('sellPrice'),
                        sellPriceValue: this.formData.sellPrice,
                        cost: this.isFieldValid('cost'),
                        costValue: this.formData.cost,
                        basicValid: basicValid
                    };

                    console.log('🔍 Validation check:', JSON.stringify(validationResult, null, 2));
                    console.log('❓ isFormValid() =', basicValid);

                    return basicValid;
                },
                
                // Smart calculation functions
                getActualSellPrice() {
                    if (this.formData.sellPrice === 'その他') {
                        return parseFloat(this.formData.customSellPrice) || 0;
                    }
                    return parseFloat(this.formData.sellPrice) || 0;
                },
                
                calculateProfits() {
                    // 自動計算は getter で実装済み
                },
                
                calculateTsubo() {
                    if (this.formData.width && this.formData.depth) {
                        const area = (this.formData.width * this.formData.depth) / 1000000; // mm2 to m2
                        const tsubo = area / 3.3058; // m2 to tsubo
                        this.formData.tsubo = Math.round(tsubo * 100) / 100; // 小数点第二位まで
                    }
                },
                
                getProfitMarginStatus() {
                    if (this.profitMargin < 20) return '低い';
                    if (this.profitMargin < 30) return '标準';
                    return '良好';
                },
                
                // Auto-generation functions
                generatePlanCode() {
                    // UUID v4形式で生成（データベースのid型に合わせる）
                    this.formData.id = crypto.randomUUID();
                    this.validateField('id');
                },
                
                getAllSelectedTags() {
                    const tags = [...(this.formData.featureTags || [])];
                    if (this.formData.customTags) {
                        tags.push(...this.formData.customTags.split(',').map(t => t.trim()).filter(t => t));
                    }
                    return tags;
                },

                editPlan(plan) {
                    this.editingPlan = plan;
                    this.currentTab = 'basic';

                    // 延床面積・施工床面積のフォールバック処理（旧データ対応）
                    const tsubo = plan.tsubo || plan.size || 0;
                    const totalFloorArea = plan.total_floor_area || (tsubo > 0 ? Math.round(tsubo * 3.3058 * 100) / 100 : '');
                    const constructionFloorArea = plan.construction_floor_area || totalFloorArea;

                    this.formData = {
                        ...plan,
                        planCode: plan.plan_code || plan.planCode || '',  // プランコード
                        ldkFloor: String(plan.ldkFloor || plan.ldk_floor || 1),  // 数値を文字列に変換
                        bathroomFloor: String(plan.bathroomFloor || plan.bathroom_floor || 1),  // 数値を文字列に変換
                        uaValue: plan.uaValue || plan.ua_value || '',
                        energyReduction: plan.energyReduction || plan.energy_reduction || '',
                        totalFloorArea: totalFloorArea,
                        constructionFloorArea: constructionFloorArea,
                        sellPrice: plan.prices?.sell ? plan.prices.sell / 10000 : (plan.sell_price ? plan.sell_price / 10000 : (plan.sellPrice || plan.price || '')),  // 円→万円に変換
                        cost: plan.prices?.cost ? plan.prices.cost / 10000 : (plan.cost ? plan.cost / 10000 : ''),      // 円→万円に変換
                        grossProfit: plan.prices?.gross ? plan.prices.gross / 10000 : (plan.gross_profit ? plan.gross_profit / 10000 : ''), // 円→万円に変換
                        tags: plan.tags || [],
                        featureTags: plan.featureTags || plan.tags || [],
                        images: plan.images || { exterior: '', interior: '' },
                        floorPlans: plan.floorPlans || plan.floor_plans || [],
                        files: plan.files || { presentation: null, drawings: {}, documents: {}, images: {}, floorPlans: {} }
                    };
                    this.showModal = true;

                    // モーダルのスクロール位置を先頭にリセット
                    this.$nextTick(() => {
                        const modalBody = document.querySelector('.modal-body');
                        if (modalBody) {
                            modalBody.scrollTop = 0;
                        }
                    });
                },

                async deletePlan(plan) {
                    if (confirm(`プラン「${plan.name}」を削除しますか？`)) {
                        try {
                            console.log('[DeletePlan] Supabaseからプランを削除');
                            await window.supabaseAPI.plans.delete(plan.id);

                            // UIから削除
                            this.plans = this.plans.filter(p => p.id !== plan.id);
                            this.filterPlans();
                            this.updateStats();
                            showToast('プランを削除しました', 'success');
                        } catch (error) {
                            console.error('プランの削除に失敗しました:', error);
                            showToast('プランの削除に失敗しました', 'error');
                        }
                    }
                },

                handleFormSubmit() {
                    console.log('[ui] save-click');
                    // 二重送信防止
                    if (this.saving) {
                        console.log('[submit] already submitting, skip');
                        return;
                    }
                    this.savePlan();
                },

                async savePlan() {
                    console.log('[submit] start');
                    console.log('[SavePlan] FormData:', this.formData);
                    console.log('[SavePlan] Is form valid?', this.isFormValid());

                    // バリデーションチェック
                    if (!this.isFormValid()) {
                        console.error('[submit] validation error');
                        console.error('[SavePlan] Form errors:', this.formErrors);

                        // 具体的なエラー内容を表示
                        const errorMessages = [];
                        let firstErrorField = null;

                        if (!this.formData.id) {
                            errorMessages.push('プランID');
                            if (!firstErrorField) firstErrorField = 'id';
                        }
                        if (!this.formData.totalFloorArea) {
                            errorMessages.push('延床面積');
                            if (!firstErrorField) firstErrorField = 'totalFloorArea';
                        }
                        if (!this.formData.constructionFloorArea) {
                            errorMessages.push('施工床面積');
                            if (!firstErrorField) firstErrorField = 'constructionFloorArea';
                        }
                        if (!this.formData.layout) {
                            errorMessages.push('間取り');
                            if (!firstErrorField) firstErrorField = 'layout';
                        }
                        if (!this.getActualSellPrice()) {
                            errorMessages.push('販売価格');
                            if (!firstErrorField) firstErrorField = 'sellPrice';
                        }
                        if (!this.formData.cost) {
                            errorMessages.push('原価');
                            if (!firstErrorField) firstErrorField = 'cost';
                        }

                        const message = errorMessages.length > 0
                            ? `以下の必須項目を入力してください: ${errorMessages.join('、')}`
                            : '必須項目を入力してください';

                        showToast(message, 'error');

                        // 最初のエラーフィールドにスクロール
                        if (firstErrorField) {
                            this.scrollToError(firstErrorField);
                        }
                        return;
                    }

                    // 二重送信防止
                    this.saving = true;
                    console.log('[SavePlan] バリデーション成功、保存処理を開始');
                    
                    try {
                        // カスタムタグを処理
                        if (this.formData.customTags) {
                            const customTags = this.formData.customTags.split(',').map(t => t.trim()).filter(t => t);
                            this.formData.tags = [...(this.formData.featureTags || []), ...customTags];
                        } else {
                            this.formData.tags = this.formData.featureTags || [];
                        }
                        
                        // 販売価格の処理
                        const actualSellPrice = this.getActualSellPrice();
                        const actualCost = parseFloat(this.formData.cost) || 0;
                        const actualGrossProfit = this.calculatedGrossProfit;

                        // プラン名を生成（階数と坪数とレイアウトから）
                        const floorName = this.formData.floors == 1 ? '平屋' : `${this.formData.floors}階建て`;
                        const planName = `${floorName} ${this.calculatedTsubo}坪 ${this.formData.layout}`;

                        // データベーススキーマに合わせてsnake_caseで送信
                        const planData = {
                            // 基本情報
                            id: this.formData.id,
                            plan_code: this.formData.planCode,  // 表示用プランコード（手入力）
                            plan_name: planName,  // データベースの実際のカラム名
                            name: planName,       // 後方互換性のため両方設定
                            description: this.formData.description || '',

                            // 基本仕様（snake_case）
                            tsubo: this.calculatedTsubo || 0,
                            total_floor_area: parseFloat(this.formData.totalFloorArea) || 0,
                            construction_floor_area: parseFloat(this.formData.constructionFloorArea) || 0,
                            width: parseFloat(this.formData.width) || 0,
                            depth: parseFloat(this.formData.depth) || 0,
                            floors: parseInt(this.formData.floors) || 2,
                            layout: this.formData.layout || '',

                            // LDK・浴室階数（snake_case）
                            ldk_floor: parseInt(this.formData.ldkFloor) || null,
                            bathroom_floor: parseInt(this.formData.bathroomFloor) || null,

                            // 価格情報（snake_case、円単位）
                            price: actualSellPrice * 10000,  // 基本価格フィールド
                            sell_price: actualSellPrice * 10000,  // 販売価格
                            cost: actualCost * 10000,  // 原価
                            gross_profit: actualGrossProfit * 10000,  // 粗利

                            // 性能値（snake_case）
                            ua_value: parseFloat(this.formData.uaValue) || null,
                            energy_reduction: parseFloat(this.formData.energyReduction) || null,

                            // 設計者・ステータス
                            designer: this.formData.designer || '',
                            status: this.formData.status || 'draft',

                            // タグ（JSONB）
                            tags: this.formData.tags || [],

                            // 画像データ（JSONB）
                            images: this.formData.images || {},

                            // 間取図データ（snake_case、JSONB）
                            floor_plans: this.formData.floorPlans || [],

                            // ファイルデータ（JSONB）
                            files: this.formData.files || {},

                            // タイムスタンプ（snake_case）
                            updated_at: new Date().toISOString()
                        };
                        
                        console.log('[SavePlan] 送信データ:', planData);

                        try {
                            if (this.editingPlan) {
                                console.log('[SavePlan] 既存プランを更新:', this.editingPlan.id);
                                await window.supabaseBridge.updatePlan(this.editingPlan.id, planData);
                                console.log('[SavePlan] プラン更新成功');
                                showToast('プランを更新しました', 'success');
                            } else {
                                console.log('[SavePlan] 新規プランを作成');
                                console.log('[SavePlan] Supabaseに保存を試行');
                                const result = await window.supabaseBridge.savePlan(planData);
                                console.log('[SavePlan] Supabase保存結果:', result);
                                showToast('プランを追加しました', 'success');
                            }

                            console.log('[SavePlan] プラン一覧を再読み込み');
                            await this.loadPlans();
                            this.filterPlans();
                            this.updateStats();

                            // モーダルを閉じる前に状態をリセット
                            this.hasUnsavedChanges = false;
                            this.closeModal();
                            console.log('[submit] success');
                        } catch (apiError) {
                            console.error('[SavePlan] API呼び出しエラー:', apiError);
                            console.error('[SavePlan] エラー詳細:', {
                                message: apiError.message,
                                stack: apiError.stack,
                                response: apiError.response
                            });
                            throw apiError;
                        }
                    } catch (error) {
                        console.error('[submit] error', error);
                        console.error('[submit] エラーの詳細:', {
                            message: error.message,
                            hint: error.hint,
                            details: error.details,
                            code: error.code
                        });

                        let errorMessage = error.message || 'プランの保存に失敗しました';

                        // データベースカラムが存在しない場合の明確なエラーメッセージ
                        if (error.message && (error.message.includes('column') || error.message.includes('does not exist'))) {
                            errorMessage = '❌ データベーススキーマが更新されていません。\n\nSupabase SQL Editorでマイグレーションを実行してください。\n\n詳細: ' + error.message;
                        } else if (error.code === '42703') {
                            errorMessage = '❌ データベーススキーマが更新されていません。\n\nマイグレーションSQLを実行してください。';
                        } else if (error.code === '23502') {
                            errorMessage = '必須項目が入力されていません: ' + (error.details || error.message);
                        } else if (error.code === '23505') {
                            errorMessage = 'プランIDが重複しています。';
                        }

                        showToast(errorMessage, 'error');
                    } finally {
                        this.saving = false;
                        console.log('[SavePlan] 保存処理終了');
                    }
                },

                scrollToError(fieldName) {
                    // エラーフィールドへスクロール
                    const element = document.querySelector(`[x-model="formData.${fieldName}"]`);
                    if (element) {
                        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        element.focus();
                        // エラーフィールドをハイライト
                        element.classList.add('ring-2', 'ring-red-500');
                        setTimeout(() => {
                            element.classList.remove('ring-2', 'ring-red-500');
                        }, 3000);
                    }
                },

                closeModal() {
                    // フォームに何か入力されている場合は確認
                    const hasInput = this.formData.id || this.formData.tsubo || this.formData.layout;

                    if (hasInput && !confirm('入力内容が保存されていません。閉じてもよろしいですか？')) {
                        return;
                    }

                    this.showModal = false;
                    this.editingPlan = null;
                    this.currentTab = 'basic';
                    // モーダル位置をリセット
                    if (this.$refs.modalDraggable) {
                        this.$refs.modalDraggable.resetPosition();
                    }
                },
                
                updateStats() {
                    // 統計情報を更新するためのイベントを発行
                    window.dispatchEvent(new CustomEvent('plans-updated'));
                },
                
                handleDrop(event, type, subtype = null) {
                    event.preventDefault();
                    
                    // ドラッグオーバー効果を削除
                    event.target.closest('.file-upload-item')?.classList.remove('drag-over');
                    
                    const files = event.dataTransfer.files;
                    if (files.length > 0) {
                        if (subtype) {
                            // 図面など複数ファイル可能な場合
                            this.processFile(Array.from(files), type, subtype);
                        } else {
                            // 単一ファイルの場合
                            this.processFile(files[0], type);
                        }
                        showToast(`${files.length}ファイルがアップロードされました`, 'success');
                    }
                },
                
                async handleFileSelect(event, type, subtype = null) {
                    const files = event.target.files;
                    if (files.length > 0) {
                        // 複数ファイル対応
                        if (files.length > 1) {
                            await this.processFile(Array.from(files), type, subtype);
                        } else {
                            await this.processFile(files[0], type, subtype);
                        }
                    }
                },
                
                async processFile(file, type, subtype = null) {
                    // 複数ファイル対応
                    if (Array.isArray(file)) {
                        for (const f of file) {
                            await this.processSingleFile(f, type, subtype);
                        }
                    } else {
                        await this.processSingleFile(file, type, subtype);
                    }
                },
                
                async processSingleFile(file, type, subtype = null) {
                    // ファイルサイズチェック（5MB制限）
                    const maxSize = 5 * 1024 * 1024; // 5MB
                    if (file.size > maxSize) {
                        showToast(`ファイルサイズが大きすぎます（最大5MB）: ${file.name}`, 'error');
                        return;
                    }

                    // 画像形式チェック
                    if (type === 'image' || type === 'floorPlan') {
                        const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
                        if (!allowedTypes.includes(file.type)) {
                            showToast('対応していない画像形式です（JPG, PNG, WebPのみ）', 'error');
                            return;
                        }
                    }

                    // ファイル情報を保存
                    const fileInfo = {
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        lastModified: file.lastModified,
                        file: file  // 実際のファイルオブジェクトを保持
                    };

                    // 画像ファイルの場合はプレビューURLを生成
                    if (file.type.startsWith('image/')) {
                        fileInfo.preview = URL.createObjectURL(file);
                    }

                    if (type === 'presentation') {
                        this.formData.files.presentation = fileInfo;
                        // Storageにアップロード
                        const url = await this.uploadFileToStorage(file, 'presentation');
                        if (url) this.formData.files.presentation.url = url;
                    } else if (type === 'drawing' && subtype) {
                        if (!this.formData.files.drawings) {
                            this.formData.files.drawings = {};
                        }
                        // 複数ファイル対応
                        if (!this.formData.files.drawings[subtype]) {
                            this.formData.files.drawings[subtype] = [];
                        }
                        if (!Array.isArray(this.formData.files.drawings[subtype])) {
                            this.formData.files.drawings[subtype] = [this.formData.files.drawings[subtype]];
                        }
                        // Storageにアップロード
                        const url = await this.uploadFileToStorage(file, 'drawing', subtype);
                        if (url) fileInfo.url = url;
                        this.formData.files.drawings[subtype].push(fileInfo);
                    } else if (type === 'document' && subtype) {
                        if (!this.formData.files.documents) {
                            this.formData.files.documents = {};
                        }
                        // 複数ファイル対応
                        if (!this.formData.files.documents[subtype]) {
                            this.formData.files.documents[subtype] = [];
                        }
                        if (!Array.isArray(this.formData.files.documents[subtype])) {
                            this.formData.files.documents[subtype] = [this.formData.files.documents[subtype]];
                        }
                        // Storageにアップロード
                        const url = await this.uploadFileToStorage(file, 'document', subtype);
                        if (url) fileInfo.url = url;
                        this.formData.files.documents[subtype].push(fileInfo);
                    } else if (type === 'image' && subtype) {
                        if (!this.formData.files.images) {
                            this.formData.files.images = {};
                        }
                        this.formData.files.images[subtype] = fileInfo;
                        // 画像の場合はSupabase Storageにアップロード（完了を待つ）
                        await this.uploadImageToStorage(file, subtype);
                    } else if (type === 'floorPlan' && subtype) {
                        if (!this.formData.files.floorPlans) {
                            this.formData.files.floorPlans = {};
                        }
                        this.formData.files.floorPlans[subtype] = fileInfo;
                        // Storageにアップロード
                        const url = await this.uploadFileToStorage(file, 'floorPlan', subtype);
                        if (url) fileInfo.url = url;
                    }

                    console.log('File processed:', type, subtype, fileInfo);
                },

                async uploadImageToStorage(file, imageType) {
                    try {
                        // ファイル名を生成（プランID_タイプ_タイムスタンプ）
                        const timestamp = Date.now();
                        const fileExt = file.name.split('.').pop();
                        const fileName = `${this.formData.id}_${imageType}_${timestamp}.${fileExt}`;
                        const filePath = `plans/${fileName}`;

                        console.log(`[UploadImage] Uploading ${imageType} to:`, filePath);

                        // Supabase Storageにアップロード
                        const { data, error } = await window.supabase.storage
                            .from('plan-images')
                            .upload(filePath, file, {
                                cacheControl: '3600',
                                upsert: false
                            });

                        if (error) {
                            console.error('[UploadImage] Upload error:', error);
                            showToast(`画像のアップロードに失敗しました: ${error.message}`, 'error');
                            return;
                        }

                        // 公開URLを取得
                        const { data: urlData } = window.supabase.storage
                            .from('plan-images')
                            .getPublicUrl(filePath);

                        const publicUrl = urlData.publicUrl;
                        console.log(`[UploadImage] Public URL:`, publicUrl);

                        // formData.imagesに保存
                        this.formData.images[imageType] = publicUrl;

                        showToast(`${imageType === 'exterior' ? '外観パース' : '内観パース'}をアップロードしました`, 'success');
                    } catch (err) {
                        console.error('[UploadImage] Unexpected error:', err);
                        showToast('画像のアップロード中にエラーが発生しました', 'error');
                    }
                },

                async uploadFileToStorage(file, fileType, subType = null) {
                    try {
                        const timestamp = Date.now();
                        const fileExt = file.name.split('.').pop();
                        const fileName = subType
                            ? `${this.formData.id}_${fileType}_${subType}_${timestamp}.${fileExt}`
                            : `${this.formData.id}_${fileType}_${timestamp}.${fileExt}`;
                        const filePath = `plans/${fileName}`;

                        console.log(`[UploadFile] Uploading ${fileType} to:`, filePath);

                        // 適切なバケットを選択
                        const bucket = fileType === 'presentation' || fileType === 'drawing' || fileType === 'document'
                            ? 'plan-drawings'
                            : 'plan-images';

                        // Supabase Storageにアップロード
                        const { data, error } = await window.supabase.storage
                            .from(bucket)
                            .upload(filePath, file, {
                                cacheControl: '3600',
                                upsert: false
                            });

                        if (error) {
                            console.error('[UploadFile] Upload error:', error);
                            showToast(`ファイルのアップロードに失敗しました: ${error.message}`, 'error');
                            return null;
                        }

                        // 公開URLを取得
                        const { data: urlData } = window.supabase.storage
                            .from(bucket)
                            .getPublicUrl(filePath);

                        console.log(`[UploadFile] Public URL:`, urlData.publicUrl);
                        return urlData.publicUrl;
                    } catch (err) {
                        console.error('[UploadFile] Unexpected error:', err);
                        showToast('ファイルのアップロード中にエラーが発生しました', 'error');
                        return null;
                    }
                },

                removeFile(type, subtype = null) {
                    if (!confirm('このファイルを削除してもよろしいですか？')) {
                        return;
                    }

                    if (type === 'image' && subtype) {
                        if (this.formData.files?.images?.[subtype]) {
                            // プレビューURLを解放
                            if (this.formData.files.images[subtype].preview) {
                                URL.revokeObjectURL(this.formData.files.images[subtype].preview);
                            }
                            delete this.formData.files.images[subtype];
                        }
                    } else if (type === 'floorPlan' && subtype) {
                        if (this.formData.files?.floorPlans?.[subtype]) {
                            if (this.formData.files.floorPlans[subtype].preview) {
                                URL.revokeObjectURL(this.formData.files.floorPlans[subtype].preview);
                            }
                            delete this.formData.files.floorPlans[subtype];
                        }
                    } else if (type === 'presentation') {
                        if (this.formData.files?.presentation) {
                            delete this.formData.files.presentation;
                        }
                    }

                    showToast('ファイルを削除しました', 'success');
                },

                removeDrawingFile(drawingType, index) {
                    if (!confirm('このファイルを削除してもよろしいですか？')) {
                        return;
                    }

                    if (this.formData.files?.drawings?.[drawingType]?.[index]) {
                        // プレビューURLを解放
                        if (this.formData.files.drawings[drawingType][index].preview) {
                            URL.revokeObjectURL(this.formData.files.drawings[drawingType][index].preview);
                        }
                        // 配列から削除
                        this.formData.files.drawings[drawingType].splice(index, 1);

                        // 配列が空になったら削除
                        if (this.formData.files.drawings[drawingType].length === 0) {
                            delete this.formData.files.drawings[drawingType];
                        }
                    }

                    showToast('ファイルを削除しました', 'success');
                },

                removeDocumentFile(docType, index) {
                    if (!confirm('このファイルを削除してもよろしいですか？')) {
                        return;
                    }

                    if (this.formData.files?.documents?.[docType]?.[index]) {
                        // プレビューURLを解放（画像の場合）
                        if (this.formData.files.documents[docType][index].preview) {
                            URL.revokeObjectURL(this.formData.files.documents[docType][index].preview);
                        }
                        // 配列から削除
                        this.formData.files.documents[docType].splice(index, 1);

                        // 配列が空になったら削除
                        if (this.formData.files.documents[docType].length === 0) {
                            delete this.formData.files.documents[docType];
                        }
                    }

                    showToast('ファイルを削除しました', 'success');
                },

                toggleFeatureTag(tag) {
                    if (!this.formData.featureTags) {
                        this.formData.featureTags = [];
                    }
                    const index = this.formData.featureTags.indexOf(tag);
                    if (index > -1) {
                        this.formData.featureTags.splice(index, 1);
                    } else {
                        this.formData.featureTags.push(tag);
                    }
                },
                
                updateFloorPlans() {
                    const floors = parseInt(this.formData.floors) || 1;
                    this.formData.floorPlans = Array(floors).fill('');
                },

                // LocalStorageに保存
                async savePlansToLocalStorage() {
                    try {
                        const plansData = {
                            plans: this.plans,
                            lastUpdated: new Date().toISOString()
                        };
                        localStorage.setItem('plansData', JSON.stringify(plansData));
                        showToast('プランデータを保存しました', 'success');
                        console.log('Plans saved to localStorage:', plansData);
                    } catch (error) {
                        console.error('Failed to save plans:', error);
                        showToast('保存に失敗しました', 'error');
                    }
                },

                // Realtime同時編集機能
                setupRealtimeSubscription() {
                    // Supabase Realtimeのインポート確認
                    if (!window.supabase) {
                        console.warn('[Realtime] Supabase not loaded, realtime disabled');
                        return;
                    }

                    // channelメソッドが存在するか確認
                    if (typeof window.supabase.channel !== 'function') {
                        console.warn('[Realtime] Supabase channel method not available, realtime disabled');
                        return;
                    }

                    try {
                        this.realtimeChannel = window.supabase
                            .channel('plans-realtime')
                            .on(
                                'postgres_changes',
                                {
                                    event: '*',
                                    schema: 'public',
                                    table: 'plans'
                                },
                                (payload) => {
                                    console.log('[Realtime] Update received:', payload);
                                    this.handleRealtimeUpdate(payload);
                                }
                            )
                            .subscribe((status) => {
                                if (status === 'SUBSCRIBED') {
                                    console.log('[Realtime] ✅ 同時編集機能が有効になりました');
                                    // showToast('同時編集機能が有効です', 'info'); // 通知は不要
                                }
                            });
                    } catch (error) {
                        console.error('[Realtime] Failed to setup subscription:', error);
                        // エラーが発生してもアプリは継続動作
                    }
                },

                handleRealtimeUpdate(payload) {
                    const { eventType, new: newRecord, old: oldRecord } = payload;

                    if (eventType === 'INSERT') {
                        // 新規追加: リストに追加
                        const exists = this.plans.find(p => p.id === newRecord.id);
                        if (!exists) {
                            this.plans.unshift(newRecord);
                            this.filterPlans();
                            showToast('他のユーザーが新しいプランを追加しました', 'info');
                        }
                    } else if (eventType === 'UPDATE') {
                        // 更新: リスト内のデータを更新
                        const index = this.plans.findIndex(p => p.id === newRecord.id);
                        if (index !== -1) {
                            // 現在編集中のプランと同じか確認
                            if (this.editingPlan && this.editingPlan.id === newRecord.id) {
                                if (confirm('他のユーザーがこのプランを更新しました。最新データを読み込みますか？\n（キャンセルすると編集内容が上書きされる可能性があります）')) {
                                    this.plans[index] = newRecord;
                                    this.editingPlan = { ...newRecord };
                                    this.loadFormData(newRecord);
                                    showToast('最新データを読み込みました', 'success');
                                }
                            } else {
                                this.plans[index] = newRecord;
                                this.filterPlans();
                                showToast('プランが更新されました', 'info');
                            }
                        }
                    } else if (eventType === 'DELETE') {
                        // 削除: リストから削除
                        this.plans = this.plans.filter(p => p.id !== oldRecord.id);
                        this.filterPlans();

                        // 編集中のプランが削除された場合
                        if (this.editingPlan && this.editingPlan.id === oldRecord.id) {
                            alert('他のユーザーがこのプランを削除しました。モーダルを閉じます。');
                            this.closeModal();
                        } else {
                            showToast('プランが削除されました', 'info');
                        }
                    }
                }
            }
        }

        // モーダルドラッグ機能
        function modalDraggable() {
            return {
                isDragging: false,
                dragPosition: { x: 0, y: 0 },
                dragStart: { x: 0, y: 0 },
                initialPos: { x: 0, y: 0 },

                startDrag(event) {
                    // モバイルではドラッグ無効
                    if (window.innerWidth < 768) return;

                    // ボタンや入力要素ではドラッグ開始しない
                    const target = event.target;
                    if (target.closest('button, input, select, textarea, [contenteditable="true"]')) {
                        return;
                    }

                    this.isDragging = true;
                    const clientX = event.type === 'touchstart' ? event.touches[0].clientX : event.clientX;
                    const clientY = event.type === 'touchstart' ? event.touches[0].clientY : event.clientY;

                    this.dragStart = {
                        x: clientX - this.dragPosition.x,
                        y: clientY - this.dragPosition.y
                    };

                    // イベントリスナーを追加
                    document.addEventListener('mousemove', this.handleDrag.bind(this));
                    document.addEventListener('mouseup', this.endDrag.bind(this));
                    document.addEventListener('touchmove', this.handleDrag.bind(this));
                    document.addEventListener('touchend', this.endDrag.bind(this));

                    event.preventDefault();
                },

                handleDrag(event) {
                    if (!this.isDragging) return;

                    const clientX = event.type === 'touchmove' ? event.touches[0].clientX : event.clientX;
                    const clientY = event.type === 'touchmove' ? event.touches[0].clientY : event.clientY;

                    let newX = clientX - this.dragStart.x;
                    let newY = clientY - this.dragStart.y;

                    // 画面境界制限（20px余白）
                    const margin = 20;
                    const modalWidth = 1536; // max-w-6xl
                    const modalHeight = window.innerHeight * 0.9; // max-h-[90vh]

                    const maxX = (window.innerWidth - modalWidth) / 2 - margin;
                    const minX = -(window.innerWidth - modalWidth) / 2 + margin;
                    const maxY = (window.innerHeight - modalHeight) / 2 - margin;
                    const minY = -(window.innerHeight - modalHeight) / 2 + margin;

                    newX = Math.max(minX, Math.min(newX, maxX));
                    newY = Math.max(minY, Math.min(newY, maxY));

                    this.dragPosition = { x: newX, y: newY };
                },

                endDrag() {
                    this.isDragging = false;

                    // イベントリスナーを削除
                    document.removeEventListener('mousemove', this.handleDrag.bind(this));
                    document.removeEventListener('mouseup', this.endDrag.bind(this));
                    document.removeEventListener('touchmove', this.handleDrag.bind(this));
                    document.removeEventListener('touchend', this.endDrag.bind(this));
                },

                resetPosition() {
                    this.dragPosition = { x: 0, y: 0 };
                }
            }
        }

        // ページ離脱時のクリーンアップ
        window.addEventListener('beforeunload', () => {
            if (typeof Alpine !== 'undefined' && Alpine.$data) {
                const component = Alpine.$data(document.querySelector('[x-data="adminPlans()"]'));
                if (component && component.cleanup) {
                    component.cleanup();
                }
            }
        });
    </script>
</body>
</html>