<!DOCTYPE html>
<html lang="ja" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ルール管理 | LIFE X 管理画面</title>
    <link href="./styles/main.css" rel="stylesheet">
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="/utils/common.js" type="module"></script>
    
</head>
<body class="h-full bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-gray-900">LIFE X 管理画面</h1>
                    <span class="ml-2 px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">管理者専用</span>
                </div>
                <nav class="hidden md:flex space-x-8">
                    <a href="/admin-plans.html" class="nav-link">プラン管理</a>
                    <a href="/admin-rules.html" class="nav-link active">ルール管理</a>
                    <a href="/admin-downloads.html" class="nav-link">ダウンロード管理</a>
                    <a href="/" class="nav-link">サイトに戻る</a>
                </nav>
            </div>
        </div>
    </header>

    <div x-data="adminRules()" x-init="init()">
        <!-- Page Header -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">ルール管理</h1>
                    <p class="text-gray-600 mt-2">加盟店ルールの追加・編集・削除を管理</p>
                </div>
                <button @click="openAddModal()" class="btn-primary">
                    <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    新規ルール追加
                </button>
            </div>

            <!-- Filter & Search -->
            <div class="card mb-6">
                <div class="flex flex-col md:flex-row gap-4">
                    <input type="text" 
                           x-model="searchQuery"
                           @input="filterRules()"
                           placeholder="ルール名または内容で検索..." 
                           class="form-input flex-1">
                    <select x-model="filterCategory" @change="filterRules()" class="form-input">
                        <option value="">全てのカテゴリ</option>
                        <option value="販売">販売ルール</option>
                        <option value="契約">契約ルール</option>
                        <option value="施工">施工ルール</option>
                        <option value="アフター">アフターサービス</option>
                        <option value="品質">品質基準</option>
                        <option value="その他">その他</option>
                    </select>
                    <select x-model="filterImportance" @change="filterRules()" class="form-input">
                        <option value="">全ての重要度</option>
                        <option value="必須">必須</option>
                        <option value="重要">重要</option>
                        <option value="推奨">推奨</option>
                    </select>
                    <select x-model="sortBy" @change="sortRules()" class="form-input">
                        <option value="order">表示順</option>
                        <option value="title">タイトル順</option>
                        <option value="category">カテゴリ順</option>
                        <option value="importance">重要度順</option>
                        <option value="date">更新日順</option>
                    </select>
                </div>
            </div>

            <!-- Rules Table -->
            <div class="card">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">表示順</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">タイトル</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">カテゴリ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">重要度</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">内容</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ステータス</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">更新日</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="rule in filteredRules" :key="rule.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                        <div class="flex items-center space-x-2">
                                            <button @click="moveUp(rule)" class="text-gray-400 hover:text-gray-600">
                                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                                </svg>
                                            </button>
                                            <span x-text="rule.order"></span>
                                            <button @click="moveDown(rule)" class="text-gray-400 hover:text-gray-600">
                                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                                </svg>
                                            </button>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="rule.title"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800" x-text="rule.category"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span x-show="rule.importance === '必須'" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">必須</span>
                                        <span x-show="rule.importance === '重要'" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-orange-100 text-orange-800">重要</span>
                                        <span x-show="rule.importance === '推奨'" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">推奨</span>
                                    </td>
                                    <td class="px-6 py-4 text-sm text-gray-500">
                                        <div class="max-w-xs truncate" x-text="rule.content"></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span x-show="rule.status === 'active'" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">有効</span>
                                        <span x-show="rule.status === 'inactive'" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">無効</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="rule.updated"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <button @click="editRule(rule)" class="text-blue-600 hover:text-blue-900 mr-3">編集</button>
                                        <button @click="deleteRule(rule)" class="text-red-600 hover:text-red-900">削除</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Add/Edit Modal -->
        <div x-show="showModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
            <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-3xl shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <h3 class="text-lg font-medium text-gray-900 mb-4" x-text="editingRule ? 'ルール編集' : '新規ルール追加'"></h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">タイトル</label>
                            <input type="text" x-model="formData.title" class="form-input w-full" placeholder="販売価格の設定">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">表示順</label>
                            <input type="number" x-model="formData.order" class="form-input w-full" placeholder="1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">カテゴリ</label>
                            <select x-model="formData.category" class="form-input w-full">
                                <option value="販売">販売ルール</option>
                                <option value="契約">契約ルール</option>
                                <option value="施工">施工ルール</option>
                                <option value="アフター">アフターサービス</option>
                                <option value="品質">品質基準</option>
                                <option value="その他">その他</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">重要度</label>
                            <select x-model="formData.importance" class="form-input w-full">
                                <option value="必須">必須</option>
                                <option value="重要">重要</option>
                                <option value="推奨">推奨</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">内容</label>
                            <textarea x-model="formData.content" rows="6" class="form-input w-full" placeholder="ルールの詳細内容を入力してください"></textarea>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">補足説明</label>
                            <textarea x-model="formData.notes" rows="3" class="form-input w-full" placeholder="補足説明がある場合は入力してください"></textarea>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">関連ドキュメント</label>
                            <input type="text" x-model="formData.documents" class="form-input w-full" placeholder="関連ドキュメントのリンクまたは名称">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ステータス</label>
                            <select x-model="formData.status" class="form-input w-full">
                                <option value="active">有効</option>
                                <option value="inactive">無効</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">適用開始日</label>
                            <input type="date" x-model="formData.effectiveDate" class="form-input w-full">
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end space-x-3">
                        <button @click="closeModal()" class="btn-secondary">キャンセル</button>
                        <button @click="saveRule()" class="btn-primary">保存</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 認証チェック
        if (!window.authManager.requireAuth()) {
            // requireAuth内でリダイレクトされる
        }

        function adminRules() {
            return {
                rules: [
                    { 
                        id: 1, 
                        order: 1,
                        title: '販売価格の設定', 
                        category: '販売', 
                        importance: '必須',
                        content: '住宅本体価格は本部指定価格から変更不可。オプション価格は加盟店で設定可能。',
                        status: 'active', 
                        updated: '2024-01-15' 
                    },
                    { 
                        id: 2, 
                        order: 2,
                        title: '契約書の取り扱い', 
                        category: '契約', 
                        importance: '必須',
                        content: '契約書は必ず本部指定のフォーマットを使用。独自の条項追加は事前承認が必要。',
                        status: 'active', 
                        updated: '2024-01-14' 
                    },
                    { 
                        id: 3, 
                        order: 3,
                        title: '施工基準の遵守', 
                        category: '施工', 
                        importance: '必須',
                        content: 'LIFE X施工マニュアルに準拠した施工を実施。定期的な品質チェックを受けること。',
                        status: 'active', 
                        updated: '2024-01-13' 
                    },
                    { 
                        id: 4, 
                        order: 4,
                        title: 'アフターサービス対応', 
                        category: 'アフター', 
                        importance: '重要',
                        content: '引き渡し後1年、2年、5年、10年の定期点検を実施。緊急対応は24時間以内に初動対応。',
                        status: 'active', 
                        updated: '2024-01-12' 
                    },
                    { 
                        id: 5, 
                        order: 5,
                        title: '品質管理体制', 
                        category: '品質', 
                        importance: '重要',
                        content: '品質管理責任者を配置し、月次で品質報告書を本部に提出。',
                        status: 'active', 
                        updated: '2024-01-11' 
                    },
                    { 
                        id: 6, 
                        order: 6,
                        title: '広告・宣伝の規定', 
                        category: '販売', 
                        importance: '推奨',
                        content: 'LIFE Xブランドガイドラインに準拠した広告物の作成。独自広告は事前承認必要。',
                        status: 'active', 
                        updated: '2024-01-10' 
                    }
                ],
                filteredRules: [],
                searchQuery: '',
                filterCategory: '',
                filterImportance: '',
                sortBy: 'order',
                showModal: false,
                editingRule: null,
                formData: {
                    title: '',
                    order: '',
                    category: '販売',
                    importance: '重要',
                    content: '',
                    notes: '',
                    documents: '',
                    status: 'active',
                    effectiveDate: ''
                },

                init() {
                    this.filterRules();
                },

                filterRules() {
                    let filtered = [...this.rules];
                    
                    if (this.searchQuery) {
                        filtered = filtered.filter(rule => 
                            rule.title.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
                            rule.content.toLowerCase().includes(this.searchQuery.toLowerCase())
                        );
                    }
                    
                    if (this.filterCategory) {
                        filtered = filtered.filter(rule => rule.category === this.filterCategory);
                    }
                    
                    if (this.filterImportance) {
                        filtered = filtered.filter(rule => rule.importance === this.filterImportance);
                    }
                    
                    this.filteredRules = filtered;
                    this.sortRules();
                },

                sortRules() {
                    this.filteredRules.sort((a, b) => {
                        switch(this.sortBy) {
                            case 'order':
                                return a.order - b.order;
                            case 'title':
                                return a.title.localeCompare(b.title);
                            case 'category':
                                return a.category.localeCompare(b.category);
                            case 'importance':
                                const importanceOrder = {'必須': 1, '重要': 2, '推奨': 3};
                                return importanceOrder[a.importance] - importanceOrder[b.importance];
                            case 'date':
                                return new Date(b.updated) - new Date(a.updated);
                            default:
                                return 0;
                        }
                    });
                },

                moveUp(rule) {
                    const index = this.rules.findIndex(r => r.id === rule.id);
                    if (index > 0) {
                        const prevRule = this.rules[index - 1];
                        const tempOrder = rule.order;
                        rule.order = prevRule.order;
                        prevRule.order = tempOrder;
                        this.rules.sort((a, b) => a.order - b.order);
                        this.filterRules();
                        lifeXAPI.showToast('表示順を変更しました', 'success');
                    }
                },

                moveDown(rule) {
                    const index = this.rules.findIndex(r => r.id === rule.id);
                    if (index < this.rules.length - 1) {
                        const nextRule = this.rules[index + 1];
                        const tempOrder = rule.order;
                        rule.order = nextRule.order;
                        nextRule.order = tempOrder;
                        this.rules.sort((a, b) => a.order - b.order);
                        this.filterRules();
                        lifeXAPI.showToast('表示順を変更しました', 'success');
                    }
                },

                openAddModal() {
                    this.editingRule = null;
                    this.formData = {
                        title: '',
                        order: this.rules.length + 1,
                        category: '販売',
                        importance: '重要',
                        content: '',
                        notes: '',
                        documents: '',
                        status: 'active',
                        effectiveDate: ''
                    };
                    this.showModal = true;
                },

                editRule(rule) {
                    this.editingRule = rule;
                    this.formData = { ...rule };
                    this.showModal = true;
                },

                deleteRule(rule) {
                    if (confirm(`ルール「${rule.title}」を削除しますか？`)) {
                        this.rules = this.rules.filter(r => r.id !== rule.id);
                        // Reorder remaining rules
                        this.rules.forEach((r, index) => r.order = index + 1);
                        this.filterRules();
                        lifeXAPI.showToast('ルールを削除しました', 'success');
                    }
                },

                saveRule() {
                    if (this.editingRule) {
                        const index = this.rules.findIndex(r => r.id === this.editingRule.id);
                        if (index !== -1) {
                            this.rules[index] = { 
                                ...this.formData, 
                                id: this.editingRule.id,
                                updated: new Date().toISOString().split('T')[0] 
                            };
                        }
                        lifeXAPI.showToast('ルールを更新しました', 'success');
                    } else {
                        const newId = Math.max(...this.rules.map(r => r.id)) + 1;
                        this.rules.push({ 
                            ...this.formData, 
                            id: newId,
                            updated: new Date().toISOString().split('T')[0] 
                        });
                        lifeXAPI.showToast('ルールを追加しました', 'success');
                    }
                    this.filterRules();
                    this.closeModal();
                },

                closeModal() {
                    this.showModal = false;
                    this.editingRule = null;
                }
            }
        }
    </script>
</body>
</html>