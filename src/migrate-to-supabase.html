<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ„ãƒ¼ãƒ« | LIFE X</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        // Supabaseæ¥ç¶šæƒ…å ±
        const supabaseUrl = 'https://tkemcbxqbrfqgmyswkjg.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRrZW1jYnhxYnJmcWdteXN3a2pnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3OTIwMjUsImV4cCI6MjA3NDM2ODAyNX0.UKHU7iTO35N3MuIzJYp9VVxB7ga2YDQ5Vrzd6Gf3k-I';
        const supabase = createClient(supabaseUrl, supabaseKey);

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
        window.supabase = supabase;
    </script>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen py-8">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h1 class="text-3xl font-bold text-gray-900">Supabase ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ„ãƒ¼ãƒ«</h1>
                <p class="mt-2 text-gray-600">LocalStorageã‹ã‚‰Supabaseãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚’å®Ÿè¡Œã—ã¾ã™</p>
            </div>

            <!-- ç§»è¡Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">ç§»è¡Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
                <div class="space-y-4">
                    <div id="migration-log" class="bg-gray-50 rounded p-4 h-64 overflow-y-auto font-mono text-sm">
                        <div class="text-gray-500">ç§»è¡Œã‚’é–‹å§‹ã™ã‚‹ã«ã¯ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</div>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="checkLocalStorageData()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            LocalStorageãƒ‡ãƒ¼ã‚¿ç¢ºèª
                        </button>
                        <button onclick="startMigration()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                            ç§»è¡Œé–‹å§‹
                        </button>
                        <button onclick="clearLog()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                            ãƒ­ã‚°ã‚¯ãƒªã‚¢
                        </button>
                    </div>
                </div>
            </div>

            <!-- ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- LocalStorage ãƒ‡ãƒ¼ã‚¿ -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold mb-3">LocalStorage ãƒ‡ãƒ¼ã‚¿</h3>
                    <div class="space-y-2">
                        <div id="localStorage-summary" class="text-sm text-gray-600"></div>
                    </div>
                </div>

                <!-- Supabase ãƒ‡ãƒ¼ã‚¿ -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold mb-3">Supabase ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</h3>
                    <div class="space-y-2">
                        <div id="supabase-summary" class="text-sm text-gray-600"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const logElement = document.getElementById('migration-log');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-red-500' :
                         type === 'success' ? 'text-green-500' :
                         type === 'warning' ? 'text-yellow-600' : 'text-gray-700';

            const logEntry = document.createElement('div');
            logEntry.className = color;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            logElement.innerHTML = '';
            log('ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        }

        async function checkLocalStorageData() {
            log('LocalStorageãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªä¸­...');
            const summary = document.getElementById('localStorage-summary');
            let html = '';

            // ãƒ—ãƒ©ãƒ³ãƒ‡ãƒ¼ã‚¿
            const plansData = localStorage.getItem('plansData');
            if (plansData) {
                const plans = JSON.parse(plansData).plans || [];
                html += `<div>ğŸ“ ãƒ—ãƒ©ãƒ³: ${plans.length}ä»¶</div>`;
                log(`ãƒ—ãƒ©ãƒ³ãƒ‡ãƒ¼ã‚¿: ${plans.length}ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`);
            } else {
                html += `<div class="text-gray-400">ğŸ“ ãƒ—ãƒ©ãƒ³: 0ä»¶</div>`;
            }

            // ãƒ«ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿
            const rulesData = localStorage.getItem('rules_categories_data');
            if (rulesData) {
                const categories = JSON.parse(rulesData).categories || [];
                const totalRules = categories.reduce((sum, cat) => sum + (cat.rules?.length || 0), 0);
                html += `<div>ğŸ“‹ ãƒ«ãƒ¼ãƒ«: ${totalRules}ä»¶ (${categories.length}ã‚«ãƒ†ã‚´ãƒª)</div>`;
                log(`ãƒ«ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿: ${totalRules}ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`);
            } else {
                html += `<div class="text-gray-400">ğŸ“‹ ãƒ«ãƒ¼ãƒ«: 0ä»¶</div>`;
            }

            // FAQãƒ‡ãƒ¼ã‚¿
            const faqData = localStorage.getItem('faqData');
            if (faqData) {
                const faqs = JSON.parse(faqData).faqs || [];
                html += `<div>â“ FAQ: ${faqs.length}ä»¶</div>`;
                log(`FAQãƒ‡ãƒ¼ã‚¿: ${faqs.length}ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`);
            } else {
                html += `<div class="text-gray-400">â“ FAQ: 0ä»¶</div>`;
            }

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿
            const downloadsData = localStorage.getItem('downloadsData');
            if (downloadsData) {
                const items = JSON.parse(downloadsData).items || [];
                html += `<div>ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰: ${items.length}ä»¶</div>`;
                log(`ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿: ${items.length}ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`);
            } else {
                html += `<div class="text-gray-400">ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰: 0ä»¶</div>`;
            }

            summary.innerHTML = html;
            await checkSupabaseData();
        }

        async function checkSupabaseData() {
            log('Supabaseãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ç¢ºèªä¸­...');
            const summary = document.getElementById('supabase-summary');
            let html = '';

            try {
                // ãƒ—ãƒ©ãƒ³æ•°
                const { count: plansCount } = await window.supabase
                    .from('plans')
                    .select('*', { count: 'exact', head: true });
                html += `<div>ğŸ“ ãƒ—ãƒ©ãƒ³: ${plansCount || 0}ä»¶</div>`;

                // ãƒ«ãƒ¼ãƒ«æ•°
                const { count: rulesCount } = await window.supabase
                    .from('rules')
                    .select('*', { count: 'exact', head: true });
                html += `<div>ğŸ“‹ ãƒ«ãƒ¼ãƒ«: ${rulesCount || 0}ä»¶</div>`;

                // FAQæ•°
                const { count: faqsCount } = await window.supabase
                    .from('faqs')
                    .select('*', { count: 'exact', head: true });
                html += `<div>â“ FAQ: ${faqsCount || 0}ä»¶</div>`;

                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ•°
                const { count: downloadsCount } = await window.supabase
                    .from('downloads')
                    .select('*', { count: 'exact', head: true });
                html += `<div>ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰: ${downloadsCount || 0}ä»¶</div>`;

                summary.innerHTML = html;
                log('Supabaseãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç¢ºèªå®Œäº†', 'success');
            } catch (error) {
                log(`Supabaseã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                summary.innerHTML = '<div class="text-red-500">æ¥ç¶šã‚¨ãƒ©ãƒ¼</div>';
            }
        }

        async function startMigration() {
            log('=== ãƒ‡ãƒ¼ã‚¿ç§»è¡Œé–‹å§‹ ===', 'success');

            try {
                // 1. ãƒ—ãƒ©ãƒ³ãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œ
                await migratePlans();

                // 2. ãƒ«ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œ
                await migrateRules();

                // 3. FAQãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œ
                await migrateFAQs();

                // 4. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œ
                await migrateDownloads();

                log('=== ãƒ‡ãƒ¼ã‚¿ç§»è¡Œå®Œäº† ===', 'success');
                await checkSupabaseData();

            } catch (error) {
                log(`ç§»è¡Œã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function migratePlans() {
            log('ãƒ—ãƒ©ãƒ³ãƒ‡ãƒ¼ã‚¿ç§»è¡Œä¸­...');
            const plansData = localStorage.getItem('plansData');
            if (!plansData) {
                log('ãƒ—ãƒ©ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warning');
                return;
            }

            const { plans } = JSON.parse(plansData);
            let successCount = 0;
            let errorCount = 0;

            for (const plan of plans) {
                try {
                    // ãƒ—ãƒ©ãƒ³åŸºæœ¬æƒ…å ±ã‚’æ•´å½¢
                    const planData = {
                        id: plan.id || `PLAN-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                        name: plan.name || 'Unknown Plan',
                        category: plan.category || null,
                        description: plan.description || null,
                        tsubo: parseFloat(plan.tsubo) || null,
                        width: parseFloat(plan.width) || null,
                        depth: parseFloat(plan.depth) || null,
                        floors: plan.floors || 2,
                        price: parseInt(plan.price) || null,
                        price_without_tax: parseInt(plan.priceWithoutTax) || null,
                        construction_period: parseInt(plan.constructionPeriod) || null,
                        bedrooms: parseInt(plan.bedrooms) || null,
                        living_dining: plan.livingDining || null,
                        kitchen: plan.kitchen || null,
                        bathroom: plan.bathroom || null,
                        toilet: parseInt(plan.toilet) || null,
                        tags: plan.tags || [],
                        status: plan.status || 'published',
                        specifications: plan.specifications || {},
                        options: plan.options || {}
                    };

                    // ãƒ—ãƒ©ãƒ³ã‚’æŒ¿å…¥
                    const { error } = await window.supabase
                        .from('plans')
                        .upsert([planData], { onConflict: 'id' });

                    if (error) throw error;

                    // ç”»åƒãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã° plan_images ã«æŒ¿å…¥
                    if (plan.exteriorImage || plan.interiorImage || plan.floorPlan1F || plan.floorPlan2F) {
                        const images = [];

                        if (plan.exteriorImage) {
                            images.push({
                                plan_id: planData.id,
                                type: 'exterior',
                                url: plan.exteriorImage
                            });
                        }

                        if (plan.interiorImage) {
                            images.push({
                                plan_id: planData.id,
                                type: 'interior',
                                url: plan.interiorImage
                            });
                        }

                        if (plan.floorPlan1F) {
                            images.push({
                                plan_id: planData.id,
                                type: 'floor_plan_1f',
                                url: plan.floorPlan1F
                            });
                        }

                        if (plan.floorPlan2F) {
                            images.push({
                                plan_id: planData.id,
                                type: 'floor_plan_2f',
                                url: plan.floorPlan2F
                            });
                        }

                        if (images.length > 0) {
                            await window.supabase
                                .from('plan_images')
                                .upsert(images, { onConflict: ['plan_id', 'type'] });
                        }
                    }

                    successCount++;
                    log(`âœ“ ãƒ—ãƒ©ãƒ³ "${plan.name}" ã‚’ç§»è¡Œã—ã¾ã—ãŸ`, 'success');
                } catch (error) {
                    errorCount++;
                    log(`âœ— ãƒ—ãƒ©ãƒ³ "${plan.name}" ã®ç§»è¡Œå¤±æ•—: ${error.message}`, 'error');
                }
            }

            log(`ãƒ—ãƒ©ãƒ³ç§»è¡Œå®Œäº†: æˆåŠŸ ${successCount}ä»¶, å¤±æ•— ${errorCount}ä»¶`, 'success');
        }

        async function migrateRules() {
            log('ãƒ«ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ç§»è¡Œä¸­...');
            const rulesData = localStorage.getItem('rules_categories_data');
            if (!rulesData) {
                log('ãƒ«ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warning');
                return;
            }

            const { categories } = JSON.parse(rulesData);
            let categoryCount = 0;
            let ruleCount = 0;

            for (const category of categories) {
                try {
                    // ã‚«ãƒ†ã‚´ãƒªã‚’æŒ¿å…¥
                    const categoryData = {
                        id: category.id || undefined,
                        name: category.name,
                        description: category.description || null,
                        icon: category.icon || null,
                        display_order: category.order || 0
                    };

                    const { data: insertedCategory, error: catError } = await window.supabase
                        .from('rule_categories')
                        .upsert([categoryData], { onConflict: 'id' })
                        .select()
                        .single();

                    if (catError) throw catError;
                    categoryCount++;

                    // ãƒ«ãƒ¼ãƒ«ã‚’æŒ¿å…¥
                    if (category.rules && category.rules.length > 0) {
                        const rules = category.rules.map((rule, index) => ({
                            category_id: insertedCategory.id,
                            title: rule.title,
                            content: rule.content || rule.description,
                            priority: rule.priority || 'normal',
                            tags: rule.tags || [],
                            status: rule.status || 'active',
                            display_order: index
                        }));

                        const { error: rulesError } = await window.supabase
                            .from('rules')
                            .insert(rules);

                        if (rulesError) throw rulesError;
                        ruleCount += rules.length;
                    }

                    log(`âœ“ ã‚«ãƒ†ã‚´ãƒª "${category.name}" ã¨ ${category.rules?.length || 0}ä»¶ã®ãƒ«ãƒ¼ãƒ«ã‚’ç§»è¡Œã—ã¾ã—ãŸ`, 'success');
                } catch (error) {
                    log(`âœ— ã‚«ãƒ†ã‚´ãƒª "${category.name}" ã®ç§»è¡Œå¤±æ•—: ${error.message}`, 'error');
                }
            }

            log(`ãƒ«ãƒ¼ãƒ«ç§»è¡Œå®Œäº†: ${categoryCount}ã‚«ãƒ†ã‚´ãƒª, ${ruleCount}ãƒ«ãƒ¼ãƒ«`, 'success');
        }

        async function migrateFAQs() {
            log('FAQãƒ‡ãƒ¼ã‚¿ç§»è¡Œä¸­...');
            const faqData = localStorage.getItem('faqData');
            if (!faqData) {
                log('FAQãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warning');
                return;
            }

            const { faqs, categories } = JSON.parse(faqData);
            let categoryCount = 0;
            let faqCount = 0;

            // ã‚«ãƒ†ã‚´ãƒªã‚’å…ˆã«ä½œæˆ
            if (categories && categories.length > 0) {
                for (const category of categories) {
                    try {
                        const { error } = await window.supabase
                            .from('faq_categories')
                            .upsert([{
                                name: category.name,
                                description: category.description || null,
                                display_order: category.order || 0
                            }], { onConflict: 'name' });

                        if (error) throw error;
                        categoryCount++;
                    } catch (error) {
                        log(`âœ— FAQã‚«ãƒ†ã‚´ãƒª "${category.name}" ã®ç§»è¡Œå¤±æ•—: ${error.message}`, 'error');
                    }
                }
            }

            // FAQã‚’æŒ¿å…¥
            if (faqs && faqs.length > 0) {
                for (const faq of faqs) {
                    try {
                        const { error } = await window.supabase
                            .from('faqs')
                            .insert([{
                                question: faq.question,
                                answer: faq.answer,
                                tags: faq.tags || [],
                                status: 'published',
                                display_order: faq.order || 0
                            }]);

                        if (error) throw error;
                        faqCount++;
                    } catch (error) {
                        log(`âœ— FAQ "${faq.question}" ã®ç§»è¡Œå¤±æ•—: ${error.message}`, 'error');
                    }
                }
            }

            log(`FAQç§»è¡Œå®Œäº†: ${categoryCount}ã‚«ãƒ†ã‚´ãƒª, ${faqCount}FAQ`, 'success');
        }

        async function migrateDownloads() {
            log('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ç§»è¡Œä¸­...');
            const downloadsData = localStorage.getItem('downloadsData');
            if (!downloadsData) {
                log('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warning');
                return;
            }

            const { items, categories } = JSON.parse(downloadsData);
            let categoryCount = 0;
            let itemCount = 0;

            // ã‚«ãƒ†ã‚´ãƒªã‚’å…ˆã«ä½œæˆ
            if (categories && categories.length > 0) {
                for (const category of categories) {
                    try {
                        const { error } = await window.supabase
                            .from('download_categories')
                            .upsert([{
                                name: category.name,
                                description: category.description || null,
                                display_order: category.order || 0
                            }], { onConflict: 'name' });

                        if (error) throw error;
                        categoryCount++;
                    } catch (error) {
                        log(`âœ— ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚«ãƒ†ã‚´ãƒª "${category.name}" ã®ç§»è¡Œå¤±æ•—: ${error.message}`, 'error');
                    }
                }
            }

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¢ã‚¤ãƒ†ãƒ ã‚’æŒ¿å…¥
            if (items && items.length > 0) {
                for (const item of items) {
                    try {
                        const { error } = await window.supabase
                            .from('downloads')
                            .insert([{
                                title: item.title,
                                description: item.description || null,
                                file_type: item.format?.toLowerCase() || 'other',
                                file_url: item.url || '#',
                                file_name: item.fileName || item.title,
                                file_size: item.size || null,
                                tags: item.tags || [],
                                status: 'active'
                            }]);

                        if (error) throw error;
                        itemCount++;
                    } catch (error) {
                        log(`âœ— ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ "${item.title}" ã®ç§»è¡Œå¤±æ•—: ${error.message}`, 'error');
                    }
                }
            }

            log(`ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç§»è¡Œå®Œäº†: ${categoryCount}ã‚«ãƒ†ã‚´ãƒª, ${itemCount}ã‚¢ã‚¤ãƒ†ãƒ `, 'success');
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ‡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯
        window.addEventListener('load', () => {
            checkLocalStorageData();
        });
    </script>
</body>
</html>